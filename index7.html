<!DOCTYPE html>
<!--[if IEMobile 7 ]><html class="no-js iem7"><![endif]-->
<!--[if lt IE 9]><html class="no-js lte-ie8"><![endif]-->
<!--[if (gt IE 8)|(gt IEMobile 7)|!(IEMobile)|!(IE)]><!-->
<html class="no-js" lang="en">
<!--<![endif]-->

  <head>
    <meta charset="utf-8">
    <meta name="google-site-verification" content="5_8DTmIiEq4gFvNAfxAD6TsGOgrMAjp8lQFQvfA6zZc" />
    <title>/var/</title>
    <meta name="author" content="Serafeim Papastefanos">


    
<style type="text/css">
pre { line-height: 125%; }
td.linenos .normal { color: inherit; background-color: transparent; padding-left: 5px; padding-right: 5px; }
span.linenos { color: inherit; background-color: transparent; padding-left: 5px; padding-right: 5px; }
td.linenos .special { color: #000000; background-color: #ffffc0; padding-left: 5px; padding-right: 5px; }
span.linenos.special { color: #000000; background-color: #ffffc0; padding-left: 5px; padding-right: 5px; }
.highlight .hll { background-color: var(--jp-cell-editor-active-background) }
.highlight { background: var(--jp-cell-editor-background); color: var(--jp-mirror-editor-variable-color) }
.highlight .c { color: var(--jp-mirror-editor-comment-color); font-style: italic } /* Comment */
.highlight .err { color: var(--jp-mirror-editor-error-color) } /* Error */
.highlight .k { color: var(--jp-mirror-editor-keyword-color); font-weight: bold } /* Keyword */
.highlight .o { color: var(--jp-mirror-editor-operator-color); font-weight: bold } /* Operator */
.highlight .p { color: var(--jp-mirror-editor-punctuation-color) } /* Punctuation */
.highlight .ch { color: var(--jp-mirror-editor-comment-color); font-style: italic } /* Comment.Hashbang */
.highlight .cm { color: var(--jp-mirror-editor-comment-color); font-style: italic } /* Comment.Multiline */
.highlight .cp { color: var(--jp-mirror-editor-comment-color); font-style: italic } /* Comment.Preproc */
.highlight .cpf { color: var(--jp-mirror-editor-comment-color); font-style: italic } /* Comment.PreprocFile */
.highlight .c1 { color: var(--jp-mirror-editor-comment-color); font-style: italic } /* Comment.Single */
.highlight .cs { color: var(--jp-mirror-editor-comment-color); font-style: italic } /* Comment.Special */
.highlight .kc { color: var(--jp-mirror-editor-keyword-color); font-weight: bold } /* Keyword.Constant */
.highlight .kd { color: var(--jp-mirror-editor-keyword-color); font-weight: bold } /* Keyword.Declaration */
.highlight .kn { color: var(--jp-mirror-editor-keyword-color); font-weight: bold } /* Keyword.Namespace */
.highlight .kp { color: var(--jp-mirror-editor-keyword-color); font-weight: bold } /* Keyword.Pseudo */
.highlight .kr { color: var(--jp-mirror-editor-keyword-color); font-weight: bold } /* Keyword.Reserved */
.highlight .kt { color: var(--jp-mirror-editor-keyword-color); font-weight: bold } /* Keyword.Type */
.highlight .m { color: var(--jp-mirror-editor-number-color) } /* Literal.Number */
.highlight .s { color: var(--jp-mirror-editor-string-color) } /* Literal.String */
.highlight .ow { color: var(--jp-mirror-editor-operator-color); font-weight: bold } /* Operator.Word */
.highlight .pm { color: var(--jp-mirror-editor-punctuation-color) } /* Punctuation.Marker */
.highlight .w { color: var(--jp-mirror-editor-variable-color) } /* Text.Whitespace */
.highlight .mb { color: var(--jp-mirror-editor-number-color) } /* Literal.Number.Bin */
.highlight .mf { color: var(--jp-mirror-editor-number-color) } /* Literal.Number.Float */
.highlight .mh { color: var(--jp-mirror-editor-number-color) } /* Literal.Number.Hex */
.highlight .mi { color: var(--jp-mirror-editor-number-color) } /* Literal.Number.Integer */
.highlight .mo { color: var(--jp-mirror-editor-number-color) } /* Literal.Number.Oct */
.highlight .sa { color: var(--jp-mirror-editor-string-color) } /* Literal.String.Affix */
.highlight .sb { color: var(--jp-mirror-editor-string-color) } /* Literal.String.Backtick */
.highlight .sc { color: var(--jp-mirror-editor-string-color) } /* Literal.String.Char */
.highlight .dl { color: var(--jp-mirror-editor-string-color) } /* Literal.String.Delimiter */
.highlight .sd { color: var(--jp-mirror-editor-string-color) } /* Literal.String.Doc */
.highlight .s2 { color: var(--jp-mirror-editor-string-color) } /* Literal.String.Double */
.highlight .se { color: var(--jp-mirror-editor-string-color) } /* Literal.String.Escape */
.highlight .sh { color: var(--jp-mirror-editor-string-color) } /* Literal.String.Heredoc */
.highlight .si { color: var(--jp-mirror-editor-string-color) } /* Literal.String.Interpol */
.highlight .sx { color: var(--jp-mirror-editor-string-color) } /* Literal.String.Other */
.highlight .sr { color: var(--jp-mirror-editor-string-color) } /* Literal.String.Regex */
.highlight .s1 { color: var(--jp-mirror-editor-string-color) } /* Literal.String.Single */
.highlight .ss { color: var(--jp-mirror-editor-string-color) } /* Literal.String.Symbol */
.highlight .il { color: var(--jp-mirror-editor-number-color) } /* Literal.Number.Integer.Long */
</style>

<style type="text/css">
/* Overrides of notebook CSS for static HTML export */
div.entry-content {
  overflow: visible;
  padding: 8px;
}
.input_area {
  padding: 0.2em;
}

a.heading-anchor {
 white-space: normal;
}

.rendered_html
code {
 font-size: .8em;
}

pre.ipynb {
  color: black;
  background: #f7f7f7;
  border: none;
  box-shadow: none;
  margin-bottom: 0;
  padding: 0;
  margin: 0px;
  font-size: 13px;
}

/* remove the prompt div from text cells */
div.text_cell .prompt {
    display: none;
}

/* remove horizontal padding from text cells, */
/* so it aligns with outer body text */
div.text_cell_render {
    padding: 0.5em 0em;
}

img.anim_icon{padding:0; border:0; vertical-align:middle; -webkit-box-shadow:none; -box-shadow:none}

div.collapseheader {
    width=100%;
    background-color:#d3d3d3;
    padding: 2px;
    cursor: pointer;
    font-family:"Helvetica Neue",Helvetica,Arial,sans-serif;
}
</style>

<script type="text/x-mathjax-config">
MathJax.Hub.Config({
    tex2jax: {
        inlineMath: [['$','$'], ['\\(','\\)']],
        processEscapes: true,
        displayMath: [['$$','$$'], ["\\[","\\]"]]
    }
});
</script>
<script type="text/javascript" async src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.2/MathJax.js?config=TeX-MML-AM_CHTML">
</script>

<script src="https://ajax.googleapis.com/ajax/libs/jquery/1.10.2/jquery.min.js"></script>

<script type="text/javascript">
jQuery(document).ready(function($) {
    $("div.collapseheader").click(function () {
    $header = $(this).children("span").first();
    $codearea = $(this).children(".input_area");
    console.log($(this).children());
    $codearea.slideToggle(500, function () {
        $header.text(function () {
            return $codearea.is(":visible") ? "Collapse Code" : "Expand Code";
        });
    });
});
});
</script>




    <!-- http://t.co/dKP3o1e -->
    <meta name="HandheldFriendly" content="True">
    <meta name="MobileOptimized" content="320">
    <meta name="viewport" content="width=device-width, initial-scale=1">


    <link href="https://www.spapas.net/favicon.png" rel="icon">

    <link href="https://www.spapas.net/theme/css/main.css" media="screen, projection" rel="stylesheet"
      type="text/css">

    <link href="https://www.spapas.net/theme/css/extra_style.css" media="screen, projection" rel="stylesheet"
      type="text/css">

    <link href="https://fonts.googleapis.com/css?family=Fira+Mono|Fira+Sans:400,700&amp;subset=greek" rel="stylesheet">

<style>
#gHPzseYvFrhZ123 {
  padding: 5px !important;
  display: block;
  margin-bottom: 10px !important;
  background: #900;
  color: #fff;
  border-radius: 5px;
  font-size: 1.0rem !important;
}
</style>


  <script>
    
      
  </script>

    <script data-ad-client="ca-pub-7673322832689008" async
      src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"
      onerror="adBlockFunction();"></script>
  </head>

<body>
  <header role="banner"><hgroup>
  <h1><a href="https://www.spapas.net/">/var/</a></h1>
    <h2>Various programming stuff</h2>
</hgroup></header>
  <nav role="navigation"><ul class="subscription" data-subscription="rss">
</ul>


<ul class="main-navigation">
      <li >
        <a href="https://www.spapas.net/category/ai.html">Ai</a>
      </li>
      <li >
        <a href="https://www.spapas.net/category/android.html">Android</a>
      </li>
      <li >
        <a href="https://www.spapas.net/category/clojure.html">Clojure</a>
      </li>
      <li >
        <a href="https://www.spapas.net/category/css.html">Css</a>
      </li>
      <li >
        <a href="https://www.spapas.net/category/django.html">Django</a>
      </li>
      <li >
        <a href="https://www.spapas.net/category/elixir.html">Elixir</a>
      </li>
      <li >
        <a href="https://www.spapas.net/category/flask.html">Flask</a>
      </li>
      <li >
        <a href="https://www.spapas.net/category/gaming.html">Gaming</a>
      </li>
      <li >
        <a href="https://www.spapas.net/category/git.html">Git</a>
      </li>
      <li >
        <a href="https://www.spapas.net/category/html.html">Html</a>
      </li>
      <li >
        <a href="https://www.spapas.net/category/javascript.html">Javascript</a>
      </li>
      <li >
        <a href="https://www.spapas.net/category/networking.html">Networking</a>
      </li>
      <li >
        <a href="https://www.spapas.net/category/pelican.html">Pelican</a>
      </li>
      <li >
        <a href="https://www.spapas.net/category/postgresql.html">Postgresql</a>
      </li>
      <li >
        <a href="https://www.spapas.net/category/python.html">Python</a>
      </li>
      <li >
        <a href="https://www.spapas.net/category/spring.html">Spring</a>
      </li>
      <li >
        <a href="https://www.spapas.net/category/unix.html">Unix</a>
      </li>
      <li >
        <a href="https://www.spapas.net/category/wagtail.html">Wagtail</a>
      </li>
</ul></nav>
  <div id="main">
    <div id="content">
    <div id="gHPzseYvFrhZ123">
      Hello! If you are using an ad blocker but find something useful here 
      and want to support me please consider disabling your ad blocker for this site. 
      <br />
      <br />
      Thank you,<br />
      Serafeim
      
    </div>
<div class="blog-index">
  		<article>
<header>
      <h1 class="entry-title">
        <a href="https://www.spapas.net/2018/05/08/django-reponse-add-delay/">Adding a delay to Django HTTP responses</a>
      </h1>
    <p class="meta">
<time datetime="2018-05-08T23:20:00+03:00" pubdate>Tue 08 May 2018</time>    </p>
</header>

<div class="entry-content"><p>Sometimes you&#8217;d like to make your Django views more slow by adding a fake delay. This may
sound controversial (why would somebody want to make some of his views slower) however it is a real requirement,
at least when developing an&nbsp;application.</p>
<p>For example, you may be using a <span class="caps">REST</span> <span class="caps">API</span> and you want to implement a spinner while your form is loading. However, usually when
developing your responses will load so soon that you won&#8217;t be able to admire your spinner in all its glory! Also, when you
submit a <span class="caps">POST</span> form (i.e a form that changes your data), it is advisable to disable your submit button so that when your users
double click it the form won&#8217;t be submitted two times (it may seem strange to some people but this is a very common error that
has bitten me many times; there are many users that think that they need to double click the buttons; thus I always disable
my submit buttons after somebody clicks them); in this case you also need to make your response a little slower to make sure
that the button is actually&nbsp;disabled!</p>
<p>I will propose two methods for adding this delay to your responses. One that will affect all (or most) your views using
a <a class="reference external" href="https://docs.djangoproject.com/en/2.0/topics/http/middleware/">middleware</a> and another that you can add to any <span class="caps">CBV</span> you want using a mixin; please see my previous <a class="reference external" href="https://spapas.github.io/2018/03/19/comprehensive-django-cbv-guide/"><span class="caps">CBV</span> guide</a> for more on
Django CBVs and mixins. For the middleware solution we&#8217;ll also take a quick look at what is the Django middleware mechanism and
how it can be used to add&nbsp;functionality.</p>
<div class="section" id="using-middleware">
<h2>Using&nbsp;middleware</h2>
<p>The Django <a class="reference external" href="https://docs.djangoproject.com/en/2.0/topics/http/middleware/">middleware</a> is a mechanism for adding your own code to the Django request / response cycle. I&#8217;ll try to explain
this a bit; Django is waiting for an <span class="caps">HTTP</span> Request (i.e <span class="caps">GET</span> a url with these headers and these query parameters), it will
parse this <span class="caps">HTTP</span> Request and prepare an <span class="caps">HTTP</span> Response (i.e some headers and a Payload). Your view will be the main actor for
retrieving the <span class="caps">HTTP</span> response and returning the <span class="caps">HTTP</span> request. However, using this middleware mechanism Django allows you to
enable other actors (the middleware) that will universally modify the <span class="caps">HTTP</span> request before passing it to your view and will also
modify the view&#8217;s <span class="caps">HTTP</span> respone before sending it back to the&nbsp;client.</p>
<p>Actually, a list of middleware called &#8230; <tt class="docutils literal"><span class="caps">MIDDLEWARE</span></tt> is <a class="reference external" href="https://docs.djangoproject.com/en/2.0/topics/http/middleware/#activating-middleware">defined by default</a> in the <tt class="docutils literal">settings.py</tt> of all new Django
projects; these are used to add various capabilities
that are universally needed, for example session support, various security enablers, django message support and others. You
can easily attach your own middleware to that list to add extra functionality. Notice that the order of the middleware in the <tt class="docutils literal"><span class="caps">MIDDLEWARE</span></tt>
list actually matters. Middleware later in the list will be executed after the ones previous in the list; we&#8217;ll see some consequences of this&nbsp;later.</p>
<p>Now the time has come to take a quick look at how to implement a middleware, <a class="reference external" href="https://docs.djangoproject.com/en/2.0/topics/http/middleware/#writing-your-own-middleware">taken from the Django docs</a>:</p>
<div class="highlight"><pre><span></span><span class="k">class</span><span class="w"> </span><span class="nc">SimpleMiddleware</span><span class="p">:</span>
    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">get_response</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">get_response</span> <span class="o">=</span> <span class="n">get_response</span>
        <span class="c1"># One-time configuration and initialization.</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__call__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request</span><span class="p">):</span>
        <span class="c1"># Code to be executed for each request before</span>
        <span class="c1"># the view (and later middleware) are called.</span>

        <span class="n">response</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_response</span><span class="p">(</span><span class="n">request</span><span class="p">)</span>

        <span class="c1"># Code to be executed for each request/response after</span>
        <span class="c1"># the view is called.</span>

        <span class="k">return</span> <span class="n">response</span>
</pre></div>
<p>Actually you can implement the middleware as a nested function however I prefer the classy version. The comments should be really enlightening:
When your project is started the constructor (<tt class="docutils literal">__init__</tt>) will be called once, for example if you want to read a configuration setting from the database
then you should do it in the <tt class="docutils literal">__init__</tt> to avoid calling the database everytime your middleware is executed (i.e for <em>every</em> request). The <tt class="docutils literal">__call__</tt> is
a special method that gets translated to calling this class instance as a function, i.e if you do something&nbsp;like:</p>
<div class="highlight"><pre><span></span><span class="n">sm</span> <span class="o">=</span> <span class="n">SimpleMiddleware</span><span class="p">()</span>
<span class="n">sm</span><span class="p">()</span>
</pre></div>
<p>Then <tt class="docutils literal">sm()</tt> will execute the <tt class="docutils literal">__call__</tt>; there are various similar <a class="reference external" href="http://www.diveintopython3.net/special-method-names.html">python special methods</a>, for example <tt class="docutils literal">__len__</tt>, <tt class="docutils literal">__eq__</tt> etc</p>
<p>Now, as you can see the <tt class="docutils literal">__call__</tt> special method has four&nbsp;parts:</p>
<ul class="simple">
<li>Code that is executed <em>before</em> the <tt class="docutils literal">self.get_response()</tt> method is called; here you should modify the request object. Middleware will reach this point in the order they are&nbsp;listed.</li>
<li>The actual call to <tt class="docutils literal">self.get_response()</tt></li>
<li>Code that is executed <em>after</em> the <tt class="docutils literal">self.get_response()</tt> method is called; here you should modify the response object. Middleware will reach this point in the reverse order they are&nbsp;listed.</li>
<li>Returning the response to be used by the next&nbsp;middleware</li>
</ul>
<p>Notice that <tt class="docutils literal">get_response</tt> will call the next middleware; while the <tt class="docutils literal">get_response</tt> for the last middleware will actually call the view. Then
the view will return a response which could be modified (if needed) by the middlewares in the opposite order of their definition&nbsp;list.</p>
<p>As an example, let&#8217;s define two simple&nbsp;middlewares:</p>
<div class="highlight"><pre><span></span><span class="k">class</span><span class="w"> </span><span class="nc">M1</span><span class="p">:</span>
    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">get_response</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">get_response</span> <span class="o">=</span> <span class="n">get_response</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__call__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request</span><span class="p">):</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;M1 before response&quot;</span><span class="p">)</span>
        <span class="n">response</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_response</span><span class="p">(</span><span class="n">request</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;M1 after response&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">response</span>

<span class="k">class</span><span class="w"> </span><span class="nc">M2</span><span class="p">:</span>
    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">get_response</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">get_response</span> <span class="o">=</span> <span class="n">get_response</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__call__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request</span><span class="p">):</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;M2 before response&quot;</span><span class="p">)</span>
        <span class="n">response</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_response</span><span class="p">(</span><span class="n">request</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;M2 after response&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">response</span>
</pre></div>
<p>When you define <tt class="docutils literal"><span class="caps">MIDDLEWARE</span> = ['M1', 'M2']</tt> you&#8217;ll see the&nbsp;following:</p>
<div class="highlight"><pre><span></span><span class="c1"># Got the request</span>
<span class="n">M1</span> <span class="n">before</span> <span class="n">response</span>
<span class="n">M2</span> <span class="n">before</span> <span class="n">response</span>
<span class="c1"># The view is rendered to the response now</span>
<span class="n">M2</span> <span class="n">after</span> <span class="n">response</span>
<span class="n">M1</span> <span class="n">after</span> <span class="n">response</span>
<span class="c1"># Return the response</span>
</pre></div>
<p>Please notice a middleware may not call <tt class="docutils literal">self.get_response</tt> to continue the chain but return directly a response (for example a 403 Forbiden&nbsp;response).</p>
<p>After this quick introduction to how middleware works, let&#8217;s take a look at a skeleton for the time-delay&nbsp;middleware:</p>
<div class="highlight"><pre><span></span><span class="kn">import</span><span class="w"> </span><span class="nn">time</span>

<span class="k">class</span><span class="w"> </span><span class="nc">TimeDelayMiddleware</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">get_response</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">get_response</span> <span class="o">=</span> <span class="n">get_response</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__call__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request</span><span class="p">):</span>
        <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">response</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_response</span><span class="p">(</span><span class="n">request</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">response</span>
</pre></div>
<p>This is really simple, I&#8217;ve just added an extra line to the previous middleware. This line adds a one-second delay to all responses. I&#8217;ve
added it before <tt class="docutils literal">self.get_response</tt> - because this delay does not depend on anything, I could have added it after <tt class="docutils literal">self.get_response</tt>
without changes in the behavior. Also, the order of this middleware in the <tt class="docutils literal"><span class="caps">MIDDLEWARE</span></tt> list doesn&#8217;t matter since it doesn&#8217;t depend on
other middleware (it just needs to run to add the&nbsp;delay).</p>
<p>This middleware may have a little more functionality, for example to configure the delay from the settings or add the delay only for
specific urls (by checking the <tt class="docutils literal">request.path</tt>).
Here&#8217;s how these extra features could be&nbsp;implemented:</p>
<div class="highlight"><pre><span></span><span class="kn">import</span><span class="w"> </span><span class="nn">time</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">django.conf</span><span class="w"> </span><span class="kn">import</span> <span class="n">settings</span>

<span class="k">class</span><span class="w"> </span><span class="nc">TimeDelayMiddleware</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">get_response</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">get_response</span> <span class="o">=</span> <span class="n">get_response</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">delay</span> <span class="o">=</span> <span class="n">settings</span><span class="o">.</span><span class="n">REQUEST_TIME_DELAY</span>


    <span class="k">def</span><span class="w"> </span><span class="fm">__call__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request</span><span class="p">):</span>
        <span class="k">if</span> <span class="s1">&#39;/api/&#39;</span> <span class="ow">in</span> <span class="n">request</span><span class="o">.</span><span class="n">path</span><span class="p">:</span>
            <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">delay</span><span class="p">)</span>
        <span class="n">response</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_response</span><span class="p">(</span><span class="n">request</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">response</span>
</pre></div>
<p>The above will add the delay only to requests whose path contains <tt class="docutils literal">'/api'</tt>. Another case is if you want to
only add the delay for <tt class="docutils literal"><span class="caps">POST</span></tt> requests by checking that <tt class="docutils literal">request.method == '<span class="caps">POST</span>'</tt>.</p>
<p>Now, to install this middleware, you can configure your <tt class="docutils literal"><span class="caps">MIDDLEWARE</span></tt> like this in your <tt class="docutils literal">settings.py</tt>
(let&#8217;s say that you have an application named <tt class="docutils literal">core</tt> containing a module named <tt class="docutils literal">middleware</tt>):</p>
<div class="highlight"><pre><span></span><span class="n">MIDDLEWARE</span> <span class="o">=</span> <span class="p">[</span>
    <span class="s1">&#39;django.middleware.security.SecurityMiddleware&#39;</span><span class="p">,</span>
    <span class="s1">&#39;django.contrib.sessions.middleware.SessionMiddleware&#39;</span><span class="p">,</span>
    <span class="s1">&#39;django.middleware.common.CommonMiddleware&#39;</span><span class="p">,</span>
    <span class="s1">&#39;django.middleware.csrf.CsrfViewMiddleware&#39;</span><span class="p">,</span>
    <span class="s1">&#39;django.contrib.auth.middleware.AuthenticationMiddleware&#39;</span><span class="p">,</span>
    <span class="s1">&#39;django.contrib.messages.middleware.MessageMiddleware&#39;</span><span class="p">,</span>
    <span class="s1">&#39;django.middleware.clickjacking.XFrameOptionsMiddleware&#39;</span><span class="p">,</span>

    <span class="s1">&#39;core.middleware.TimeDelayMiddleware&#39;</span><span class="p">,</span>
<span class="p">]</span>
</pre></div>
<p>The other middleware are the default ones in Django. One more thing to consider is that if
you have a single settings.py this middleware will be called; one way to override the delay
is to check for settings.<span class="caps">DEBUG</span> and only call <tt class="docutils literal">time.sleep</tt> when <tt class="docutils literal"><span class="caps">DEBUG</span> == True</tt>. However,
the proper way to do it is to have different settings for your development and production
environments and add the <tt class="docutils literal">TimeDelayMiddleware</tt> only to your development <tt class="docutils literal"><span class="caps">MIDDLEWARE</span></tt> list.
Having different settings for each development is a <a class="reference external" href="https://medium.com/&#64;ayarshabeer/django-best-practice-settings-file-for-multiple-environments-6d71c6966ee2">common practice in Django</a> and I totally
recommend to use&nbsp;it.</p>
</div>
<div class="section" id="using-cbvs">
<h2>Using&nbsp;CBVs</h2>
<p>Another method to add a delay to the execution of a view is to implement a TimeDelayMixin and inherit
your Class Based View from it. As we&#8217;ve seen in the <a class="reference external" href="https://spapas.github.io/2018/03/19/comprehensive-django-cbv-guide/"><span class="caps">CBV</span> guide</a>, the <tt class="docutils literal">dispatch</tt> method is the one
that is always called when your <span class="caps">CBV</span> is rendered, thus your <tt class="docutils literal">TimeDelayMixin</tt> could be implemented like&nbsp;this:</p>
<div class="highlight"><pre><span></span><span class="kn">import</span><span class="w"> </span><span class="nn">time</span>

<span class="k">class</span><span class="w"> </span><span class="nc">TimeDelayMixin</span><span class="p">(</span><span class="nb">object</span><span class="p">,</span> <span class="p">):</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">dispatch</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
        <span class="k">return</span> <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">dispatch</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
</pre></div>
<p>This is very simple (and you can use similar techniques as described for the middleware above to configure
the delay time or add the delay only when <tt class="docutils literal">settings.<span class="caps">DEBUG</span> == True</tt> etc) - to actually use it, just inherit your
view from this mixin,&nbsp;f.e:</p>
<div class="highlight"><pre><span></span><span class="k">class</span><span class="w"> </span><span class="nc">DelayedSampleListView</span><span class="p">(</span><span class="n">TimeDelayMixin</span><span class="p">,</span> <span class="n">ListView</span><span class="p">):</span>
    <span class="n">model</span> <span class="o">=</span> <span class="n">Sample</span>
</pre></div>
<p>Now whenever you call your <tt class="docutils literal">DelayedSampleListView</tt> you&#8217;ll see it after the configured&nbsp;delay!</p>
<p>What is really interesting is that the <tt class="docutils literal">dispatch</tt> method actually exists (and has the same functionality) also
in Django Rest Framework CBVs, thus using the same mixin you can add the delay not only your normal CBVs but
also your <span class="caps">DRF</span> <span class="caps">API</span>&nbsp;views!</p>
</div>
</div>
  		</article>
  		<article>
<header>
      <h1 class="entry-title">
        <a href="https://www.spapas.net/2018/04/05/easy-immutable-objects/">Easy immutable objects in Javascript</a>
      </h1>
    <p class="meta">
<time datetime="2018-04-05T12:20:00+03:00" pubdate>Thu 05 April 2018</time>    </p>
</header>

<div class="entry-content"><p>With the rise of <a class="reference external" href="https://redux.js.org">Redux</a> and other similar Javascript frameworks (e.g <a class="reference external" href="https://hyperapp.js.org">Hyperapp</a>) that
try to be a little more <em>functional</em> (functional as in functional programming), a
new problem was introduced to Javascript programmers (at least to those that weren&#8217;t
familair with functional programming): How to keep their application&#8217;s
state&nbsp;&#8220;immutable&#8221;.</p>
<p>Immutable means that the state should be an object that does not change (mutates) - instead
of changing it, Redux needs the state object to be <a class="reference external" href="https://redux.js.org/basics/reducers">created from the beginning</a>.</p>
<p>So when something happens in your application you need to discard
the existing state object and create a new one from scratch by modifying and copying the previous state values.
This is easy
in most toy-apps that are used when introducing the concept, for example if your state is <tt class="docutils literal">{counter: 0}</tt>
then you could just define the reducer for the <tt class="docutils literal"><span class="caps">ADD</span></tt> action (i.e when the user clicks the <tt class="docutils literal">+</tt> button) like&nbsp;this:</p>
<div class="highlight"><pre><span></span><span class="kd">let</span><span class="w"> </span><span class="nx">reducer</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="nx">state</span><span class="o">=</span><span class="p">{</span><span class="nx">counter</span><span class="o">:</span><span class="w"> </span><span class="mf">0</span><span class="p">},</span><span class="w"> </span><span class="nx">action</span><span class="p">)</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="k">switch</span><span class="w"> </span><span class="p">(</span><span class="nx">action</span><span class="p">.</span><span class="nx">type</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">case</span><span class="w"> </span><span class="s1">&#39;ADD&#39;</span><span class="o">:</span><span class="w"> </span><span class="k">return</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="s1">&#39;counter&#39;</span><span class="o">:</span><span class="w"> </span><span class="nx">state</span><span class="p">.</span><span class="nx">counter</span><span class="o">+</span><span class="mf">1</span><span class="w"> </span><span class="p">}</span>
<span class="w">    </span><span class="k">default</span><span class="o">:</span><span class="w"> </span><span class="k">return</span><span class="w"> </span><span class="nx">state</span>
<span class="w">  </span><span class="p">}</span>
<span class="p">}</span>
</pre></div>
<p>Unfortunately, your application will definitely have a much more complex state than&nbsp;this!</p>
<p>In the following, I&#8217;ll do a quick introduction on how to keep your state objects immutable
using modern Javascript techniques, I&#8217;ll present how complex it is to modify non-trivial
immutable objects and finally I&#8217;ll give you a quick recipe for modifying your non-trivial
immutable objects. If you want to play with the concepts I&#8217;ll introduce you can do it at a
<a class="reference external" href="https://repl.it/&#64;spapas/JS-Drill-Down-objectarray-immutable">playground I&#8217;ve created on repl.it</a>.</p>
<p>Please keep in mind that this article has been written for <span class="caps">ES6</span> - take a look at my
<a class="reference external" href="https://spapas.github.io/2015/11/16/using-browserify-es6/">browserify with <span class="caps">ES6</span></a> article to see how you can also use it in your projects with&nbsp;Browserify.</p>
<p>Also, if you&#8217;d like to see a non-toy React + Redux application or you&#8217;d like a gentle
introduction to the concepts I talked about (state, reducers, actions etc)
you can follow along my <a class="reference external" href="https://spapas.github.io/2016/03/02/react-redux-tutorial/">React Redux tutorial</a>. This is a rather old article
(considering how quickly the Javascript framework state change) but the basic concepts
introduced there are true&nbsp;today.</p>
<div class="section" id="immutable-objects">
<h2>Immutable&nbsp;objects</h2>
<p>Let&#8217;s start our descent into avoiding mutations by supposing that you had
something a little more complex than the initial example, for example your state was like&nbsp;this:</p>
<div class="highlight"><pre><span></span><span class="kd">let</span><span class="w"> </span><span class="nx">state</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="s1">&#39;counter&#39;</span><span class="o">:</span><span class="w"> </span><span class="mf">0</span><span class="p">,</span>
<span class="w">    </span><span class="s1">&#39;name&#39;</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;John&#39;</span><span class="p">,</span>
<span class="w">    </span><span class="s1">&#39;age&#39;</span><span class="o">:</span><span class="w"> </span><span class="mf">36</span>
<span class="p">}</span>
</pre></div>
<p>If you continued the same example then your <tt class="docutils literal"><span class="caps">ADD</span></tt> reducer would need to return something like&nbsp;this</p>
<div class="highlight"><pre><span></span><span class="k">return</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="s1">&#39;counter&#39;</span><span class="o">:</span><span class="w"> </span><span class="nx">state</span><span class="p">.</span><span class="nx">counter</span><span class="o">+</span><span class="mf">1</span><span class="p">,</span>
<span class="w">    </span><span class="s1">&#39;name&#39;</span><span class="o">:</span><span class="w"> </span><span class="nx">state</span><span class="p">.</span><span class="nx">name</span><span class="p">,</span>
<span class="w">    </span><span class="s1">&#39;age&#39;</span><span class="o">:</span><span class="w"> </span><span class="nx">state</span><span class="p">.</span><span class="nx">age</span>
<span class="p">}</span>
</pre></div>
<p>This gets difficult and error prone very soon - and what happens if you later need to add another attribute to your&nbsp;state?</p>
<p>The correct way to implement this would be to enumerate all properties of state except &#8216;counter&#8217;, copy them to a new
object, and then assign counter+1 to the new object&#8217;s counter attribute. You could implement this by hand however,
thankfully, there&#8217;s the <a class="reference external" href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Object/assign">Object.assign</a> method! This method will copy all attributes from a list of objects
to an object which will return as a result and is defined like&nbsp;this:</p>
<div class="highlight"><pre><span></span><span class="nb">Object</span><span class="p">.</span><span class="nx">assign</span><span class="p">(</span><span class="nx">target</span><span class="p">,</span><span class="w"> </span><span class="p">...</span><span class="nx">sources</span><span class="p">)</span>
</pre></div>
<p>The <tt class="docutils literal">target</tt> parameter is the object that will retrieve all attributes from <tt class="docutils literal">sources</tt> (which is a variadic argument - you can
have as many sources as you want - even 0; in this case the target will be returned). For a quick example,&nbsp;running:</p>
<div class="highlight"><pre><span></span><span class="kd">let</span><span class="w"> </span><span class="nx">o</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="s1">&#39;a&#39;</span><span class="o">:</span><span class="w"> </span><span class="mf">1</span><span class="p">}</span>
<span class="kd">let</span><span class="w"> </span><span class="nx">oo</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">Object</span><span class="p">.</span><span class="nx">assign</span><span class="p">(</span><span class="nx">o</span><span class="p">,</span><span class="w"> </span><span class="p">{</span><span class="s1">&#39;b&#39;</span><span class="o">:</span><span class="w"> </span><span class="mf">2</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;c&#39;</span><span class="o">:</span><span class="w"> </span><span class="mf">1</span><span class="p">},</span><span class="w"> </span><span class="p">{</span><span class="s1">&#39;c&#39;</span><span class="o">:</span><span class="w"> </span><span class="mf">3</span><span class="p">})</span>
<span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">oo</span><span class="p">,</span><span class="w"> </span><span class="nx">o</span><span class="o">===</span><span class="nx">oo</span><span class="p">)</span>
</pre></div>
<p>will return <tt class="docutils literal">{ a: 1, b: 2, c: 3 } true</tt> i.e the attributes &#8216;b&#8217; and &#8216;c&#8217; were copied to <tt class="docutils literal">o</tt> and it was assigned to <tt class="docutils literal">oo</tt> &#8212; notice
that o and oo are the same object (thus <tt class="docutils literal">o</tt> is modified now). Also, notice that the the attributes of objects to the right
have priority over the attributes of the objects to the left (<tt class="docutils literal">'c': 1</tt> was overriden by <tt class="docutils literal">'c': 3</tt>).</p>
<p>As you should have guessed by now, you should never pass the
state as the <tt class="docutils literal">target</tt> but instead you should create a new object, thus the <tt class="docutils literal"><span class="caps">ADD</span></tt> reducer should return the&nbsp;following:</p>
<div class="highlight"><pre><span></span><span class="k">return</span><span class="w"> </span><span class="nb">Object</span><span class="p">.</span><span class="nx">assign</span><span class="p">({},</span><span class="w"> </span><span class="nx">state</span><span class="p">,</span><span class="w"> </span><span class="p">{</span><span class="s1">&#39;counter&#39;</span><span class="o">:</span><span class="w"> </span><span class="nx">state</span><span class="p">.</span><span class="nx">counter</span><span class="o">+</span><span class="mf">1</span><span class="p">)</span>
</pre></div>
<p>This means that it will create a new object which will copy all current attributes of state and increase the existing
<tt class="docutils literal">counter</tt> attribute.</p>
<p>I&#8217;d like to also add here that instead of using the <tt class="docutils literal">Object.assign</tt> method you could use the <a class="reference external" href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Operators/Spread_syntax">spread syntax</a>
to more or less do the same. The spread syntax on an object takes this object&#8217;s attributes and outputs them as key-value
dictionary pairs (for them to be used to initialize other objects). Thus, you can use the spread syntax to create an new object that has the same attributes
of another object like&nbsp;this:</p>
<div class="highlight"><pre><span></span><span class="kd">let</span><span class="w"> </span><span class="nx">newState</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{...</span><span class="nx">state</span><span class="p">}</span>
<span class="c1">// which is similar to</span>
<span class="nx">newState</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">Object</span><span class="p">.</span><span class="nx">assign</span><span class="p">({},</span><span class="w"> </span><span class="nx">state</span><span class="p">)</span>
</pre></div>
<p>Of course you usually need to override some attributes, which can be passed directly to the newly created object,
for example for the <tt class="docutils literal"><span class="caps">ADD</span></tt> reducer:</p>
<div class="highlight"><pre><span></span><span class="k">return</span><span class="w"> </span><span class="p">{...</span><span class="nx">state</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;counter&#39;</span><span class="o">:</span><span class="w"> </span><span class="nx">state</span><span class="p">.</span><span class="nx">counter</span><span class="o">+</span><span class="mf">1</span><span class="w"> </span><span class="p">}</span>
</pre></div>
<p>Like <tt class="docutils literal">Object.assign</tt>, you can have as many sources as you want in your spread syntax thus nothing stops you from using <tt class="docutils literal">...</tt> multiple times to copy the attributes of multiple objects
for example you could define <tt class="docutils literal"><span class="caps">ADD</span></tt> like&nbsp;this:</p>
<div class="highlight"><pre><span></span><span class="k">return</span><span class="w"> </span><span class="p">{...</span><span class="nx">state</span><span class="p">,</span><span class="w"> </span><span class="p">...{</span><span class="s1">&#39;counter&#39;</span><span class="o">:</span><span class="w"> </span><span class="nx">state</span><span class="p">.</span><span class="nx">counter</span><span class="o">+</span><span class="mf">1</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="p">}</span>
</pre></div>
<p>The order is similar to Object.assign, i.e the attributes that follow will override the previous&nbsp;ones.</p>
<p>One final comment is that both <tt class="docutils literal">Object.assign</tt> and copying objects with the spread syntax will do a &#8220;shallow&#8221;
copy i.e it will copy only the outer object, not the objects its keys refer to. An example of this behavior is that
if you run the&nbsp;following:</p>
<div class="highlight"><pre><span></span><span class="kd">let</span><span class="w"> </span><span class="nx">a</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="s1">&#39;val&#39;</span><span class="o">:</span><span class="w"> </span><span class="mf">3</span><span class="w"> </span><span class="p">}</span>
<span class="kd">let</span><span class="w"> </span><span class="nx">x</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="nx">a</span><span class="w"> </span><span class="p">}</span>
<span class="kd">let</span><span class="w"> </span><span class="nx">y</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{...</span><span class="nx">x</span><span class="p">}</span>
<span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">x</span><span class="p">,</span><span class="w"> </span><span class="nx">y</span><span class="p">)</span>
<span class="nx">x</span><span class="p">[</span><span class="s1">&#39;val2&#39;</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">4</span>
<span class="nx">y</span><span class="p">[</span><span class="s1">&#39;val2&#39;</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">5</span>
<span class="nx">a</span><span class="p">[</span><span class="s1">&#39;val&#39;</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">33</span>
<span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">x</span><span class="p">,</span><span class="w"> </span><span class="nx">y</span><span class="p">)</span>
</pre></div>
<p>you&#8217;ll&nbsp;get:</p>
<div class="highlight"><pre><span></span><span class="p">{</span><span class="w"> </span><span class="nx">a</span><span class="o">:</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">val</span><span class="o">:</span><span class="w"> </span><span class="mf">3</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">a</span><span class="o">:</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">val</span><span class="o">:</span><span class="w"> </span><span class="mf">3</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="p">}</span>
<span class="p">{</span><span class="w"> </span><span class="nx">a</span><span class="o">:</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">val</span><span class="o">:</span><span class="w"> </span><span class="mf">33</span><span class="w"> </span><span class="p">},</span><span class="w"> </span><span class="nx">val2</span><span class="o">:</span><span class="w"> </span><span class="mf">4</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">a</span><span class="o">:</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">val</span><span class="o">:</span><span class="w"> </span><span class="mf">33</span><span class="w"> </span><span class="p">},</span><span class="w"> </span><span class="nx">val2</span><span class="o">:</span><span class="w"> </span><span class="mf">5</span><span class="w"> </span><span class="p">}</span>
</pre></div>
<p>i.e <tt class="docutils literal">x</tt> and <tt class="docutils literal">y</tt> got a different <tt class="docutils literal">val2</tt> attribute since they not the same object, however both <tt class="docutils literal">x</tt> and <tt class="docutils literal">y</tt>
have a reference to the <em>same</em> <tt class="docutils literal">a</tt> thus when it&#8217;s <tt class="docutils literal">val</tt> attribute was changed this change appears to both <tt class="docutils literal">x</tt> and <tt class="docutils literal">y</tt>!</p>
<p>What the above means is that if you have a state object containing
other objects (or arrays) you will also need to copy these children
objects to keep your state immutable. We&#8217;ll see examples on this&nbsp;later.</p>
</div>
<div class="section" id="immutable-arrays">
<h2>Immutable&nbsp;arrays</h2>
<p>One thing we haven&#8217;t talked about yet is what happens if there&#8217;s an array in the state, for example your state is
<tt class="docutils literal">let <span class="pre">state=[]</span></tt> and you have and <tt class="docutils literal"><span class="caps">APPEND</span></tt> reducer that puts something in the end of that array. The naive (and wrong)
way to do it is to call <tt class="docutils literal">push</tt> directly to the state - this will mutate your state and is not be&nbsp;allowed!</p>
<p>You need to copy the array elements and the tool for this job is <a class="reference external" href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Array/slice">Array.slice</a>. This methods takes two optional arguments (<tt class="docutils literal">begin</tt>
and <tt class="docutils literal">end</tt>) that define the range of elements that will be copied; if you call it without arguments then it will copy
the whole array. Using slice, your <tt class="docutils literal"><span class="caps">APPEND</span></tt> reducer can be like&nbsp;this:</p>
<div class="highlight"><pre><span></span><span class="kd">let</span><span class="w"> </span><span class="nx">newState</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">state</span><span class="p">.</span><span class="nx">slice</span><span class="p">()</span>
<span class="nx">newState</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="s1">&#39;new element&#39;</span><span class="p">)</span>
<span class="k">return</span><span class="w"> </span><span class="nx">newState</span>
</pre></div>
<p>Also, you could use the <cite>Array.concat</cite> method which will return a new array by copying all the elements of its&nbsp;arguments</p>
<div class="highlight"><pre><span></span><span class="k">return</span><span class="w"> </span><span class="nx">state</span><span class="p">.</span><span class="nx">concat</span><span class="p">([</span><span class="s1">&#39;new element&#39;</span><span class="p">])</span>
</pre></div>
<p>This will append <tt class="docutils literal">new element</tt> to a new object that will have the elements of state (it won&#8217;t modify the
existing state) and is easier if you have this exact requirement. The advantage of slice is that you can
use it to add/remove/modify elements from any place in the original array. For example, here&#8217;s how you can
add an element after the first element of an&nbsp;array:</p>
<div class="highlight"><pre><span></span><span class="kd">let</span><span class="w"> </span><span class="nx">x</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">[</span><span class="s1">&#39;a&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;b&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;c&#39;</span><span class="w"> </span><span class="p">]</span>
<span class="kd">let</span><span class="w"> </span><span class="nx">y</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">x</span><span class="p">.</span><span class="nx">slice</span><span class="p">(</span><span class="mf">0</span><span class="p">,</span><span class="mf">1</span><span class="p">).</span><span class="nx">concat</span><span class="p">([</span><span class="s1">&#39;second&#39;</span><span class="w"> </span><span class="p">],</span><span class="w"> </span><span class="nx">x</span><span class="p">.</span><span class="nx">slice</span><span class="p">(</span><span class="mf">1</span><span class="p">,</span><span class="mf">3</span><span class="p">))</span>
</pre></div>
<p>Now <tt class="docutils literal">y</tt> will be equal to <tt class="docutils literal">[ 'a', 'second', 'b', 'c' ]</tt>. So the above will get the first (0-th) element from the <tt class="docutils literal">x</tt>
array and concat it with another element (<tt class="docutils literal">second</tt>) and the remaining elements of <tt class="docutils literal">x</tt>. Remember that <tt class="docutils literal">x</tt> is not
modifyied since <tt class="docutils literal">concat</tt> will create a new&nbsp;array.</p>
<p>In a similar fashion to objects, instead of using concat it is much easier to use the spread syntax. The spread syntax for
an array will output its elements one after the other for them to be used by other arrays. Thus, continuing from the
previous example, <tt class="docutils literal"><span class="pre">[...x]</span></tt> will return a new array with the elements of <tt class="docutils literal">x</tt> (so it is similar to <tt class="docutils literal">x.slice()</tt> or <tt class="docutils literal">x.concat()</tt>),
thus to re-generate the previous example you&#8217;ll do something&nbsp;like</p>
<div class="highlight"><pre><span></span><span class="kd">let</span><span class="w"> </span><span class="nx">y</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">y</span><span class="o">=</span><span class="p">[...</span><span class="nx">x</span><span class="p">.</span><span class="nx">slice</span><span class="p">(</span><span class="mf">0</span><span class="p">,</span><span class="mf">1</span><span class="p">),</span><span class="w"> </span><span class="s1">&#39;second&#39;</span><span class="p">,</span><span class="w"> </span><span class="p">...</span><span class="nx">x</span><span class="p">.</span><span class="nx">slice</span><span class="p">(</span><span class="mf">1</span><span class="p">,</span><span class="mf">3</span><span class="p">)]</span>
</pre></div>
<p>All three of concat, slice or the spread syntax will do a shallow copy (similar to how Object.assign works) so the same
conclusions from the previous section are true here: If you have arrays inside other arrays (or objects) you&#8217;ll need to copy the inner
arrays&nbsp;recursively.</p>
</div>
<div class="section" id="more-complex-cases">
<h2>More complex&nbsp;cases</h2>
<p>We&#8217;ll now take a look at some more complex cases and see how quickly it gets difficult because of the shallow copying.
Let&#8217;s suppose that our state is the&nbsp;following:</p>
<div class="highlight"><pre><span></span><span class="kd">const</span><span class="w"> </span><span class="nx">state</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="s1">&#39;user&#39;</span><span class="o">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="s1">&#39;first_name&#39;</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;John&#39;</span><span class="p">,</span>
<span class="w">    </span><span class="s1">&#39;last_name&#39;</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;Doe&#39;</span><span class="p">,</span>
<span class="w">    </span><span class="s1">&#39;address&#39;</span><span class="o">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="s1">&#39;city&#39;</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;Athens&#39;</span><span class="p">,</span>
<span class="w">      </span><span class="s1">&#39;country&#39;</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;Greece&#39;</span><span class="p">,</span>
<span class="w">      </span><span class="s1">&#39;zip&#39;</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;12345&#39;</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">  </span><span class="p">}</span>
<span class="p">}</span>
</pre></div>
<p>and we want to assign a <tt class="docutils literal">group</tt> attribute to the state. This can be easily done with <tt class="docutils literal">assign</tt>:</p>
<div class="highlight"><pre><span></span><span class="kd">let</span><span class="w"> </span><span class="nx">groups</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">[{</span>
<span class="w">    </span><span class="s1">&#39;name&#39;</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;group1&#39;</span>
<span class="p">}]</span>

<span class="nx">state</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">Object</span><span class="p">.</span><span class="nx">assign</span><span class="p">({},</span><span class="w"> </span><span class="nx">state</span><span class="p">,</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="s1">&#39;groups&#39;</span><span class="o">:</span><span class="w"> </span><span class="nx">groups</span>
<span class="p">})</span>
</pre></div>
<p>or&nbsp;spread:</p>
<div class="highlight"><pre><span></span><span class="nx">state</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="p">...</span><span class="nx">state</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;groups&#39;</span><span class="o">:</span><span class="w"> </span><span class="nx">groups</span>
<span class="p">}</span>
</pre></div>
<p>Notice that instead of <tt class="docutils literal">'groups': groups</tt> I could have used the <a class="reference external" href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Operators/Object_initializer#Syntax">shorthand syntax</a> and written only <tt class="docutils literal">groups</tt> and it would still work
(i.e <tt class="docutils literal">state = <span class="pre">{...state,</span> groups}</tt> is the same). In all cases, the resulting state will&nbsp;be:</p>
<div class="highlight"><pre><span></span><span class="p">{</span>
<span class="w">  </span><span class="s1">&#39;user&#39;</span><span class="o">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="s1">&#39;first_name&#39;</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;John&#39;</span><span class="p">,</span>
<span class="w">    </span><span class="s1">&#39;last_name&#39;</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;Doe&#39;</span><span class="p">,</span>
<span class="w">    </span><span class="s1">&#39;address&#39;</span><span class="o">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="s1">&#39;city&#39;</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;Athens&#39;</span><span class="p">,</span>
<span class="w">      </span><span class="s1">&#39;country&#39;</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;Greece&#39;</span><span class="p">,</span>
<span class="w">      </span><span class="s1">&#39;zip&#39;</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;12345&#39;</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">  </span><span class="p">},</span>
<span class="w">  </span><span class="s1">&#39;groups&#39;</span><span class="o">:</span><span class="w"> </span><span class="p">[{</span>
<span class="w">    </span><span class="s1">&#39;name&#39;</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;group1&#39;</span>
<span class="w">  </span><span class="p">}]</span>
<span class="p">}</span>
</pre></div>
<p>From now on I&#8217;ll only use the spread syntax which is more&nbsp;compact.</p>
<p>Let&#8217;s try to change the user&#8217;s name. This is not as easy as the first example because we need&nbsp;to:</p>
<ul class="simple">
<li>Create a new copy of the <tt class="docutils literal">user</tt> object with the new first&nbsp;name</li>
<li>Create a new copy of the <tt class="docutils literal">state</tt> object with the new user object created&nbsp;above</li>
</ul>
<p>This can be done in two steps like&nbsp;this:</p>
<div class="highlight"><pre><span></span><span class="kd">let</span><span class="w"> </span><span class="nx">user</span><span class="w"> </span><span class="o">=</span><span class="p">{...</span><span class="nx">state</span><span class="p">[</span><span class="s1">&#39;user&#39;</span><span class="p">],</span><span class="w"> </span><span class="s1">&#39;first_name&#39;</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;Jack&#39;</span><span class="p">}</span>
<span class="nx">state</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{...</span><span class="nx">state</span><span class="p">,</span><span class="w"> </span><span class="nx">user</span><span class="p">}</span>
</pre></div>
<p>or in one step like&nbsp;this:</p>
<div class="highlight"><pre><span></span><span class="nx">state</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{...</span><span class="nx">state</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;user&#39;</span><span class="o">:</span><span class="p">{</span>
<span class="w">  </span><span class="p">...</span><span class="nx">state</span><span class="p">[</span><span class="s1">&#39;user&#39;</span><span class="p">],</span><span class="w"> </span><span class="s1">&#39;first_name&#39;</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;Jack&#39;</span><span class="p">}</span>
<span class="p">}</span>
</pre></div>
<p>The single step assignment is the combination of the two step described above. It is a little more complex
but it saves typing and is prefered because it allows the reducer function to have a single expression. Now
let&#8217;s try to modify the user&#8217;s zip code. We&#8217;ll do it in three steps&nbsp;first:</p>
<div class="highlight"><pre><span></span><span class="kd">let</span><span class="w"> </span><span class="nx">address</span><span class="w"> </span><span class="o">=</span><span class="p">{...</span><span class="nx">state</span><span class="p">[</span><span class="s1">&#39;user&#39;</span><span class="p">][</span><span class="s1">&#39;address&#39;</span><span class="p">],</span><span class="w"> </span><span class="s1">&#39;zip&#39;</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;54321&#39;</span><span class="p">}</span>
<span class="nx">user</span><span class="w"> </span><span class="o">=</span><span class="p">{...</span><span class="nx">state</span><span class="p">[</span><span class="s1">&#39;user&#39;</span><span class="p">],</span><span class="w"> </span><span class="nx">address</span><span class="p">}</span>
<span class="nx">state</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{...</span><span class="nx">state</span><span class="p">,</span><span class="w"> </span><span class="nx">user</span><span class="p">}</span>
</pre></div>
<p>And now in&nbsp;one:</p>
<div class="highlight"><pre><span></span><span class="nx">state</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{...</span><span class="nx">state</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;user&#39;</span><span class="o">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="p">...</span><span class="nx">state</span><span class="p">[</span><span class="s1">&#39;user&#39;</span><span class="p">],</span><span class="w"> </span><span class="s1">&#39;address&#39;</span><span class="o">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="p">...</span><span class="nx">state</span><span class="p">[</span><span class="s1">&#39;user&#39;</span><span class="p">][</span><span class="s1">&#39;address&#39;</span><span class="p">],</span><span class="w"> </span><span class="s1">&#39;zip&#39;</span><span class="o">:</span><span class="w"> </span><span class="mf">54321</span>
<span class="w">  </span><span class="p">}</span>
<span class="p">}}</span>
</pre></div>
<p>Now, as can be seen in the above examples, modifying (without mutating) a compex state object
is not very easy - it needs much thinking and is too error prone! This will be even more
apparent when we also get the array modifications into the equation, for example by adding another
two&nbsp;groups:</p>
<div class="highlight"><pre><span></span><span class="nx">state</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="p">...</span><span class="nx">state</span><span class="p">,</span><span class="w"> </span><span class="nx">groups</span><span class="o">:</span><span class="w"> </span><span class="p">[</span>
<span class="w">    </span><span class="p">...</span><span class="nx">state</span><span class="p">[</span><span class="s1">&#39;groups&#39;</span><span class="p">].</span><span class="nx">slice</span><span class="p">(),</span>
<span class="w">    </span><span class="p">{</span><span class="nx">name</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;group2&#39;</span><span class="p">,</span><span class="w"> </span><span class="nx">id</span><span class="o">:</span><span class="w"> </span><span class="mf">2</span><span class="p">},</span>
<span class="w">    </span><span class="p">{</span><span class="nx">name</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;group3&#39;</span><span class="p">,</span><span class="w"> </span><span class="nx">id</span><span class="o">:</span><span class="w"> </span><span class="mf">3</span><span class="p">}</span>
<span class="w">  </span><span class="p">]</span>
<span class="p">}</span>
</pre></div>
<p>The above copies the existing state and assigns to it a new <tt class="docutils literal">groups</tt> object by copying
the existing groups and appending two more groups to that array! The state now will&nbsp;be:</p>
<div class="highlight"><pre><span></span><span class="p">{</span>
<span class="w">  </span><span class="nx">user</span><span class="o">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nx">first_name</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;Jack&#39;</span><span class="p">,</span>
<span class="w">    </span><span class="nx">last_name</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;Doe&#39;</span><span class="p">,</span>
<span class="w">    </span><span class="nx">address</span><span class="o">:</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">city</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;Athens&#39;</span><span class="p">,</span><span class="w"> </span><span class="nx">country</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;Greece&#39;</span><span class="p">,</span><span class="w"> </span><span class="nx">zip</span><span class="o">:</span><span class="w"> </span><span class="mf">54321</span><span class="w"> </span><span class="p">}</span>
<span class="w">  </span><span class="p">},</span>
<span class="w">  </span><span class="nx">groups</span><span class="o">:</span><span class="w"> </span><span class="p">[</span>
<span class="w">    </span><span class="p">{</span><span class="w"> </span><span class="nx">name</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;group1&#39;</span><span class="w"> </span><span class="p">},</span>
<span class="w">    </span><span class="p">{</span><span class="w"> </span><span class="nx">name</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;group2&#39;</span><span class="p">,</span><span class="w"> </span><span class="nx">id</span><span class="o">:</span><span class="w"> </span><span class="mf">2</span><span class="w"> </span><span class="p">},</span>
<span class="w">    </span><span class="p">{</span><span class="w"> </span><span class="nx">name</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;group3&#39;</span><span class="p">,</span><span class="w"> </span><span class="nx">id</span><span class="o">:</span><span class="w"> </span><span class="mf">3</span><span class="w"> </span><span class="p">}</span>
<span class="w">  </span><span class="p">]</span>
<span class="p">}</span>
</pre></div>
<p>As a final examply, how can we add the missing <tt class="docutils literal">id</tt> attribute to the first group?
Following the above&nbsp;techniques:</p>
<div class="highlight"><pre><span></span><span class="nx">state</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="p">...</span><span class="nx">state</span><span class="p">,</span><span class="w"> </span><span class="nx">groups</span><span class="o">:</span><span class="w"> </span><span class="p">[</span>
<span class="w">    </span><span class="p">{...</span><span class="nx">state</span><span class="p">[</span><span class="s1">&#39;groups&#39;</span><span class="p">][</span><span class="mf">0</span><span class="p">],</span><span class="w"> </span><span class="s1">&#39;id&#39;</span><span class="o">:</span><span class="w"> </span><span class="mf">1</span><span class="p">},</span>
<span class="w">    </span><span class="p">...</span><span class="nx">state</span><span class="p">[</span><span class="s1">&#39;groups&#39;</span><span class="p">].</span><span class="nx">slice</span><span class="p">(</span><span class="mf">1</span><span class="p">)</span>
<span class="w">  </span><span class="p">]</span>
<span class="p">}</span>
</pre></div>
<p>One more time what the above&nbsp;does?</p>
<ul class="simple">
<li>Creates a new object and copies all existing properties of state to&nbsp;it</li>
<li>Creates a new array which assigns it to the new state&#8217;s <tt class="docutils literal">groups</tt> attribute</li>
<li>For the first element of that array it copies all attributes of the first element of state[&#8216;groups&#8217;] and assings it an <tt class="docutils literal">id=1</tt> attribute</li>
<li>For the remaining elements of that array it copies all elements of state[&#8216;groups] after the first&nbsp;one</li>
</ul>
<p>Now think what would happen if we had an even more complex state with 3 or 4 nested&nbsp;levels!</p>
</div>
<div class="section" id="immutability-s-little-helpers">
<h2>Immutability&#8217;s little&nbsp;helpers</h2>
<p>As you&#8217;ve seen from the previous examples, using immutable objects is not as easy as seems from
the toy examples. Actually, drilling down into complex immutable
objects and returning new ones that have
some values changed  is a well-known problem in the functional world and has already a solution
called &#8220;lenses&#8221;. This is a funny name but it more or less means that you use a magnifying lens to look at
exactly the value you want and modify or retrieve it. The problem with lenses is that although they solve
the problem I mention is that if you want to use them you&#8217;ll need to dive deep into functional
programming and also you&#8217;ll need to include an extra library to your project (even if you only
want this specific&nbsp;capability).</p>
<p>For completeness, here&#8217;s the <a class="reference external" href="http://ramdajs.com/docs/#lens">the docs on lens</a> from <a class="reference external" href="http://ramdajs.com">Ramda</a> which is a well known Javascript functional library.
This needs you to understand what is <tt class="docutils literal">prop</tt>, what is <tt class="docutils literal">assoc</tt> and then how to use the lens with <tt class="docutils literal">view</tt>,
<tt class="docutils literal">set</tt> and <tt class="docutils literal">over</tt>. For me, these are way too much things to remember for such a specific thing. Also, notice
that the minified version of Ramda is around 45 kb which is not small. Yes, if I wanted
to fully use Ramda or a similar library I&#8217;d be delighted to use all these techniques and include it as a
dependency - however most people prefer to stick with more familiar (and more procedural)&nbsp;concepts.</p>
<p>The helpers I&#8217;m going to present here are more or less a poor man&#8217;s lens, i.e you will be able to use the basic
functionality of a lens&nbsp;but&#8230;</p>
<ul class="simple">
<li>without the peculiar syntax&nbsp;and</li>
<li>without the need to learn more functional concepts than what you&#8217;ll want&nbsp;and</li>
<li>without the need to include any more external&nbsp;dependencies</li>
</ul>
<p>Pretty good deal,&nbsp;no?</p>
<p>In any case, a lens has two parts, a get and a set. The get will be used to drill down and retrieve a value from a
complex object while the set will be used to drill down and assign a value to a complex object. The set does not
modify the object but returns a new one. The get lens is not really needed since you can easily drill down to an
object using the good old index syntax but I&#8217;ll include it here for&nbsp;completenes.</p>
<p>We&#8217;ll start with the get which seems easier. For this, I&#8217;ll just create a function that will take an object and
a path inside that object as parameter and retrieve the value at that path. The path could be either a string of the form
&#8216;a.0.c.d&#8217; or an array [&#8216;a&#8217;, &#8216;0&#8217;, &#8216;c&#8217;, &#8216;d&#8217;] - for numerical indeces we&#8217;ll consider an array at that&nbsp;point.</p>
<p>Thus, for the object <tt class="docutils literal">{'a': <span class="pre">[{'b':</span> {'c': {'d': 32} <span class="pre">}}]}</span></tt> when the lens getter is called with either
<tt class="docutils literal">'a.0.b.c'</tt> or [&#8216;a&#8217;, 0, &#8216;b&#8217;, &#8216;c&#8217;] as the path, it should return <tt class="docutils literal">{'d': 32}</tt>.</p>
<p>To implement the get helper I will use a functional concept, <tt class="docutils literal">reduce</tt>. I&#8217;ve already explained this concept
in my <a class="reference external" href="https://spapas.github.io/2016/03/02/react-redux-tutorial/#interlude-so-what-s-a-reducer">previous react-redux tutorial</a> so I urge you to read that article for more info. Using reduce we
can apply one by one accumulatively the members of the path to the initial object and the result will be
the value of that path. Here&#8217;s the implementation of <tt class="docutils literal">pget</tt> (from property&nbsp;get):</p>
<div class="highlight"><pre><span></span><span class="kd">const</span><span class="w"> </span><span class="nx">objgetter</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="nx">accumulator</span><span class="p">,</span><span class="w"> </span><span class="nx">currentValue</span><span class="p">)</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="nx">accumulator</span><span class="p">[</span><span class="nx">currentValue</span><span class="p">];</span>
<span class="kd">const</span><span class="w"> </span><span class="nx">pget</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="nx">obj</span><span class="p">,</span><span class="w"> </span><span class="nx">path</span><span class="p">)</span><span class="w"> </span><span class="p">=&gt;</span><span class="w">  </span><span class="p">(</span>
<span class="w">    </span><span class="p">(</span><span class="ow">typeof</span><span class="w"> </span><span class="nx">path</span><span class="w"> </span><span class="o">===</span><span class="w"> </span><span class="s1">&#39;string&#39;</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="nx">path</span><span class="w"> </span><span class="ow">instanceof</span><span class="w"> </span><span class="nb">String</span><span class="p">)</span><span class="o">?</span><span class="nx">path</span><span class="p">.</span><span class="nx">split</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">)</span><span class="o">:</span><span class="nx">path</span>
<span class="p">).</span><span class="nx">reduce</span><span class="p">(</span><span class="nx">objgetter</span><span class="p">,</span><span class="w"> </span><span class="nx">obj</span><span class="p">)</span>
</pre></div>
<p>I have defined an objgetter reducer function that gets an accumulated object and the current
value of the path and just returns the <tt class="docutils literal">currentValue</tt> index of that accumulated object. Finally,
for the get lens (named <tt class="docutils literal">pget</tt>) I just check to see if the path is a string or an array (if it&#8217;s
a string I split it on dots) and then I &#8220;reduce&#8221; the path using the objgetter defined above and
starting by the original object as the initial value. To understand how it is working, let&#8217;s try calling it
for an&nbsp;object:</p>
<div class="highlight"><pre><span></span><span class="kd">const</span><span class="w"> </span><span class="nx">s1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="s1">&#39;a&#39;</span><span class="o">:</span><span class="w"> </span><span class="p">[{</span><span class="s1">&#39;b&#39;</span><span class="o">:</span><span class="w"> </span><span class="p">{</span><span class="s1">&#39;c&#39;</span><span class="o">:</span><span class="w"> </span><span class="p">{</span><span class="s1">&#39;d&#39;</span><span class="o">:</span><span class="w"> </span><span class="mf">32</span><span class="p">}</span><span class="w"> </span><span class="p">}}]}</span>
<span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">pget</span><span class="p">(</span><span class="nx">s1</span><span class="p">,</span><span class="w"> </span><span class="p">[</span><span class="s1">&#39;a&#39;</span><span class="p">,</span><span class="w"> </span><span class="mf">0</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;b&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;c&#39;</span><span class="p">]))</span>
</pre></div>
<p>The above <tt class="docutils literal">pget</tt> will call <tt class="docutils literal">reduce</tt> on the passed array using the defined <tt class="docutils literal">objgetter</tt> above
as the reducer function and <tt class="docutils literal">s1</tt> as the original object. So, the reducer function will be called with
the following values each&nbsp;time:</p>
<table border="1" class="docutils">
<colgroup>
<col width="68%" />
<col width="32%" />
</colgroup>
<thead valign="bottom">
<tr><th class="head">accumulator</th>
<th class="head">currentvalue</th>
</tr>
</thead>
<tbody valign="top">
<tr><td><tt class="docutils literal">s1</tt></td>
<td><tt class="docutils literal">'a'</tt></td>
</tr>
<tr><td><tt class="docutils literal"><span class="pre">s1['a']</span></tt></td>
<td><tt class="docutils literal">0</tt></td>
</tr>
<tr><td><tt class="docutils literal"><span class="pre">s1['a'][0]</span></tt></td>
<td><tt class="docutils literal">'b'</tt></td>
</tr>
<tr><td><tt class="docutils literal"><span class="pre">s1['a'][0]['b']</span></tt></td>
<td><tt class="docutils literal">'c'</tt></td>
</tr>
<tr><td><tt class="docutils literal"><span class="pre">s1['a'][0]['b']['c']</span></tt></td>
<td>&nbsp;</td>
</tr>
</tbody>
</table>
<p>Thus the result will be exactly what we wanted <tt class="docutils literal">{'d' :32}</tt>. An interesting thing is that it&#8217;s working
fine without the need to differentiate between arrays and objects because of how index access <tt class="docutils literal">[]</tt> works.</p>
<p>Continuing for the set lens (which will be more difficult), I&#8217;ll first represent a simple version that
works only with objects and an array path but displays the main idea of how this will work: It uses recursion i.e it will call itself to gradually build the new object. Here&#8217;s how it is&nbsp;implemented:</p>
<div class="highlight"><pre><span></span><span class="kd">const</span><span class="w"> </span><span class="nx">pset0</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="nx">obj</span><span class="p">,</span><span class="w"> </span><span class="nx">path</span><span class="p">,</span><span class="w"> </span><span class="nx">val</span><span class="p">)</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="kd">let</span><span class="w"> </span><span class="nx">idx</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">path</span><span class="p">[</span><span class="mf">0</span><span class="p">]</span>

<span class="w">  </span><span class="k">if</span><span class="p">(</span><span class="nx">path</span><span class="p">.</span><span class="nx">length</span><span class="o">==</span><span class="mf">1</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="p">...</span><span class="nx">obj</span><span class="p">,</span><span class="w"> </span><span class="p">[</span><span class="nx">idx</span><span class="p">]</span><span class="o">:</span><span class="w"> </span><span class="nx">val</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">  </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="nx">remaining</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">path</span><span class="p">.</span><span class="nx">slice</span><span class="p">(</span><span class="mf">1</span><span class="p">)</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="p">...</span><span class="nx">obj</span><span class="p">,</span>
<span class="w">      </span><span class="p">[</span><span class="nx">idx</span><span class="p">]</span><span class="o">:</span><span class="w"> </span><span class="nx">pset0</span><span class="p">(...[</span><span class="nx">obj</span><span class="p">[</span><span class="nx">idx</span><span class="p">]],</span><span class="w"> </span><span class="nx">remaining</span><span class="p">,</span><span class="w"> </span><span class="nx">val</span><span class="p">)</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">  </span><span class="p">}</span>
<span class="p">}</span>
</pre></div>
<p>As already explained, I have assumed that the path is an array of indeces and that the <tt class="docutils literal">obj</tt> is a complex object
(no arrays in it please); the function returns a new object with the old object&#8217;s value at the path be replaced
with <tt class="docutils literal">val</tt>. This function checks to see if the path has only one element, if yes it will assign the value to that
attribute of the object it retrieve. If not, it will call itself recursively by skipping the current index and assign the return value to the
current index of the curent object. Let&#8217;s see how it works for the following&nbsp;call:</p>
<div class="highlight"><pre><span></span><span class="kd">const</span><span class="w"> </span><span class="nx">s2</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="nx">a0</span><span class="o">:</span><span class="w"> </span><span class="mf">0</span><span class="p">,</span><span class="w"> </span><span class="nx">a</span><span class="o">:</span><span class="w"> </span><span class="p">{</span><span class="nx">b0</span><span class="o">:</span><span class="w"> </span><span class="mf">0</span><span class="p">,</span><span class="w"> </span><span class="nx">b</span><span class="o">:</span><span class="w"> </span><span class="p">{</span><span class="nx">c0</span><span class="o">:</span><span class="w"> </span><span class="mf">0</span><span class="p">,</span><span class="w"> </span><span class="nx">c</span><span class="o">:</span><span class="w"> </span><span class="mf">3</span><span class="p">}}}</span>
<span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">pset0</span><span class="p">(</span><span class="nx">s2</span><span class="p">,</span><span class="w"> </span><span class="p">[</span><span class="s1">&#39;a&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;b&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;c&#39;</span><span class="p">],</span><span class="w"> </span><span class="mf">4</span><span class="p">))</span>
</pre></div>
<table border="1" class="docutils">
<colgroup>
<col width="7%" />
<col width="34%" />
<col width="59%" />
</colgroup>
<thead valign="bottom">
<tr><th class="head"># Call</th>
<th class="head">Call parameters</th>
<th class="head">Return</th>
</tr>
</thead>
<tbody valign="top">
<tr><td>1</td>
<td>pset0(s2, [&#8216;a&#8217;, &#8216;b&#8217;, &#8216;c&#8217;], 4)</td>
<td>{&#8230;s2, [&#8216;b&#8217;]: pset0(s2[&#8216;a&#8217;], [&#8216;b&#8217;, &#8216;c&#8217;], 4) }</td>
</tr>
<tr><td>2</td>
<td>pset0(s2[&#8216;a&#8217;], [&#8216;b&#8217;, &#8216;c&#8217;], 4)</td>
<td>{&#8230;s2[&#8216;a&#8217;], [&#8216;c&#8217;]: pset0(s2[&#8216;a&#8217;][&#8216;b&#8217;], [&#8216;c&#8217;], 4) }</td>
</tr>
<tr><td>3</td>
<td>pset0(s2[&#8216;a&#8217;][&#8216;b&#8217;], [&#8216;c&#8217;], 4)</td>
<td>{&#8230;s2[&#8216;a&#8217;][&#8216;b&#8217;], [&#8216;c&#8217;]: 4}</td>
</tr>
</tbody>
</table>
<p>Thus, the first time it will be called it will return a new object with the attributes of <tt class="docutils literal">s2</tt>
but overriding its <tt class="docutils literal">'b'</tt> index with the return of the second call. The second call will return
a new object with the attributes of <tt class="docutils literal"><span class="pre">s2['a']</span></tt> but override it&#8217;s <tt class="docutils literal">'c'</tt> index with the return
of the third call. Finally, the 3rd call will return an object with the attributes of <tt class="docutils literal"><span class="pre">s2['a']['b']</span></tt>
and setting the <tt class="docutils literal">'c'</tt> index to <tt class="docutils literal">4</tt>. The result will be as expected equal&nbsp;to:</p>
<div class="highlight"><pre><span></span><span class="p">{</span><span class="nx">a0</span><span class="o">:</span><span class="w"> </span><span class="mf">0</span><span class="p">,</span><span class="w"> </span><span class="nx">a</span><span class="o">:</span><span class="w"> </span><span class="p">{</span><span class="nx">b0</span><span class="o">:</span><span class="w"> </span><span class="mf">0</span><span class="p">,</span><span class="w"> </span><span class="nx">b</span><span class="o">:</span><span class="w"> </span><span class="p">{</span><span class="nx">c0</span><span class="o">:</span><span class="w"> </span><span class="mf">0</span><span class="p">,</span><span class="w"> </span><span class="nx">c</span><span class="o">:</span><span class="w"> </span><span class="mf">4</span><span class="w"> </span><span class="p">}}}</span>
</pre></div>
<p>Now that we&#8217;ve understood the logic we can extend the above function with the following&nbsp;extras:</p>
<ul class="simple">
<li>support for arrays in the object using numerical&nbsp;indeces</li>
<li>support for array (<tt class="docutils literal">['a', 'b']</tt>) or string path (<tt class="docutils literal">'a.b'</tt>)&nbsp;parameter</li>
<li>support for a direct value to set on the path or a function that will be applied on that&nbsp;value</li>
</ul>
<p>Here&#8217;s the resulting set&nbsp;lens:</p>
<div class="highlight"><pre><span></span><span class="kd">const</span><span class="w"> </span><span class="nx">pset</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="nx">obj</span><span class="p">,</span><span class="w"> </span><span class="nx">path</span><span class="p">,</span><span class="w"> </span><span class="nx">val</span><span class="p">)</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="kd">let</span><span class="w"> </span><span class="nx">parts</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="ow">typeof</span><span class="w"> </span><span class="nx">path</span><span class="w"> </span><span class="o">===</span><span class="w"> </span><span class="s1">&#39;string&#39;</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="nx">path</span><span class="w"> </span><span class="ow">instanceof</span><span class="w"> </span><span class="nb">String</span><span class="p">)</span><span class="o">?</span><span class="nx">path</span><span class="p">.</span><span class="nx">split</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">)</span><span class="o">:</span><span class="nx">path</span>
<span class="w">  </span><span class="kd">const</span><span class="w"> </span><span class="nx">cset</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="nx">obj</span><span class="p">,</span><span class="w"> </span><span class="nx">cidx</span><span class="p">,</span><span class="w"> </span><span class="nx">val</span><span class="p">)</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="nx">newval</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">val</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="ow">typeof</span><span class="w"> </span><span class="nx">val</span><span class="w"> </span><span class="o">===</span><span class="w"> </span><span class="s2">&quot;function&quot;</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="nx">newval</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">val</span><span class="p">(</span><span class="nx">obj</span><span class="p">[</span><span class="nx">cidx</span><span class="p">])</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">    </span><span class="k">if</span><span class="p">(</span><span class="nb">Array</span><span class="p">.</span><span class="nx">isArray</span><span class="p">(</span><span class="nx">obj</span><span class="p">))</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="k">return</span><span class="w"> </span><span class="p">[</span>
<span class="w">        </span><span class="p">...</span><span class="nx">obj</span><span class="p">.</span><span class="nx">slice</span><span class="p">(</span><span class="mf">0</span><span class="p">,</span><span class="w"> </span><span class="nx">cidx</span><span class="o">*</span><span class="mf">1</span><span class="p">),</span>
<span class="w">        </span><span class="nx">newval</span><span class="p">,</span>
<span class="w">        </span><span class="p">...</span><span class="nx">obj</span><span class="p">.</span><span class="nx">slice</span><span class="p">(</span><span class="nx">cidx</span><span class="o">*</span><span class="mf">1</span><span class="o">+</span><span class="mf">1</span><span class="p">)</span>
<span class="w">        </span><span class="p">]</span>
<span class="w">    </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="k">return</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="p">...</span><span class="nx">obj</span><span class="p">,</span><span class="w"> </span><span class="p">[</span><span class="nx">cidx</span><span class="p">]</span><span class="o">:</span><span class="w"> </span><span class="nx">newval</span>
<span class="w">      </span><span class="p">}</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">  </span><span class="p">}</span>

<span class="w">  </span><span class="kd">let</span><span class="w"> </span><span class="nx">pidx</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">parts</span><span class="p">[</span><span class="mf">0</span><span class="p">]</span>
<span class="w">  </span><span class="k">if</span><span class="p">(</span><span class="nx">parts</span><span class="p">.</span><span class="nx">length</span><span class="o">==</span><span class="mf">1</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="nx">cset</span><span class="p">(</span><span class="nx">obj</span><span class="p">,</span><span class="w"> </span><span class="nx">pidx</span><span class="p">,</span><span class="w"> </span><span class="nx">val</span><span class="p">)</span>
<span class="w">  </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="nx">remaining</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">parts</span><span class="p">.</span><span class="nx">slice</span><span class="p">(</span><span class="mf">1</span><span class="p">)</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="nx">cset</span><span class="p">(</span><span class="nx">obj</span><span class="p">,</span><span class="w"> </span><span class="nx">pidx</span><span class="p">,</span><span class="w"> </span><span class="nx">pset</span><span class="p">(</span><span class="nx">obj</span><span class="p">[</span><span class="nx">pidx</span><span class="p">],</span><span class="w"> </span><span class="nx">remaining</span><span class="p">,</span><span class="w"> </span><span class="nx">val</span><span class="p">))</span>
<span class="w">  </span><span class="p">}</span>
<span class="p">}</span>
</pre></div>
<p>It may seem a little complex but I think it&#8217;s easy to be understood: The parts in the beginning
will just check to see if the path is an array or a string and split the string to its parts.
The <tt class="docutils literal">cset</tt> function that follows is a local function that is used to make the copy of the object
or array and set the new value. Here&#8217;s how it is working: It will first check to see if the <tt class="docutils literal">val</tt>
parameter is a function or a not. If it is a function it will apply this function to the object&#8217;s index
to get the <tt class="docutils literal">newvalue</tt> else it will just use <tt class="docutils literal">val</tt> as the <tt class="docutils literal">newvalue</tt>. After that it checks if the
object it got is an array or not. If it is an array it will do the slice trick we saw before to copy
the elements of the array except the <tt class="docutils literal">newval</tt> which will put it at the index (notice that the index
at that point must be numerical but that&#8217;s up to you to assert). If the current <tt class="docutils literal">obj</tt> is not an array
then it must be an object thus it uses the spread syntax to copy the object&#8217;s attributes and reassign
the current index to <tt class="docutils literal">newval</tt>.</p>
<p>The last part of <tt class="docutils literal">pset</tt> is similar to the <tt class="docutils literal">pset0</tt> it just uses <tt class="docutils literal">cset</tt> to do the new object/array
generation instead of doing it in place like <tt class="docutils literal">pset0</tt> - as already explained, <tt class="docutils literal">pset</tt> is called recursively
until only one element remains on the path in which case the <tt class="docutils literal">newval</tt> will be assigned to the current index of
the current <tt class="docutils literal">obj</tt>.</p>
<p>Let&#8217;s try to use <tt class="docutils literal">pset</tt> for the following rather complex&nbsp;state:</p>
<div class="highlight"><pre><span></span><span class="kd">let</span><span class="w"> </span><span class="nx">state2</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="s1">&#39;users&#39;</span><span class="o">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="s1">&#39;results&#39;</span><span class="o">:</span><span class="w"> </span><span class="p">[</span>
<span class="w">      </span><span class="p">{</span><span class="s1">&#39;name&#39;</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;Sera&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;groups&#39;</span><span class="o">:</span><span class="w"> </span><span class="p">[</span><span class="s1">&#39;g1&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;g2&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;g3&#39;</span><span class="p">]},</span>
<span class="w">      </span><span class="p">{</span><span class="s1">&#39;name&#39;</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;John&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;groups&#39;</span><span class="o">:</span><span class="w"> </span><span class="p">[</span><span class="s1">&#39;g1&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;g2&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;g3&#39;</span><span class="p">]},</span>
<span class="w">      </span><span class="p">{</span><span class="s1">&#39;name&#39;</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;Joe&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;groups&#39;</span><span class="o">:</span><span class="w"> </span><span class="p">[]}</span>
<span class="w">    </span><span class="p">],</span>
<span class="w">    </span><span class="s1">&#39;pagination&#39;</span><span class="o">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="s1">&#39;total&#39;</span><span class="o">:</span><span class="w"> </span><span class="mf">100</span><span class="p">,</span>
<span class="w">      </span><span class="s1">&#39;perpage&#39;</span><span class="o">:</span><span class="w"> </span><span class="mf">5</span><span class="p">,</span>
<span class="w">      </span><span class="s1">&#39;number&#39;</span><span class="o">:</span><span class="w"> </span><span class="mf">0</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">  </span><span class="p">},</span>
<span class="w">  </span><span class="s1">&#39;groups&#39;</span><span class="o">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="s1">&#39;results&#39;</span><span class="o">:</span><span class="w"> </span><span class="p">[</span>
<span class="w">    </span><span class="p">]</span>
<span class="w">    </span><span class="p">,</span>
<span class="w">    </span><span class="s1">&#39;total&#39;</span><span class="o">:</span><span class="w"> </span><span class="mf">0</span>
<span class="w">  </span><span class="p">}</span>
<span class="p">}</span>
</pre></div>
<p>Let&#8217;s call it three times one after the other to change various&nbsp;attributes:</p>
<div class="highlight"><pre><span></span><span class="kd">let</span><span class="w"> </span><span class="nx">new_state2</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">pset</span><span class="p">(</span>
<span class="w">    </span><span class="nx">pset</span><span class="p">(</span>
<span class="w">        </span><span class="nx">pset</span><span class="p">(</span>
<span class="w">            </span><span class="nx">pset</span><span class="p">(</span><span class="nx">state2</span><span class="p">,</span><span class="w"> </span><span class="s2">&quot;users.results.2.groups.0&quot;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;aa&#39;</span><span class="p">),</span>
<span class="w">        </span><span class="s2">&quot;users.results.0.name&quot;</span><span class="p">,</span><span class="w"> </span><span class="nx">x</span><span class="p">=&gt;</span><span class="nx">x</span><span class="p">.</span><span class="nx">toUpperCase</span><span class="p">()),</span>
<span class="w">    </span><span class="s2">&quot;users.total&quot;</span><span class="p">,</span><span class="w"> </span><span class="nx">x</span><span class="p">=&gt;</span><span class="nx">x</span><span class="o">+</span><span class="mf">1</span><span class="p">),</span>
<span class="s1">&#39;users.results.1.name&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;Jack&#39;</span><span class="p">)</span>
</pre></div>
<p>And here&#8217;s the&nbsp;result:</p>
<div class="highlight"><pre><span></span><span class="p">{</span>
<span class="w">    </span><span class="s2">&quot;users&quot;</span><span class="o">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="s2">&quot;results&quot;</span><span class="o">:</span><span class="w"> </span><span class="p">[{</span>
<span class="w">            </span><span class="s2">&quot;name&quot;</span><span class="o">:</span><span class="w"> </span><span class="s2">&quot;SERA&quot;</span><span class="p">,</span>
<span class="w">            </span><span class="s2">&quot;groups&quot;</span><span class="o">:</span><span class="w"> </span><span class="p">[</span><span class="s2">&quot;g1&quot;</span><span class="p">,</span><span class="w"> </span><span class="s2">&quot;g2&quot;</span><span class="p">,</span><span class="w"> </span><span class="s2">&quot;g3&quot;</span><span class="p">]</span>
<span class="w">        </span><span class="p">},</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="s2">&quot;name&quot;</span><span class="o">:</span><span class="w"> </span><span class="s2">&quot;Jack&quot;</span><span class="p">,</span>
<span class="w">            </span><span class="s2">&quot;groups&quot;</span><span class="o">:</span><span class="w"> </span><span class="p">[</span><span class="s2">&quot;g1&quot;</span><span class="p">,</span><span class="w"> </span><span class="s2">&quot;g2&quot;</span><span class="p">,</span><span class="w"> </span><span class="s2">&quot;g3&quot;</span><span class="p">]</span>
<span class="w">        </span><span class="p">},</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="s2">&quot;name&quot;</span><span class="o">:</span><span class="w"> </span><span class="s2">&quot;Joe&quot;</span><span class="p">,</span>
<span class="w">            </span><span class="s2">&quot;groups&quot;</span><span class="o">:</span><span class="w"> </span><span class="p">[</span><span class="s2">&quot;aa&quot;</span><span class="p">]</span>
<span class="w">        </span><span class="p">}],</span>
<span class="w">        </span><span class="s2">&quot;pagination&quot;</span><span class="o">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="s2">&quot;total&quot;</span><span class="o">:</span><span class="w"> </span><span class="mf">101</span><span class="p">,</span>
<span class="w">            </span><span class="s2">&quot;perpage&quot;</span><span class="o">:</span><span class="w"> </span><span class="mf">5</span><span class="p">,</span>
<span class="w">            </span><span class="s2">&quot;number&quot;</span><span class="o">:</span><span class="w"> </span><span class="mf">0</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">    </span><span class="p">},</span>
<span class="w">    </span><span class="s2">&quot;groups&quot;</span><span class="o">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="s2">&quot;results&quot;</span><span class="o">:</span><span class="w"> </span><span class="p">[],</span>
<span class="w">        </span><span class="s2">&quot;total&quot;</span><span class="o">:</span><span class="w"> </span><span class="mf">0</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>
</pre></div>
<p>This should be self&nbsp;explanatory.</p>
<p>I&#8217;ve published the above immutable little helpers as an npm package: <a class="reference external" href="https://www.npmjs.com/package/poor-man-lens">https://www.npmjs.com/package/poor-man-lens</a> (yes I
decided to use the poor man lens name instead of the immutable little helpers) - they are too simple and could be easily
copied and pasted to your project but I&#8217;ve seen even smaller npm packages and I wanted to try to see if it is easy to
publish a package to npm (answer: it is very easy - easier than python&#8217;s pip). Also there&#8217;s a github repository for
these utils in case somebody wants to contribute anything or look at the source: <a class="reference external" href="https://github.com/spapas/poor-man-lens">https://github.com/spapas/poor-man-lens</a>.</p>
<p>Notice that this package has been written in <span class="caps">ES5</span> (and actually has a polyfil for Object.assign) thus you should probably
be able to use it anywhere you want, even directly from the browser by directly including the <tt class="docutils literal">pml.js</tt> file.</p>
</div>
<div class="section" id="conclusion">
<h2>Conclusion</h2>
<p>Using the above techniques you should be able to easily keep your state objects immutable. For simple cases you
can stick to the spread syntax or Object.assign / Array.slice but for more complex cases you may want to consider
either copying directly the pset and pget utils I explained above or just using the <a class="reference external" href="https://www.npmjs.com/package/poor-man-lens">poor-man-lens npm package</a>.</p>
</div>
</div>
  		</article>
  		<article>
<header>
      <h1 class="entry-title">
        <a href="https://www.spapas.net/2018/03/19/comprehensive-django-cbv-guide/">A comprehensive Django CBV guide</a>
      </h1>
    <p class="meta">
<time datetime="2018-03-19T12:20:00+02:00" pubdate>Mon 19 March 2018</time>    </p>
</header>

<div class="entry-content"><div class="contents topic" id="contents">
<p class="topic-title"><a class="reference internal" href="#top">Contents</a></p>
<ul class="simple">
<li><a class="reference internal" href="#a-gentle-introduction-to-cbvs" id="toc-entry-1">A gentle introduction to CBVs</a><ul>
<li><a class="reference internal" href="#hand-made-cbvs" id="toc-entry-2">Hand-made&nbsp;CBVs</a></li>
<li><a class="reference internal" href="#is-this-really-dry" id="toc-entry-3">Is this really <span class="caps">DRY</span>&nbsp;?</a></li>
<li><a class="reference internal" href="#re-using-view-functionality" id="toc-entry-4">Re-using view&nbsp;functionality</a></li>
<li><a class="reference internal" href="#interlude-an-mro-primer" id="toc-entry-5">Interlude: An <span class="caps">MRO</span>&nbsp;primer</a></li>
<li><a class="reference internal" href="#using-mixins-for-code-reuse" id="toc-entry-6">Using mixins for&nbsp;code-reuse</a></li>
<li><a class="reference internal" href="#the-super-situation" id="toc-entry-7">The super&nbsp;situation</a></li>
<li><a class="reference internal" href="#using-super-in-our-hierarchy" id="toc-entry-8">Using super in our&nbsp;hierarchy</a></li>
<li><a class="reference internal" href="#testing-all-this" id="toc-entry-9">Testing all&nbsp;this</a></li>
</ul>
</li>
<li><a class="reference internal" href="#a-high-level-overview-of-cbvs" id="toc-entry-10">A high level overview of CBVs</a><ul>
<li><a class="reference internal" href="#taking-a-look-at-the-view" id="toc-entry-11">Taking a look at the&nbsp;View</a></li>
<li><a class="reference internal" href="#redirectview-and-templateview" id="toc-entry-12">RedirectView and&nbsp;TemplateView</a></li>
<li><a class="reference internal" href="#the-formview" id="toc-entry-13">The&nbsp;FormView</a></li>
<li><a class="reference internal" href="#the-listview-and-detailview" id="toc-entry-14">The ListView and&nbsp;DetailView</a></li>
<li><a class="reference internal" href="#the-createview" id="toc-entry-15">The&nbsp;CreateView</a></li>
<li><a class="reference internal" href="#the-updateview-and-deleteview" id="toc-entry-16">The UpdateView and&nbsp;DeleteView</a></li>
<li><a class="reference internal" href="#access-control-mixins" id="toc-entry-17">Access control&nbsp;mixins</a></li>
<li><a class="reference internal" href="#some-other-cbvs" id="toc-entry-18">Some other&nbsp;CBVs</a></li>
</ul>
</li>
<li><a class="reference internal" href="#real-world-use-cases" id="toc-entry-19">Real world use cases</a><ul>
<li><a class="reference internal" href="#do-something-when-a-valid-form-is-submitted" id="toc-entry-20">Do something when a valid form is&nbsp;submitted</a></li>
<li><a class="reference internal" href="#change-the-queryset-of-the-cbv" id="toc-entry-21">Change the queryset of the <span class="caps">CBV</span></a></li>
<li><a class="reference internal" href="#allow-each-user-to-list-view-edit-delete-only-his-own-items" id="toc-entry-22">Allow each user to list/view/edit/delete only his own&nbsp;items</a></li>
<li><a class="reference internal" href="#configure-the-form-s-initial-values-from-get-parameters" id="toc-entry-23">Configure the form&#8217;s initial values from <span class="caps">GET</span>&nbsp;parameters</a></li>
<li><a class="reference internal" href="#pass-extra-kwargs-to-the-formview-form" id="toc-entry-24">Pass extra kwargs to the FormView&nbsp;form</a></li>
<li><a class="reference internal" href="#add-values-to-the-context" id="toc-entry-25">Add values to the&nbsp;context</a></li>
<li><a class="reference internal" href="#add-a-simple-filter-to-a-listview" id="toc-entry-26">Add a simple filter to a&nbsp;ListView</a></li>
<li><a class="reference internal" href="#support-for-success-messages" id="toc-entry-27">Support for success&nbsp;messages</a></li>
<li><a class="reference internal" href="#implement-a-quick-moderation" id="toc-entry-28">Implement a quick&nbsp;moderation</a></li>
<li><a class="reference internal" href="#allow-access-to-a-view-if-a-user-has-one-out-of-a-group-of-permissions" id="toc-entry-29">Allow access to a view if a user has one out of a group of&nbsp;permissions</a></li>
<li><a class="reference internal" href="#disable-a-view-based-on-some-condition" id="toc-entry-30">Disable a view based on some&nbsp;condition</a></li>
<li><a class="reference internal" href="#output-non-html-views" id="toc-entry-31">Output non-html&nbsp;views</a></li>
<li><a class="reference internal" href="#use-one-templateview-for-multiple-html-templates" id="toc-entry-32">Use one TemplateView for multiple html&nbsp;templates</a></li>
<li><a class="reference internal" href="#implement-a-partial-ajax-view" id="toc-entry-33">Implement a partial Ajax&nbsp;view</a></li>
<li><a class="reference internal" href="#add-a-dynamic-filter-and-or-table-to-the-context" id="toc-entry-34">Add a dynamic filter and/or table to the&nbsp;context</a></li>
<li><a class="reference internal" href="#configure-forms-for-your-views" id="toc-entry-35">Configure forms for your&nbsp;views</a></li>
<li><a class="reference internal" href="#display-a-different-form-for-create-and-update" id="toc-entry-36">Display a different form for Create and&nbsp;Update</a></li>
<li><a class="reference internal" href="#only-allow-specific-http-methods-for-a-view" id="toc-entry-37">Only allow specific <span class="caps">HTTP</span> methods for a&nbsp;view</a></li>
<li><a class="reference internal" href="#create-an-umbrella-view-for-multiple-models" id="toc-entry-38">Create an umbrella View for multiple&nbsp;models</a></li>
</ul>
</li>
<li><a class="reference internal" href="#a-heavy-cbv-user-project" id="toc-entry-39">A heavy <span class="caps">CBV</span> user&nbsp;project</a></li>
<li><a class="reference internal" href="#conclusion" id="toc-entry-40">Conclusion</a></li>
</ul>
</div>
<p>Class Based Views (<span class="caps">CBV</span>) is one of my favourite things about Django. During my
first Django projects (using Django 1.4 around 6 years ago) I was mainly using
functional views &#8212; that&#8217;s what the tutorial recommended then anyway. However,
slowly in my next projects I started reducing the amount of functional views
and embracing CBVs, slowly understanding their usage and usefulness. Right now,
I more or less only use CBVs for my views; even if sometimes it seems more work
to use a <span class="caps">CBV</span> instead of a functional one I know that sometime in the future I&#8217;d
be glad that I did it since I&#8217;ll want to re-use some view functionality and
CBVs are more or less the only way to have <span class="caps">DRY</span> views in&nbsp;Django.</p>
<p>I&#8217;ve heard various rants about them, mainly that they are too complex and difficult to
understand and use, however I believe that they are not really difficult when
you start from the basics. Even if it is a little work to become comfortable with
the <span class="caps">CBV</span> logic, when they are used properly they will greatly improve your Django experience
so it is definitely worth&nbsp;it.</p>
<p>Notice
that to properly understand CBVs you must have a good understanding of how
Python&#8217;s (multiple) inheritance and <span class="caps">MRO</span> work. Yes, this is a rather complex and
confusing thing but I&#8217;ll try to also explain this as good as I can to the first chapter
of this article so if you follow along you shouldn&#8217;t have any&nbsp;problems.</p>
<p>This guide has four&nbsp;parts:</p>
<ul class="simple">
<li>A gentle introduction to how CBVs are working and to the the problems that do solve. For this we&#8217;ll implement
our own simple Custom Class Based View variant and take a look at python&#8217;s inheritance&nbsp;model.</li>
<li>A high level overview of the real Django CBVs using <a class="reference external" href="http://ccbv.co.uk`"><span class="caps">CBV</span> inspector</a> as our&nbsp;guide.</li>
<li>A number of use cases where CBVs can be used to elegantly solve real world&nbsp;problems</li>
<li>Describing the usage of some of the previous use cases to a real Django&nbsp;application</li>
</ul>
<p>I&#8217;ve implemented an accompanying project to this article which you can find at <a class="reference external" href="https://github.com/spapas/cbv-tutorial">https://github.com/spapas/cbv-tutorial</a>.
This project has two separate parts. One that is the implementation of the Custom Class Based View variant
to see how it is working and the other is the application that contains the usage of the various <span class="caps">CBV</span> use&nbsp;cases.</p>
<div class="section" id="a-gentle-introduction-to-cbvs">
<h2>A gentle introduction to&nbsp;CBVs</h2>
<p>In this part of the guide we&#8217;ll do a gentle introduction to how CBVs work by implementing
our own class based views variant - along with it we&#8217;ll introduce and try to understand
some concepts of  python (multiple) inheritance and how it applies to&nbsp;CBVs.</p>
<p>Before continuing, let&#8217;s talk about the concept of the &#8220;view&#8221; in Django:
Django is considered an <span class="caps">MVT</span> (Model View Template) framework - the View as
conceived by Django is not the same as the <span class="caps">MVC</span>-View. A Django View is more or
less a way to define the data that the Template (which is cloased to the <span class="caps">MVC</span>-View)
will display, so the Django View (with the help of the Django Framework) is similar
to the <span class="caps">MVC</span>-Controller.</p>
<p>In any case, traditionally a view in Django is a normal python function that takes a single parameter,
the <a class="reference external" href="https://docs.djangoproject.com/en/1.11/ref/request-response/#django.http.HttpRequest">request</a> object and must return a <a class="reference external" href="https://docs.djangoproject.com/en/1.11/ref/request-response/#django.http.HttpResponse">response</a> object (notice that if the
view uses request parameters for example the id of an object to be edited
they will also be passed to the function). The responsibility of the
view function is to properly parse the request parameters and construct the
response object - as can be understood there is a lot of work that need to be
done for each view (for example check if the method is <span class="caps">GET</span> or <span class="caps">POST</span>, if the user
has access to that page, retrieve objects from the database, crate a context dict
and pass it to the template to be rendered&nbsp;etc).</p>
<p>Now, since functional views are simple python functions it is <em>not</em> easy to override,
reuse or extend their behaviour. There are more or less two methods for this: Use function
decorators or pass extra parameters when adding the view to your urls. I&#8217;d like
to point out here that there&#8217;s a third method for code-reuse: Extracting
functionality to common and re-usable functions or classes that will be called from the
functional views but this is not something specific to Django views but a general
concept of good programming style which you should follow&nbsp;anyway.</p>
<p>The first one uses <a class="reference external" href="https://wiki.python.org/moin/PythonDecorators">python decorators</a> to create a functional view that wraps the
initial one. The new view is called before the initial one, adds some functionality
(for example check if the current user has access, modify request parameters etc),
calls the initial one which will return a response object, modify the response if needed
and then return that. This is how <a class="reference external" href="https://docs.djangoproject.com/en/2.0/topics/auth/default/#the-login-required-decorator">login_required</a> works. Notice that by using
decorators you can change things before and after the original view runs but
you can&#8217;t do anything about the way the original view&nbsp;works.</p>
<p>For the second one (adding extra view parameters) you must
write your function view in a way which allows it to be reused, for example instead
of hard-coding the template name allow it to be passed as a parameter or instead
of using a specific form class for a form make it configurable through a parameter. Then,
when you add this function to your urls you will pass different parameters
depending on how you want to configure your view. Using this method you can
override the original function behaviour however there&#8217;s a limit to the number of
parameters you can allow your function views to have and notice that these
function views cannot be further overridden. The <a class="reference external" href="https://docs.djangoproject.com/en/2.0/topics/auth/default/#django.contrib.auth.views.login">login</a> authentication view (which
is now deprecated in favour of a <span class="caps">CBV</span> one)
is using this technique, for example you can pass it
the template name that will be used, a custom authentication form&nbsp;etc.</p>
<p>It should be obvious that both these methods have severe limitations and do not allow you to be as <span class="caps">DRY</span> as
you should be. When using the wrapped views you can&#8217;t actually
change the functionality of the original view (since that original function needs
to be called) but only do things before and after calling it. Also, using the
parameters will lead to spaghetti code with multiple if / else conditions in order
to take into account the various cases that may arise. All the above lead to
very reduced re-usability and DRYness of functional views - usually the best thing
you can do is to gather the common things in external normal python functions (not view functions) that could be
re-used from other functional views as already&nbsp;discussed.</p>
<p>Class based views solve the above problem of non-<span class="caps">DRY</span>-ness by using the well known
concept of <span class="caps">OO</span> inheritance: The view is defined from a class which has methods
for implementing the view functionality - you inherit from that class and override
the parts you want so the inherited class based view will use the overridden methods instead
of the original ones. You can also create re-usable classes (mixins) that offer a specific
functionality to your class based view by implementing some of the methods of the
original class. Each one of your class based views can inherit its functionality from
multiple mixins thus allowing you to define a single class for each thing you need
and re-using it everywhere. Notice of course that this is possible only if the
CBVs are <em>properly implemented</em> to allow overriding their functionality. We&#8217;ll see
how this is possible in the next&nbsp;section.</p>
<div class="section" id="hand-made-cbvs">
<h3>Hand-made&nbsp;CBVs</h3>
<p>To make things more clear we&#8217;ll start implementing our own class based views hierarchy. Here&#8217;s
a rather naive first&nbsp;try:</p>
<div class="highlight"><pre><span></span><span class="k">class</span><span class="w"> </span><span class="nc">CustomClassView</span><span class="p">:</span>
    <span class="n">context</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">header</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">kwargs</span> <span class="o">=</span> <span class="n">kwargs</span>
        <span class="k">for</span> <span class="p">(</span><span class="n">k</span><span class="p">,</span><span class="n">v</span><span class="p">)</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="nb">setattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">render</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="s2">&quot;&quot;&quot;</span>
<span class="s2">            &lt;html&gt;</span>
<span class="s2">                &lt;body&gt;</span>
<span class="s2">                    &lt;h1&gt;</span><span class="si">{header}</span><span class="s2">&lt;/h1&gt;</span>
<span class="s2">                    </span><span class="si">{body}</span>
<span class="s2">                &lt;/body&gt;</span>
<span class="s2">            &lt;/html&gt;</span>
<span class="s2">        &quot;&quot;&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                <span class="n">header</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">header</span><span class="p">,</span> <span class="n">body</span><span class="o">=</span><span class="s1">&#39;&lt;br /&gt;&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">context</span><span class="p">),</span>
            <span class="p">)</span>

    <span class="nd">@classmethod</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">as_view</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="k">def</span><span class="w"> </span><span class="nf">view</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="p">):</span>
            <span class="n">instance</span> <span class="o">=</span> <span class="bp">cls</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">HttpResponse</span><span class="p">(</span><span class="n">instance</span><span class="o">.</span><span class="n">render</span><span class="p">())</span>

        <span class="k">return</span> <span class="n">view</span>
</pre></div>
<p>This class can be used to render a simple <span class="caps">HTML</span> template with a custom header and
a list of items in the body (named <tt class="docutils literal">context</tt>). There are two things to notice here: The <tt class="docutils literal">__init__</tt> method (which
will be called as the object&#8217;s constructor) will assign all the keyword arguments (<tt class="docutils literal">kwargs</tt>) it receives
as instance attributes (for example <tt class="docutils literal"><span class="pre">CustomClassView(header='hello')</span></tt> will create
an instance with <tt class="docutils literal">'hello'</tt> as its <tt class="docutils literal">header</tt> attribute). The <tt class="docutils literal">as_view</tt> is a class method
(i.e it can be called directly on the <em>class</em> without the need to instantiate an object
for example you can call <tt class="docutils literal">CustomClassView.as_view()</tt> ) that
defines and returns a traditional functional view (named <tt class="docutils literal">view</tt>) that will be used to
actually serve the view. The returned
functional view is very simple - it just instantiates a new instance (object)
of <tt class="docutils literal">CustomClassView</tt> passing
the <tt class="docutils literal">kwargs</tt> it got in the constructor and then returns a normal <tt class="docutils literal">HttpResponse</tt> with
the instance&#8217;s <tt class="docutils literal">render()</tt> result. This <tt class="docutils literal">render()</tt> method will just output some html
using the instance&#8217;s header and context to fill&nbsp;it.</p>
<p>Notice that the instance of the <tt class="docutils literal">CustomClassView</tt> inside the <tt class="docutils literal">as_view</tt> class method
is not created using
<tt class="docutils literal"><span class="pre">CustomClassView(**kwargs)</span></tt> but using <tt class="docutils literal"><span class="pre">cls(**kwargs)</span></tt> - <tt class="docutils literal">cls</tt> is the name of the
class that <tt class="docutils literal">as_view</tt> was called on and is actually passed as a parameter for
class methods (in a similar manner to how <tt class="docutils literal">self</tt> is passed to instance methods).
This is important to instantiate an object instance of the proper&nbsp;class.</p>
<p>For example, if you created a class that inherited from <tt class="docutils literal">CustomClassView</tt>
and called its <tt class="docutils literal">as_view</tt> method then when you use the <tt class="docutils literal">cls</tt> parameter to instantiate
the object it will correctly create an object of the <em>inherited</em> class and not the <em>base</em> one
(if on the other hand you had used <tt class="docutils literal"><span class="pre">CustomClassView(**kwargs)</span></tt> to instantiate the instance
then the <tt class="docutils literal">as_view</tt> method of the inheriting classes would instantiate instances of
<tt class="docutils literal">CustomClassView</tt> so inheritance wouldn&#8217;t really&nbsp;work!).</p>
<p>To add the above class method in your urls, just use its <tt class="docutils literal">as_view()</tt> as you&#8217;d
normally use a functional&nbsp;view:</p>
<div class="highlight"><pre><span></span><span class="kn">from</span><span class="w"> </span><span class="nn">django.conf.urls</span><span class="w"> </span><span class="kn">import</span> <span class="n">include</span><span class="p">,</span> <span class="n">url</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">.</span><span class="w"> </span><span class="kn">import</span> <span class="n">views</span>

<span class="n">urlpatterns</span> <span class="o">=</span> <span class="p">[</span>
    <span class="n">url</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;^ccv-empty/$&#39;</span><span class="p">,</span> <span class="n">views</span><span class="o">.</span><span class="n">CustomClassView</span><span class="o">.</span><span class="n">as_view</span><span class="p">(),</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;ccv-empty&#39;</span><span class="p">),</span>
    <span class="c1"># ... other urls</span>
<span class="p">]</span>
</pre></div>
<p>This doesn&#8217;t actually render anything since both header and context are empty on
the created instance &#8212; remember that <tt class="docutils literal">as_view</tt> returns a functional view that
instantiates a <tt class="docutils literal">CustomClassView</tt> object and returns an <tt class="docutils literal">HttpResponse</tt> filling it
with the object&#8217;s <tt class="docutils literal">render()</tt> results. To add some output we can either
create another class that inherits from <tt class="docutils literal">CustomClassView</tt> or
initialize the attributes from the constructor of the class (using the kwargs functionality described&nbsp;above).</p>
<p>The inherited class can just override the values of the&nbsp;attributes:</p>
<div class="highlight"><pre><span></span><span class="k">class</span><span class="w"> </span><span class="nc">InheritsCustomClassView</span><span class="p">(</span><span class="n">CustomClassView</span><span class="p">,</span> <span class="p">):</span>
    <span class="n">header</span> <span class="o">=</span> <span class="s2">&quot;Hi&quot;</span>
    <span class="n">context</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;test&#39;</span><span class="p">,</span> <span class="s1">&#39;test2&#39;</span> <span class="p">]</span>
</pre></div>
<p>And then just add the inherited class to your urls as&nbsp;before:</p>
<div class="highlight"><pre><span></span><span class="n">url</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;^ccv-inherits/$&#39;</span><span class="p">,</span> <span class="n">views</span><span class="o">.</span><span class="n">InheritsCustomClassView</span><span class="o">.</span><span class="n">as_view</span><span class="p">(),</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;ccv-inherits&#39;</span><span class="p">),</span>
</pre></div>
<p>The <tt class="docutils literal">as_view()</tt> method will create an instance of <tt class="docutils literal">InheritsCustomClassView</tt> that has
the values configured in the class as attributes and return
its <tt class="docutils literal">render()</tt> output as&nbsp;response.</p>
<p>The other way to configure the attributes of the class is to
pass them to the <tt class="docutils literal">as_view</tt> class method (which in turn will pass them to the instances
constructor which will set the attributes in the instance). Here&#8217;s an&nbsp;example:</p>
<div class="highlight"><pre><span></span><span class="n">url</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;^ccv-with-values/$&#39;</span><span class="p">,</span> <span class="n">views</span><span class="o">.</span><span class="n">CustomClassView</span><span class="o">.</span><span class="n">as_view</span><span class="p">(</span><span class="n">header</span><span class="o">=</span><span class="s1">&#39;Hello&#39;</span><span class="p">,</span> <span class="n">context</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;hello&#39;</span><span class="p">,</span> <span class="s1">&#39;world&#39;</span><span class="p">,</span> <span class="p">],</span> <span class="n">footer</span><span class="o">=</span><span class="s1">&#39;Bye&#39;</span><span class="p">,</span> <span class="p">),</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;ccv-with-values&#39;</span><span class="p">),</span>
</pre></div>
<p>The above will create a <tt class="docutils literal">CustomClassView</tt> instance with the provided values as its&nbsp;attributes.</p>
<p>Although this method of configuration is used in normal django CBVs (for example
setting the <tt class="docutils literal">template_name</tt> in a <tt class="docutils literal">TemplateView</tt>) I recommend you avoid using it because passing parameters
to the <tt class="docutils literal">as_view</tt> method pollutes the urls.py with configuration
that (at least in my opinion) should <em>not</em> be there (and there&#8217;s no reason to have to take a look at both
your urls.py and your views.py to understand the behavior of your views) and also, even for very simple views I know that after some time I&#8217;ll need
to add some functionality that cannot be implemented by passing the parameters so I prefer to bite the
bullet and define all my views as inherited classes so it will be easy for me to further customize them later (we&#8217;ll
see how this is done in a second). Thus, even if you&nbsp;have</p>
<p>In any case, I won&#8217;t discuss passing parameters to the <tt class="docutils literal">as_view</tt> method any more,
so from now on any class based views I define will be added to urls py using <tt class="docutils literal">ClassName.as_view()</tt> without any
parameters to the <tt class="docutils literal">as_view()</tt> class&nbsp;method.</p>
</div>
<div class="section" id="is-this-really-dry">
<h3>Is this really <span class="caps">DRY</span>&nbsp;?</h3>
<p>Let&#8217;s now suppose that we wanted to allow our class based view to print something on the header even if no header is provided
when you configure it. The only way to do it would be to re-define the <tt class="docutils literal">render</tt> method like&nbsp;this:</p>
<div class="highlight"><pre><span></span><span class="k">def</span><span class="w"> </span><span class="nf">render</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="n">header</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">header</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">header</span> <span class="k">else</span> <span class="s2">&quot;DEFAULT HEADER&quot;</span>
    <span class="k">return</span> <span class="s2">&quot;&quot;&quot;</span>
<span class="s2">        &lt;html&gt;</span>
<span class="s2">            &lt;body&gt;</span>
<span class="s2">                &lt;h1&gt;</span><span class="si">{header}</span><span class="s2">&lt;/h1&gt;</span>
<span class="s2">                </span><span class="si">{body}</span>
<span class="s2">            &lt;/body&gt;</span>
<span class="s2">        &lt;/html&gt;</span>
<span class="s2">    &quot;&quot;&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
            <span class="n">header</span><span class="o">=</span><span class="n">header</span><span class="p">,</span> <span class="n">body</span><span class="o">=</span><span class="s1">&#39;&lt;br /&gt;&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">context</span><span class="p">),</span>
        <span class="p">)</span>
</pre></div>
<p>This is definitely not the <span class="caps">DRY</span> way to do it because you would need to re-define the whole <tt class="docutils literal">render</tt> method. Think
what would happen if
you wanted to print <tt class="docutils literal">&quot;<span class="caps">ANOTHER</span> <span class="caps">DEFAULT</span> <span class="caps">HEADER</span>&quot;</tt> as a default header for some other view - once again re-defining
<tt class="docutils literal">render</tt>! In fact, the above
<tt class="docutils literal">CustomClassView</tt> is naively implemented because it does not allow proper customization through inheritance. The
same problems for the header arise also when you need modify the body; for
example, if you wanted to add an index number before displaying the items of the list then you&#8217;d need to again re-implement the
whole <tt class="docutils literal">render</tt> method.</p>
<p>If that was our only option then we could just stick to functional views. However, we can do
much better if we define the class based view in such a way that allows inherited classes to override methods that
define specific parts of the functionality. To do this the class-based-view must be properly implemented so each
part of its functionality is implemented by a different&nbsp;method.</p>
<p>Here&#8217;s how we could improve the <tt class="docutils literal">CustomClassView</tt> to make it more <span class="caps">DRY</span>:</p>
<div class="highlight"><pre><span></span><span class="k">class</span><span class="w"> </span><span class="nc">BetterCustomClassView</span><span class="p">(</span><span class="n">CustomClassView</span><span class="p">,</span> <span class="p">):</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">get_header</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="p">):</span>
        <span class="nb">print</span> <span class="p">(</span><span class="s2">&quot;Better Custom Class View&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">header</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">header</span> <span class="k">else</span> <span class="s2">&quot;&quot;</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">get_context</span><span class="p">(</span><span class="bp">self</span> <span class="p">,</span> <span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">context</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">context</span> <span class="k">else</span> <span class="p">[]</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">render_context</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">context</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_context</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">context</span><span class="p">:</span>
            <span class="k">return</span> <span class="s1">&#39;&lt;br /&gt;&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">context</span><span class="p">)</span>
        <span class="k">return</span> <span class="s2">&quot;&quot;</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">render</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="s2">&quot;&quot;&quot;</span>
<span class="s2">            &lt;html&gt;</span>
<span class="s2">                &lt;body&gt;</span>
<span class="s2">                    &lt;h1&gt;</span><span class="si">{header}</span><span class="s2">&lt;/h1&gt;</span>
<span class="s2">                    </span><span class="si">{body}</span>
<span class="s2">                &lt;/body&gt;</span>
<span class="s2">            &lt;/html&gt;</span>
<span class="s2">        &quot;&quot;&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                <span class="n">header</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">get_header</span><span class="p">(),</span> <span class="n">body</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">render_context</span><span class="p">(),</span>
            <span class="p">)</span>
</pre></div>
<p>So what happens here? First of all we inherit from <tt class="docutils literal">CustomClassView</tt> to keep the
<tt class="docutils literal">as_view</tt> method which doesn&#8217;t need changing. Beyond this, the render
uses methods (<tt class="docutils literal">get_header</tt> and <tt class="docutils literal">render_context</tt>) to retrieve the values from the header and the body - this means
that we could re-define these methods to an inherited class in order to override
what these methods will return. Beyond <tt class="docutils literal">get_header</tt> and <tt class="docutils literal">render_contex</tt> I&#8217;ve added
a <tt class="docutils literal">get_context</tt> method that is used by <tt class="docutils literal">render_context</tt> to make this <span class="caps">CBV</span> even
more re-usable. For example I may
need to configure the context (add/remove items from the context i.e have a <span class="caps">CBV</span>
that adds a last item with the number of list items to the list to be displayed). Of course this could
be done from <tt class="docutils literal">render_context</tt> <em>but</em> this means that I would need to define my new functionality
(modifying the context items) <em>and</em> re-defining the context list formatting. It is much
better (in my opinion always) to keep properly separated these&nbsp;things.</p>
<p>Now, the above is a first try that I created to mainly fulfil my requirement of
having a default header and some more examples I will discuss later (and keep
everything simple enough). You could
extract more functionality as methods-for-overriding, for example the render
method could be written like&nbsp;this:</p>
<div class="highlight"><pre><span></span><span class="k">def</span><span class="w"> </span><span class="nf">render</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_template</span><span class="p">()</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
            <span class="n">header</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">get_header</span><span class="p">(),</span> <span class="n">body</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">render_context</span><span class="p">(),</span>
        <span class="p">)</span>
</pre></div>
<p>and add a <tt class="docutils literal">get_template</tt> method that will return the actual html template. There&#8217;s no
hard rules here on what functionality should be extracted to a method (so it could
be overridden) however I recommend to follow the <span class="caps">YAGNI</span> rule (i.e implement everything
as normal and when you see that some functionality needs to be overridden then refactor
your code to extract it to a separate&nbsp;method).</p>
<p>Let&#8217;s see an example of adding the default header functionality by overriding <tt class="docutils literal">get_header</tt>:</p>
<div class="highlight"><pre><span></span><span class="k">class</span><span class="w"> </span><span class="nc">DefaultHeaderBetterCustomClassView</span><span class="p">(</span><span class="n">BetterCustomClassView</span><span class="p">,</span> <span class="p">):</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">get_header</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">header</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">header</span> <span class="k">else</span> <span class="s2">&quot;DEFAULT HEADER&quot;</span>
</pre></div>
<p>Classes inheriting from <tt class="docutils literal">DefaultHeaderBetterCustomClassView</tt> can choose to not
actually define a header attribute so <tt class="docutils literal">&quot;<span class="caps">DEFAULT</span> <span class="caps">HEADER</span>&quot;</tt> will be printed instead. Keep in
mind that for <tt class="docutils literal">DefaultHeaderBetterCustomClassView</tt> to be actually useful you&#8217;ll need to
have more than one classes that need this default-header functionality (or else you could
just set the header attribute of your class to <tt class="docutils literal">&quot;<span class="caps">DEFAULT</span> <span class="caps">HEADER</span>&quot;</tt> - this is not
user generated input, this is your source&nbsp;code!).</p>
</div>
<div class="section" id="re-using-view-functionality">
<h3>Re-using view&nbsp;functionality</h3>
<p>We have come now to a crucial point in this chapter, so please stick with me. Let&#8217;s say that you have
<em>more than one</em> class based views that contain a header attribute. You want to include
the default header functionality on all of them so that if any view instantiated from these
class based views doesn&#8217;t define a header
the default string will be output (I know that this may be a rather trivial example but I want
to keep everything simple to make following easy - instead of the default header the functionality
you want to override may be adding stuff to the context or filtering the objects you&#8217;ll retrieve
from the&nbsp;database).</p>
<p>To re-use this default header functionality from multiple classes you have <em>two</em> options:
Either inherit all classes that need this functionality from <tt class="docutils literal">DefaultHeaderBetterCustomClassView</tt> or
extract the custom <tt class="docutils literal">get_header</tt> method to a <em>mixin</em> and inherit from the mixin. A mixin is a class not
related to the class based view hierarchy we are using - the mixin inherits from object (or from another
mixin) and just defines the methods and attributes that need to be overridden. When the mixin is <em>mixed</em>
with the ancestors of a class its functionality will be used by that class (we&#8217;ll see how shortly). So
the mixin will only define <tt class="docutils literal">get_header</tt> and not all other methods like
<tt class="docutils literal">render</tt>, <tt class="docutils literal">get_context</tt> etc. Using the
<tt class="docutils literal">DefaultHeaderBetterCustomClassView</tt> is enough for some cases but for the general case
of re-using the functionality you&#8217;ll need to create the mixin. Let&#8217;s see&nbsp;why:</p>
<p>Suppose that you have a base class that renders the header and context as <span class="caps">JSON</span> instead of the <span class="caps">HTML</span>
template, something like&nbsp;this:</p>
<div class="highlight"><pre><span></span><span class="k">class</span><span class="w"> </span><span class="nc">JsonCustomClassView</span><span class="p">:</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">get_header</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">header</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">header</span> <span class="k">else</span> <span class="s2">&quot;&quot;</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">get_context</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">context</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">context</span> <span class="k">else</span> <span class="p">[]</span>

    <span class="nd">@classmethod</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">as_view</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="k">def</span><span class="w"> </span><span class="nf">view</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="p">):</span>
            <span class="n">instance</span> <span class="o">=</span> <span class="bp">cls</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">HttpResponse</span><span class="p">(</span><span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">({</span>
                <span class="s1">&#39;header&#39;</span><span class="p">:</span> <span class="n">instance</span><span class="o">.</span><span class="n">get_header</span><span class="p">(),</span>
                <span class="s1">&#39;context&#39;</span><span class="p">:</span> <span class="n">instance</span><span class="o">.</span><span class="n">get_context</span><span class="p">(),</span>
            <span class="p">}))</span>

        <span class="k">return</span> <span class="n">view</span>
</pre></div>
<p>Notice that this class does not inherit from our previous hierarchy (i.e does not
inherit from BetterCustomClassView) but from object since it provides
its own <tt class="docutils literal">as_view</tt> method. How could we re-use default header functionality
in this class (without having to re-implement it)? One solution would be to create a class that
inherits from both <tt class="docutils literal">JsonCustomClassView</tt> and <tt class="docutils literal">DefaultHeaderBetterCustomClassView</tt> using something&nbsp;like</p>
<div class="highlight"><pre><span></span><span class="c1"># OPTION 1</span>
<span class="k">class</span><span class="w"> </span><span class="nc">DefaultHeaderJsonCustomClassView</span><span class="p">(</span><span class="n">DefaultHeaderBetterCustomClassView</span><span class="p">,</span> <span class="n">JsonCustomClassView</span><span class="p">):</span>
    <span class="k">pass</span>

<span class="c1"># OR</span>
<span class="c1"># OPTION 2</span>
<span class="k">class</span><span class="w"> </span><span class="nc">JsonDefaultHeaderCustomClassView</span><span class="p">(</span><span class="n">JsonCustomClassView</span><span class="p">,</span> <span class="n">DefaultHeaderBetterCustomClassView</span><span class="p">):</span>
    <span class="k">pass</span>
</pre></div>
<p>What will happen here? Notice that the methods <tt class="docutils literal">get_header</tt> and <tt class="docutils literal">as_view</tt> exist in <em>both</em> ancestor classes! So
which one will be used in each case? Actually, there&#8217;s a (rather complex) rule for that called
<span class="caps">MRO</span> (Method Resolution Order). The <span class="caps">MRO</span> is also what can be used to know which <tt class="docutils literal">get_header</tt>
and <tt class="docutils literal">as_view</tt> will be used in each case in the previous&nbsp;example.</p>
</div>
<div class="section" id="interlude-an-mro-primer">
<h3>Interlude: An <span class="caps">MRO</span>&nbsp;primer</h3>
<p>What is <span class="caps">MRO</span>? For every class that Python sees, it tries to create a <em>list</em> (<span class="caps">MRO</span> list) of ancestor classes containing that class as
the first element and its ancestors in a specific order I&#8217;ll discuss in the next paragraph. When a method
of an object of that specific class needs to be
called, then the method will be searched in the <span class="caps">MRO</span> list (from the first element of the <span class="caps">MRO</span> list i.e. starting with the class itself) - when a class is found
in the list that defines the method then that method instance (i.e. the method defined in this class) will be called and the search will stop (careful readers: I haven&#8217;t
yet talked about <em>super</em> so please be&nbsp;patient).</p>
<p>Now, how is the <span class="caps">MRO</span> list created? As I explained, the first element
is the class itself. The second element is the <span class="caps">MRO</span> of the <em>leftmost</em> ancestor of that object (so <span class="caps">MRO</span> will
run recursively on each ancestor), the third element will be the <span class="caps">MRO</span> of the ancestor right next to the leftmost
ancestor etc. There is one extra and important rule: When a class is found multiple times in the <span class="caps">MRO</span> list (for example
if some elements have a common ancestor) then <em>only the last occurrence in the list will be kept</em> - so each class
will exist only once in the <span class="caps">MRO</span> list. The above rule implies that the
rightmost element in every <span class="caps">MRO</span> list will always be object - please make sure you
understand why before&nbsp;continuing.</p>
<p>Thus, the <span class="caps">MRO</span> list for <tt class="docutils literal">DefaultHeaderJsonCustomClassView</tt> defined in the previous section
is (remember, start
with the class to the left and add the <span class="caps">MRO</span> of each of its ancestors starting
from the leftmost one):
<tt class="docutils literal">[DefaultHeaderJsonCustomClassView, DefaultHeaderBetterCustomClassView, BetterCustomClassView, CustomClassView, JsonCustomClassView, object]</tt>, while
for <tt class="docutils literal">JsonDefaultHeaderCustomClassView</tt> is
<tt class="docutils literal">[JsonDefaultHeaderCustomClassView, JsonCustomClassView, DefaultHeaderBetterCustomClassView, BetterCustomClassView, CustomClassView, object]</tt>. What this
means is that for <tt class="docutils literal">DefaultHeaderJsonCustomClassView</tt> the <tt class="docutils literal">CustomClassView.as_view()</tt> and <tt class="docutils literal">DefaultHeaderBetterCustomClassView.get_header()</tt> will be used (thus
we will not get the <span class="caps">JSON</span> output) and for <tt class="docutils literal">JsonDefaultHeaderCustomClassView</tt> the <tt class="docutils literal">JsonCustomClassView.as_view()</tt> and <tt class="docutils literal">JsonCustomClassView.get_header()</tt>
will be used (so we won&#8217;t get the default header functionality) - i.e none of those two options will result to the desired&nbsp;behaviour.</p>
<p>Let&#8217;s try an example that has the same base class twice in the hierarchy (actually the previous examples also had a class twice in
the hierarchy - <tt class="docutils literal">object</tt> but let&#8217;s be more explicit). For this, we&#8217;ll create a
<tt class="docutils literal">DefaultContextBetterCustomClassView</tt> that returns a default context if the context is empty
(similar to the default header&nbsp;functionality).</p>
<div class="highlight"><pre><span></span><span class="k">class</span><span class="w"> </span><span class="nc">DefaultContextBetterCustomClassView</span><span class="p">(</span><span class="n">BetterCustomClassView</span><span class="p">,</span> <span class="p">):</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">get_context</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">context</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">context</span> <span class="k">else</span> <span class="p">[</span><span class="s2">&quot;DEFAULT CONTEXT&quot;</span><span class="p">]</span>
</pre></div>
<p>Now we&#8217;ll create a class that inherits from both <tt class="docutils literal">DefaultHeaderBetterCustomClassView</tt> and <tt class="docutils literal">DefaultContextBetterCustomClassView</tt>:</p>
<div class="highlight"><pre><span></span><span class="k">class</span><span class="w"> </span><span class="nc">DefaultHeaderContextCustomClassView</span><span class="p">(</span><span class="n">DefaultHeaderBetterCustomClassView</span><span class="p">,</span> <span class="n">DefaultContextBetterCustomClassView</span><span class="p">):</span>
    <span class="k">pass</span>
</pre></div>
<p>Let&#8217;s do the <span class="caps">MRO</span> for the <tt class="docutils literal">DefaultHeaderContextCustomClassView</tt> class:</p>
<p>Initially, the <span class="caps">MRO</span> will be the&nbsp;following:</p>
<pre class="code literal-block">
Starting with the initial class
1. DefaultHeaderContextCustomClassView
Follows the leftmost class (DefaultHeaderBetterCustomClassView) MRO
2. DefaultHeaderBetterCustomClassView, 3. BetterCustomClassView, 4. CustomClassView, 5. object
And finally the next class (DefaultContextBetterCustomClassView) MRO
6. DefaultContextBetterCustomClassView, 7. BetterCustomClassView, 8. CustomClassView, 9. object
</pre>
<p>Notice that classes <tt class="docutils literal">BetterCustomClassView</tt>, <tt class="docutils literal">CustomClassView</tt> and <tt class="docutils literal">object</tt> are repeated two times
(on place 3,4,5 and 7,8,9) thus <em>only</em> their last (rightmost) occurrences will be kept in the list. So the
resulting <span class="caps">MRO</span> is the following (3,4,5 are&nbsp;removed):</p>
<p><tt class="docutils literal">[DefaultHeaderContextCustomClassView, DefaultHeaderBetterCustomClassView, DefaultContextBetterCustomClassView, BetterCustomClassView, CustomClassView, object]</tt></p>
<p>One funny thing here is that the <tt class="docutils literal">DefaultHeaderContextCustomClassView</tt> <em>will actually work</em> properly because the
<tt class="docutils literal">get_header</tt> will be found in <tt class="docutils literal">DefaultHeaderBetterCustomClassView</tt> and the
<tt class="docutils literal">get_context</tt> will be found in <tt class="docutils literal">DefaultContextBetterCustomClassView</tt> so this
result to the correct&nbsp;functionality.</p>
<p>Yes it does work but at what cost? Do you really want to do the mental exercise
of finding out the <span class="caps">MRO</span> for each class you define to see which method will be actually used? Also, what would happen if the
<tt class="docutils literal">DefaultHeaderContextCustomClassView</tt> class also had a <tt class="docutils literal">get_context</tt> method defined
(hint: that <tt class="docutils literal">get_context</tt> would be used and the <tt class="docutils literal">get_context</tt> of <tt class="docutils literal">DefaultContextBetterCustomClassView</tt>
would be&nbsp;ignored).</p>
<p>Before finishing this interlude, I&#8217;d like to make a confession: The Python <span class="caps">MRO</span> algorithm is not as simple as
than the procedure I described. It uses an algorithm called <a class="reference external" href="https://en.wikipedia.org/wiki/C3_linearization">C3 linearization</a> which seems way too complex
to start explaining or understanding if you not a <span class="caps">CS</span> student. What you&#8217;ll need to remember is that the
procedure I described works fine in normal cases when you don&#8217;t try to do something stupid. Here&#8217;s a
<a class="reference external" href="https://medium.com/technology-nineleaps/python-method-resolution-order-4fd41d2fcc">post that explains the theory more</a>. However if you  follow along my recommendations below you won&#8217;t
have any problems with <span class="caps">MRO</span>, actually you won&#8217;t really need to use the <span class="caps">MRO</span> that much to understand
the method calling&nbsp;hierarchy.</p>
</div>
<div class="section" id="using-mixins-for-code-reuse">
<h3>Using mixins for&nbsp;code-reuse</h3>
<p>The above explanation of <span class="caps">MRO</span> should convince you that you should avoid
mixing hierarchies of classes - if you are not convinced then wait until I introduce <tt class="docutils literal">super()</tt>
in the next section and I guarantee that you&#8217;ll&nbsp;be!</p>
<p>So, that&#8217;s why I
propose implementing common functionality that needs to be re-used between
classes only with mixins (hint: that&#8217;s also what Django does). Each re-usable functionality
will be implemented in its own mixin;  class views that need to implement that
functionality will just inherit from the mixin along with the base class view. Each
one of the view classes you define should inherit from <em>one and only one</em> other class
view and any number of mixins you want. Make sure that the view class is rightmost in
the ancestors list and the mixins are to the left of it (so that they will properly override
its behaviour; remember that the methods of the ancestors to the left are searched first
in the <span class="caps">MRO</span> list &#8212; and the methods of the defined class have of course the highest priority
since it goes first in the <span class="caps">MRO</span>&nbsp;list).</p>
<p>Let&#8217;s try implementing the proposed mixins for a default header and&nbsp;context:</p>
<div class="highlight"><pre><span></span><span class="k">class</span><span class="w"> </span><span class="nc">DefaultHeaderMixin</span><span class="p">:</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">get_header</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">header</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">header</span> <span class="k">else</span> <span class="s2">&quot;DEFAULT HEADER&quot;</span>

<span class="k">class</span><span class="w"> </span><span class="nc">DefaultContextMixin</span><span class="p">:</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">get_context</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">context</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">context</span> <span class="k">else</span> <span class="p">[</span><span class="s2">&quot;DEFAULT CONTEXT&quot;</span><span class="p">]</span>
</pre></div>
<p>and all the proposed use cases using the base class view and the&nbsp;mixins:</p>
<div class="highlight"><pre><span></span><span class="k">class</span><span class="w"> </span><span class="nc">DefaultHeaderMixinBetterCustomClassView</span><span class="p">(</span><span class="n">mixins</span><span class="o">.</span><span class="n">DefaultHeaderMixin</span><span class="p">,</span> <span class="n">BetterCustomClassView</span><span class="p">):</span>
    <span class="k">pass</span>

<span class="k">class</span><span class="w"> </span><span class="nc">DefaultContextMixinBetterCustomClassView</span><span class="p">(</span><span class="n">mixins</span><span class="o">.</span><span class="n">DefaultContextMixin</span><span class="p">,</span> <span class="n">BetterCustomClassView</span><span class="p">):</span>
    <span class="k">pass</span>

<span class="k">class</span><span class="w"> </span><span class="nc">DefaultHeaderContextMixinBetterCustomClassView</span><span class="p">(</span><span class="n">mixins</span><span class="o">.</span><span class="n">DefaultHeaderMixin</span><span class="p">,</span> <span class="n">mixins</span><span class="o">.</span><span class="n">DefaultContextMixin</span><span class="p">,</span> <span class="n">BetterCustomClassView</span><span class="p">):</span>
    <span class="k">pass</span>

<span class="k">class</span><span class="w"> </span><span class="nc">JsonDefaultHeaderMixinCustomClassView</span><span class="p">(</span><span class="n">mixins</span><span class="o">.</span><span class="n">DefaultHeaderMixin</span><span class="p">,</span> <span class="n">JsonCustomClassView</span><span class="p">):</span>
    <span class="k">pass</span>
</pre></div>
<p>I believe that the above definitions are self-documented and it is very easy to know which
method of the resulting class will be called each time: Start from the main class and if
the method is not found there continue from left to right to the ancestor list; since the mixins
do only one thing and do it well you&#8217;ll know what each class does simply by looking at its&nbsp;definition.</p>
</div>
<div class="section" id="the-super-situation">
<h3>The super&nbsp;situation</h3>
<p>The final (and most complex) thing and extension I&#8217;d like to discuss for our custom class based views is the case
where you want to use the functionality of more than one mixins for the <em>same thing</em>. For example, let&#8217;s suppose
that we had a mixin that added some data to the context and a different mixing that added
some different data to the context. Both would use the <tt class="docutils literal">get_context</tt> method
and you&#8217;d like to have the context data of both of them to your context. But
this is not possible using the implementations above because when a
<tt class="docutils literal">get_context</tt> is found in the <span class="caps">MRO</span> list it will be called and the <span class="caps">MRO</span> search
will finish&nbsp;there!</p>
<p>So how could we add the functionality of both these mixins to a class based view? This is the same problem as
if we wanted to inherit from a mixin (or a class view) and override one of its methods
but <em>also</em> call its parent (overridden) method for example to get its output and use it as the base
of the output for the overridden method. Both these situations (re-use
functionality of two mixins with the same method or re-use functionality
from a parent method you override) are the same because what stays in the end is
the <span class="caps">MRO</span> list. For example say we we had the following base&nbsp;class</p>
<pre class="code literal-block">
class V:pass
</pre>
<p>and we wanted to override it either using mixins or by using normal&nbsp;inheritance.</p>
<p>When using mixins for example like&nbsp;this:</p>
<pre class="code literal-block">
class M1:pass
class M2:pass
class MIXIN(M2, M1, V):pass
</pre>
<p>we&#8217;ll have the following <span class="caps">MRO</span>:</p>
<pre class="code literal-block">
# MIXIN.mro()
# [MIXIN, M2, M1, V, object, ]
</pre>
<p>while when using inheritance like&nbsp;this:</p>
<pre class="code literal-block">
class M1V(V):pass
class M2M1V(M1V):pass
class INHERITANCE(M2M1V):pass
</pre>
<p>we&#8217;ll have the following <span class="caps">MRO</span>:</p>
<blockquote>
# <span class="caps">INHERITANCE</span>.mro()
# [<span class="caps">INHERITANCE</span>, <span class="caps">M2M1V</span>, <span class="caps">M1V</span>, V, object ]</blockquote>
<p>As we can see in both cases the base class V is the last one (just next to object)
and between this class and the one that needs the functionality (<tt class="docutils literal"><span class="caps">MIXIN</span></tt> in the first
case and <tt class="docutils literal"><span class="caps">INHERITANCE</span></tt> in the second case) there are
the classes that will define the extra functionality that needs to be re-used: <tt class="docutils literal">M2</tt> and <tt class="docutils literal">M1</tt> (start from
left to right) in the first case and <tt class="docutils literal"><span class="caps">M2M1V</span></tt> and <tt class="docutils literal"><span class="caps">M1V</span></tt> (follow the inheritance hierarchy)
in the second case. So in both cases when calling a method they will be searched the same way using
the <span class="caps">MRO</span> list and when the method is found it will be executed and the search will&nbsp;stop.</p>
<p>But what if we needed to re-use some method from <tt class="docutils literal">V</tt> (or from some other ancestor) and
a class on the left of the <span class="caps">MRO</span> list has the same method?
The answer, as you should have guessed by now if you have some Python knowledge is <tt class="docutils literal">super()</tt>.</p>
<p>The <tt class="docutils literal">super</tt> method can be used by a class method to call a method of <em>its ancestors</em> respecting
the <span class="caps">MRO</span>. Thus, running <tt class="docutils literal"><span class="pre">super().x()</span></tt> from a method instance will try to find method <tt class="docutils literal">x()</tt>
on the <span class="caps">MRO</span> ancestors of this instance <em>even if the instance defines the &#8220;x()&#8220; method</em> i.e it will
not search the first element of the <span class="caps">MRO</span> list. Notice
that if the <tt class="docutils literal">x()</tt> method does not exist in the headless-<span class="caps">MRO</span> chain you&#8217;ll get an attribute error.
So, usually, you&#8217;ll can <tt class="docutils literal"><span class="pre">super().x()</span></tt> from <em>inside</em> the <tt class="docutils literal">x()</tt> method to call your parent&#8217;s (as
specified by the <span class="caps">MRO</span> list) same-named method and retrieve its&nbsp;output.</p>
<p>Let&#8217;s take a closer look at how <tt class="docutils literal">super()</tt> works using a simple example. For this, we&#8217;ll define a method calld <tt class="docutils literal">x()</tt> on all classes
of the previous&nbsp;example:</p>
<div class="highlight"><pre><span></span><span class="k">class</span><span class="w"> </span><span class="nc">V</span><span class="p">:</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">x</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="nb">print</span> <span class="p">(</span><span class="s2">&quot;From V&quot;</span><span class="p">)</span>

<span class="k">class</span><span class="w"> </span><span class="nc">M1</span><span class="p">:</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">x</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">x</span><span class="p">()</span>
        <span class="nb">print</span> <span class="p">(</span><span class="s2">&quot;From M1&quot;</span><span class="p">)</span>

<span class="k">class</span><span class="w"> </span><span class="nc">M2</span><span class="p">:</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">x</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">x</span><span class="p">()</span>
        <span class="nb">print</span> <span class="p">(</span><span class="s2">&quot;From M2&quot;</span><span class="p">)</span>

<span class="k">class</span><span class="w"> </span><span class="nc">MIXIN</span><span class="p">(</span><span class="n">M2</span><span class="p">,</span> <span class="n">M1</span><span class="p">,</span> <span class="n">V</span><span class="p">):</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">x</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">x</span><span class="p">()</span>
        <span class="nb">print</span> <span class="p">(</span><span class="s2">&quot;From MIXIN&quot;</span><span class="p">)</span>


<span class="k">class</span><span class="w"> </span><span class="nc">M1V</span><span class="p">(</span><span class="n">V</span><span class="p">):</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">x</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">x</span><span class="p">()</span>
        <span class="nb">print</span> <span class="p">(</span><span class="s2">&quot;From M1V&quot;</span><span class="p">)</span>

<span class="k">class</span><span class="w"> </span><span class="nc">M2M1V</span><span class="p">(</span><span class="n">M1V</span><span class="p">):</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">x</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">x</span><span class="p">()</span>
        <span class="nb">print</span> <span class="p">(</span><span class="s2">&quot;From M2M1V&quot;</span><span class="p">)</span>

<span class="k">class</span><span class="w"> </span><span class="nc">INHERITANCE</span><span class="p">(</span><span class="n">M2M1V</span><span class="p">):</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">x</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">x</span><span class="p">()</span>
        <span class="nb">print</span> <span class="p">(</span><span class="s2">&quot;From INHERITANCE&quot;</span><span class="p">)</span>

<span class="nb">print</span> <span class="p">(</span><span class="s2">&quot;MIXIN OUTPUT&quot;</span><span class="p">)</span>
<span class="n">MIXIN</span><span class="p">()</span><span class="o">.</span><span class="n">x</span><span class="p">()</span>

<span class="nb">print</span> <span class="p">(</span><span class="s2">&quot;INHERITANCE OUTPUT&quot;</span><span class="p">)</span>
<span class="n">INHERITANCE</span><span class="p">()</span><span class="o">.</span><span class="n">x</span><span class="p">()</span>
</pre></div>
<p>Here&#8217;s the&nbsp;output:</p>
<pre class="code literal-block">
MIXIN OUTPUT
From V
From M1
From M2
From MIXIN
INHERITANCE OUTPUT
From V
From M1V
From M2M1V
From INHERITANCE
</pre>
<p>Notice when each message is printed: Because x() first calls its <tt class="docutils literal">super()</tt> method
and then it prints the message in both cases first the <tt class="docutils literal">From V</tt> message is printed
from the base class and then from the following classes in the hierarchy (as per the <span class="caps">MRO</span>)
ending with the class of the instance (either <tt class="docutils literal"><span class="caps">MIXIN</span></tt> or <tt class="docutils literal"><span class="caps">INHERITANCE</span></tt>). Also the
print order is the same in both cases as we&#8217;ve already explained. Please make
sure you understand why the output is like this before&nbsp;continuing.</p>
</div>
<div class="section" id="using-super-in-our-hierarchy">
<h3>Using super in our&nbsp;hierarchy</h3>
<p>Using super and mixins it is easy to mix and match functionality to create new
classes. Of course, super can be used without mixins when overriding a method from
a class you inherit from and want to also call your ancestor&#8217;s&nbsp;method.</p>
<p>Here&#8217;s how we could add a prefix to the&nbsp;header:</p>
<div class="highlight"><pre><span></span><span class="k">class</span><span class="w"> </span><span class="nc">HeaderPrefixMixin</span><span class="p">:</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">get_header</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="p">):</span>
        <span class="k">return</span> <span class="s2">&quot;PREFIX: &quot;</span> <span class="o">+</span> <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">get_header</span><span class="p">()</span>
</pre></div>
<p>and here&#8217;s how it could be&nbsp;used:</p>
<div class="highlight"><pre><span></span><span class="k">class</span><span class="w"> </span><span class="nc">HeaderPrefixBetterCustomClassView</span><span class="p">(</span><span class="n">mixins</span><span class="o">.</span><span class="n">HeaderPrefixMixin</span><span class="p">,</span> <span class="n">BetterCustomClassView</span><span class="p">):</span>
    <span class="n">header</span><span class="o">=</span><span class="s1">&#39;Hello!&#39;</span>
</pre></div>
<p>This will retrieve the header from the ancestor and properly print the header displaying both <span class="caps">PREFIX</span> and Hello.
What if we wanted to re-use the default header mixin? First let&#8217;s change <tt class="docutils literal">DefaultHeaderMixin</tt>
to properly use <tt class="docutils literal">super()</tt>:</p>
<div class="highlight"><pre><span></span><span class="k">class</span><span class="w"> </span><span class="nc">DefaultHeaderSuperMixin</span><span class="p">:</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">get_header</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="p">):</span>
        <span class="k">return</span> <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">get_header</span><span class="p">()</span> <span class="k">if</span> <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">get_header</span><span class="p">()</span> <span class="k">else</span> <span class="s2">&quot;DEFAULT HEADER&quot;</span>
</pre></div>
<div class="highlight"><pre><span></span><span class="k">class</span><span class="w"> </span><span class="nc">HeaderPrefixDefaultBetterCustomClassView</span><span class="p">(</span><span class="n">mixins</span><span class="o">.</span><span class="n">HeaderPrefixMixin</span><span class="p">,</span> <span class="n">mixins</span><span class="o">.</span><span class="n">DefaultHeaderSuperMixin</span><span class="p">,</span> <span class="n">BetterCustomClassView</span><span class="p">):</span>
    <span class="k">pass</span>
</pre></div>
<p>Notice the order of the ancestor classes. The <tt class="docutils literal">get_header()</tt> of  <tt class="docutils literal">HeaderPrefixMixin</tt> will be called which
will call the <tt class="docutils literal">get_header()</tt> of
<tt class="docutils literal">DefaultHeaderSuperMixin</tt> (which will call the <tt class="docutils literal">get_header()</tt> of <tt class="docutils literal">BetterCustomClassView</tt> returning <tt class="docutils literal">None</tt>).
So the result will be <tt class="docutils literal">&quot;<span class="caps">PREFIX</span>: <span class="caps">DEFAULT</span> <span class="caps">HEADER</span>&quot;</tt>. However if instead we had defined this class&nbsp;like</p>
<div class="highlight"><pre><span></span><span class="k">class</span><span class="w"> </span><span class="nc">HeaderPrefixDefaultBetterCustomClassView</span><span class="p">(</span><span class="n">mixins</span><span class="o">.</span><span class="n">DefaultHeaderSuperMixin</span><span class="p">,</span> <span class="n">mixins</span><span class="o">.</span><span class="n">HeaderPrefixMixin</span><span class="p">,</span> <span class="n">BetterCustomClassView</span><span class="p">):</span>
    <span class="k">pass</span>
</pre></div>
<p>the result would be <tt class="docutils literal">&quot;<span class="caps">PREFIX</span>: &quot;</tt> (<span class="caps">DEFAULT</span> <span class="caps">HEADER</span> won&#8217;t be printed). Can you understand&nbsp;why?</p>
<p>One thing to keep in mind is that most probably you&#8217;ll need to call <tt class="docutils literal">super()</tt> and return its output when you override a method.
Even if you think that you don&#8217;t need to call it for this view or mixin, you may need it later from some other view or mixin that
inherits from this view. Also notice that <tt class="docutils literal">super()</tt> may not return anything but may have some
side-effects in your class (for example set a <tt class="docutils literal">self</tt> attribute) which you won&#8217;t get if you don&#8217;t call&nbsp;it!</p>
<p>For another example of super, let&#8217;s define a couple of mixins that add things to the&nbsp;context:</p>
<div class="highlight"><pre><span></span><span class="k">class</span><span class="w"> </span><span class="nc">ExtraContext1Mixin</span><span class="p">:</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">get_context</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="p">):</span>
        <span class="n">ctx</span> <span class="o">=</span> <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">get_context</span><span class="p">()</span>
        <span class="n">ctx</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;data1&#39;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">ctx</span>


<span class="k">class</span><span class="w"> </span><span class="nc">ExtraContext2Mixin</span><span class="p">:</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">get_context</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="p">):</span>
        <span class="n">ctx</span> <span class="o">=</span> <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">get_context</span><span class="p">()</span>
        <span class="n">ctx</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="s1">&#39;data2&#39;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">ctx</span>
</pre></div>
<p>The first one retrieves the ancestor context list and appends <tt class="docutils literal">'data1'</tt> to the
it while the second one will insert <tt class="docutils literal">'data2'</tt> to the start of the list. To use
these mixins just add them to the ancestor list of your class hierarchy as usually.
One interesting thing to notice here is that because of how <tt class="docutils literal">get_context</tt> is
defined we&#8217;ll get the same output no matter the order of the mixins in the hierarchy
since <tt class="docutils literal">ExtraContext1Mixin</tt> will append <tt class="docutils literal">data1</tt> to the end of the context list and
the <tt class="docutils literal">ExtraContext2Mixin</tt> will insert <tt class="docutils literal">data2</tt> to the start of the context&nbsp;list.</p>
<div class="highlight"><pre><span></span><span class="k">class</span><span class="w"> </span><span class="nc">ExtraContext12BetterCustomClassView</span><span class="p">(</span><span class="n">mixins</span><span class="o">.</span><span class="n">ExtraContext1Mixin</span><span class="p">,</span> <span class="n">mixins</span><span class="o">.</span><span class="n">ExtraContext2Mixin</span><span class="p">,</span> <span class="n">BetterCustomClassView</span><span class="p">):</span>
    <span class="k">pass</span>

<span class="k">class</span><span class="w"> </span><span class="nc">ExtraContext21BetterCustomClassView</span><span class="p">(</span><span class="n">mixins</span><span class="o">.</span><span class="n">ExtraContext2Mixin</span><span class="p">,</span> <span class="n">mixins</span><span class="o">.</span><span class="n">ExtraContext1Mixin</span><span class="p">,</span> <span class="n">BetterCustomClassView</span><span class="p">):</span>
    <span class="k">pass</span>
</pre></div>
<p>If instead both of these mixins appended the item to the end of the list, then
the output would be different depending on the ancestor order.
Of course, since we&#8217;ve already defined <tt class="docutils literal">HeaderPrefixMixin</tt> and <tt class="docutils literal">DefaultHeaderSuperMixin</tt> nothing stops us
from using all those mixins&nbsp;together!</p>
<div class="highlight"><pre><span></span><span class="k">class</span><span class="w"> </span><span class="nc">AllTogetherNowBetterCustomClassView</span><span class="p">(</span>
        <span class="n">mixins</span><span class="o">.</span><span class="n">HeaderPrefixMixin</span><span class="p">,</span>
        <span class="n">mixins</span><span class="o">.</span><span class="n">DefaultHeaderSuperMixin</span><span class="p">,</span>
        <span class="n">mixins</span><span class="o">.</span><span class="n">ExtraContext1Mixin</span><span class="p">,</span>
        <span class="n">mixins</span><span class="o">.</span><span class="n">ExtraContext2Mixin</span><span class="p">,</span>
        <span class="n">BetterCustomClassView</span>
    <span class="p">):</span>
    <span class="k">pass</span>
</pre></div>
<p>This will have the desired behaviour of adding a prefix to the header, having a default header if not one was defined
and adding the extra context from both&nbsp;mixins!</p>
</div>
<div class="section" id="testing-all-this">
<h3>Testing all&nbsp;this</h3>
<p>In the accompanying project at <a class="reference external" href="https://github.com/spapas/cbv-tutorial">https://github.com/spapas/cbv-tutorial</a> you can take a look at how this
custom <span class="caps">CBV</span> hierarchy works by running it and taking a look at the <tt class="docutils literal">core</tt> project (visit <a class="reference external" href="http://127.0.0.1:8001/non-django-cbv/">http://127.0.0.1:8001/non-django-cbv/</a>).
There you can take a look at the views.py and mixins.py to see all the views and mixins we&#8217;ve discussed in this&nbsp;chapter.</p>
</div>
</div>
<div class="section" id="a-high-level-overview-of-cbvs">
<h2>A high level overview of&nbsp;CBVs</h2>
<p>After the previous rather long (but I hope gentle enough) introduction to implementing
our own class based view hierarchy using inheritance, mixins, <span class="caps">MRO</span>, method overriding
and <tt class="docutils literal">super</tt> we can now start talking about the Django Class Based Views (CBVs). Our
guide will be the <a class="reference external" href="http://ccbv.co.uk`"><span class="caps">CBV</span> inspector</a> application which displays all classes and mixins
that Django CBVs are using along with their methods and attributes. Using this application
and after reading this article you should be able to quickly and definitely know
which method or attribute you need to define to each one of your mixins or&nbsp;views.</p>
<p>To use <span class="caps">CBV</span> inspector, just click on a class name (for example <tt class="docutils literal">CreateView</tt>); you will
immediately see its <span class="caps">MRO</span> ancestors, its list of attributes (and the ancestor class that defines
each one) and finally a list of methods that this class and all its ancestors define.
Of course when a method is defined by multiple classes the <span class="caps">MRO</span> ordering will be used -
super is used when the functionality of the ancestor classes is also used. The <span class="caps">CBV</span>
inspector (and our project) has Python 3 syntax. If you want to follow along with
Python 2 (I don&#8217;t recommend it though since Django 2.0 only supports Python 3.x) use the following
syntax to call super for method <tt class="docutils literal">x()</tt>:</p>
<div class="highlight"><pre><span></span><span class="nb">super</span><span class="p">(</span><span class="n">ClassName</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">x</span><span class="p">()</span>
</pre></div>
<p>this is the same as&nbsp;calling</p>
<div class="highlight"><pre><span></span><span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">x</span><span class="p">()</span>
</pre></div>
<p>in Python&nbsp;3.x.</p>
<div class="section" id="taking-a-look-at-the-view">
<h3>Taking a look at the&nbsp;View</h3>
<p>In any case, our travel starts from the central <span class="caps">CBV</span> class which is (intuitively) called &#8230; <a class="reference external" href="https://ccbv.co.uk/View">View</a>!</p>
<p>This class is used as the base in Django&#8217;s <span class="caps">CBV</span> hierarchy (similar to how  <tt class="docutils literal">CustomClassView</tt>
was used in our own hierarchy). It has only one attribute
(<tt class="docutils literal">http_method_names</tt>) and a very small number of methods. The most important method is the
<tt class="docutils literal">as_view</tt> class method (which is similar to the one we defined in the previous section).
The <tt class="docutils literal">as_view</tt> will instantiate an instance object of the <tt class="docutils literal">View</tt> class
(actually the class that inherits from <tt class="docutils literal">View</tt>) and use this object to properly generate a functional&nbsp;view.</p>
<p>The <tt class="docutils literal">View</tt> class cannot be used as it is
but it must be inherited by a child class. The child class needs to define a method
that has the same name as each http method that is supported - for example if
only <span class="caps">HTTP</span> <span class="caps">GET</span> and <span class="caps">HTTP</span> <span class="caps">POST</span> are supported then the inherited class must define a
<tt class="docutils literal">get</tt> and a <tt class="docutils literal">post</tt> method; these methods are called from the functional view
through a method called <tt class="docutils literal">dispatch</tt> and need to return a proper response object. So,
we have two central methods here: The <tt class="docutils literal">as_view</tt> class method that creates the
object instance and returns its view function and <tt class="docutils literal">dispatch</tt> that will call
the proper named class method depending on the <span class="caps">HTTP</span> method (i.e post, get, put
etc). One thing to keep from this discussion is that you shouldn&#8217;t ever need to
mess with <tt class="docutils literal">as_view</tt> but, because <tt class="docutils literal">dispatch</tt> is the only instance method that is
guaranteed to run every time the class based view will run, you will frequently
need to override it especially to control access&nbsp;control.</p>
<p>As an example, we can implemented the <tt class="docutils literal">BetterCustomClassView</tt> from the first
section using <tt class="docutils literal">View</tt> as its&nbsp;ancestor:</p>
<div class="highlight"><pre><span></span><span class="k">class</span><span class="w"> </span><span class="nc">DjangoBetterCustomClassView</span><span class="p">(</span><span class="n">View</span><span class="p">,</span> <span class="p">):</span>
    <span class="n">header</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
    <span class="n">context</span> <span class="o">=</span><span class="s1">&#39;&#39;</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">get_header</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">header</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">header</span> <span class="k">else</span> <span class="s2">&quot;&quot;</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">get_context</span><span class="p">(</span><span class="bp">self</span> <span class="p">,</span> <span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">context</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">context</span> <span class="k">else</span> <span class="p">[]</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">render_context</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">context</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_context</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">context</span><span class="p">:</span>
            <span class="k">return</span> <span class="s1">&#39;&lt;br /&gt;&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">context</span><span class="p">)</span>
        <span class="k">return</span> <span class="s2">&quot;&quot;</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">get</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="n">resp</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;</span>
<span class="s2">            &lt;html&gt;</span>
<span class="s2">                &lt;body&gt;</span>
<span class="s2">                    &lt;h1&gt;</span><span class="si">{header}</span><span class="s2">&lt;/h1&gt;</span>
<span class="s2">                    </span><span class="si">{body}</span>
<span class="s2">                &lt;/body&gt;</span>
<span class="s2">            &lt;/html&gt;</span>
<span class="s2">        &quot;&quot;&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                <span class="n">header</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">get_header</span><span class="p">(),</span> <span class="n">body</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">render_context</span><span class="p">(),</span>
            <span class="p">)</span>
        <span class="k">return</span> <span class="n">HttpResponse</span><span class="p">(</span><span class="n">resp</span><span class="p">)</span>
</pre></div>
<p>This method won&#8217;t print anything but of course it could use the mixins from
before to have some default&nbsp;values:</p>
<div class="highlight"><pre><span></span><span class="k">class</span><span class="w"> </span><span class="nc">DefaultHeaderContextDjangoBetterCustomClassView</span><span class="p">(</span><span class="n">DefaultHeaderMixin</span><span class="p">,</span> <span class="n">DefaultContextMixin</span><span class="p">,</span> <span class="n">DjangoBetterCustomClassView</span><span class="p">):</span>
    <span class="k">pass</span>
</pre></div>
<p>Of course instead of using our mixins and render methods it would be much better
to use the proper ones defined by Django - that&#8217;s what we&#8217;re going to do from
now on I just wanted to make clear that there&#8217;s nothing special in Django&#8217;s <span class="caps">CBV</span>
hierarchy and can be overridden as we&#8217;d&nbsp;like.</p>
</div>
<div class="section" id="redirectview-and-templateview">
<h3>RedirectView and&nbsp;TemplateView</h3>
<p>Continuing our tour of Django CBVs I&#8217;d like to talk a little about the classes
that the <span class="caps">CBV</span> Inspector puts in the same level as <tt class="docutils literal">View</tt> (<span class="caps">GENERIC</span> <span class="caps">BASE</span>):
<a class="reference external" href="https://docs.djangoproject.com/en/2.0/ref/class-based-views/base/#redirectview">RedirectView</a> and <a class="reference external" href="https://docs.djangoproject.com/en/2.0/ref/class-based-views/base/#templateview">TemplateView</a>. Both inherit directly from <tt class="docutils literal">View</tt> and, the
first one defines a <tt class="docutils literal">get</tt> method that returns a redirect to another page
while the latter one renders and returns a Django template in the <tt class="docutils literal">get</tt>
method.</p>
<p>The <tt class="docutils literal">RedirectView</tt> inherits directly from view and has attributes like <tt class="docutils literal">url</tt>
(to use a static url)
or <tt class="docutils literal">pattern_name</tt> (to use one of the patterns define in your urls.py)
to define where it should redirect. These attributes are
used by the <tt class="docutils literal">get_redirect_url</tt> which will generate the actual url to redirect
to and can be overriden for example to redirect to a different location depending
on the current&nbsp;user.</p>
<p>The <tt class="docutils literal">TemplateView</tt> on the other hand inherits from <tt class="docutils literal">View</tt> and two more classes (actually
these are mixins) beyond <tt class="docutils literal">View</tt>: <tt class="docutils literal">TemplateResponseMixin</tt> and
<tt class="docutils literal">ContextMixin</tt>. If you take a look at them you&#8217;ll see that the
<tt class="docutils literal">TemplateResponseMixin</tt> defines some template-related attributes (most important being
the <tt class="docutils literal">template_name</tt>) and two
methods: One that retrieves the template that will be used to render this View
(<tt class="docutils literal">get_template_names</tt>)
and one that actually renders the template (<tt class="docutils literal">render_to_response</tt>) using a
<a class="reference external" href="https://docs.djangoproject.com/en/2.0/ref/template-response/#django.template.response.TemplateResponse">TemplateResponse</a> instance. The
<tt class="docutils literal">ContextMixin</tt> provides the <tt class="docutils literal">get_context_data</tt> that is
passed to the template to be rendered and should be overridden if you want to
pass more context&nbsp;variables.</p>
<p>We can already see many opportunities of reusing and overriding
functionality and improving our <span class="caps">DRY</span> score, for example: Create a catch all RedirectView
that depending on the remainder of the url it will redirect to a different page,
create a mixin that appends some things to the context of all CBVs using it, use dynamic templates
based on some other condition (that&#8217;s actually what Detail/List/UpdateView
are doing), render a template to a different output than Html (for example a
text file) etc. I&#8217;ll try to present examples for these in the next&nbsp;section.</p>
</div>
<div class="section" id="the-formview">
<h3>The&nbsp;FormView</h3>
<p>The next view we&#8217;re going to talk about is <a class="reference external" href="https://docs.djangoproject.com/en/2.0/ref/class-based-views/generic-editing/#formview">FormView</a>. This is a view that can be
used whenever we want to display a form (<em>not</em> a form related to a Model i.e for
Create/Update/Delete, for these cases there are specific CBVs we&#8217;ll see later).
It is interesting to take a look at the list of its
ancestors: <tt class="docutils literal">TemplateResponseMixin</tt>, <tt class="docutils literal">BaseFormView</tt>, <tt class="docutils literal">FormMixin</tt>, <tt class="docutils literal">ContextMixin</tt>, <tt class="docutils literal">ProcessFormView</tt> and <tt class="docutils literal">View</tt>.
We are familiar with <tt class="docutils literal">TemplateResponseMixin</tt>, <tt class="docutils literal">ContextMixin</tt> and <tt class="docutils literal">View</tt> but not with
the others. Before discussing these classes let&#8217;s take a look at the FormView
hierarchy, courtesy of <a class="reference external" href="http://ccbv.co.uk">http://ccbv.co.uk</a> and <a class="reference external" href="http://yuml.me">http://yuml.me</a>:</p>
<img src="https://yuml.me/diagram/plain;/class/[TemplateResponseMixin%7Bbg:white%7D]%5E-[FormView%7Bbg:green%7D],%20[BaseFormView%7Bbg:white%7D]%5E-[FormView%7Bbg:green%7D],%20[FormMixin%7Bbg:white%7D]%5E-[BaseFormView%7Bbg:white%7D],%20[ContextMixin%7Bbg:white%7D]%5E-[FormMixin%7Bbg:white%7D],%20[ProcessFormView%7Bbg:white%7D]%5E-[BaseFormView%7Bbg:white%7D],%20[View%7Bbg:lightblue%7D]%5E-[ProcessFormView%7Bbg:white%7D].svg" alt="FormView"><p>The above diagram should make everything easier: The <tt class="docutils literal">FormMixin</tt> inherits
from <tt class="docutils literal">ContextMixin</tt> and overrides its <tt class="docutils literal">get_context_data</tt> method to add the
form to the view. Beyond this, it adds some attributes and methods for proper form handling, for
example the <tt class="docutils literal">form_class</tt> (attribute when the form class will be the same always) and
<tt class="docutils literal">get_form_class()</tt> (method when the form class will be dynamic for example
depending on the logged in user), <tt class="docutils literal">initial</tt> and <tt class="docutils literal">get_initial()</tt> (same logic as before for
the form&#8217;s initial values), <tt class="docutils literal">form_valid()</tt> and <tt class="docutils literal">form_invalid()</tt> to define
what should happen when the form is valid or invalid, <tt class="docutils literal">get_form_kwargs</tt> to pass
some keyword arguments to the form&#8217;s constructor etc. Notice that FormMixin
does not define any form handling logic (i.e check if the form is valid and call
its <tt class="docutils literal">form_valid()</tt> method) &#8212; this logic is defined in the <tt class="docutils literal">ProcessFormView</tt>
which inherits from <tt class="docutils literal">View</tt> and defines proper <tt class="docutils literal">get()</tt> (just render the form)
and <tt class="docutils literal">post()</tt> (check if the form is valid and call <tt class="docutils literal">form_valid</tt> else call <tt class="docutils literal">form_invalid</tt>)&nbsp;methods.</p>
<p>One interesting here is to notice here is that Django defines both the <tt class="docutils literal">FormMixin</tt> and <tt class="docutils literal">ProcessFormView</tt>.
The <tt class="docutils literal">FormMixin</tt> offers the basic Form elements (the form class, initial data
etc) and could be re-used in a different flow beyond the one offered by
<tt class="docutils literal">ProcessFormView</tt> (for example display the form as a <span class="caps">JSON</span> object instead of a
Django template). On the other hand, <tt class="docutils literal">ProcessFormView</tt> is required in order to
define the <tt class="docutils literal">get</tt> and <tt class="docutils literal">post</tt> methods that are needed from the <tt class="docutils literal">View</tt>. These
methods can&#8217;t be overridden in the FormMixin since that would mean that the mixin
would behave as a&nbsp;view!</p>
<p>Finally, the <tt class="docutils literal">BaseFormView</tt> class is used to
inherit from <tt class="docutils literal">ProcessFormView</tt> and <tt class="docutils literal">FormMixin</tt>. It does not do anything
more than providing a base class that other classes that want to use the form
functionality (i.e both the <tt class="docutils literal">ProcessFormView</tt> and <tt class="docutils literal">FormMixin</tt>) will inherit&nbsp;from.</p>
</div>
<div class="section" id="the-listview-and-detailview">
<h3>The ListView and&nbsp;DetailView</h3>
<p>Next in our Django <span class="caps">CBV</span> tour is the <a class="reference external" href="https://docs.djangoproject.com/en/2.0/ref/class-based-views/generic-display/#listview">ListView</a>. The <tt class="docutils literal">ListView</tt> is used to render multiple
objects in a template, for example in a list or table. Here&#8217;s a diagram of the class
hierarchy (courtesy of <a class="reference external" href="http://ccbv.co.uk">http://ccbv.co.uk</a> and <a class="reference external" href="http://yuml.me">http://yuml.me</a>):</p>
<img src="https://yuml.me/diagram/plain;/class/[MultipleObjectTemplateResponseMixin%7Bbg:white%7D]%5E-[ListView%7Bbg:green%7D],%20[TemplateResponseMixin%7Bbg:white%7D]%5E-[MultipleObjectTemplateResponseMixin%7Bbg:white%7D],%20[BaseListView%7Bbg:white%7D]%5E-[ListView%7Bbg:green%7D],%20[MultipleObjectMixin%7Bbg:white%7D]%5E-[BaseListView%7Bbg:white%7D],%20[ContextMixin%7Bbg:white%7D]%5E-[MultipleObjectMixin%7Bbg:white%7D],%20[View%7Bbg:lightblue%7D]%5E-[BaseListView%7Bbg:white%7D].svg" alt="ListView"><p>The <tt class="docutils literal">MultipleObjectMixin</tt> is used make a query to the database (either using a
model or a queryset) and pass the results to the context. It also supports
custom ordering (<tt class="docutils literal">get_ordering()</tt>) and pagination (<tt class="docutils literal">paginate_queryset()</tt>).
However, the most important method of this mixin is <tt class="docutils literal">get_queryset()</tt>. This
method checks to see if the <tt class="docutils literal">queryset</tt> or <tt class="docutils literal">model</tt> attribute are defined
(<tt class="docutils literal">queryset</tt> will be checked first so it has priority if both are defined) and
returns a queryset result (taking into account the ordering). This queryset
result will be used by the <tt class="docutils literal">get_context_data()</tt> method of this mixin to
actually put it to the context by saving to a context variable named <tt class="docutils literal">object_list</tt>.
Notice that you can set the <tt class="docutils literal">context_object_name</tt> attribute to add and extra
another variable to the context with the queryset beyond <tt class="docutils literal">object_list</tt> (for
example if you have an <tt class="docutils literal">ArticleLsitView</tt> you can set <tt class="docutils literal">context_object_name = articles</tt> to
be able to do <tt class="docutils literal">{% for article in articles %}</tt> in your context instead of
<tt class="docutils literal">{% for article in object_list %}</tt>).</p>
<p>The <tt class="docutils literal">MultipleObjectMixin</tt> can be used and
overridden when we need to put multiple objects in a View. This mixin is
inherited (along with <tt class="docutils literal">View</tt>) from <tt class="docutils literal">BaseListView</tt> that adds a proper <tt class="docutils literal">get</tt>
method to call <tt class="docutils literal">get_context_data</tt> and pass the result to the&nbsp;template.</p>
<p>As we can also see, Django uses the <tt class="docutils literal">MultipleObjectTemplateResponseMixin</tt> that
inherits from <tt class="docutils literal">TemplateResponseMixin</tt> to render the template. This mixin does
some magic with the queryset or model to define a
template name (so you won&#8217;t need to define it yourself) - that&#8217;s from where the
<tt class="docutils literal">app_label/app_model_list.html</tt> default template name is&nbsp;created.</p>
<p>Similar to the <tt class="docutils literal">ListView</tt> is the <a class="reference external" href="https://docs.djangoproject.com/en/2.0/ref/class-based-views/generic-display/#detailview">DetailView</a> which has the same class hierarchy as the <tt class="docutils literal">ListView</tt> with two differences:
It uses <tt class="docutils literal">SingleObjectMixin</tt> instead of <tt class="docutils literal">MultipleOjbectMixin</tt>,
<tt class="docutils literal">SingleObjectTemplateResponseMixin</tt> instead of <tt class="docutils literal">MultipleObjectTemplateResponseMixin</tt>
and <tt class="docutils literal">BaseDetailView</tt> instead of <tt class="docutils literal">BaseListView</tt>. The
<tt class="docutils literal">SingleObjectMixin</tt> will use the <tt class="docutils literal">get_queryset()</tt> (in a similar manner to the <tt class="docutils literal">get_queryset()</tt> of
<tt class="docutils literal">MultipleObjectMixin</tt>) method to return a single object (so all attributes and methods
concerning ordering or pagination are missing) but instead has the <tt class="docutils literal">get_object()</tt> method which
will pick and return a single object from that queryset (using a <tt class="docutils literal">pk</tt> or <tt class="docutils literal">slug</tt> parameter). This object
will be put to the context of this view by the <tt class="docutils literal">get_context_data</tt>. The <tt class="docutils literal">BaseDetailView</tt> just
defines a proper <tt class="docutils literal">get</tt> to call the <tt class="docutils literal">get_context_data</tt> (of <tt class="docutils literal">SingleObjectMixin</tt>) and finally
the <tt class="docutils literal">SingleObjectTemplateResponseMixin</tt> will automatically generate the template name (i.e generate
<tt class="docutils literal">app_label/app_model_detail.html</tt>).</p>
</div>
<div class="section" id="the-createview">
<h3>The&nbsp;CreateView</h3>
<p>The next Django <span class="caps">CBV</span> we&#8217;ll talk about is <a class="reference external" href="https://docs.djangoproject.com/en/2.0/ref/class-based-views/generic-display/#createview">CreateView</a>. This class is used to create a new instance
of a model. It has a rather complex hierarchy diagram but we&#8217;ve already discussed most of these&nbsp;classes:</p>
<img src="https://yuml.me/diagram/plain;/class/[SingleObjectTemplateResponseMixin%7Bbg:white%7D]%5E-[CreateView%7Bbg:green%7D],%20[TemplateResponseMixin%7Bbg:white%7D]%5E-[SingleObjectTemplateResponseMixin%7Bbg:white%7D],%20[BaseCreateView%7Bbg:white%7D]%5E-[CreateView%7Bbg:green%7D],%20[ModelFormMixin%7Bbg:white%7D]%5E-[BaseCreateView%7Bbg:white%7D],%20[FormMixin%7Bbg:white%7D]%5E-[ModelFormMixin%7Bbg:white%7D],%20[ContextMixin%7Bbg:white%7D]%5E-[FormMixin%7Bbg:white%7D],%20[SingleObjectMixin%7Bbg:white%7D]%5E-[ModelFormMixin%7Bbg:white%7D],%20[ContextMixin%7Bbg:white%7D]%5E-[SingleObjectMixin%7Bbg:white%7D],%20[ProcessFormView%7Bbg:white%7D]%5E-[BaseCreateView%7Bbg:white%7D],%20[View%7Bbg:lightblue%7D]%5E-[ProcessFormView%7Bbg:white%7D].svg" /><p>As we can see the <tt class="docutils literal">CreateView</tt> inherits from <tt class="docutils literal">BaseCreateView</tt> and <tt class="docutils literal">SingleObjectTemplateResponseMixin</tt>. The
<tt class="docutils literal">SingleObjectTemplateResponseMixin</tt> is mainly used to define the template names that will be searched for
(i.e <tt class="docutils literal">app_label/app_model_form.html</tt>), while the <tt class="docutils literal">BaseCreateView</tt>
is used to combine the functionality of <tt class="docutils literal">ProcessFormView</tt> (that handles the basic form workflow as we have
already discussed) and <tt class="docutils literal">ModelFormMixin</tt>. The <tt class="docutils literal">ModelFormMixin</tt> is a rather complex mixin that inherits from
both <tt class="docutils literal">SingleObjectMixin</tt> and <tt class="docutils literal">FormMixin</tt>. The <tt class="docutils literal">SingleObjectMixin</tt> functionality is not really used by <tt class="docutils literal">CreateView</tt>
(since no object will need to be retrieved for the <tt class="docutils literal">CreateView</tt>) however the <tt class="docutils literal">ModelFormMixin</tt> is also used
by <tt class="docutils literal">UpdateView</tt> that&#8217;s why <tt class="docutils literal">ModelFormMixin</tt> also inherits from it (to retrieve the object that will be&nbsp;updated).</p>
<p><tt class="docutils literal">ModelFormMixin</tt> mixin adds functionality
for handling forms related to models and object instances. More specifically it adds functionality for:
* creating a form class (if one is not provided) by the configured model / queryset. If you don&#8217;t provide the form class (by using the <tt class="docutils literal">form_class</tt> attribute) then you need to configure the fields that the generated form will display by passing an array of field names through the <tt class="docutils literal">fields</tt> attribute
* overrides the <tt class="docutils literal">form_valid</tt> in order to save the object instance of the form
* fixes <tt class="docutils literal">get_success_url</tt> to redirect to the saved object&#8217;s absolute_url when the object is saved
* pass the current object to be updated (that was retrieving through the <tt class="docutils literal">SingleObjectMixin</tt>) -if there is a current object- to the form as the <tt class="docutils literal">instance</tt> attribute</p>
</div>
<div class="section" id="the-updateview-and-deleteview">
<h3>The UpdateView and&nbsp;DeleteView</h3>
<p>The <a class="reference external" href="https://docs.djangoproject.com/en/2.0/ref/class-based-views/generic-display/#updateview">UpdateView</a> class is almost identical to the <tt class="docutils literal">CreateView</tt> - the only difference is that
<tt class="docutils literal">UpdateView</tt> inherits from <tt class="docutils literal">BaseUpdateView</tt> (and <tt class="docutils literal">SingleObjectTemplateResponseMixin</tt>) instead
of <tt class="docutils literal">BaseCreateView</tt>.  The <tt class="docutils literal">BaseUpdateView</tt> overrides the <tt class="docutils literal">get</tt> and <tt class="docutils literal">post</tt> methods of
<tt class="docutils literal">ProcessFormView</tt> to retrieve the object (using <tt class="docutils literal">SingleObjectMixin</tt>&#8216;s <tt class="docutils literal">get_object()</tt>)
and assign it to an instance variable - this will then be picked up by the <tt class="docutils literal">ModelFormMixin</tt> and used
properly in the form as explained before. One thing I notice here is that it seems that the hierarchy would
be better if the <tt class="docutils literal">ModelFormMixin</tt> inherited <em>only</em> from <tt class="docutils literal">FormMixin</tt> (instead of both from
<tt class="docutils literal">FormMixin</tt> and <tt class="docutils literal">SingleObjectMixin</tt>) and <tt class="docutils literal">BaseUpdateView</tt> inheriting from <tt class="docutils literal">ProcessFormView</tt>,
<tt class="docutils literal">ModelForMixin</tt> <em>and</em> <tt class="docutils literal">SingleObjectMixin</tt>. This way the <tt class="docutils literal">BaseCreateView</tt> wouldn&#8217;t get the
non-needed <tt class="docutils literal">SingleObjectMixin</tt> functionality. I am not sure why Django is implemented this way
(i.e the <tt class="docutils literal">ModelFormMixin</tt> also inheriting from <tt class="docutils literal">SingleObjectMixin</tt> thus passing this non-needed
functionality to <tt class="docutils literal">BaseCreateView</tt>) &#8212; if a reader has a clue I&#8217;d like to know&nbsp;it.</p>
<p>In any way, I&#8217;d like to also present the <a class="reference external" href="https://docs.djangoproject.com/en/2.0/ref/class-based-views/generic-display/#deleteview">DeleteView</a> which is more or less the same as the <a class="reference external" href="https://docs.djangoproject.com/en/2.0/ref/class-based-views/generic-display/#detailview">DetailView</a>
with the addition of the <tt class="docutils literal">DeleteMixin</tt> in the mix. The <tt class="docutils literal">DeleteMixin</tt> adds a <tt class="docutils literal">post()</tt> method
that will delete the object when called and makes <tt class="docutils literal">success_url</tt> required (since there would be no
object to redirect to after this view is&nbsp;posted).</p>
</div>
<div class="section" id="access-control-mixins">
<h3>Access control&nbsp;mixins</h3>
<p>Another small hierarchy of class based views (actually these are all mixins) are the authentication ones which
can be used to control access to a view.
These are <tt class="docutils literal">AcessMixin</tt>, <tt class="docutils literal">LoginRequiredMixin</tt>, <tt class="docutils literal">PermissionRequiredMixin</tt> and <tt class="docutils literal">UserPassesTestMixin</tt>.
The <tt class="docutils literal">AccessMixin</tt> provides some basic functionality (i.e what to do when the user does not have access
to the view, find out the login url to redirect him etc) and is used as a base for the other three. These
three override the <tt class="docutils literal">dispatch()</tt> method of <tt class="docutils literal">View</tt> to check if the user has the specific rights (i.e
if he has logged in for <tt class="docutils literal">LoginRequiredMixin</tt>, if he has the defined permissions for <tt class="docutils literal">PermissionRequiredMixin</tt>
or if he passes the provided test in <tt class="docutils literal">UserPassesTextMixin</tt>). If the user has the rights the view will proceed
as normally (call super&#8217;s dispatch) else the access denied functionality from <tt class="docutils literal">AccessMixin</tt> will be&nbsp;implemented.</p>
</div>
<div class="section" id="some-other-cbvs">
<h3>Some other&nbsp;CBVs</h3>
<p>Beyond the class based views I discussed in this section, Django also has a bunch of CBVs related
to account views (<tt class="docutils literal">LoginView</tt>, <tt class="docutils literal">LogoutView</tt>, <tt class="docutils literal">PasswordChangeView</tt> etc) and Dates (<tt class="docutils literal">DateDetailView</tt>, <tt class="docutils literal">YearArchiveView</tt> etc).
I won&#8217;t go into detail about these since they follow the same concepts and use most of the mixins
we&#8217;ve discussed before. Using the <span class="caps">CBV</span> Inspector you should be able to follow along and decide the methods you need
to override for your&nbsp;needs.</p>
<p>Also, most well written Django packages will define their own CBVs that inherit
from the Django CBVs - with the knowledge you acquired here you will be able to follow along on their source code to understand how everything&nbsp;works.</p>
</div>
</div>
<div class="section" id="real-world-use-cases">
<h2>Real world use&nbsp;cases</h2>
<p>In this section I am going to present a number of use cases demonstrating the usefulness of Django CBVs. In most of
these examples I am going to override one of the methods of the mixins I discussed in the previous section. There
are <em>two</em> methods you can use for integrating the following use cases to your&nbsp;application.</p>
<p>Create your own class inheriting from one of the Django CBVs and add to it directly the method to override. For example,
if you wanted to override the <tt class="docutils literal">get_queryset()</tt> method a <tt class="docutils literal">ListView</tt> you would do&nbsp;a:</p>
<div class="highlight"><pre><span></span><span class="k">class</span><span class="w"> </span><span class="nc">GetQuerysetOverrideListView</span><span class="p">(</span><span class="n">ListView</span><span class="p">):</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">get_queryset</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">qs</span> <span class="o">=</span> <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">get_queryset</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">qs</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">status</span><span class="o">=</span><span class="s1">&#39;PUBLISHED&#39;</span><span class="p">)</span>
</pre></div>
<p>This is useful if you know that you aren&#8217;t going to need the overriden <tt class="docutils literal">get_queryset</tt> functionality to a different
method and following the <span class="caps">YAGNI</span> principle (or if you know that even if you need it you could inherit from <tt class="docutils literal">GetQuerysetOverrideListView</tt>
i.e in another ListView).
However, if you know that there may be more CBVs that would need their
queryset filtered by <tt class="docutils literal"><span class="pre">status='<span class="caps">PUBLISHED</span>'</span></tt> then you should add a mixin that would be used by your&nbsp;CBVs:</p>
<div class="highlight"><pre><span></span><span class="k">class</span><span class="w"> </span><span class="nc">GetQuerysetOverrideMixin</span><span class="p">:</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">get_queryset</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">qs</span> <span class="o">=</span> <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">get_queryset</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">qs</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">status</span><span class="o">=</span><span class="s1">&#39;PUBLISHED&#39;</span><span class="p">)</span>

<span class="k">class</span><span class="w"> </span><span class="nc">GetQuerysetOverrideListView</span><span class="p">(</span><span class="n">GetQuerysetOverrideMixin</span><span class="p">,</span> <span class="n">ListView</span><span class="p">):</span>
    <span class="k">pass</span>
</pre></div>
<p>Now, one thing that needs some discussion here is that the method <tt class="docutils literal">get_queryset</tt> is provided by a mixin (in fact
it is provided by two mixins: <tt class="docutils literal">MultipleObjectMixin</tt> for <tt class="docutils literal">ListView</tt> and <tt class="docutils literal">SingleObjectMixin</tt> for <tt class="docutils literal">DetailView</tt>,
<tt class="docutils literal">UpdateView</tt> and <tt class="docutils literal">DeleteView</tt>). Because of how <span class="caps">MRO</span> works, I won&#8217;t need to inherit <tt class="docutils literal">GetQuerysetOverrideMixin</tt> from
<tt class="docutils literal">MultipleObjectMixin</tt> (or <tt class="docutils literal">SingleObjectMixin</tt> but let&#8217;s ignore that for now) but I can just inherit from object
and make sure that, as already discussed, put the mixin <em>before</em> (to the left) of the <span class="caps">CBV</span>. Notice that even if I had
defined <tt class="docutils literal">GetQuerysetOverrideMixin</tt> as <tt class="docutils literal">GetQuerysetOverrideMixin(MultipleObjectMixin)</tt> the <tt class="docutils literal">MultipleObjectMixin</tt> class would
be found <em>twice</em> in the <span class="caps">MRO</span> list so only the rightmost instance would remain. So the <span class="caps">MRO</span> for both <tt class="docutils literal">GetQuerysetOverrideMixin(object, )</tt>
and <tt class="docutils literal">GetQuerysetOverrideMixin(MultipleObjectMixin)</tt> <em>would be the same</em>! Also, inheriting directly from object makes
our <tt class="docutils literal">GetQuerysetOverrideMixin</tt> more <span class="caps">DRY</span> since if it inherited from <tt class="docutils literal">MultipleObjectMixin</tt> we&#8217;d need to create <em>another</em>
version of it that would inherit from <tt class="docutils literal">SingleObjectMixin</tt>; this is because <tt class="docutils literal">get_queryset</tt> exists in both these&nbsp;mixins.</p>
<p>For some of the following use cases I am also going to use the following models for user generated content (articles and uploaded&nbsp;files):</p>
<div class="highlight"><pre><span></span><span class="n">STATUS_CHOICES</span> <span class="o">=</span> <span class="p">(</span>
    <span class="p">(</span><span class="s1">&#39;DRAFT&#39;</span><span class="p">,</span> <span class="s1">&#39;Draft&#39;</span><span class="p">,</span> <span class="p">),</span>
    <span class="p">(</span><span class="s1">&#39;PUBLISHED&#39;</span><span class="p">,</span> <span class="s1">&#39;Published&#39;</span><span class="p">,</span> <span class="p">),</span>
    <span class="p">(</span><span class="s1">&#39;REMOVED&#39;</span><span class="p">,</span> <span class="s1">&#39;Removed&#39;</span><span class="p">,</span> <span class="p">),</span>
<span class="p">)</span>


<span class="k">class</span><span class="w"> </span><span class="nc">Category</span><span class="p">(</span><span class="n">models</span><span class="o">.</span><span class="n">Model</span><span class="p">):</span>
    <span class="n">name</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">CharField</span><span class="p">(</span><span class="n">max_length</span><span class="o">=</span><span class="mi">128</span><span class="p">,</span> <span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__str__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span>

    <span class="k">class</span><span class="w"> </span><span class="nc">Meta</span><span class="p">:</span>
        <span class="n">permissions</span> <span class="o">=</span> <span class="p">(</span>
            <span class="p">(</span><span class="s2">&quot;publisher_access&quot;</span><span class="p">,</span> <span class="s2">&quot;Publisher Access&quot;</span><span class="p">),</span>
            <span class="p">(</span><span class="s2">&quot;admin_access&quot;</span><span class="p">,</span> <span class="s2">&quot;Admin Access&quot;</span><span class="p">),</span>
        <span class="p">)</span>


<span class="k">class</span><span class="w"> </span><span class="nc">AbstractGeneralInfo</span><span class="p">(</span><span class="n">models</span><span class="o">.</span><span class="n">Model</span><span class="p">):</span>
    <span class="n">status</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">CharField</span><span class="p">(</span><span class="n">max_length</span><span class="o">=</span><span class="mi">16</span><span class="p">,</span> <span class="n">choices</span><span class="o">=</span><span class="n">STATUS_CHOICES</span><span class="p">,</span> <span class="p">)</span>
    <span class="n">category</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">ForeignKey</span><span class="p">(</span><span class="s1">&#39;category&#39;</span><span class="p">,</span> <span class="n">on_delete</span><span class="o">=</span><span class="n">models</span><span class="o">.</span><span class="n">PROTECT</span><span class="p">,</span> <span class="p">)</span>
    <span class="n">created_on</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">DateTimeField</span><span class="p">(</span><span class="n">auto_now_add</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="p">)</span>
    <span class="n">created_by</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">ForeignKey</span><span class="p">(</span><span class="n">settings</span><span class="o">.</span><span class="n">AUTH_USER_MODEL</span><span class="p">,</span> <span class="n">on_delete</span><span class="o">=</span><span class="n">models</span><span class="o">.</span><span class="n">PROTECT</span><span class="p">,</span> <span class="n">related_name</span><span class="o">=</span><span class="s1">&#39;</span><span class="si">%(class)s</span><span class="s1">_created_by&#39;</span><span class="p">,</span> <span class="p">)</span>
    <span class="n">modified_on</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">DateTimeField</span><span class="p">(</span><span class="n">auto_now</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="p">)</span>
    <span class="n">modified_by</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">ForeignKey</span><span class="p">(</span><span class="n">settings</span><span class="o">.</span><span class="n">AUTH_USER_MODEL</span><span class="p">,</span> <span class="n">on_delete</span><span class="o">=</span><span class="n">models</span><span class="o">.</span><span class="n">PROTECT</span><span class="p">,</span> <span class="n">related_name</span><span class="o">=</span><span class="s1">&#39;</span><span class="si">%(class)s</span><span class="s1">_modified_by&#39;</span><span class="p">,</span> <span class="p">)</span>

    <span class="n">owned_by</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">ForeignKey</span><span class="p">(</span><span class="n">settings</span><span class="o">.</span><span class="n">AUTH_USER_MODEL</span><span class="p">,</span> <span class="n">on_delete</span><span class="o">=</span><span class="n">models</span><span class="o">.</span><span class="n">PROTECT</span><span class="p">,</span> <span class="n">related_name</span><span class="o">=</span><span class="s1">&#39;</span><span class="si">%(class)s</span><span class="s1">_owned_by&#39;</span><span class="p">,</span> <span class="p">)</span>
    <span class="n">published_on</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">DateTimeField</span><span class="p">(</span><span class="n">blank</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">null</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="k">class</span><span class="w"> </span><span class="nc">Meta</span><span class="p">:</span>
        <span class="n">abstract</span> <span class="o">=</span> <span class="kc">True</span>


<span class="k">class</span><span class="w"> </span><span class="nc">Article</span><span class="p">(</span><span class="n">AbstractGeneralInfo</span><span class="p">):</span>
    <span class="n">title</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">CharField</span><span class="p">(</span><span class="n">max_length</span><span class="o">=</span><span class="mi">128</span><span class="p">,</span> <span class="p">)</span>
    <span class="n">content</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">TextField</span><span class="p">()</span>


<span class="k">class</span><span class="w"> </span><span class="nc">Document</span><span class="p">(</span><span class="n">AbstractGeneralInfo</span><span class="p">):</span>
    <span class="n">description</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">CharField</span><span class="p">(</span><span class="n">max_length</span><span class="o">=</span><span class="mi">128</span><span class="p">,</span> <span class="p">)</span>
    <span class="n">file</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">FileField</span><span class="p">()</span>
</pre></div>
<p>All this can be found on the accompanying project <a class="reference external" href="https://github.com/spapas/cbv-tutorial">https://github.com/spapas/cbv-tutorial</a> on the djangocbv app (visit <a class="reference external" href="http://127.0.0.1:8001/djangocbv/">http://127.0.0.1:8001/djangocbv/</a>).</p>
<div class="section" id="do-something-when-a-valid-form-is-submitted">
<h3>Do something when a valid form is&nbsp;submitted</h3>
<p>When a form is submitted and the form is valid
the <tt class="docutils literal">form_valid</tt> method of <tt class="docutils literal">ModelForMixin</tt> (and <tt class="docutils literal">FormMixin</tt>) will be called. This method
can be overridden to do various things before (or after) the form is saved. For example,
you may want have a field whose value is calculated from other fields in the form or you want to
create an extra object. Let&#8217;s see a generic example of overriding a <tt class="docutils literal">CreateView</tt> or <tt class="docutils literal">UpdateView</tt> with&nbsp;comments:</p>
<div class="highlight"><pre><span></span><span class="k">def</span><span class="w"> </span><span class="nf">form_valid</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">form</span><span class="p">,</span> <span class="p">):</span>
    <span class="c1"># let&#39;s calculate a field value</span>
    <span class="n">form</span><span class="o">.</span><span class="n">instance</span><span class="o">.</span><span class="n">calculated_field</span> <span class="o">=</span> <span class="n">form</span><span class="o">.</span><span class="n">cleaned_data</span><span class="p">[</span><span class="s1">&#39;data1&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="n">form</span><span class="o">.</span><span class="n">cleaned_data</span><span class="p">[</span><span class="s1">&#39;data2&#39;</span><span class="p">]</span>

    <span class="c1"># save the form by calling super().form_valid(); keep the return value - it is the value of get_success_url</span>
    <span class="n">redirect_to</span> <span class="o">=</span> <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">form_valid</span><span class="p">(</span><span class="n">form</span><span class="p">)</span>

    <span class="c1"># For Create or UpdateView, the just-saved object will be assigned to self.object</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="s2">&quot;Created an object with id </span><span class="si">{0}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">object</span><span class="o">.</span><span class="n">id</span><span class="p">)</span>

    <span class="c1"># return the redirect</span>
    <span class="k">return</span> <span class="n">redirect_to</span>
</pre></div>
<p>This is rather complex so I&#8217;ll also explain it: The form_valid gets the actual form which, since is validated
has a <tt class="docutils literal">cleaned_data</tt> dictionary of values. This form also has an <tt class="docutils literal">instance</tt> attribute which is the object
that this form is bound to - notice that a normal <tt class="docutils literal">Form</tt> won&#8217;t have an instance only a <tt class="docutils literal">ModelForm</tt>.
This can be used to modify the instance of this form as needed - before saving it. When you want to actually save
the instance you call <tt class="docutils literal"><span class="pre">super().form_valid()</span></tt> passing it the modified form (and instance). This method does
three&nbsp;things</p>
<ul class="simple">
<li>It saves the instance to the&nbsp;database</li>
<li>It assigns the saved object to the <tt class="docutils literal">object</tt> instance attribute (so you can refer to it by <tt class="docutils literal">self.instance</tt>)</li>
<li>It uses <tt class="docutils literal">get_redirect_url</tt> to retrieve the location where you should redirect after the form is&nbsp;submitted</li>
</ul>
<p>Thus in this example we save <tt class="docutils literal">redirect_to</tt> to return it also from our method also and then can use <tt class="docutils literal">self.object.id</tt>
to log the id of the current&nbsp;object.</p>
<p>On a more specific example, notice the <tt class="docutils literal">Article</tt> and <tt class="docutils literal">Document</tt> models which both inherit (abstract)
from <tt class="docutils literal">AbstractGeneralInfo</tt> have a <tt class="docutils literal">created_by</tt> and
a <tt class="docutils literal">modified_by</tt> field. These fields have to be filled automatically from the current logged in user. Now, there are various
options to do that but what I vote for is using an <tt class="docutils literal">AuditableMixin</tt> as I have already described in <a class="reference external" href="https://spapas.github.io/2015/01/21/django-model-auditing/#adding-simple-auditing-functionality-ourselves">my Django model auditing article</a>.</p>
<p>To replicate the functionality we&#8217;ll create an <tt class="docutils literal">AuditableMixin</tt> like&nbsp;this:</p>
<div class="highlight"><pre><span></span><span class="k">class</span><span class="w"> </span><span class="nc">AuditableMixin</span><span class="p">(</span><span class="nb">object</span><span class="p">,):</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">form_valid</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">form</span><span class="p">,</span> <span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">form</span><span class="o">.</span><span class="n">instance</span><span class="o">.</span><span class="n">created_by</span><span class="p">:</span>
            <span class="n">form</span><span class="o">.</span><span class="n">instance</span><span class="o">.</span><span class="n">created_by</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">user</span>
        <span class="n">form</span><span class="o">.</span><span class="n">instance</span><span class="o">.</span><span class="n">modified_by</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">user</span>
        <span class="k">return</span> <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">form_valid</span><span class="p">(</span><span class="n">form</span><span class="p">)</span>
</pre></div>
<p>This mixin can be used by both the create and update view of both <tt class="docutils literal">Article</tt> and <tt class="docutils literal">Document</tt>. So all four of these
classes will share the same functionality. Notice that the <tt class="docutils literal">form_valid</tt> method is overridden - the <tt class="docutils literal">created_by</tt>
of the form&#8217;s instance (which is the object that was edited, remember how <tt class="docutils literal">ModelFormMixin</tt> works) will by set
to the current user if it is null (so it will be only set once) while the <tt class="docutils literal">modified_by</tt> will be set always to the
current user. Finally we call <tt class="docutils literal"><span class="pre">super().form_valid</span></tt> and return its response so
that the form will be actually saved and the redirect will go to the proper success url. To use it for example for the
<tt class="docutils literal">Article</tt>, <tt class="docutils literal">CreateView</tt> should be defined like&nbsp;this:</p>
<div class="highlight"><pre><span></span><span class="k">class</span><span class="w"> </span><span class="nc">ArticleCreateView</span><span class="p">(</span><span class="n">AuditableMixin</span><span class="p">,</span> <span class="n">CreateView</span><span class="p">):</span>
    <span class="k">class</span><span class="w"> </span><span class="nc">Meta</span><span class="p">:</span>
        <span class="n">model</span> <span class="o">=</span> <span class="n">Article</span>
</pre></div>
</div>
<div class="section" id="change-the-queryset-of-the-cbv">
<h3>Change the queryset of the <span class="caps">CBV</span></h3>
<p>All CBVs that inherit from <tt class="docutils literal">SingleObjectMixin</tt> or <tt class="docutils literal">MultipleObjectMixin</tt> (<tt class="docutils literal">ListView</tt>, <tt class="docutils literal">DetailView</tt>, <tt class="docutils literal">UpdateView</tt> and <tt class="docutils literal">DeleteView</tt>)
have a <tt class="docutils literal">model</tt> and a <tt class="docutils literal">queryset</tt> property that can be used (either one or the other) to define the queryset that will be used for
querying the database for that CBVs results. This queryset can be further dynamically refined by overriding the <tt class="docutils literal">get_queryset()</tt> method.
What I usually do is that I define the <tt class="docutils literal">model</tt> attribute and then override <tt class="docutils literal">get_querset</tt> in order to dynamically modify the&nbsp;queryset.</p>
<p>For example, let&#8217;s say that I wanted to add a count of articles and documents per each category. Here&#8217;s how the <tt class="docutils literal">CategoryListView</tt> could be&nbsp;done:</p>
<div class="highlight"><pre><span></span><span class="k">class</span><span class="w"> </span><span class="nc">CategoryListView</span><span class="p">(</span><span class="n">ExportCsvMixin</span><span class="p">,</span> <span class="n">AdminOrPublisherPermissionRequiredMixin</span><span class="p">,</span> <span class="n">ListView</span><span class="p">):</span>
    <span class="n">model</span> <span class="o">=</span> <span class="n">Category</span>
    <span class="n">context_object_name</span> <span class="o">=</span> <span class="s1">&#39;categories&#39;</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">get_queryset</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">qs</span> <span class="o">=</span> <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">get_queryset</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">qs</span><span class="o">.</span><span class="n">annotate</span><span class="p">(</span><span class="n">article_cnt</span><span class="o">=</span><span class="n">Count</span><span class="p">(</span><span class="s1">&#39;article&#39;</span><span class="p">),</span> <span class="n">document_cnt</span><span class="o">=</span><span class="n">Count</span><span class="p">(</span><span class="s1">&#39;document&#39;</span><span class="p">))</span>
</pre></div>
<p>Notice that I also use some more mixins for this <tt class="docutils literal">ListView</tt> (they&#8217;ll be explained later). The <tt class="docutils literal">get_queryset</tt> adds
the annotation to the <tt class="docutils literal">super()</tt> queryset (which will be <tt class="docutils literal">Category.objects.all()</tt>). One final comment is that instead
of this, I could have more or less the same functionality by implementing <tt class="docutils literal">CategoryListView</tt>:</p>
<div class="highlight"><pre><span></span><span class="k">class</span><span class="w"> </span><span class="nc">CategoryListView</span><span class="p">(</span><span class="n">ExportCsvMixin</span><span class="p">,</span> <span class="n">AdminOrPublisherPermissionRequiredMixin</span><span class="p">,</span> <span class="n">ListView</span><span class="p">):</span>
    <span class="n">context_object_name</span> <span class="o">=</span> <span class="s1">&#39;categories&#39;</span>
    <span class="n">query</span> <span class="o">=</span> <span class="n">Category</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">all</span><span class="p">()</span><span class="o">.</span><span class="n">annotate</span><span class="p">(</span><span class="n">article_cnt</span><span class="o">=</span><span class="n">Count</span><span class="p">(</span><span class="s1">&#39;article&#39;</span><span class="p">),</span> <span class="n">document_cnt</span><span class="o">=</span><span class="n">Count</span><span class="p">(</span><span class="s1">&#39;document&#39;</span><span class="p">))</span>
</pre></div>
<p>This has the same functionality (return all categories with the number of articles and documents for each one) and
saves some typing from overriding the <tt class="docutils literal">get_queryset</tt>  method. However as I said most of the time I use the model
attribute and override the <tt class="docutils literal">get_queryset</tt> method because it seems more explicit and descriptive to me and most of
the time I&#8217;ll need to add some more filtering (based on the current user, based on some query parameter etc) that
can only be implemented on the <tt class="docutils literal">get_queryset</tt>.</p>
</div>
<div class="section" id="allow-each-user-to-list-view-edit-delete-only-his-own-items">
<h3>Allow each user to list/view/edit/delete only his own&nbsp;items</h3>
<p>Continuing from the previous example of modifying the queryset, let&#8217;s suppose that we want to allow each
user to be able to list the items (articles and
documents) he has created and view/edit/delete them. We also want to allow admins and publishers to view/edit&nbsp;everything.</p>
<p>Since the <tt class="docutils literal">Article</tt> and <tt class="docutils literal">Document</tt> models both have an <tt class="docutils literal">owned_by</tt> element we can use use this to filter
the results returned by <tt class="docutils literal">get_queryset()</tt>. For example, here&#8217;s a mixin that checks if the current user is
admin or publisher. If he is a publisher then he will just return the <tt class="docutils literal">super()</tt> queryset. If however he is a simple
user it will return only the results that are owned by him with <tt class="docutils literal">qs.filter(owned_by=self.request.user)</tt>.</p>
<div class="highlight"><pre><span></span><span class="k">class</span><span class="w"> </span><span class="nc">LimitAccessMixin</span><span class="p">:</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">get_queryset</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">qs</span> <span class="o">=</span> <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">get_queryset</span><span class="p">()</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">user</span><span class="o">.</span><span class="n">has_perm</span><span class="p">(</span><span class="s1">&#39;djangocbv.admin_access&#39;</span><span class="p">)</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">user</span><span class="o">.</span><span class="n">has_perm</span><span class="p">(</span><span class="s1">&#39;djangocbv.publisher_access&#39;</span><span class="p">)</span> <span class="p">:</span>
            <span class="k">return</span> <span class="n">qs</span>
        <span class="k">return</span> <span class="n">qs</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">owned_by</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">user</span><span class="p">)</span>
</pre></div>
<p>Another similar mixin that is used is the <tt class="docutils literal">HideRemovedMixin</tt> that, for simple users, excludes from the queryset the objects that
are&nbsp;removed:</p>
<div class="highlight"><pre><span></span><span class="k">class</span><span class="w"> </span><span class="nc">HideRemovedMixin</span><span class="p">:</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">get_queryset</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">qs</span> <span class="o">=</span> <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">get_queryset</span><span class="p">()</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">user</span><span class="o">.</span><span class="n">has_perm</span><span class="p">(</span><span class="s1">&#39;djangocbv.admin_access&#39;</span><span class="p">)</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">user</span><span class="o">.</span><span class="n">has_perm</span><span class="p">(</span><span class="s1">&#39;djangocbv.publisher_access&#39;</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">qs</span>
        <span class="k">return</span> <span class="n">qs</span><span class="o">.</span><span class="n">exclude</span><span class="p">(</span><span class="n">status</span><span class="o">=</span><span class="s1">&#39;REMOVED&#39;</span><span class="p">)</span>
</pre></div>
<p>One thing that needs a little discussion is that for both of these mixins I am using <tt class="docutils literal">get_queryset</tt> to implement access control to
allow using the same mixin for views that inherit from both <tt class="docutils literal">SingleObjectMixin</tt> and <tt class="docutils literal">MultipleObjectMixin</tt> (since the <tt class="docutils literal">get_queryset</tt> is
used in both of them). This
means that when a user tries to access an object that has not access to he&#8217;ll get a nice 404&nbsp;error.</p>
<p>Beyond this, instead of filtering the queryset,
for views inheriting from <tt class="docutils literal">SingleObjectMixin</tt> (i.e <tt class="docutils literal">DetailView</tt>, <tt class="docutils literal">UpdateView</tt> and <tt class="docutils literal">DeleteView</tt>)
we could have overridden the <tt class="docutils literal">get_object</tt> method to raise an access denied exception. Here&#8217;s how <tt class="docutils literal">get_object</tt> could be
overridden to raise a 403 Forbidden status when a user tries to access an object that does not belong to&nbsp;him:</p>
<div class="highlight"><pre><span></span><span class="kn">from</span><span class="w"> </span><span class="nn">django.core.exceptions</span><span class="w"> </span><span class="kn">import</span> <span class="n">PermissionDenied</span>

<span class="k">def</span><span class="w"> </span><span class="nf">get_object</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">queryset</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="n">obj</span> <span class="o">=</span> <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">get_object</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">obj</span><span class="o">.</span><span class="n">owned_by</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">user</span><span class="p">:</span>
        <span class="k">raise</span> <span class="n">PermissionDenied</span>
    <span class="k">return</span> <span class="n">obj</span>
</pre></div>
</div>
<div class="section" id="configure-the-form-s-initial-values-from-get-parameters">
<h3>Configure the form&#8217;s initial values from <span class="caps">GET</span>&nbsp;parameters</h3>
<p>Sometimes we want to have a <tt class="docutils literal">CreateView</tt> with some fields already filled. I usually
implement this by passing the proper parameters to the <span class="caps">URL</span> (i.e by calling it as /create_view?category_id=2)
and then using the following mixin to override the <tt class="docutils literal">FormMixin</tt> <tt class="docutils literal">get_initial</tt> method in order to
return the form&#8217;s initial data from&nbsp;it:</p>
<div class="highlight"><pre><span></span><span class="k">class</span><span class="w"> </span><span class="nc">SetInitialMixin</span><span class="p">(</span><span class="nb">object</span><span class="p">,):</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">get_initial</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">initial</span> <span class="o">=</span> <span class="nb">super</span><span class="p">(</span><span class="n">SetInitialMixin</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">get_initial</span><span class="p">()</span>
        <span class="n">initial</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">GET</span><span class="o">.</span><span class="n">dict</span><span class="p">())</span>
        <span class="k">return</span> <span class="n">initial</span>
</pre></div>
<p>So if the /article_create url can be used to initialte the <tt class="docutils literal">CreateView</tt> for the article,
using <tt class="docutils literal"><span class="pre">/article_create?category_id=3</span></tt> will show the CreateView with the Category with id=3
pre-selected in the category&nbsp;field!</p>
</div>
<div class="section" id="pass-extra-kwargs-to-the-formview-form">
<h3>Pass extra kwargs to the FormView&nbsp;form</h3>
<p>This is a very common requirement. The form may need to be modified by an external condition,
for example the current user or something that can be calculated from the view. Here&#8217;s a
sample mixin that passes the current request (which also includes the user) to the&nbsp;form:</p>
<div class="highlight"><pre><span></span><span class="k">class</span><span class="w"> </span><span class="nc">RequestArgMixin</span><span class="p">:</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">get_form_kwargs</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">kwargs</span> <span class="o">=</span> <span class="nb">super</span><span class="p">(</span><span class="n">RequestArgMixin</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">get_form_kwargs</span><span class="p">()</span>
        <span class="n">kwargs</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="s1">&#39;request&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="p">})</span>
        <span class="k">return</span> <span class="n">kwargs</span>
</pre></div>
<p>Please notice that the form has to properly handle the extra kwarg in its constructor,
before calling the super&#8217;s constructor. For
example, here&#8217;s how a form that can accept the request could be&nbsp;implemented:</p>
<div class="highlight"><pre><span></span><span class="k">class</span><span class="w"> </span><span class="nc">RequestForm</span><span class="p">(</span><span class="n">forms</span><span class="o">.</span><span class="n">Form</span><span class="p">):</span>
    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">request</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;request&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
</pre></div>
<p>We use <tt class="docutils literal">pop</tt> to remove the request from the received <tt class="docutils literal">kwargs</tt> and only then we call the
parent&nbsp;constructor.</p>
</div>
<div class="section" id="add-values-to-the-context">
<h3>Add values to the&nbsp;context</h3>
<p>To add values to the context of a <span class="caps">CBV</span> we override the <tt class="docutils literal">get_context_data()</tt> method. Here&#8217;s
a mixin that adds a list of categories to all CBVs using&nbsp;it:</p>
<div class="highlight"><pre><span></span><span class="k">class</span><span class="w"> </span><span class="nc">CategoriesContextMixin</span><span class="p">:</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">get_context_data</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="n">ctx</span> <span class="o">=</span> <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">get_context_data</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="n">ctx</span><span class="p">[</span><span class="s1">&#39;categories&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">Category</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">all</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">ctx</span>
</pre></div>
<p>Notice that the mixin calls super to get the context data of its ancestors and appends to it. This
mean that if we also had a mixin that f.e added the current logged in user to the context (this isn&#8217;t really
needed since there&#8217;s a context processor for this but anyway) then when a <span class="caps">CBV</span> inherited from both of
them then the data of both of them would be added to the&nbsp;context.</p>
<p>As a general comment there are three other methods the same functionality could be&nbsp;achieved:</p>
<ul class="simple">
<li>Just override the <tt class="docutils literal">get_context_data</tt> of the <span class="caps">CBV</span> you want to add extra data to its&nbsp;context</li>
<li>Add a template tag that will bring the needed data to the&nbsp;template</li>
<li>Use a context processor to bring the data to all&nbsp;templates</li>
</ul>
<p>As can be understood, each of the above methods has certain advantages and disadvantages. For
example, if the extra data will query the database then the context processor method will add
one extra query for all page loads (even if the data is not needed). On the other hand,
the template tag will query the database only on specific views but it makes debugging and
reasoning about your template more difficult since if you have a lot of template tags you&#8217;ll have
various context variables appearing from thing&nbsp;air!</p>
<p>One final comment is that overriding the <tt class="docutils literal">get_context_data</tt> method will probably be the most
common thing you&#8217;re going to do when using CBVs (you&#8217;ll definitely need to add things to the context)
so try to remember the following 3 needed&nbsp;lines:</p>
<div class="highlight"><pre><span></span><span class="k">def</span><span class="w"> </span><span class="nf">get_context_data</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
    <span class="n">ctx</span> <span class="o">=</span> <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">get_context_data</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
    <span class="c1"># ... here we add stuff to the ctx</span>
    <span class="k">return</span> <span class="n">ctx</span>
</pre></div>
</div>
<div class="section" id="add-a-simple-filter-to-a-listview">
<h3>Add a simple filter to a&nbsp;ListView</h3>
<p>For filtering I recommend using the excellent <a class="reference external" href="https://github.com/carltongibson/django-filter">django-filter</a> package as I&#8217;ve already
presented in <a class="reference external" href="https://spapas.github.io/2017/10/11/essential-django-packages/">my essential Django package list</a>. Here&#8217;s how a mixin can be created that
adds a filter to the&nbsp;context:</p>
<div class="highlight"><pre><span></span><span class="k">class</span><span class="w"> </span><span class="nc">AddFilterMixin</span><span class="p">:</span>
    <span class="n">filter_class</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">get_context_data</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="n">ctx</span> <span class="o">=</span> <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">get_context_data</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">filter_class</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span><span class="s2">&quot;Please define filter_class when using AddFilterMixin&quot;</span><span class="p">)</span>
        <span class="nb">filter</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">filter_class</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">GET</span><span class="p">,</span> <span class="n">queryset</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">get_queryset</span><span class="p">())</span>
        <span class="n">ctx</span><span class="p">[</span><span class="s1">&#39;filter&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">filter</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">context_object_name</span><span class="p">:</span>
            <span class="n">ctx</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">context_object_name</span><span class="p">]</span> <span class="o">=</span> <span class="nb">filter</span><span class="o">.</span><span class="n">qs</span>
        <span class="k">return</span> <span class="n">ctx</span>
</pre></div>
<p>Notice that the <tt class="docutils literal">get_context_data</tt> checks to see if the <tt class="docutils literal">filter_class</tt> attribute has been
defined (if not it will raise a useful explanation). It will then instantiate the filter class
passing it the <tt class="docutils literal">self.request.<span class="caps">GET</span></tt> and the current queryset (<tt class="docutils literal">self.get_queryset()</tt>) - so for
example any extra filtering you are doing to the queryset (for example only show content owned by the
current user) will be also used. Finally, pass the filter to the context and assign the
contect_object_name to the filtered&nbsp;queryset.</p>
<p>Here&#8217;s for example how this mixin is used for <tt class="docutils literal">ArticleListView</tt>:</p>
<div class="highlight"><pre><span></span><span class="k">class</span><span class="w"> </span><span class="nc">ArticleListView</span><span class="p">(</span><span class="n">AddFilterMixin</span><span class="p">,</span> <span class="n">ListView</span><span class="p">):</span>
    <span class="n">model</span> <span class="o">=</span> <span class="n">Article</span>
    <span class="n">context_object_name</span> <span class="o">=</span> <span class="s1">&#39;articles&#39;</span>
    <span class="n">filter_class</span> <span class="o">=</span> <span class="n">ArticleFilter</span>
</pre></div>
<p>And then just add the following to the <tt class="docutils literal">article_list.html</tt> template:</p>
<div class="highlight"><pre><span></span><span class="o">&lt;</span><span class="n">form</span> <span class="n">method</span><span class="o">=</span><span class="s1">&#39;GET&#39;</span><span class="o">&gt;</span>
    <span class="p">{{</span> <span class="nb">filter</span><span class="o">.</span><span class="n">form</span> <span class="p">}}</span>
    <span class="o">&lt;</span><span class="nb">input</span> <span class="nb">type</span><span class="o">=</span><span class="s1">&#39;submit&#39;</span> <span class="n">value</span><span class="o">=</span><span class="s1">&#39;Filter&#39;</span> <span class="o">/&gt;</span>
<span class="o">&lt;/</span><span class="n">form</span><span class="o">&gt;</span>
<span class="p">{</span><span class="o">%</span> <span class="k">for</span> <span class="n">article</span> <span class="ow">in</span> <span class="n">articles</span> <span class="o">%</span><span class="p">}</span>
    <span class="n">Display</span> <span class="n">article</span> <span class="n">info</span> <span class="o">-</span> <span class="n">only</span> <span class="n">filtered</span> <span class="n">articles</span> <span class="n">will</span> <span class="n">be</span> <span class="n">here</span>
<span class="p">{</span><span class="o">%</span> <span class="n">endfor</span> <span class="o">%</span><span class="p">}</span>
</pre></div>
</div>
<div class="section" id="support-for-success-messages">
<h3>Support for success&nbsp;messages</h3>
<p>Django has a very useful <a class="reference external" href="https://docs.djangoproject.com/en/2.0/ref/contrib/messages/">messages framework</a> which can be used to add flash messages
to a view. A flash message is a message that persists in the sesion until it is viewed
by the user. So, for example when a user edits an object and saves it, he&#8217;ll be redirected
to the success page - if you have configured a flash message to inform the user that the
save was ok then he&#8217;ll see this message once and then if he reloads the page it will
be&nbsp;removed.</p>
<p>Here&#8217;s a mixin that can be used to support flash messages using Django&#8217;s message&nbsp;framework:</p>
<div class="highlight"><pre><span></span><span class="k">class</span><span class="w"> </span><span class="nc">SuccessMessageMixin</span><span class="p">:</span>
    <span class="n">success_message</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">get_success_message</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">success_message</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">form_valid</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">form</span><span class="p">):</span>
        <span class="n">messages</span><span class="o">.</span><span class="n">success</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_success_message</span><span class="p">())</span>
        <span class="k">return</span> <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">form_valid</span><span class="p">(</span><span class="n">form</span><span class="p">)</span>
</pre></div>
<p>This mixin overrides the <tt class="docutils literal">form_valid</tt> and adds the message using <tt class="docutils literal">get_success_message</tt> - this
can be overriden if you want to have a dynamic message or just set the <tt class="docutils literal">success_message</tt> attribute
for a static message, for example something like&nbsp;this:</p>
<div class="highlight"><pre><span></span><span class="k">class</span><span class="w"> </span><span class="nc">SuccesMessageArticleCreateView</span><span class="p">(</span><span class="n">SuccessMessageMixin</span><span class="p">,</span> <span class="n">CreateView</span><span class="p">):</span>
    <span class="n">success_message</span> <span class="o">=</span> <span class="s1">&#39;Object was created!&#39;</span>

    <span class="k">class</span><span class="w"> </span><span class="nc">Meta</span><span class="p">:</span>
        <span class="n">model</span> <span class="o">=</span> <span class="n">Article</span>
</pre></div>
<p>I&#8217;d like to once again point out here that since the <tt class="docutils literal"><span class="pre">super().form_valid(form)</span></tt> method is properly used
then if a <span class="caps">CBV</span> uses multiple mixins that override form_valid (for example if your <span class="caps">CBV</span> overrides both
<tt class="docutils literal">SuccessMessageMixin</tt> and <tt class="docutils literal">AuditableMixin</tt> then the form_valid of <em>both</em> will be called so you&#8217;ll
get both the created_by/modified_by values set to the current user and the success&nbsp;message!</p>
<p>Notice that Django actually provides an implementation of <a class="reference external" href="https://docs.djangoproject.com/en/2.0/ref/contrib/messages/#adding-messages-in-class-based-views">a message mixin</a> which can be used instead
of the proposed implementation here (I didn&#8217;t know it until recently that&#8217;s why I am using this to some
projects and I also present it&nbsp;here).</p>
</div>
<div class="section" id="implement-a-quick-moderation">
<h3>Implement a quick&nbsp;moderation</h3>
<p>It is easy to implement some moderation to our model publishing. For example, let&#8217;s suppose that we only
allow publishers to publish a model. Here&#8217;s how it can be&nbsp;done:</p>
<div class="highlight"><pre><span></span><span class="k">def</span><span class="w"> </span><span class="nf">form_valid</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">form</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">form</span><span class="o">.</span><span class="n">instance</span><span class="o">.</span><span class="n">status</span> <span class="o">!=</span> <span class="s1">&#39;REMOVED&#39;</span><span class="p">:</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">user</span><span class="o">.</span><span class="n">has_perm</span><span class="p">(</span><span class="s1">&#39;djangocbv.publisher_access&#39;</span><span class="p">):</span>
            <span class="n">form</span><span class="o">.</span><span class="n">instance</span><span class="o">.</span><span class="n">status</span> <span class="o">=</span> <span class="s1">&#39;PUBLISHED&#39;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">form</span><span class="o">.</span><span class="n">instance</span><span class="o">.</span><span class="n">status</span> <span class="o">=</span> <span class="s1">&#39;DRAFT&#39;</span>

    <span class="k">return</span> <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">form_valid</span><span class="p">(</span><span class="n">form</span><span class="p">)</span>
</pre></div>
<p>So, first of all we make sure that the object is not <tt class="docutils literal"><span class="caps">REMOVED</span></tt> (if it is
remove it we don&#8217;t do anything else). Next we check if the current user has
<tt class="docutils literal">publisher_access</tt> if yes we change the object&#8217;s status to <tt class="docutils literal"><span class="caps">PUBLISHED</span></tt> - on any
other case we change its status to <tt class="docutils literal"><span class="caps">DRAFT</span></tt>. Notice that this means that whenever a
publisher saves the object it will be published and whenever a non-publisher saves it
it will be made a draft. We then call our ancestor&#8217;s <tt class="docutils literal">form_valid</tt> to save the object
and return to success&nbsp;url.</p>
<p>I&#8217;d like to repeat here that this mixin, since it calls super, can work concurrently
with any other mixins that override <tt class="docutils literal">form_valid</tt> (and also call their super method
of course), for example it can be used together with the audit (auto-fill created_by
and moderated_by) and the success mixin we defined&nbsp;previously!</p>
</div>
<div class="section" id="allow-access-to-a-view-if-a-user-has-one-out-of-a-group-of-permissions">
<h3>Allow access to a view if a user has one out of a group of&nbsp;permissions</h3>
<p>For this we&#8217;ll need to use the authentication mixins functionality. We could implement
this by overriding <tt class="docutils literal">PermissionRequiredMixin</tt> or by overriding <tt class="docutils literal">UserPassesTestMixin</tt>.</p>
<p>Using <tt class="docutils literal">PermissionRequiredMixin</tt> is not very easy because the way it works
it will allow access if the user has <em>all</em> permissions from the group (not only one as is the requirement).
Of course you could override its <tt class="docutils literal">has_permission</tt> method to change the way it checks if
the user has the permissions (i.e make sure it has one permission instead of&nbsp;all):</p>
<div class="highlight"><pre><span></span><span class="k">class</span><span class="w"> </span><span class="nc">AnyPermissionRequiredMixin</span><span class="p">(</span><span class="n">PermissionRequiredMixin</span><span class="p">,</span> <span class="p">):</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">has_permission</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">perms</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_permission_required</span><span class="p">()</span>
        <span class="k">return</span> <span class="nb">any</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">user</span><span class="o">.</span><span class="n">has_perm</span><span class="p">(</span><span class="n">perm</span><span class="p">)</span> <span class="k">for</span> <span class="n">perm</span> <span class="ow">in</span> <span class="n">perms</span><span class="p">)</span>
</pre></div>
<p>Also we could implement our mixin using <tt class="docutils literal">UserPassesTestMixin</tt> as its&nbsp;base:</p>
<div class="highlight"><pre><span></span><span class="k">class</span><span class="w"> </span><span class="nc">AnyPermissionRequiredAlternativeMixin</span><span class="p">(</span><span class="n">UserPassesTestMixin</span><span class="p">):</span>
    <span class="n">permissions</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">test_func</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="nb">any</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">user</span><span class="o">.</span><span class="n">has_perm</span><span class="p">(</span><span class="n">perm</span><span class="p">)</span> <span class="k">for</span> <span class="n">perm</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">permissions</span><span class="p">)</span>
</pre></div>
<p>The functionality is very simple: If the user has one of the list of the configured permissions then the test will pass (so he&#8217;ll have access to the view).
If instead the user has none of the permissions then he won&#8217;t be able to access the&nbsp;view.</p>
<p>Notice that for the above implementations we inherited from <tt class="docutils literal">PermissionRequiredMixin</tt> or <tt class="docutils literal">UserPassesTextMixin</tt> to keep their functionality - if we had inherited
these mixins from object then we&#8217;d need to inherit our CBVs from both <tt class="docutils literal">AnyPermissionRequiredMixin</tt> and <tt class="docutils literal">PermissionRequiredMixin</tt> or
<tt class="docutils literal">AnyPermissionRequiredAlternativeMixin</tt> and <tt class="docutils literal">UserPassesTestMixin</tt> (with the correct <span class="caps">MRO</span> order of&nbsp;course).</p>
<p>Now, the whole permission cheking functionality can be even more <span class="caps">DRY</span>. Let&#8217;s suppose that we know that there are a couple of views which should only
be visible to users having either the <tt class="docutils literal">app.admin</tt> or <tt class="docutils literal">app.curator</tt> permission. Instead of inheriting all these views from <tt class="docutils literal">AnyPermissionRequiredMixin</tt>
and configuring the permissions list to each one, the <span class="caps">DRY</span> way to implement this is to add yet another mixin from which the CBVs will actually&nbsp;inhert:</p>
<div class="highlight"><pre><span></span><span class="k">class</span><span class="w"> </span><span class="nc">AdminOrPublisherPermissionRequiredMixin</span><span class="p">(</span><span class="n">AnyPermissionRequiredMixin</span><span class="p">):</span>
    <span class="n">permissions</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;djangocbv.admin_access&#39;</span><span class="p">,</span> <span class="s1">&#39;djangocbv.publisher_access&#39;</span><span class="p">]</span>
</pre></div>
</div>
<div class="section" id="disable-a-view-based-on-some-condition">
<h3>Disable a view based on some&nbsp;condition</h3>
<p>There are times you want to disable a view based on an arbitrary condition - for example example make the view
disabled before a specific date. Here&#8217;s a simple mixin that overrides <tt class="docutils literal">dispatch</tt> to do&nbsp;this:</p>
<div class="highlight"><pre><span></span><span class="k">class</span><span class="w"> </span><span class="nc">DisabledDateMixin</span><span class="p">(</span><span class="nb">object</span><span class="p">,</span> <span class="p">):</span>
    <span class="n">the_date</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">date</span><span class="p">(</span><span class="mi">2018</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">dispatch</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">datetime</span><span class="o">.</span><span class="n">date</span><span class="o">.</span><span class="n">today</span><span class="p">()</span> <span class="o">&lt;</span> <span class="n">the_date</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">PermissionDenied</span>
        <span class="k">return</span> <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">dispatch</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
</pre></div>
<p>You can even disable a view completely  in case you want to keep it in your urls.py using this&nbsp;mixin:</p>
<div class="highlight"><pre><span></span><span class="k">class</span><span class="w"> </span><span class="nc">DisabledDateMixin</span><span class="p">(</span><span class="nb">object</span><span class="p">,</span> <span class="p">):</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">dispatch</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="k">raise</span> <span class="n">PermissionDenied</span>
</pre></div>
</div>
<div class="section" id="output-non-html-views">
<h3>Output non-html&nbsp;views</h3>
<p>I&#8217;ve written a whole article about this, please take a look at my <a class="reference external" href="https://spapas.github.io/2014/09/15/django-non-html-responses/">Django non-<span class="caps">HTML</span> responses</a>&nbsp;article.</p>
<p>Also, notice that is very easy to create a mixin that will output a view to <span class="caps">PDF</span> - I have already written
an <a class="reference external" href="https://spapas.github.io/2015/11/27/pdf-in-django/#using-a-cbv">essential guide for outputting PDFs in Django</a> so I am just going to refer you to this article for
(much more)&nbsp;information!</p>
<p>Finally, let&#8217;s take a look at a generic Mixin that you can use to add <span class="caps">CSV</span> exporting capabilities to a
<tt class="docutils literal">ListView</tt>:</p>
<div class="highlight"><pre><span></span><span class="k">class</span><span class="w"> </span><span class="nc">ExportCsvMixin</span><span class="p">:</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">render_to_response</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">context</span><span class="p">,</span> <span class="o">**</span><span class="n">response_kwargs</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">GET</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;csv&#39;</span><span class="p">):</span>
            <span class="n">response</span> <span class="o">=</span> <span class="n">HttpResponse</span><span class="p">(</span><span class="n">content_type</span><span class="o">=</span><span class="s1">&#39;text/csv&#39;</span><span class="p">)</span>
            <span class="n">response</span><span class="p">[</span><span class="s1">&#39;Content-Disposition&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;attachment; filename=&quot;export.csv&quot;&#39;</span>

            <span class="n">writer</span> <span class="o">=</span> <span class="n">csv</span><span class="o">.</span><span class="n">writer</span><span class="p">(</span><span class="n">response</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">idx</span><span class="p">,</span> <span class="n">o</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">context</span><span class="p">[</span><span class="s1">&#39;object_list&#39;</span><span class="p">]):</span>
                <span class="k">if</span> <span class="n">idx</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span> <span class="c1"># Write headers</span>
                    <span class="n">writer</span><span class="o">.</span><span class="n">writerow</span><span class="p">(</span><span class="n">k</span> <span class="k">for</span> <span class="p">(</span><span class="n">k</span><span class="p">,</span><span class="n">v</span><span class="p">)</span> <span class="ow">in</span> <span class="n">o</span><span class="o">.</span><span class="vm">__dict__</span><span class="o">.</span><span class="n">items</span><span class="p">()</span> <span class="k">if</span> <span class="ow">not</span> <span class="n">k</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;_&#39;</span><span class="p">))</span>
                <span class="n">writer</span><span class="o">.</span><span class="n">writerow</span><span class="p">(</span><span class="n">v</span> <span class="k">for</span> <span class="p">(</span><span class="n">k</span><span class="p">,</span><span class="n">v</span><span class="p">)</span> <span class="ow">in</span> <span class="n">o</span><span class="o">.</span><span class="vm">__dict__</span><span class="o">.</span><span class="n">items</span><span class="p">()</span> <span class="k">if</span> <span class="ow">not</span> <span class="n">k</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;_&#39;</span><span class="p">))</span>

            <span class="k">return</span> <span class="n">response</span>
        <span class="k">return</span> <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">render_to_response</span><span class="p">(</span><span class="n">context</span><span class="p">,</span> <span class="o">**</span><span class="n">response_kwargs</span><span class="p">)</span>
</pre></div>
<p>As you can see this mixin overrides the <tt class="docutils literal">render_to_response</tt> method. It will check if there&#8217;s a
<tt class="docutils literal">csv</tt> key to the <tt class="docutils literal"><span class="caps">GET</span></tt> queryset dictionary, thus the url must be called with <tt class="docutils literal"><span class="pre">?csv=true</span></tt> or something similar. You
can just add this link to your&nbsp;template:</p>
<div class="highlight"><pre><span></span><span class="p">&lt;</span><span class="nt">a</span> <span class="na">class</span><span class="o">=</span><span class="s">&#39;button&#39;</span> <span class="na">href</span><span class="o">=</span><span class="s">&#39;?csv=true&#39;</span><span class="p">&gt;</span>Export csv<span class="p">&lt;/</span><span class="nt">a</span><span class="p">&gt;</span>
</pre></div>
<p>So if the view needs to be exported to <span class="caps">CSV</span>, it will create a new <tt class="docutils literal">HttpResponse</tt> object with the correct content type.
The next line will add a header that (<tt class="docutils literal"><span class="pre">Content-Disposition</span></tt>) will mark the response as an attachment and give it a default file name.
We then crate a new <tt class="docutils literal">csv.writer</tt> passing the just-created response as the place to write the csv. The <tt class="docutils literal">for</tt> loop that follows
enumerates the <tt class="docutils literal">object_list</tt> value of the context (remember that this is added by the <tt class="docutils literal">MultipleObjectMixin</tt> and contains the
result of the <tt class="docutils literal">ListView</tt>). It will then use the object&#8217;s <tt class="docutils literal">__dict__</tt> attribute to write the headers (for the first time) and then
write the values of all&nbsp;objects.</p>
<p>As another simple example, let&#8217;s create a quick <span class="caps">JSON</span> output mixin for our&nbsp;DetailViews:</p>
<div class="highlight"><pre><span></span><span class="k">class</span><span class="w"> </span><span class="nc">JsonDetailMixin</span><span class="p">:</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">render_to_response</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">context</span><span class="p">,</span> <span class="o">**</span><span class="n">response_kwargs</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">GET</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;json&#39;</span><span class="p">):</span>
            <span class="n">response</span> <span class="o">=</span> <span class="n">HttpResponse</span><span class="p">(</span><span class="n">content_type</span><span class="o">=</span><span class="s1">&#39;application/json&#39;</span><span class="p">)</span>
            <span class="n">response</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="nb">dict</span><span class="p">(</span> <span class="p">(</span><span class="n">k</span><span class="p">,</span><span class="nb">str</span><span class="p">(</span><span class="n">v</span><span class="p">))</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span><span class="n">v</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">object</span><span class="o">.</span><span class="vm">__dict__</span><span class="o">.</span><span class="n">items</span><span class="p">()</span> <span class="p">)))</span>
            <span class="k">return</span> <span class="n">response</span>
        <span class="k">return</span> <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">render_to_response</span><span class="p">(</span><span class="n">context</span><span class="p">,</span> <span class="o">**</span><span class="n">response_kwargs</span><span class="p">)</span>
</pre></div>
<p>If you add this to a view inheriting from <tt class="docutils literal">DetailView</tt> and pass it the <tt class="docutils literal"><span class="pre">?json=true</span></tt> query parameter
you&#8217;ll get a <span class="caps">JSON</span>&nbsp;response!</p>
</div>
<div class="section" id="use-one-templateview-for-multiple-html-templates">
<h3>Use one TemplateView for multiple html&nbsp;templates</h3>
<p>Using a <tt class="docutils literal">TemplateView</tt> you could display an html template without much problem just by
settings the <tt class="docutils literal">template</tt> attribute of your class. What if you wanted to have a single
<tt class="docutils literal">TemplateView</tt> that would display many templates based on the query path? Simple, just
override <tt class="docutils literal">get_template_names</tt> to return a different template based on the path. For example,
using this&nbsp;view:</p>
<div class="highlight"><pre><span></span>class DynamicTemplateView(TemplateView):
    def get_template_names(self):
        what = self.kwargs[&#39;what&#39;]
        return &#39;{0}.html&#39;.format(what)
</pre></div>
<p>You can render any template you have depending on the value of the <tt class="docutils literal">what</tt> kwarg. To allow
only specific template names you can either add a check to the above implementation (i.e that
what is <tt class="docutils literal">help</tt> or <tt class="docutils literal">about</tt>) or you may do it to the urls.py if you use a regular expression. Thus,
to only allow <tt class="docutils literal">help.html</tt> and <tt class="docutils literal">about.html</tt> to be rendered with this method add it to your urls like&nbsp;this:</p>
<div class="highlight"><pre><span></span>re_path(r&#39;^show/(?P<span class="p">&lt;</span><span class="nt">what</span><span class="p">&gt;</span>help|about)/&#39;, views.DynamicTemplateView.as_view(), name=&#39;template-show&#39;),
</pre></div>
<p>Finally, to use it to render the <tt class="docutils literal">help.html</tt> you&#8217;ll just call it like &lt;a href=&#8217;{% url &#8220;template-show&#8221; &#8220;help&#8221;&nbsp;%}&#8217;&gt;Help&lt;/a&gt;</p>
<p>Notice that of course instead of creating the <tt class="docutils literal">DynamicTemplateView</tt> you could just dump these html files in your
static folder and return them using the static files functionality. However the extra thing that the <tt class="docutils literal">DynamicTemplateView</tt>
brings to you is that this is a full Django template thus you can use template tags, filters, your context variables, inherit
from your site-base and even override <tt class="docutils literal">get_context_data</tt> to add extra info to the template! All this is not possible with
static&nbsp;files!</p>
</div>
<div class="section" id="implement-a-partial-ajax-view">
<h3>Implement a partial Ajax&nbsp;view</h3>
<p>Overriding <tt class="docutils literal">get_template_names</tt> can also be used to create a <span class="caps">DRY</span> Ajax view
of your data! For example, let&#8217;s say that you have a <tt class="docutils literal">DetailView</tt> for one of your models that
has overriden the <tt class="docutils literal">get_template_names</tt> like&nbsp;this:</p>
<div class="highlight"><pre><span></span><span class="k">def</span><span class="w"> </span><span class="nf">get_template_names</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">is_ajax</span><span class="p">()</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">GET</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;ajax_partial&#39;</span><span class="p">):</span>
        <span class="k">return</span> <span class="s1">&#39;core/partial/data_ajax.html&#39;</span>
    <span class="k">return</span> <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">get_template_names</span><span class="p">()</span>
</pre></div>
<p>and you have also defined a normal template for classic request response viewing and an ajax template
that contains only the specific data for this instances (i.e it does not containg html body, headers, footers etc,
only a &lt;div&gt; with the instance&#8217;s data). Notice I&#8217;m using either the <tt class="docutils literal">is_ajax</tt> method or I directly passed <span class="caps">GET</span>
value (<tt class="docutils literal">ajax_partial</tt>) - this is needed because sometimes <tt class="docutils literal">is_ajax</tt> is not working as expected (depending on
how you&#8217;re going to do the request), also this way you can easily test the partial ajax view through your browser
by passing it <tt class="docutils literal"><span class="pre">?ajax_partia=true</span></tt>.</p>
<p>Using this technique you can create an Ajax view of your data just by requesting the DetailView through an
Ajax call and dumping the response you get to a modal dialog (for example)  - no need for fancy <span class="caps">REST</span> APIs. Also as
a bonus, the classic DetailView will work normally, so you can have the Ajax view to give a summary of the instance&#8217;s
data (i.e have a subset of the info on the Ajax template) and the normal view to display&nbsp;everything.</p>
</div>
<div class="section" id="add-a-dynamic-filter-and-or-table-to-the-context">
<h3>Add a dynamic filter and/or table to the&nbsp;context</h3>
<p>If you have a lot of similar models you can add a mixin that dynamically creates tables and a filters
for these models  - take a look at my <a class="reference external" href="https://spapas.github.io/2015/10/05/django-dynamic-tables-similar-models/">dynamic tables and filters for similar models</a>&nbsp;article!</p>
</div>
<div class="section" id="configure-forms-for-your-views">
<h3>Configure forms for your&nbsp;views</h3>
<p>As I&#8217;ve already explained if you are using a <tt class="docutils literal">FormView</tt> you&#8217;ll need to set a <tt class="docutils literal">form_class</tt> for
your view (needed by <tt class="docutils literal">FormMixin</tt>) while, for an Update or <tt class="docutils literal">CreateView</tt> which use the <tt class="docutils literal">ModelFormMixin</tt>
you can either set the <tt class="docutils literal"><span class="pre">form-class</span></tt> or directly configure the instance&#8217;s fields that will be displayed
to the form using the <tt class="docutils literal">fields</tt> attribute.</p>
<p>For example, let&#8217;s say that you have a rather generic <tt class="docutils literal">FormView</tt> that will display a different form
depending on the user permissions. Here&#8217;s how you could do this to return a <tt class="docutils literal">SuperForm</tt> if the
current user is a superuser and a <tt class="docutils literal">SimpleForm</tt> in other&nbsp;cases:</p>
<div class="highlight"><pre><span></span><span class="k">def</span><span class="w"> </span><span class="nf">get_form_class</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">user</span><span class="o">.</span><span class="n">is_superuser</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">SuperForm</span>
    <span class="k">return</span> <span class="n">SimpleForm</span>
</pre></div>
</div>
<div class="section" id="display-a-different-form-for-create-and-update">
<h3>Display a different form for Create and&nbsp;Update</h3>
<p>There are various ways you can do this (for example you can just declare a different <tt class="docutils literal">form_class</tt> for your
<tt class="docutils literal">Create</tt> and <tt class="docutils literal">UpdateView</tt>) but I think that the most <span class="caps">DRY</span> one, especially if the create and update form are
similar is to pass an <tt class="docutils literal">is_create</tt> argument to the form which it will then be used to properly configure the&nbsp;form.</p>
<p>Thus, on your <tt class="docutils literal">CreateView</tt> you&#8217;ll add this <tt class="docutils literal">get_form_kwargs</tt>:</p>
<div class="highlight"><pre><span></span><span class="k">def</span><span class="w"> </span><span class="nf">get_form_kwargs</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="n">kwargs</span> <span class="o">=</span> <span class="nb">super</span><span class="p">(</span><span class="n">MyCreateView</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">get_form_kwargs</span><span class="p">()</span>
    <span class="n">kwargs</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="s1">&#39;is_create&#39;</span><span class="p">:</span> <span class="kc">True</span><span class="p">})</span>
    <span class="k">return</span> <span class="n">kwargs</span>
</pre></div>
<p>while on your <tt class="docutils literal">UpdateView</tt> you&#8217;ll add&nbsp;this:</p>
<div class="highlight"><pre><span></span><span class="k">def</span><span class="w"> </span><span class="nf">get_form_kwargs</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="n">kwargs</span> <span class="o">=</span> <span class="nb">super</span><span class="p">(</span><span class="n">MyUpdateView</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">get_form_kwargs</span><span class="p">()</span>
    <span class="n">kwargs</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="s1">&#39;is_create&#39;</span><span class="p">:</span> <span class="kc">False</span><span class="p">})</span>
    <span class="k">return</span> <span class="n">kwargs</span>
</pre></div>
<p>Please notice that the form has to properly handle the extra kwarg in its constructor as I&#8217;ve already explained&nbsp;previously.</p>
</div>
<div class="section" id="only-allow-specific-http-methods-for-a-view">
<h3>Only allow specific <span class="caps">HTTP</span> methods for a&nbsp;view</h3>
<p>Let&#8217;s say that you want to create an <tt class="docutils literal">UnpublishView</tt> i.e a view that will change the status of your content
to <tt class="docutils literal"><span class="caps">DRAFT</span></tt>. Since this view will change your model instance it must be called through <tt class="docutils literal"><span class="caps">POST</span></tt>, however
you may not want to display an individual form for this view, just a button that when called will display
a client-side (Javascript) prompt and if the user clicks it it will immediately do a <tt class="docutils literal"><span class="caps">POST</span></tt> request
by submitting the form. The best way to create this is to just implement an <tt class="docutils literal">UpdateView</tt> for your model
and change its form valid to change the status to <tt class="docutils literal"><span class="caps">DRAFT</span></tt>, something like&nbsp;this:</p>
<div class="highlight"><pre><span></span><span class="k">def</span><span class="w"> </span><span class="nf">form_valid</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">form</span><span class="p">,</span> <span class="p">):</span>
    <span class="n">form</span><span class="o">.</span><span class="n">instance</span><span class="o">.</span><span class="n">status</span> <span class="o">=</span> <span class="s1">&#39;DRAFT&#39;</span>
    <span class="k">return</span> <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">form_valid</span><span class="p">(</span><span class="n">form</span><span class="p">)</span>
</pre></div>
<p>Beyond this, you&#8217;ll need to add a <tt class="docutils literal">fields = []</tt> attribute to your <tt class="docutils literal">UpdateView</tt> to denote that you won&#8217;t
need to update any fields from the model (since you&#8217;ll update the status directly) and finally, to only allow
this view to be called through an http <tt class="docutils literal"><span class="caps">POST</span></tt> method add the following&nbsp;attribute:</p>
<div class="highlight"><pre><span></span><span class="n">http_method_names</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;post&#39;</span><span class="p">,]</span>
</pre></div>
</div>
<div class="section" id="create-an-umbrella-view-for-multiple-models">
<h3>Create an umbrella View for multiple&nbsp;models</h3>
<p>Let&#8217;s say that you have a couple of models (called <tt class="docutils literal">Type1</tt> and <tt class="docutils literal">Type2</tt> that are more or less the same and
you want to quickly create a <tt class="docutils literal">ListView</tt> for both of them but you&#8217;d like to create just one <tt class="docutils literal">ListView</tt> and
separate them by their url. Here&#8217;s how it could be&nbsp;done:</p>
<div class="highlight"><pre><span></span><span class="k">class</span><span class="w"> </span><span class="nc">UmbrellaListView</span><span class="p">(</span><span class="n">ListView</span><span class="p">):</span>
    <span class="n">template_name</span><span class="o">=</span><span class="s1">&#39;umbrella_list.html&#39;</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">dispatch</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">kind</span> <span class="o">=</span> <span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;kind&#39;</span><span class="p">]</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">kind</span> <span class="o">==</span> <span class="s1">&#39;type1&#39;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">queryset</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">Type1</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">all</span><span class="p">()</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">kind</span> <span class="o">==</span> <span class="s1">&#39;type2&#39;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">queryset</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">Type2</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">all</span><span class="p">()</span>
        <span class="k">return</span> <span class="nb">super</span><span class="p">(</span><span class="n">UmbrellaListView</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">dispatch</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
</pre></div>
<p>Notice that for this to work properly you must setup your urls like&nbsp;this:</p>
<div class="highlight"><pre><span></span><span class="o">...</span>
<span class="n">url</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;^list/(?P&lt;kind&gt;type1|type2)/$&#39;</span><span class="p">,</span> <span class="n">UmbrellaListView</span><span class="o">.</span><span class="n">as_view</span><span class="p">()</span> <span class="p">)</span> <span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;umbrella_list&#39;</span> <span class="p">),</span>
<span class="o">...</span>
</pre></div>
</div>
</div>
<div class="section" id="a-heavy-cbv-user-project">
<h2>A heavy <span class="caps">CBV</span> user&nbsp;project</h2>
<p>In this small chapter I&#8217;d like to present a bunch of mixins and views that I&#8217;ve defined to the
accompanying project (<a class="reference external" href="https://github.com/spapas/cbv-tutorial">https://github.com/spapas/cbv-tutorial</a>).</p>
<p>Let&#8217;s start with the mixins (I won&#8217;t show the mixins I&#8217;ve already talked about in the previous&nbsp;chapter):</p>
<div class="highlight"><pre><span></span><span class="k">class</span><span class="w"> </span><span class="nc">SetOwnerIfNeeded</span><span class="p">:</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">form_valid</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">form</span><span class="p">,</span> <span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">form</span><span class="o">.</span><span class="n">instance</span><span class="o">.</span><span class="n">owned_by_id</span><span class="p">:</span>
            <span class="n">form</span><span class="o">.</span><span class="n">instance</span><span class="o">.</span><span class="n">owned_by</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">user</span>
        <span class="k">return</span> <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">form_valid</span><span class="p">(</span><span class="n">form</span><span class="p">)</span>


<span class="k">class</span><span class="w"> </span><span class="nc">ChangeStatusMixin</span><span class="p">:</span>
    <span class="n">new_status</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">form_valid</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">form</span><span class="p">,</span> <span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">new_status</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span><span class="s2">&quot;Please define new_status when using ChangeStatusMixin&quot;</span><span class="p">)</span>
        <span class="n">form</span><span class="o">.</span><span class="n">instance</span><span class="o">.</span><span class="n">status</span> <span class="o">=</span> <span class="n">new_status</span>
        <span class="k">return</span> <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">form_valid</span><span class="p">(</span><span class="n">form</span><span class="p">)</span>


<span class="k">class</span><span class="w"> </span><span class="nc">ContentCreateMixin</span><span class="p">(</span><span class="n">SuccessMessageMixin</span><span class="p">,</span>
                        <span class="n">AuditableMixin</span><span class="p">,</span>
                        <span class="n">SetOwnerIfNeeded</span><span class="p">,</span>
                        <span class="n">RequestArgMixin</span><span class="p">,</span>
                        <span class="n">SetInitialMixin</span><span class="p">,</span>
                        <span class="n">ModerationMixin</span><span class="p">,</span>
                        <span class="n">LoginRequiredMixin</span><span class="p">):</span>
    <span class="n">success_message</span> <span class="o">=</span> <span class="s1">&#39;Object successfully created!&#39;</span>


<span class="k">class</span><span class="w"> </span><span class="nc">ContentUpdateMixin</span><span class="p">(</span><span class="n">SuccessMessageMixin</span><span class="p">,</span>
                        <span class="n">AuditableMixin</span><span class="p">,</span>
                        <span class="n">SetOwnerIfNeeded</span><span class="p">,</span>
                        <span class="n">RequestArgMixin</span><span class="p">,</span>
                        <span class="n">SetInitialMixin</span><span class="p">,</span>
                        <span class="n">ModerationMixin</span><span class="p">,</span>
                        <span class="n">LimitAccessMixin</span><span class="p">,</span>
                        <span class="n">LoginRequiredMixin</span><span class="p">):</span>
    <span class="n">success_message</span> <span class="o">=</span> <span class="s1">&#39;Object successfully updated!&#39;</span>


<span class="k">class</span><span class="w"> </span><span class="nc">ContentListMixin</span><span class="p">(</span><span class="n">ExportCsvMixin</span><span class="p">,</span> <span class="n">AddFilterMixin</span><span class="p">,</span> <span class="n">HideRemovedMixin</span><span class="p">,</span> <span class="p">):</span>
    <span class="k">pass</span>


<span class="k">class</span><span class="w"> </span><span class="nc">ContentRemoveMixin</span><span class="p">(</span><span class="n">SuccessMessageMixin</span>
                         <span class="n">AdminOrPublisherPermissionRequiredMixin</span><span class="p">,</span>
                         <span class="n">AuditableMixin</span><span class="p">,</span>
                         <span class="n">HideRemovedMixin</span><span class="p">,</span>
                         <span class="n">ChangeStatusMixin</span><span class="p">,):</span>
    <span class="n">http_method_names</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;post&#39;</span><span class="p">,]</span>
    <span class="n">new_status</span> <span class="o">=</span> <span class="s1">&#39;REMOVED&#39;</span>
    <span class="n">fields</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">success_message</span> <span class="o">=</span> <span class="s1">&#39;Object successfully removed!&#39;</span>


<span class="k">class</span><span class="w"> </span><span class="nc">ContentUnpublishMixin</span><span class="p">(</span><span class="n">SuccessMessageMixin</span>
                            <span class="n">AdminOrPublisherPermissionRequiredMixin</span><span class="p">,</span>
                            <span class="n">AuditableMixin</span><span class="p">,</span>
                            <span class="n">UnpublishSuccessMessageMixin</span><span class="p">,</span>
                            <span class="n">ChangeStatusMixin</span><span class="p">,):</span>
    <span class="n">http_method_names</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;post&#39;</span><span class="p">,]</span>
    <span class="n">new_status</span> <span class="o">=</span> <span class="s1">&#39;DRAFT&#39;</span>
    <span class="n">fields</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">success_message</span> <span class="o">=</span> <span class="s1">&#39;Object successfully unpublished!&#39;</span>
</pre></div>
<p>The <tt class="docutils literal">SetOwnerIfNeeded</tt> and  <tt class="docutils literal">ChangeStatusMixin</tt> are simple mixins that override <tt class="docutils literal">form_valid</tt> to
introduce some functionality before saving the&nbsp;object).</p>
<p>The mixins that follow are used to group functionality of
other mixins together and will be inherited by the views. Thus, <tt class="docutils literal">ContentCreateMixin</tt> has the mixin functionality needed to create something (for example
an <tt class="docutils literal">Article</tt> or a <tt class="docutils literal">Document</tt>) i.e show a success message, add auditing information, set the object&#8217;s owner,
pass the request to the form, set the form&#8217;s initial values, do some moderation and only allow logged in users. On
a similar fashion, the <tt class="docutils literal">ContentUpdateMixin</tt> collects the functionality needed to update something and is similar to
<tt class="docutils literal">ContentCreateMixin</tt> (with the difference that it also as the <tt class="docutils literal">LimitAccessMixin</tt> to only allow simple users to
edit their own content). The <tt class="docutils literal">ContentListMixin</tt> adds functionality for export to <span class="caps">CSV</span>, simple filter and hiding removed&nbsp;things.</p>
<p>Finally, the <tt class="docutils literal">ContentRemoveMixin</tt> and <tt class="docutils literal">ContentUnpublishMixin</tt> are used to implement Views for removing and unpublishing
an object. Both of them inherit from <tt class="docutils literal">ChangeStatusMixin</tt> - one setting
the <tt class="docutils literal">new_status</tt> to <tt class="docutils literal"><span class="caps">REMOVED</span></tt> the other to <tt class="docutils literal"><span class="caps">DRAFT</span></tt>.</p>
<p>Notice that they share much functionality so I could
remove both <tt class="docutils literal">ContentRemoveMixin</tt> and <tt class="docutils literal">ContentUnpublishMixin</tt> and add a single <tt class="docutils literal">ContentChangeStatusMixin</tt> like&nbsp;this:</p>
<div class="highlight"><pre><span></span><span class="k">class</span><span class="w"> </span><span class="nc">ContentChangeStatusMixin</span><span class="p">(</span><span class="n">AdminOrPublisherPermissionRequiredMixin</span><span class="p">,</span>
                            <span class="n">AuditableMixin</span><span class="p">,</span>
                            <span class="n">UnpublishSuccessMessageMixin</span><span class="p">,</span>
                            <span class="n">ChangeStatusMixin</span><span class="p">,):</span>
    <span class="n">http_method_names</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;post&#39;</span><span class="p">,]</span>
    <span class="n">fields</span> <span class="o">=</span> <span class="p">[]</span>
</pre></div>
<p>Thus the <tt class="docutils literal">new_status</tt> attribute wouldn&#8217;t be there so the views inheriting from this <tt class="docutils literal">ContentChangeStatusMixin</tt>
(i.e <tt class="docutils literal">*RemoveView</tt> and <tt class="docutils literal">*UnpublishView</tt>) would need to define the <tt class="docutils literal">new_status</tt> field themselves.
This is definitely valid (and more <span class="caps">DRY</span>) but less explicit than the way I&#8217;ve implemented this - i.e you may
wanted to not allow publishers to remove objects, only admins (so you could implement that differently in the <tt class="docutils literal">get_queryset</tt>
or <tt class="docutils literal">dispatch</tt> method of <tt class="docutils literal">ContentRemoveMixin</tt> and <tt class="docutils literal">ContentUpdateMixin</tt>) this is easier if you have both the
<tt class="docutils literal">ContentRemoveMixin</tt> and <tt class="docutils literal">ContentUnpublishMixin</tt>.</p>
<p>Now let&#8217;s take a look at the&nbsp;views:</p>
<div class="highlight"><pre><span></span><span class="k">class</span><span class="w"> </span><span class="nc">CategoryListView</span><span class="p">(</span><span class="n">ExportCsvMixin</span><span class="p">,</span> <span class="n">AdminOrPublisherPermissionRequiredMixin</span><span class="p">,</span> <span class="n">ListView</span><span class="p">):</span>
    <span class="n">model</span> <span class="o">=</span> <span class="n">Category</span>
    <span class="n">context_object_name</span> <span class="o">=</span> <span class="s1">&#39;categories&#39;</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">get_queryset</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">qs</span> <span class="o">=</span> <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">get_queryset</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">qs</span><span class="o">.</span><span class="n">annotate</span><span class="p">(</span><span class="n">article_cnt</span><span class="o">=</span><span class="n">Count</span><span class="p">(</span><span class="s1">&#39;article&#39;</span><span class="p">),</span> <span class="n">document_cnt</span><span class="o">=</span><span class="n">Count</span><span class="p">(</span><span class="s1">&#39;document&#39;</span><span class="p">))</span>


<span class="k">class</span><span class="w"> </span><span class="nc">CategoryCreateView</span><span class="p">(</span><span class="n">SuccessMessageMixin</span><span class="p">,</span> <span class="n">AdminOrPublisherPermissionRequiredMixin</span><span class="p">,</span> <span class="n">CreateView</span><span class="p">):</span>
    <span class="n">model</span> <span class="o">=</span> <span class="n">Category</span>
    <span class="n">fields</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">]</span>
    <span class="n">success_message</span> <span class="o">=</span> <span class="s1">&#39;Category created!&#39;</span>
    <span class="n">success_url</span> <span class="o">=</span> <span class="n">reverse_lazy</span><span class="p">(</span><span class="s1">&#39;category-list&#39;</span><span class="p">)</span>


<span class="k">class</span><span class="w"> </span><span class="nc">CategoryUpdateView</span><span class="p">(</span><span class="n">SuccessMessageMixin</span><span class="p">,</span> <span class="n">AdminOrPublisherPermissionRequiredMixin</span><span class="p">,</span> <span class="n">UpdateView</span><span class="p">):</span>
    <span class="n">model</span> <span class="o">=</span> <span class="n">Category</span>
    <span class="n">fields</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">]</span>
    <span class="n">success_message</span> <span class="o">=</span> <span class="s1">&#39;Category updated!&#39;</span>
    <span class="n">success_url</span> <span class="o">=</span> <span class="n">reverse_lazy</span><span class="p">(</span><span class="s1">&#39;category-list&#39;</span><span class="p">)</span>


<span class="k">class</span><span class="w"> </span><span class="nc">CategoryDetailView</span><span class="p">(</span><span class="n">CategoriesContextMixin</span><span class="p">,</span> <span class="n">DetailView</span><span class="p">):</span>
    <span class="n">model</span> <span class="o">=</span> <span class="n">Category</span>
    <span class="n">context_object_name</span> <span class="o">=</span> <span class="s1">&#39;category&#39;</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">get_context_data</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="n">ctx</span> <span class="o">=</span> <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">get_context_data</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="n">ctx</span><span class="p">[</span><span class="s1">&#39;article_number&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">Article</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">category</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">object</span><span class="p">)</span><span class="o">.</span><span class="n">count</span><span class="p">()</span>
        <span class="n">ctx</span><span class="p">[</span><span class="s1">&#39;document_number&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">Document</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">category</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">object</span><span class="p">)</span><span class="o">.</span><span class="n">count</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">ctx</span>


<span class="k">class</span><span class="w"> </span><span class="nc">ArticleListView</span><span class="p">(</span><span class="n">ContentListMixin</span><span class="p">,</span> <span class="n">ListView</span><span class="p">):</span>
    <span class="n">model</span> <span class="o">=</span> <span class="n">Article</span>
    <span class="n">context_object_name</span> <span class="o">=</span> <span class="s1">&#39;articles&#39;</span>
    <span class="n">filter_class</span> <span class="o">=</span> <span class="n">ArticleFilter</span>


<span class="k">class</span><span class="w"> </span><span class="nc">ArticleCreateView</span><span class="p">(</span><span class="n">ContentCreateMixin</span><span class="p">,</span> <span class="n">CreateView</span><span class="p">):</span>
    <span class="n">model</span> <span class="o">=</span> <span class="n">Article</span>
    <span class="n">form_class</span> <span class="o">=</span> <span class="n">ArticleForm</span>
    <span class="n">success_url</span> <span class="o">=</span> <span class="n">reverse_lazy</span><span class="p">(</span><span class="s1">&#39;article-list&#39;</span><span class="p">)</span>


<span class="k">class</span><span class="w"> </span><span class="nc">ArticleUpdateView</span><span class="p">(</span><span class="n">ContentUpdateMixin</span><span class="p">,</span> <span class="n">UpdateView</span><span class="p">):</span>
    <span class="n">model</span> <span class="o">=</span> <span class="n">Article</span>
    <span class="n">form_class</span> <span class="o">=</span> <span class="n">ArticleForm</span>
    <span class="n">success_url</span> <span class="o">=</span> <span class="n">reverse_lazy</span><span class="p">(</span><span class="s1">&#39;article-list&#39;</span><span class="p">)</span>


<span class="k">class</span><span class="w"> </span><span class="nc">ArticleDetailView</span><span class="p">(</span><span class="n">HideRemovedMixin</span><span class="p">,</span> <span class="n">JsonDetailMixin</span><span class="p">,</span> <span class="n">DetailView</span><span class="p">):</span>
    <span class="n">model</span> <span class="o">=</span> <span class="n">Article</span>
    <span class="n">context_object_name</span> <span class="o">=</span> <span class="s1">&#39;article&#39;</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">get_template_names</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">is_ajax</span><span class="p">()</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">GET</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;partial&#39;</span><span class="p">):</span>
            <span class="k">return</span> <span class="s1">&#39;djangocbv/_article_content_partial.html&#39;</span>
        <span class="k">return</span> <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">get_template_names</span><span class="p">()</span>


<span class="k">class</span><span class="w"> </span><span class="nc">ArticleRemoveView</span><span class="p">(</span><span class="n">ContentRemoveMixin</span><span class="p">,</span> <span class="n">UpdateView</span><span class="p">):</span>
    <span class="n">model</span> <span class="o">=</span> <span class="n">Article</span>
    <span class="n">success_url</span> <span class="o">=</span> <span class="n">reverse_lazy</span><span class="p">(</span><span class="s1">&#39;article-list&#39;</span><span class="p">)</span>


<span class="k">class</span><span class="w"> </span><span class="nc">ArticleUnpublishView</span><span class="p">(</span><span class="n">ContentUnpublishMixin</span><span class="p">,</span> <span class="n">UpdateView</span><span class="p">):</span>
    <span class="n">model</span> <span class="o">=</span> <span class="n">Article</span>
    <span class="n">success_url</span> <span class="o">=</span> <span class="n">reverse_lazy</span><span class="p">(</span><span class="s1">&#39;article-list&#39;</span><span class="p">)</span>


<span class="k">class</span><span class="w"> </span><span class="nc">DocumentListView</span><span class="p">(</span><span class="n">ContentListMixin</span><span class="p">,</span> <span class="n">ListView</span><span class="p">):</span>
    <span class="n">model</span> <span class="o">=</span> <span class="n">Document</span>
    <span class="n">context_object_name</span> <span class="o">=</span> <span class="s1">&#39;documents&#39;</span>
    <span class="n">filter_class</span> <span class="o">=</span> <span class="n">DocumentFilter</span>


<span class="k">class</span><span class="w"> </span><span class="nc">DocumentCreateView</span><span class="p">(</span><span class="n">ContentCreateMixin</span><span class="p">,</span> <span class="n">CreateView</span><span class="p">):</span>
    <span class="n">model</span> <span class="o">=</span> <span class="n">Document</span>
    <span class="n">form_class</span> <span class="o">=</span> <span class="n">DocumentForm</span>
    <span class="n">success_url</span> <span class="o">=</span> <span class="n">reverse_lazy</span><span class="p">(</span><span class="s1">&#39;document-list&#39;</span><span class="p">)</span>


<span class="k">class</span><span class="w"> </span><span class="nc">DocumentUpdateView</span><span class="p">(</span><span class="n">ContentUpdateMixin</span><span class="p">,</span> <span class="n">UpdateView</span><span class="p">):</span>
    <span class="n">model</span> <span class="o">=</span> <span class="n">Document</span>
    <span class="n">form_class</span> <span class="o">=</span> <span class="n">DocumentForm</span>
    <span class="n">success_url</span> <span class="o">=</span> <span class="n">reverse_lazy</span><span class="p">(</span><span class="s1">&#39;document-list&#39;</span><span class="p">)</span>


<span class="k">class</span><span class="w"> </span><span class="nc">DocumentDetailView</span><span class="p">(</span><span class="n">HideRemovedMixin</span><span class="p">,</span> <span class="n">JsonDetailMixin</span><span class="p">,</span> <span class="n">DetailView</span><span class="p">):</span>
    <span class="n">model</span> <span class="o">=</span> <span class="n">Document</span>
    <span class="n">context_object_name</span> <span class="o">=</span> <span class="s1">&#39;document&#39;</span>


<span class="k">class</span><span class="w"> </span><span class="nc">DocumentRemoveView</span><span class="p">(</span><span class="n">ContentRemoveMixin</span><span class="p">,</span> <span class="n">UpdateView</span><span class="p">):</span>
    <span class="n">model</span> <span class="o">=</span> <span class="n">Document</span>
    <span class="n">success_url</span> <span class="o">=</span> <span class="n">reverse_lazy</span><span class="p">(</span><span class="s1">&#39;document-list&#39;</span><span class="p">)</span>


<span class="k">class</span><span class="w"> </span><span class="nc">DocumentUnpublishView</span><span class="p">(</span><span class="n">ContentUnpublishMixin</span><span class="p">,</span> <span class="n">UpdateView</span><span class="p">):</span>
    <span class="n">model</span> <span class="o">=</span> <span class="n">Document</span>
    <span class="n">success_url</span> <span class="o">=</span> <span class="n">reverse_lazy</span><span class="p">(</span><span class="s1">&#39;document-list&#39;</span><span class="p">)</span>


<span class="k">class</span><span class="w"> </span><span class="nc">DynamicTemplateView</span><span class="p">(</span><span class="n">TemplateView</span><span class="p">):</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">get_template_names</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">what</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;what&#39;</span><span class="p">]</span>
        <span class="k">return</span> <span class="s1">&#39;</span><span class="si">{0}</span><span class="s1">.html&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">what</span><span class="p">)</span>
</pre></div>
<p>As you will see there&nbsp;are</p>
<ul class="simple">
<li>4 views related to categories (Create, Detail, Update and&nbsp;List)</li>
<li>6 views related to articles (Create, Detail, Update, List, Unpublish and Remove)&nbsp;and</li>
<li>another 6 views related to documents (same as&nbsp;articles).</li>
</ul>
<p>The views for <tt class="docutils literal">Article</tt> and <tt class="docutils literal">Document</tt> are more or less the same: They inherit
from the corresponding mixin we defined previously (<tt class="docutils literal">CreateContentMixin</tt>, <tt class="docutils literal">UpdateContentMixin</tt> etc) add a
redirect to their corresponding list view (I am using <tt class="docutils literal">redirect_lazy</tt> there because <tt class="docutils literal">redirect</tt> wouldn&#8217;t work
because it will lead to a cyclic dependency between urls and views) and define their corresponding form and model.
For the the DetailViews I don&#8217;t use a group mixin like the others but I just add the <tt class="docutils literal">HideRemovedMixin</tt> and
<tt class="docutils literal">JsonDetailMixin</tt> directly to their ancestor list. This is to make clear that the group mixins (<tt class="docutils literal">ContentCreateMixin</tt> etc)
are optional and I could for example define <tt class="docutils literal">ArticleCreateView</tt> like&nbsp;this:</p>
<div class="highlight"><pre><span></span><span class="k">class</span><span class="w"> </span><span class="nc">ArticleCreateView</span><span class="p">(</span><span class="n">SuccessMessageMixin</span><span class="p">,</span>
                    <span class="n">AuditableMixin</span><span class="p">,</span>
                    <span class="n">SetOwnerIfNeeded</span><span class="p">,</span>
                    <span class="n">RequestArgMixin</span><span class="p">,</span>
                    <span class="n">SetInitialMixin</span><span class="p">,</span>
                    <span class="n">ModerationMixin</span><span class="p">,</span>
                    <span class="n">LoginRequiredMixin</span><span class="p">,</span>
                    <span class="n">CreateView</span><span class="p">):</span>
    <span class="n">model</span> <span class="o">=</span> <span class="n">Article</span>
    <span class="n">form_class</span> <span class="o">=</span> <span class="n">ArticleForm</span>
    <span class="n">success_url</span> <span class="o">=</span> <span class="n">reverse_lazy</span><span class="p">(</span><span class="s1">&#39;article-list&#39;</span><span class="p">)</span>
    <span class="n">success_message</span> <span class="o">=</span> <span class="s1">&#39;Object successfully created!&#39;</span>
</pre></div>
<p>What&#8217;s the advantage of using the  <tt class="docutils literal">ContentCreateMixin</tt>  then? Well since the same mixins are used from <tt class="docutils literal">DocumentCreateView</tt>
I won&#8217;t need to re-define this list there. Also if for example I want to allow users that have a specific permission to create
articles and document I will remove the <tt class="docutils literal">LoginRequireMixin</tt> and add the <tt class="docutils literal">AllowCreateContentMixin</tt> only to the <tt class="docutils literal">ContentCreateMixin</tt>
and not to both <tt class="docutils literal">ArticleCreateView</tt> and <tt class="docutils literal">DocumentCreateView</tt> (and I won&#8217;t be in danger of forgetting to change it somewhere).
Of course all this depends on your requirements and how <span class="caps">DRY</span> you need to&nbsp;be.</p>
<p>The category related views are simpler and override their mixins directly. Finally there&#8217;s a <tt class="docutils literal">DynamicTemplateView</tt> to
display templates based on their filename as discussed&nbsp;previously.</p>
<p>Before continuing, please try to understand how much more <span class="caps">DRY</span> this project is when compared to using a traditional
functional one (or if not using mixins). For example, there&#8217;s a <tt class="docutils literal">RequestArgMixin</tt> that is used by all views that create/update content. If <span class="caps">INHERITANCE</span>
didn&#8217;t use that mixin I&#8217;d need to re-define the same functionality (pass the current request to the form&#8217;s constructor) to
4 views (Article/Document Create/Update). Or for the <tt class="docutils literal">AuditableMixin</tt> I&#8217;d need to remember to upgrade the created/modified by
to 8 views (Article/Document&nbsp;Create/Update/Unpublish/Remove)!</p>
</div>
<div class="section" id="conclusion">
<h2>Conclusion</h2>
<p>The previous discussion should convince you how much more <span class="caps">DRY</span> your views will be when using CBVs and how
much quicker will be to create your views. Also, if
you followed closely the first and second chapters you should be able to understand everything that is
needed for CBVs and be able to properly understand which method or attribute you need to override to
implement some specific functionality. Finally, the list of examples in the third chapter should help
you get started in all your <span class="caps">CBV</span> needs - if you have some specific question about CBVs or you&#8217;d like
another use case added to the list feel free to ask and I&#8217;ll try to add&nbsp;it!</p>
<p><em>Update 21/04/2020</em> As per commenter&#8217;s Ahmed I. Elsayed comment, there are sites with a similar
functionality with the <span class="caps">CBV</span> inspector for the Django Rest Framework (<a class="reference external" href="http://www.cdrf.co/">http://www.cdrf.co/</a>) and
Django Forms (<a class="reference external" href="https://cdf.9vo.lt/">https://cdf.9vo.lt/</a>)! They are an excellent resource for&nbsp;reference!!</p>
</div>
</div>
  		</article>
  		<article>
<header>
      <h1 class="entry-title">
        <a href="https://www.spapas.net/2018/03/06/easy-youtube-mp3-downloading/">Easy downloading youtube videos and mp3s using youtube-dl and python</a>
      </h1>
    <p class="meta">
<time datetime="2018-03-06T12:20:00+02:00" pubdate>Tue 06 March 2018</time>    </p>
</header>

<div class="entry-content"><p>In this article I am going to present you with an easy (and advertisement/malware free) way to download
videos from youtube, converting them to mp3 if needed. Also, I will give some more useful hints, for
example how to download multiple mp3s using a script, how to break a long mp3 to same-length parts
so you could quickly skip tracks when you play it in your stereo&nbsp;etc.</p>
<p>I am going to give specific instructions for Windows users - however everything I&#8217;ll propose should also be applicable
to <span class="caps">OSX</span> or Linux users with minor&nbsp;modifications.</p>
<p>The tools we are going to use&nbsp;are:</p>
<ul class="simple">
<li><a class="reference external" href="https://rg3.github.io/youtube-dl/">youtube-dl</a> which is a python library for downloading videos from youtube (and some other&nbsp;sites)</li>
<li><a class="reference external" href="https://www.ffmpeg.org">ffmpeg</a> which is a passepartout video/audio editing&nbsp;library</li>
</ul>
<div class="section" id="installation">
<h2>Installation</h2>
<p>To install youtube-dl I recommend installing it in your global python (2 or 3) package list using pip. Please read my
<a class="reference external" href="https://www.spapas.net/2017/12/20/python-2-3-windows/">previous</a>&nbsp;article</p>
<p>to see how you should install and use Python 2 or 3
on Windows. Following the instructions from there, you can do the following to install youtube-dl in your global
Python 3&nbsp;packages:</p>
<pre class="code literal-block">
py -3 -m pip install youtube-dl
</pre>
<p>To run youtube-dl you&#8217;ll write something like <tt class="docutils literal">py <span class="pre">-3</span> <span class="pre">-m</span> youtube_dl url_or_video_id</tt> (notice the underscore instead of dash since
dashes are not supported in module names in python). For example try something like this <tt class="docutils literal">py <span class="pre">-3</span> <span class="pre">-m</span> youtube_dl YgtL4S7Hrwo</tt> and you&#8217;ll
be rewarded with the 2016 Pycon talk from Guido van Rossum! If you find this a little too much too type don&#8217;t be afraid, I will give
some hints later about how to improve&nbsp;this.</p>
<p>To upgrade your youtube-dl installation you should do something like&nbsp;this:</p>
<pre class="code literal-block">
py -3 -m pip install -U youtube-dl
</pre>
<p>Notice that you must frequently upgrade your youtube-dl installation because sometimes youtube changes the requirements
for viewing / downloading videos and your old version will not work. So if for some reason something is not correct when
you use youtube-dl always try updating&nbsp;first.</p>
<p>If you wanted you could also create a virtual environment (see instructions on previously mentioned article) and install youtube-dl locally there using <tt class="docutils literal">pip install <span class="pre">youtube-dl</span></tt>
however I prefer to install it on the global packages to be really easy for me to call it from a command prompt I open. Notice
that if you install youtube-dl in a virtualenv, after you activate that virtualenv you&#8217;ll be able to run it just by typing <tt class="docutils literal"><span class="pre">youtube-dl</span></tt>.</p>
<p>Finally, If for some reason you don&#8217;t want want to mess with python and all this (or it just seems greek to you) then you
may go on and directly download a <a class="reference external" href="https://yt-dl.org/latest/youtube-dl.exe">youtube-dl windows executable</a>. Just put it in your path and you should be good to&nbsp;go.</p>
<p>To install ffmpeg, I recommend <a class="reference external" href="https://ffmpeg.zeranoe.com/builds/">downloading the Windows build from here</a> (select the correct Windows architecture of your system and
always static linking - the version doesn&#8217;t matter). This will get you a zip - we are mainly interested to the three files under the
<tt class="docutils literal">bin</tt> folder of that zip which should be copied to a directory under your&nbsp;path:</p>
<ul class="simple">
<li>ffmpeg is the passepartout video converting toot that we are going to&nbsp;use</li>
<li>ffprobe will print some information about a file (about its container and video/audio&nbsp;streams)</li>
<li>ffplay will play the file &#8212; not really recommended there are better tools but it is invaluable
for testing; if it can be played be ffplay then ffmpeg will be able to properly read your&nbsp;file</li>
</ul>
<p>Notice I recommend copying things to a directory in your path. This is recommended and will save you from repeatedly typing the same things
over and over. Also, later I will propose a bunch of <span class="caps">DOS</span> batch (.bat) files that can also be copied to that directory and help you even
more in you youtube video downloading. To add a directory to the <span class="caps">PATH</span>, just press Windows+Pause Break, Advanced System Settings, Advanced,
Environment Variables, edit the &#8220;Path&#8221; User variable (for your user) and append the directory&nbsp;there.</p>
</div>
<div class="section" id="using-youtube-dl">
<h2>Using&nbsp;youtube-dl</h2>
<p>As I&#8217;ve already explained before, to run youtube-dl you&#8217;ll either write something like <tt class="docutils literal">py <span class="pre">-3</span> <span class="pre">-m</span> youtube_dl</tt> (if you&#8217;ve installed it
to your global python packages) or run youtube-dl if you&#8217;ve downloaded the pre-built exe or have installed it in a virtualenv. To save
you from some keystrokes, you can create a batch file that will run and pass any more parameters to it, something like&nbsp;this:</p>
<pre class="code literal-block">
py -3 -m youtube_dl %*
</pre>
<p>(the %* will capture the remaining command line) so to get the previous video just run <tt class="docutils literal">getvideo YgtL4S7Hrwo</tt>
(or getvideo <a class="reference external" href="https://www.youtube.com/watch?v=YgtL4S7Hrwo">https://www.youtube.com/watch?v=YgtL4S7Hrwo</a> - works the same with the video id or the complete&nbsp;url).</p>
<p>One thing I&#8217;d like to mention here is that youtube-dl works fine with playlists and even channels. For example,
to download all videos from PyCon 2017 just do&nbsp;this:</p>
<p><tt class="docutils literal">getvideo <span class="pre">https://www.youtube.com/channel/UCrJhliKNQ8g0qoE_zvL8eVg/feed</span></tt> and you should see something&nbsp;like:</p>
<pre class="code literal-block">
E:\&gt;py -3 -m youtube_dl https://www.youtube.com/channel/UCrJhliKNQ8g0qoE_zvL8eVg/feed
[youtube:channel] UCrJhliKNQ8g0qoE_zvL8eVg: Downloading channel page
[youtube:playlist] UUrJhliKNQ8g0qoE_zvL8eVg: Downloading webpage
[download] Downloading playlist: Uploads from PyCon 2017
[youtube:playlist] UUrJhliKNQ8g0qoE_zvL8eVg: Downloading page #1
[youtube:playlist] playlist Uploads from PyCon 2017: Downloading 143 videos
[download] Downloading video 1 of 143
[youtube] AjFfsOA7AQI: Downloading webpage
[youtube] AjFfsOA7AQI: Downloading video info webpage
[youtube] AjFfsOA7AQI: Extracting video information
WARNING: Requested formats are incompatible for merge and will be merged into mkv.
[download] Destination: Final remarks and conference close  - Pycon 2017-AjFfsOA7AQI.f137.mp4
[download]   2.9% of 34.49MiB at 940.52KiB/s ETA 00:36
</pre>
<p>This is gonna take some time&nbsp;&#8230;</p>
<p>Now, youtube-dl has <a class="reference external" href="https://github.com/rg3/youtube-dl/blob/master/README.md#options">many options</a> and can be configured with <a class="reference external" href="https://github.com/rg3/youtube-dl/blob/master/README.md#configuration">default values</a> depending on your
requirements. I won&#8217;t go into detail about these except on some things I usually use, if you
need some help feel free to ask&nbsp;me.</p>
<p>When you download a video, youtube-dl will try to download the best quality possible for that video,
however a video may have various different formats that can be queries by passing the option <tt class="docutils literal"><span class="pre">--list-formats</span></tt>
to ffmpeg, for example here&#8217;s the output from the previously mentioned&nbsp;video:</p>
<pre class="code literal-block">
E:\&gt;getvideo YgtL4S7Hrwo --list-formats
[youtube] YgtL4S7Hrwo: Downloading webpage
[youtube] YgtL4S7Hrwo: Downloading video info webpage
[youtube] YgtL4S7Hrwo: Extracting video information
[info] Available formats for YgtL4S7Hrwo:
format code  extension  resolution note
249          webm       audio only DASH audio   53k , opus &#64; 50k, 15.14MiB
250          webm       audio only DASH audio   72k , opus &#64; 70k, 20.29MiB
171          webm       audio only DASH audio  111k , vorbis&#64;128k, 29.42MiB
140          m4a        audio only DASH audio  130k , m4a_dash container, mp4a.40.2&#64;128k, 38.38MiB
251          webm       audio only DASH audio  130k , opus &#64;160k, 36.94MiB
278          webm       256x144    144p   58k , webm container, vp9, 30fps, video only, 11.01MiB
242          webm       426x240    240p   88k , vp9, 30fps, video only, 12.40MiB
160          mp4        256x144    144p  120k , avc1.4d400c, 30fps, video only, 33.64MiB
243          webm       640x360    360p  153k , vp9, 30fps, video only, 23.48MiB
134          mp4        640x360    360p  230k , avc1.4d401e, 30fps, video only, 28.91MiB
133          mp4        426x240    240p  260k , avc1.4d4015, 30fps, video only, 74.75MiB
244          webm       854x480    480p  289k , vp9, 30fps, video only, 39.31MiB
135          mp4        854x480    480p  488k , avc1.4d401f, 30fps, video only, 56.43MiB
247          webm       1280x720   720p  945k , vp9, 30fps, video only, 102.45MiB
136          mp4        1280x720   720p 1074k , avc1.4d401f, 30fps, video only, 116.72MiB
17           3gp        176x144    small , mp4v.20.3, mp4a.40.2&#64; 24k
36           3gp        320x180    small , mp4v.20.3, mp4a.40.2
43           webm       640x360    medium , vp8.0, vorbis&#64;128k
18           mp4        640x360    medium , avc1.42001E, mp4a.40.2&#64; 96k
22           mp4        1280x720   hd720 , avc1.64001F, mp4a.40.2&#64;192k (best)
</pre>
<p>As you can see, each has an id and defines an extension (container)  and info about its video and audio stream.
You can download a <em>specific</em> format by using the -f command line otpion. For example , to download the audio-only
format with the worst audio quality use <tt class="docutils literal"><span class="pre">C:\Users\serafeim&gt;getvideo</span> YgtL4S7Hrwo <span class="pre">-f</span> 249</tt>. Notice that there are
formats with audio ony and other formats with vide only. To download the worst format possible (resulting in the
smallest file size of course ) you can pass the <tt class="docutils literal"><span class="pre">-f</span> worst</tt> command line (there&#8217;s also a <tt class="docutils literal"><span class="pre">-f</span> best</tt> command line
which is used by&nbsp;default).</p>
<p>Another thing I&#8217;d like to point out here is that you can define an <a class="reference external" href="https://github.com/rg3/youtube-dl/blob/master/README.md#output-template">output template</a> using the <tt class="docutils literal"><span class="pre">-o</span></tt> option that
will format the name of the output file of your video using the provided options. There are  <a class="reference external" href="https://github.com/rg3/youtube-dl/blob/master/README.md#output-template-examples">many examples in the docs</a>
so I won&#8217;t go into any more details&nbsp;here.</p>
<p>Another cool option is the -a that will help you download all videos from a file. For example, if you have a file
named <tt class="docutils literal">videos.txt</tt> with the following&nbsp;contsnts:</p>
<pre class="code literal-block">
AjFfsOA7AQI
3dDtACSYVx0
G17E4Muylis
</pre>
<p>running <tt class="docutils literal">getvideo <span class="pre">-a</span> videos.txt <span class="pre">-f</span> worst</tt></p>
<p>will get you all three videos in their worst quality. If you don&#8217;t want to create files then you can use something
like&nbsp;this:</p>
<pre class="code literal-block">
for %i in (AjFfsOA7AQI 3dDtACSYVx0 G17E4Muylis) do getvideo %i -f worst
</pre>
<p>and it will run  getvideo for all three&nbsp;files.</p>
<p>Some more options I&#8217;d like to recommend using&nbsp;are:</p>
<ul class="simple">
<li><tt class="docutils literal"><span class="pre">--restrict-filenames</span></tt> to avoid strange&nbsp;filenames</li>
<li><tt class="docutils literal"><span class="pre">--ignore-errors</span></tt> to ignore errors when download multiple files (from a playlist or a channel) - this is really
useful because if you have a play with missing items youtube-dl will stop downloading the remaining files when it
encounters the missing&nbsp;one</li>
</ul>
<p>If you want to always use these options you may add them to your configuration file (<tt class="docutils literal"><span class="pre">C:\Users\&lt;user</span> <span class="pre">name&gt;\youtube-dl.conf</span></tt>)
or to the getvideo.bat defined above i.e getvideo.bat will&nbsp;be:</p>
<pre class="code literal-block">
py -3 -m youtube_dl --restrict-filenames --ignore-errors %*
</pre>
</div>
<div class="section" id="extracting-mp3s">
<h2>Extracting&nbsp;mp3s</h2>
<p>The next step in this trip is to understand how to extract mp3s from videos that are downloaded from youtube. If you&#8217;ve
payed attention you&#8217;d know that by now you can download audio-only formats from youtube - however they are in a format
called <a class="reference external" href="https://en.wikipedia.org/wiki/Dynamic_Adaptive_Streaming_over_HTTP"><span class="caps">DASH</span></a> which most probably is <em>not</em> playable by your car stereo (<span class="caps">DASH</span> is specialized for streaming audio through <span class="caps">HTTP</span>).</p>
<p>Thus, the proper way to get mp3s is to post-process
the downloaded file using ffmpeg to convert it to mp3. This could be done manually (by doing something
<tt class="docutils literal">ffmpeg <span class="pre">-i</span> input out.mp3</tt> &#8212; ffmpeg is smart enough to know how to convert per extension)
but thankfully youtube-dl offers the <tt class="docutils literal"><span class="pre">-x</span></tt> (and friend) parameters to make this automatic. Using <tt class="docutils literal"><span class="pre">-x</span></tt> tells
youtube-dl to extract the audio from the video (notice that youtube-dl is smart enough to download one of the audio-only
formats so you don&#8217;t have ). Using -x alone may result in a different audio format (for example .ogg) so to force conversion to mp3
you should also add the  <tt class="docutils literal"><span class="pre">--audio-format</span> mp3</tt> parameter. Thus, to download an mp3 you can use the following command
line (continuing from the previous&nbsp;examples):</p>
<pre class="code literal-block">
py -3 -m youtube_dl --restrict-filenames --ignore-errors -x --audio-format mp3  AjFfsOA7AQI
</pre>
<p>or even better, create a <tt class="docutils literal">getmp3.bat</tt> batch file that will be used to retrieve an&nbsp;mp3:</p>
<pre class="code literal-block">
py -3 -m youtube_dl --restrict-filenames --ignore-errors -x --audio-format mp3 %1
</pre>
<p>Please notice that also in this case youtube-dl is smart enough to download an audio-only format thus
you won&#8217;t need to select it by hand using <tt class="docutils literal"><span class="pre">-f</span></tt> to save&nbsp;bandwith.</p>
</div>
<div class="section" id="splitting-the-mp3-file-to-parts">
<h2>Splitting the mp3 file to&nbsp;parts</h2>
<p>Some people would like to split their large mp3 files to same-length segments. Of course it would be better
for the file to be split by silence to individual songs (if the file contains songs) but these methods usually
don&#8217;t work that good so I prefer the same length segments. To do that using ffmpeg you just need to add the
following&nbsp;parameters:</p>
<pre class="code literal-block">
ffmpeg -i input.mp3 -segment_time 180 -f segment out.%03d.mp3&quot;
</pre>
<p>The segment time is in seconds (so each segment will be 3 minutes) while the output files will have a name like
<tt class="docutils literal">out.001.mp3, out.002.mp3</tt> etc.</p>
<p>What if you&#8217;d like to make the segmentation automatic? For this, I recommend writing a batch file with two
commands - one to download the mp3 and a second one to call ffmpeg to segment the file. Notice that you
could use the <tt class="docutils literal"><span class="pre">--postprocessor-args</span> <span class="caps">ARGS</span></tt> command line parameter to pass the required arguments to youtube-dl
so it will be done in one command however I&#8217;d like to have a little more control thus I prefer two commands (if
you decide to use <tt class="docutils literal"><span class="pre">--postprocessor-args</span> <span class="caps">ARGS</span></tt> keep in mind that args must be inside double quotes&nbsp;&#8220;&#8221;).</p>
<p>Since we are going to use two commands, we need to feed the output file of youtube-dl to ffmpeg and specify a
name for the ffmpeg output file-segments. The easiest way to do that is to just pass two parameters to the batch
file - one for the video to download and one for its name. Copy the following to a file named <tt class="docutils literal">getmp3seg.bat</tt>:</p>
<pre class="code literal-block">
py -3 -m youtube_dl %1 -x --audio-format mp3 --audio-quality 128k -o %2.%%(ext)s&quot;
ffmpeg -i %2.mp3 -segment_time 180 -f segment %2.%%03d.mp3
del %2.mp3
</pre>
<p>You can then call it like this: <tt class="docutils literal">getmp3seg AjFfsOA7AQI test</tt>. The first line will download and covert
the video to mp3 and put it in a file named <tt class="docutils literal">test.mp3</tt> (the %2 is the test, the %% is used to
escape the % and the %(ext)s is the extensions - this is needed if you use something like -o %2.mp3
youtube-dl will be confused when trying to convert the file to mp3 and will not work). The 2nd line
will segment the file to 180 second seconds (notice that here also we need to escape %) and the third
line will delete the original mp3. This leaves us with the following 4 files (the video was around 10 minutes): <tt class="docutils literal">test.000.mp3,
test.001.mp3, test.002.mp3, test.003.mp3</tt>.</p>
<p>One final thing I&#8217;d like to present here is a (more complex) script that you can use to download a video
and segmentize it only if it is more than 360 seconds. For this, we will also use the <a class="reference external" href="http://ibiblio.org/mp3info/">mp3info</a> util which can
be downloaded directly from the homepage and copied to the path. So copy the following to a script named <tt class="docutils literal">getmp3seg2.bat</tt>:</p>
<pre class="code literal-block">
&#64;echo off

IF &quot;%2&quot;==&quot;&quot; GOTO HAVE_1

py -3 -m youtube_dl %1 -x --audio-format mp3 -o %2.%%(ext)s&quot;

FOR /f %%i IN ('mp3info -p &quot;%%S&quot; %2.mp3') DO SET koko=%%i

IF %koko%  GTR 360 (
        ECHO greater than or equal to 360
        ffmpeg -i %2.mp3 -segment_time 180 -f segment %2.%%03d.mp3
        del %2.mp3
)  else (
   ECHO less than 360
)

GOTO :eof

:HAVE_1
ECHO Please call this file with video id and title
</pre>
<p>This is a little more complex - I&#8217;ll explain it quickly: <tt class="docutils literal">&#64;echo off</tt> is used to suppress non needed output.
The <tt class="docutils literal"><span class="caps">IF</span></tt> following makes sure that you have two parameters. The next line downloads the file and converts it to mp3. The <tt class="docutils literal"><span class="caps">FOR</span></tt>
loop is a little strange but it&#8217;s result will be to retrieve the output of <tt class="docutils literal">mp3info <span class="pre">-o</span> &quot;%S&quot; title.mp3</tt> (which is the
duration in seconds of that mp3) and assign it to the <tt class="docutils literal">koko</tt> variable. The next <tt class="docutils literal"><span class="caps">IF</span></tt> checks if <tt class="docutils literal">koko</tt> is greater than (<tt class="docutils literal"><span class="caps">GTR</span></tt>)
360 seconds and if yes will run the conversion code we discussed before - else it will just output that it is less than 360&nbsp;seconds.</p>
<p>Finally, there&#8217;s a <tt class="docutils literal"><span class="caps">GOTO</span>: eof</tt> line to skip printing the error message when the batch is called with less than two&nbsp;parameters.</p>
</div>
<div class="section" id="using-youtube-dl-from-python">
<h2>Using youtube-dl from&nbsp;python</h2>
<p>Integrating with youtube-dl from python is easy. Of course, you could just go on and directly call the command line
however you can have more control. The most important class is <tt class="docutils literal">youtube_dl.YoutubeDL.YoutubeDL</tt>. You instantiate
an object of this class class passing the parameters you&#8217;d like and call its <tt class="docutils literal">download()</tt> instance method passing
a list of urls. Here&#8217;s a small script that downloads the input video&nbsp;ids:</p>
<div class="highlight"><pre><span></span><span class="kn">import</span><span class="w"> </span><span class="nn">sys</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">youtube_dl</span><span class="w"> </span><span class="kn">import</span> <span class="n">YoutubeDL</span>

<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s1">&#39;__main__&#39;</span><span class="p">:</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
        <span class="n">ydl_opts</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">ydl</span> <span class="o">=</span> <span class="n">YoutubeDL</span><span class="p">(</span><span class="n">ydl_opts</span><span class="p">)</span>
        <span class="n">ydl</span><span class="o">.</span><span class="n">download</span><span class="p">(</span><span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">[</span><span class="mi">1</span><span class="p">:])</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Enter list of urls to download&quot;</span><span class="p">)</span>
        <span class="n">exit</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
</pre></div>
<p>Save it in a file named getvideo.py and run it like <tt class="docutils literal">py <span class="pre">-3</span> getvideo.py AjFfsOA7AQI 3dDtACSYVx0 G17E4Muylis</tt> to download all three&nbsp;videos!</p>
</div>
<div class="section" id="fixing-your-unicode-names">
<h2>Fixing your unicode&nbsp;names</h2>
<p>The last thing I&#8217;d like to talk about concerns people that want to download videos with Unicode characters in their titles (for example&nbsp;Greek).</p>
<p>Let&#8217;s suppose that you want to download the file vFVNOaUPRow which is piano music from a well-know greek composer. If you get it without parameters
(for example <tt class="docutils literal">py <span class="pre">-3</span> <span class="pre">-m</span> youtube_dl <span class="pre">-x</span> <span class="pre">--audio-format</span> mp3 vFVNOaUPRow</tt>)
you&#8217;ll get the following output file: <tt class="docutils literal">Ο Μάνος Χατζιδάκις. παίζει 11 κομμάτια στο <span class="pre">πιάνο-vFVNOaUPRow.f247.mp3</span></tt> (notice the greek characters) while, if
you add the <tt class="docutils literal"><span class="pre">--restrict-filenames</span></tt> I mentioned before you&#8217;ll get <tt class="docutils literal"><span class="pre">_11-vFVNOaUPRow.f247.mp3</span></tt> (notice that the greek characters have been removed
since they are not&nbsp;safe).</p>
<p>So if you use the <tt class="docutils literal"><span class="pre">--restrict-filenames</span></tt> parameter you&#8217;ll get an output that contains <em>only</em> the video id (and any safe characters it may find) while
if you don&#8217;t use it you&#8217;ll get the normal title of the video. However, most stereos <em>do not</em> display unicode characters properly so if I get this
file to my car I&#8217;ll see garbage and I won&#8217;t be able to identify it &#8212; I will be able to listen it but not see its&nbsp;name!</p>
<p>To fix that, I propose transliterating the unicode characters using the <a class="reference external" href="https://pypi.python.org/pypi/Unidecode">unidecode</a> library. Just install it using <tt class="docutils literal">pip</tt>. Then you can the following
script to rename all mp3 files in a directory to using english characters&nbsp;only:</p>
<div class="highlight"><pre><span></span><span class="kn">import</span><span class="w"> </span><span class="nn">os</span><span class="o">,</span><span class="w"> </span><span class="nn">unidecode</span>

<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s1">&#39;__main__&#39;</span><span class="p">:</span>
    <span class="k">for</span> <span class="n">file</span> <span class="ow">in</span> <span class="n">os</span><span class="o">.</span><span class="n">listdir</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">file</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s1">&#39;mp3&#39;</span><span class="p">):</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Renaming </span><span class="si">{0}</span><span class="s2"> to </span><span class="si">{1}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">file</span><span class="p">,</span> <span class="n">unidecode</span><span class="o">.</span><span class="n">unidecode</span><span class="p">(</span><span class="n">file</span><span class="p">)))</span>
            <span class="n">os</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">file</span><span class="p">,</span> <span class="n">unidecode</span><span class="o">.</span><span class="n">unidecode</span><span class="p">(</span><span class="n">file</span><span class="p">))</span>
</pre></div>
<p>Copy this to a file named transliterate.py and run it in a directory containing mp3 files (<tt class="docutils literal">py <span class="pre">-3</span> transliterate.py</tt>) to rename them to non-unicode&nbsp;characters.</p>
</div>
</div>
  		</article>
  		<article>
<header>
      <h1 class="entry-title">
        <a href="https://www.spapas.net/2018/03/01/django-rest-auth/">Authentication for django-rest-framework with django-rest-auth</a>
      </h1>
    <p class="meta">
<time datetime="2018-03-01T22:40:00+02:00" pubdate>Thu 01 March 2018</time>    </p>
</header>

<div class="entry-content"><p><strong>Update: 25/08/2021</strong> Please notice that I&#8217;ve written
a <a class="reference external" href="https://www.spapas.net/2021/08/25/django-token-rest-auth/">a new article</a>
concerning Token authentication in django rest framework which
I recommend to read instead of this one since most info here is&nbsp;deprecated.</p>
<div class="section" id="introduction">
<h2>Introduction</h2>
<p>Most of the times I need authentication with any <span class="caps">REST</span> APIs defined through <a class="reference external" href="http://www.django-rest-framework.org">django-rest-framework</a>
I will use  <a class="reference external" href="http://www.django-rest-framework.org/api-guide/authentication/#sessionauthentication">SessionAuthentication</a> method. This method uses the session cookie (which is set through the
normal Django login and logout views)
to check out if there&#8217;s an authenticated user and get his username. This method works only in the
same session (browser window) as the one that actually did the login but this should be enough for most&nbsp;cases.</p>
<p>However, sometimes instead of using the normal Django login/logout views, you&#8217;ll want
to authentication through <span class="caps">REST</span> end-points, for example for using them with SPAs (where
you don&#8217;t want to use the traditional views for authentication but through <span class="caps">REST</span> end-points) or
because you have implemented a mobile (or desktop) application that needs to authenticate with
your&nbsp;script.</p>
<p>There are various ways this could be done but one of the simplest is using <a class="reference external" href="https://github.com/Tivix/django-rest-auth">django-rest-auth</a>.
This project adds a number of <span class="caps">REST</span> end-points to your project that can be used for user login
and registration (and even social login when combined with <a class="reference external" href="https://github.com/pennersr/django-allauth">django-allauth</a>).
In the following I am going to write a simple tutorial on how to actually use django-rest-auth to
authenticate with django-rest-framework using the provided <span class="caps">REST</span> end points and how to call a
<span class="caps">REST</span> <span class="caps">API</span> as an authenticated&nbsp;user.</p>
<p>Before continuing with the tutorial, let&#8217;s take a look at what we&#8217;ll build&nbsp;here:</p>
<img alt="Our project" src="/images/rest-auth.gif" style="width: 640px;" />
<p>This is a single html page (styled with <a class="reference external" href="https://picturepan2.github.io/spectre/">spectre.css</a>) that checks if the user is logged in
and either displays the login or logout button (using javascript). When you click the login you&#8217;ll get a modal in which you
can enter your credentials which will be submitted through <span class="caps">REST</span> to the django-rest-auth endpoint and
depending on the response will set a javascript variable (and a corresponding session/local storage key).
Then you can use the &#8220;Test auth&#8221; button that works only on authenticated users and returns their username.
Finally, notice that after you log out the &#8220;test auth&#8221; button returns a 403 access&nbsp;denied.</p>
<p>If you want to play with this project yourself, you can clone it here <a class="reference external" href="https://github.com/spapas/rest_authenticate">https://github.com/spapas/rest_authenticate</a>.
Just create a venv, install requirements, create a superuser and you should be good to&nbsp;go!</p>
</div>
<div class="section" id="some-theory">
<h2>Some&nbsp;theory</h2>
<p>After you log in with Django, your authentication information is saved to the &#8220;session&#8221;_. The session is a bucket of information
that the Django application saves about your visit &#8212; to distinguish between different visitors a cookie with a unique
value named <tt class="docutils literal">sessionid</tt> will be used. So, your web browser will send this cookie with each page request thus allowing Django
to know which bucket of information is yours (and if you&#8217;ve authenticated know who are you). This is not a Django
related concept but a general one (supported by most if not all <span class="caps">HTTP</span> frameworks) and is used to add state to an otherwise
stateless medium (<span class="caps">HTTP</span>).</p>
<p>Since the <tt class="docutils literal">sessionid</tt> cookie is sent not only with traditional but also with Ajax request it can be used to authenticate
<span class="caps">REST</span> requests after you&#8217;ve logged in. This is what is used by default in django-rest-framework and as I said in the
introduction it is a very good solution for most use cases: You login to django and you can go ahead and call the <span class="caps">REST</span>
<span class="caps">API</span> through Ajax; the <tt class="docutils literal">sessionid</tt> cookie will be sent along with the request and you&#8217;ll be&nbsp;authenticated.</p>
<p>Now, although the session authentication is nice for using in browsers, you may need to access your <span class="caps">API</span> through a desktop
or a mobile application where, setting the cookies yourself is not the optimal solution. Also, you may have an <span class="caps">SPA</span> that needs
to access an <span class="caps">API</span> in a different domain; using <a class="reference external" href="https://stackoverflow.com/questions/3342140/cross-domain-cookies">using cookies for this is not easy</a> - if possible at&nbsp;all.</p>
<p>For such cases, django-rest-framework
offers a different authentication method called <tt class="docutils literal">TokenAuthentication_</tt>. Using this method, each user of the Django application
is correlated with a random string (Token) which is passed along with the request at its header thus the Django app can authenticate
the user using this token! One thing that may seem strange is that since both the session cookie and a token are
set through <span class="caps">HTTP</span> Headers why all the fuss about tokens? Why not just use the session cookie and be done with it. Well, there are
various reasons - here&#8217;s a <cite>rather extensive article</cite> explaining some. Some of the reasons are that a token can be valid forever
while the session is something ephemeral - beyond authorization information, sessions may keep various other data for a web
application and are expired after some time to save space. Also, since tokens are used for exactly this (authentication) they
are much easier to use and reason about. Finally, as I&#8217;ve already explained, sharing cookies by multiple sites is not something
you&#8217;d like to&nbsp;do.</p>
</div>
<div class="section" id="installation-configuration">
<h2>Installation <span class="amp">&amp;</span>&nbsp;configuration</h2>
<p>To install django-rest-auth just follow <a class="reference external" href="http://django-rest-auth.readthedocs.io/en/latest/installation.html#installation">the instructions here</a> i.e just add
<tt class="docutils literal">'rest_framework', 'rest_framework.authtoken'</tt> and <tt class="docutils literal">'rest_auth'</tt> to your <cite>INSTALLED_APPS</cite> in
<tt class="docutils literal">settings.py</tt> and run&nbsp;migrate.</p>
<p>Since I won&#8217;t be adding any other apps to this project (no models are actually needed), I&#8217;ve added
two directories <tt class="docutils literal">static</tt> and <tt class="docutils literal">templates</tt> to put static files and templates there. This is configured
by adding the <tt class="docutils literal">'<span class="caps">DIRS</span>'</tt> attribte to <tt class="docutils literal"><span class="caps">TEMPLATES</span></tt>, like&nbsp;this:</p>
<div class="highlight"><pre><span></span><span class="n">TEMPLATES</span> <span class="o">=</span> <span class="p">[</span>
    <span class="p">{</span>
        <span class="s1">&#39;BACKEND&#39;</span><span class="p">:</span> <span class="s1">&#39;django.template.backends.django.DjangoTemplates&#39;</span><span class="p">,</span>
        <span class="s1">&#39;DIRS&#39;</span><span class="p">:</span> <span class="p">[</span>
            <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">BASE_DIR</span><span class="p">,</span> <span class="s1">&#39;templates&#39;</span><span class="p">),</span>
        <span class="p">],</span>
        <span class="o">//</span> <span class="o">...</span>
</pre></div>
<p>and adding the <cite>STATICFILES_DIRS</cite> setting:</p>
<div class="highlight"><pre><span></span><span class="n">STATICFILES_DIRS</span> <span class="o">=</span> <span class="p">[</span>
    <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">BASE_DIR</span><span class="p">,</span> <span class="s2">&quot;static&quot;</span><span class="p">),</span>
<span class="p">]</span>
</pre></div>
<p>The remaining setting are the default as were created by <tt class="docutils literal"><span class="pre">django-admin</span> startproject</tt>.</p>
<p>I have included the the following urls to <tt class="docutils literal">urls.py</tt>:</p>
<div class="highlight"><pre><span></span><span class="n">urlpatterns</span> <span class="o">=</span> <span class="p">[</span>
    <span class="n">path</span><span class="p">(</span><span class="s1">&#39;admin/&#39;</span><span class="p">,</span> <span class="n">admin</span><span class="o">.</span><span class="n">site</span><span class="o">.</span><span class="n">urls</span><span class="p">),</span>
    <span class="n">path</span><span class="p">(</span><span class="s1">&#39;test_auth/&#39;</span><span class="p">,</span> <span class="n">TestAuthView</span><span class="o">.</span><span class="n">as_view</span><span class="p">(),</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;test_auth&#39;</span><span class="p">,</span> <span class="p">),</span>
    <span class="n">path</span><span class="p">(</span><span class="s1">&#39;rest-auth/logout/&#39;</span><span class="p">,</span> <span class="n">LogoutViewEx</span><span class="o">.</span><span class="n">as_view</span><span class="p">(),</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;rest_logout&#39;</span><span class="p">,</span> <span class="p">),</span>
    <span class="n">path</span><span class="p">(</span><span class="s1">&#39;rest-auth/login/&#39;</span><span class="p">,</span> <span class="n">LoginView</span><span class="o">.</span><span class="n">as_view</span><span class="p">(),</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;rest_login&#39;</span><span class="p">,</span> <span class="p">),</span>
    <span class="n">path</span><span class="p">(</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">HomeTemplateView</span><span class="o">.</span><span class="n">as_view</span><span class="p">(),</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;home&#39;</span><span class="p">,</span> <span class="p">),</span>
<span class="p">]</span> <span class="o">+</span> <span class="n">static</span><span class="p">(</span><span class="n">settings</span><span class="o">.</span><span class="n">STATIC_URL</span><span class="p">,</span> <span class="n">document_root</span><span class="o">=</span><span class="n">settings</span><span class="o">.</span><span class="n">STATIC_ROOT</span><span class="p">)</span>
</pre></div>
<p>These are: The django-admin, a test_auth view (that works only for authenticated users and returns their username),
<em>a view (LogoutViewEx) that overrides the rest-auth <span class="caps">REST</span> logout-view</em> (I&#8217;ll explain why this is needed in a minute),
the rest-auth <span class="caps">REST</span> login-view, the home template view (which is the only view implemented) and finally a mapping
of your static files to the <tt class="docutils literal">STATIC_URL</tt>.</p>
</div>
<div class="section" id="the-views">
<h2>The&nbsp;views</h2>
<p>There are three views in this application - the <tt class="docutils literal">HomeTemplateView</tt>, the <tt class="docutils literal">TestAuthView</tt>
and the <tt class="docutils literal">LogoutViewEx</tt> view that overrides the normal <tt class="docutils literal">LogoutView</tt> of <tt class="docutils literal"><span class="pre">django-rest-auth</span></tt>.
The first one is
a simple <tt class="docutils literal">TemplateView</tt> that just
displays an html page and loads the client side code - we&#8217;ll talk about it later in the front-side&nbsp;section.</p>
<p>The <tt class="docutils literal">TestAuthView</tt> is implemented like&nbsp;this:</p>
<div class="highlight"><pre><span></span><span class="k">class</span><span class="w"> </span><span class="nc">TestAuthView</span><span class="p">(</span><span class="n">APIView</span><span class="p">):</span>
    <span class="n">authentication_classes</span> <span class="o">=</span> <span class="p">(</span><span class="n">authentication</span><span class="o">.</span><span class="n">TokenAuthentication</span><span class="p">,)</span>
    <span class="n">permission_classes</span> <span class="o">=</span> <span class="p">(</span><span class="n">permissions</span><span class="o">.</span><span class="n">IsAuthenticated</span><span class="p">,)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">get</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request</span><span class="p">,</span> <span class="nb">format</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">Response</span><span class="p">(</span><span class="s2">&quot;Hello </span><span class="si">{0}</span><span class="s2">!&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">user</span><span class="p">))</span>
</pre></div>
<p>This is very simple however I&#8217;d like to make a few comments about the above. First of all you see that
I&#8217;ve defined <tt class="docutils literal">authentication_classes</tt> and <tt class="docutils literal">permission_classes</tt>. These options&nbsp;define</p>
<ul class="simple">
<li>which method will be used for authenticating access to the <span class="caps">REST</span> view i.e finding out if the user
requesting access has logged in and if yes what&#8217;s his username (in our case the <tt class="docutils literal">TokenAuthentication</tt> will be&nbsp;used)</li>
<li>if the user is authorized (has permission) to call this <span class="caps">REST</span> view (in our case only authenticated users will be&nbsp;allowed)</li>
</ul>
<p>The authentication and permission clases can be set globally
in your <tt class="docutils literal">settings.py</tt> using <tt class="docutils literal"><span class="pre">REST_FRAMEWORK['DEFAULT_AUTHENTICATION_CLASSES']</span></tt> and
<tt class="docutils literal"><span class="pre">REST_FRAMEWORK['DEFAULT_PERMISSION_CLASSES']</span></tt>
or defined per-class like this. If I wanted to have the same authentication and permission classes defined
in my <tt class="docutils literal">settings.py</tt> so I wouldn&#8217;t need to set these options per-class I&#8217;d add the following to my <tt class="docutils literal">settings.py</tt>:</p>
<div class="highlight"><pre><span></span><span class="n">REST_FRAMEWORK</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s1">&#39;DEFAULT_AUTHENTICATION_CLASSES&#39;</span><span class="p">:</span> <span class="p">(</span>
        <span class="s1">&#39;rest_framework.authentication.TokenAuthentication&#39;</span><span class="p">,</span>
    <span class="p">),</span>
    <span class="s1">&#39;DEFAULT_PERMISSION_CLASSES&#39;</span><span class="p">:</span> <span class="p">(</span>
        <span class="s1">&#39;rest_framework.permissions.IsAuthenticated&#39;</span><span class="p">,</span>
    <span class="p">),</span>
<span class="p">}</span>
</pre></div>
<p>Finally, keep in mind that you haven&#8217;t defined these in your views or your settings, they will have the
following <a class="reference external" href="http://www.django-rest-framework.org/api-guide/settings/#default_authentication_classes">default</a> <a class="reference external" href="http://www.django-rest-framework.org/api-guide/settings/#default_permission_classes">values</a>:</p>
<div class="highlight"><pre><span></span><span class="n">REST_FRAMEWORK</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s1">&#39;DEFAULT_AUTHENTICATION_CLASSES&#39;</span><span class="p">:</span> <span class="p">(</span>
        <span class="s1">&#39;rest_framework.authentication.SessionAuthentication&#39;</span><span class="p">,</span>
        <span class="s1">&#39;rest_framework.authentication.BasicAuthentication&#39;</span>
    <span class="p">),</span>
    <span class="s1">&#39;DEFAULT_PERMISSION_CLASSES&#39;</span><span class="p">:</span> <span class="p">(</span>
        <span class="s1">&#39;rest_framework.permissions.AllowAny&#39;</span><span class="p">,</span>
    <span class="p">),</span>
<span class="p">}</span>
</pre></div>
<p>The above mean that if you don&#8217;t define authentication and permission classes anywhere then the <span class="caps">REST</span>
views will use either session authentication (i.e the user has logged in normally using
the Django login views as explained before) or basic authentication
(the request provides the credentials in the header using traditional <span class="caps">HTTP</span> Basic authentication)
and also that all users (logged in or not) will be allowed to call all APIs (this is
probably not something you&nbsp;want).</p>
<p>The <tt class="docutils literal">TokenAuthentication</tt> that we are using instead means that for every user there must be a valid token which will be provided
for each request he does. The tokens are normal object instances of <tt class="docutils literal">rest_framework.authtoken.models.Token</tt>
and you can take a look at them (or even add one) through the Django admin (auth token - tokens). You can also
even do whatever you normally would do to an object instance, for&nbsp;example:</p>
<div class="highlight"><pre><span></span><span class="o">&gt;&gt;&gt;</span> <span class="p">[</span> <span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">user</span><span class="p">,</span> <span class="n">x</span><span class="o">.</span><span class="n">key</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">Token</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">all</span><span class="p">()]</span>
<span class="p">[(</span><span class="o">&lt;</span><span class="n">User</span><span class="p">:</span> <span class="n">root</span><span class="o">&gt;</span><span class="p">,</span> <span class="s1">&#39;db4dcc1b9d00d1af74fb3cb41e1f9e673208485b&#39;</span><span class="p">)]</span>
</pre></div>
<p>To authenticate with a token (using <a class="reference external" href="http://www.django-rest-framework.org/api-guide/authentication/#tokenauthentication">TokenAuthentication</a>), you must add an extra header to your request with the format
<tt class="docutils literal">Authorization: Token token</tt> for example in the previous case <tt class="docutils literal">root</tt> would add
<tt class="docutils literal">Authorization: Token db4dcc1b9d00d1af74fb3cb41e1f9e673208485b</tt>. To do this you&#8217;ll need something
client-side code which we&#8217;ll see in the next&nbsp;section.</p>
<p>To do it with <a class="reference external" href="https://curl.haxx.se">curl</a> you can just do something like&nbsp;this:</p>
<div class="highlight"><pre><span></span>curl<span class="w"> </span>http://127.0.0.1:8000/test_auth/<span class="w"> </span>-H<span class="w"> </span><span class="s2">&quot;Authorization:Token db4dcc1b9d00d1af74fb3cb41e1f9e673208485b&quot;</span>
</pre></div>
<p>Try it with a valid and invalid token and without providing a token at all and see the response each&nbsp;time.</p>
<p>So, django-rest-framework provides the model (Token) and the mechanism (add the extra Authentication header) for
authentication with Tokens. What it does not provide is a simple way to create/remove tokens for users: This
is where <tt class="docutils literal"><span class="pre">django-rest-auth</span></tt> comes to the rescue! Its login and logout <span class="caps">REST</span> views will automatically
create (and delete) tokens for the users that are logging in. They will also authenticate the user
normally (using sessions) - this means that if a user logs in using the login <span class="caps">REST</span> endpoint he&#8217;ll then
be logged in normally to the site and be able to access non-<span class="caps">REST</span> parts of the site (for example the django-admin).
Also, if the user logs in through the django-rest-auth <span class="caps">REST</span> end point and if you have are using <tt class="docutils literal">SessionAuthentication</tt>
to one of your views then he&#8217;ll be able to authenticate to these views <em>without</em> the need to pass the token (can
you understand&nbsp;why?).</p>
<p>Finally, let&#8217;s take a look at the <tt class="docutils literal">LogoutViewEx</tt>:</p>
<div class="highlight"><pre><span></span><span class="k">class</span><span class="w"> </span><span class="nc">LogoutViewEx</span><span class="p">(</span><span class="n">LogoutView</span><span class="p">):</span>
    <span class="n">authentication_classes</span> <span class="o">=</span> <span class="p">(</span><span class="n">authentication</span><span class="o">.</span><span class="n">TokenAuthentication</span><span class="p">,)</span>
</pre></div>
<p>This class only defines the authentication_classes attribute. Is this really needed? Well, it depends on
you project. If you take a look at the source code of <tt class="docutils literal">LogoutView</tt> (<a class="reference external" href="https://github.com/Tivix/django-rest-auth/blob/master/rest_auth/views.py#L99">https://github.com/Tivix/django-rest-auth/blob/master/rest_auth/views.py#L99</a>)
you&#8217;ll see that it does not define <tt class="docutils literal">authentication_classes</tt>. This, as we&#8217;ve already discussed, means that it will
fall-back to whatever you have defined in the settings (or the defaults of django-rest-framework). So, if you haven&#8217;t
defined anything in the settings then you&#8217;ll get the by default the
SessionAuthentication and BasicAuthentication methods (hint: <em>not</em> the <tt class="docutils literal">TokenAuthentication</tt>). This means that you won&#8217;t be able to
logout when you pass the token (but <em>will</em> be able to logout from the web-app after you login - why?). So to make everything
crystal and be able to reason better about the behavior I specifically define the <tt class="docutils literal">LogoutViewEx</tt> to use the <tt class="docutils literal">TokenAuthentication</tt> - that&#8217;s
what you&#8217;d use if you developed a mobile or desktop app&nbsp;anyway.</p>
</div>
<div class="section" id="the-client-side-scripts">
<h2>The client side&nbsp;scripts</h2>
<p>I&#8217;ve included all client-side code to a <tt class="docutils literal">home.html</tt> template that is loaded
from the <tt class="docutils literal">HomeTemplateView</tt>. The client-side code has been implemented only with jQuery because I think
this is the library that most people are familiar with - and is really easy to be understood even if you
are not familiar with it. It more or less consists of four sections in&nbsp;html:</p>
<ul class="simple">
<li>A user-is-logged-in section that displays the username and the logout&nbsp;button</li>
<li>A user-is-not-logged-in section that displays a message and the login&nbsp;button</li>
<li>A test-auth section that displays a button for calling the <tt class="docutils literal">TestAuthView</tt> defined previously and outputs its&nbsp;response</li>
<li>The login&nbsp;modal</li>
</ul>
<p>Here&#8217;s the html (using spectre.css for&nbsp;styling):</p>
<div class="highlight"><pre><span></span><span class="p">&lt;</span><span class="nt">div</span> <span class="na">class</span><span class="o">=</span><span class="s">&quot;container grid-lg&quot;</span><span class="p">&gt;</span>
    <span class="p">&lt;</span><span class="nt">h2</span><span class="p">&gt;</span>Test<span class="p">&lt;/</span><span class="nt">h2</span><span class="p">&gt;</span>
    <span class="p">&lt;</span><span class="nt">div</span> <span class="na">class</span><span class="o">=</span><span class="s">&quot;columns&quot;</span> <span class="na">id</span><span class="o">=</span><span class="s">&quot;non-logged-in&quot;</span><span class="p">&gt;</span>
        <span class="p">&lt;</span><span class="nt">div</span> <span class="na">class</span><span class="o">=</span><span class="s">&#39;column col-3&#39;</span><span class="p">&gt;</span>
            You have to log-in!
        <span class="p">&lt;/</span><span class="nt">div</span><span class="p">&gt;</span>
        <span class="p">&lt;</span><span class="nt">div</span> <span class="na">class</span><span class="o">=</span><span class="s">&#39;column col-3&#39;</span><span class="p">&gt;</span>
            <span class="p">&lt;</span><span class="nt">button</span> <span class="na">class</span><span class="o">=</span><span class="s">&quot;btn btn-primary&quot;</span>  <span class="na">id</span><span class="o">=</span><span class="s">&#39;loginButton&#39;</span><span class="p">&gt;</span>Login<span class="p">&lt;/</span><span class="nt">button</span><span class="p">&gt;</span>
        <span class="p">&lt;/</span><span class="nt">div</span><span class="p">&gt;</span>
    <span class="p">&lt;/</span><span class="nt">div</span><span class="p">&gt;</span>
    <span class="p">&lt;</span><span class="nt">div</span> <span class="na">class</span><span class="o">=</span><span class="s">&quot;columns&quot;</span> <span class="na">id</span><span class="o">=</span><span class="s">&quot;logged-in&quot;</span><span class="p">&gt;</span>
        <span class="p">&lt;</span><span class="nt">div</span> <span class="na">class</span><span class="o">=</span><span class="s">&#39;column col-3&#39;</span><span class="p">&gt;</span>
            Welcome <span class="p">&lt;</span><span class="nt">span</span> <span class="na">id</span><span class="o">=</span><span class="s">&#39;span-username&#39;</span><span class="p">&gt;&lt;/</span><span class="nt">span</span><span class="p">&gt;</span>!
        <span class="p">&lt;/</span><span class="nt">div</span><span class="p">&gt;</span>
        <span class="p">&lt;</span><span class="nt">div</span> <span class="na">class</span><span class="o">=</span><span class="s">&#39;column col-3&#39;</span><span class="p">&gt;</span>
            <span class="p">&lt;</span><span class="nt">button</span> <span class="na">class</span><span class="o">=</span><span class="s">&quot;btn btn-primary&quot;</span>  <span class="na">id</span><span class="o">=</span><span class="s">&#39;logoutButton&#39;</span><span class="p">&gt;</span>Logout<span class="p">&lt;/</span><span class="nt">button</span><span class="p">&gt;</span>
        <span class="p">&lt;/</span><span class="nt">div</span><span class="p">&gt;</span>
    <span class="p">&lt;/</span><span class="nt">div</span><span class="p">&gt;</span>
    <span class="p">&lt;</span><span class="nt">hr</span> <span class="p">/&gt;</span>
    <span class="p">&lt;</span><span class="nt">div</span> <span class="na">class</span><span class="o">=</span><span class="s">&quot;columns&quot;</span> <span class="na">id</span><span class="o">=</span><span class="s">&quot;test&quot;</span><span class="p">&gt;</span>
        <span class="p">&lt;</span><span class="nt">div</span> <span class="na">class</span><span class="o">=</span><span class="s">&#39;column col-3&#39;</span><span class="p">&gt;</span>
            <span class="p">&lt;</span><span class="nt">button</span> <span class="na">class</span><span class="o">=</span><span class="s">&quot;btn btn-primary&quot;</span>  <span class="na">id</span><span class="o">=</span><span class="s">&#39;testAuthButton&#39;</span><span class="p">&gt;</span>Test auth<span class="p">&lt;/</span><span class="nt">button</span><span class="p">&gt;</span>
        <span class="p">&lt;/</span><span class="nt">div</span><span class="p">&gt;</span>
        <span class="p">&lt;</span><span class="nt">div</span> <span class="na">class</span><span class="o">=</span><span class="s">&#39;column col-9&#39;</span><span class="p">&gt;</span>
            <span class="p">&lt;</span><span class="nt">div</span> <span class="na">id</span><span class="o">=</span><span class="s">&#39;test-auth-response&#39;</span> <span class="p">&gt;&lt;/</span><span class="nt">div</span><span class="p">&gt;</span>
        <span class="p">&lt;/</span><span class="nt">div</span><span class="p">&gt;</span>
    <span class="p">&lt;/</span><span class="nt">div</span><span class="p">&gt;</span>
<span class="p">&lt;/</span><span class="nt">div</span><span class="p">&gt;</span>

<span class="p">&lt;</span><span class="nt">div</span> <span class="na">class</span><span class="o">=</span><span class="s">&quot;modal&quot;</span> <span class="na">id</span><span class="o">=</span><span class="s">&quot;login-modal&quot;</span><span class="p">&gt;</span>
    <span class="p">&lt;</span><span class="nt">a</span> <span class="na">href</span><span class="o">=</span><span class="s">&quot;#close&quot;</span> <span class="na">class</span><span class="o">=</span><span class="s">&quot;modal-overlay close-modal&quot;</span> <span class="na">aria-label</span><span class="o">=</span><span class="s">&quot;Close&quot;</span><span class="p">&gt;&lt;/</span><span class="nt">a</span><span class="p">&gt;</span>
    <span class="p">&lt;</span><span class="nt">div</span> <span class="na">class</span><span class="o">=</span><span class="s">&quot;modal-container&quot;</span><span class="p">&gt;</span>
        <span class="p">&lt;</span><span class="nt">div</span> <span class="na">class</span><span class="o">=</span><span class="s">&quot;modal-header&quot;</span><span class="p">&gt;</span>
            <span class="p">&lt;</span><span class="nt">a</span> <span class="na">href</span><span class="o">=</span><span class="s">&quot;#close&quot;</span> <span class="na">class</span><span class="o">=</span><span class="s">&quot;btn btn-clear float-right close-modal&quot;</span> <span class="na">aria-label</span><span class="o">=</span><span class="s">&quot;Close&quot;</span><span class="p">&gt;&lt;/</span><span class="nt">a</span><span class="p">&gt;</span>
            <span class="p">&lt;</span><span class="nt">div</span> <span class="na">class</span><span class="o">=</span><span class="s">&quot;modal-title h5&quot;</span><span class="p">&gt;</span>Please login<span class="p">&lt;/</span><span class="nt">div</span><span class="p">&gt;</span>
        <span class="p">&lt;/</span><span class="nt">div</span><span class="p">&gt;</span>
        <span class="p">&lt;</span><span class="nt">div</span> <span class="na">class</span><span class="o">=</span><span class="s">&quot;modal-body&quot;</span><span class="p">&gt;</span>
            <span class="p">&lt;</span><span class="nt">div</span> <span class="na">class</span><span class="o">=</span><span class="s">&quot;content&quot;</span><span class="p">&gt;</span>
                <span class="p">&lt;</span><span class="nt">form</span><span class="p">&gt;</span>
                    {% csrf_token %}
                    <span class="p">&lt;</span><span class="nt">div</span> <span class="na">class</span><span class="o">=</span><span class="s">&quot;form-group&quot;</span><span class="p">&gt;</span>
                        <span class="p">&lt;</span><span class="nt">label</span> <span class="na">class</span><span class="o">=</span><span class="s">&quot;form-label&quot;</span> <span class="na">for</span><span class="o">=</span><span class="s">&quot;input-username&quot;</span><span class="p">&gt;</span>Username<span class="p">&lt;/</span><span class="nt">label</span><span class="p">&gt;</span>
                        <span class="p">&lt;</span><span class="nt">input</span> <span class="na">class</span><span class="o">=</span><span class="s">&quot;form-input&quot;</span> <span class="na">type</span><span class="o">=</span><span class="s">&quot;text&quot;</span> <span class="na">id</span><span class="o">=</span><span class="s">&quot;input-username&quot;</span> <span class="na">placeholder</span><span class="o">=</span><span class="s">&quot;Name&quot;</span><span class="p">&gt;</span>
                    <span class="p">&lt;/</span><span class="nt">div</span><span class="p">&gt;</span>
                    <span class="p">&lt;</span><span class="nt">div</span> <span class="na">class</span><span class="o">=</span><span class="s">&quot;form-group&quot;</span><span class="p">&gt;</span>
                        <span class="p">&lt;</span><span class="nt">label</span> <span class="na">class</span><span class="o">=</span><span class="s">&quot;form-label&quot;</span> <span class="na">for</span><span class="o">=</span><span class="s">&quot;input-password&quot;</span><span class="p">&gt;</span>Password<span class="p">&lt;/</span><span class="nt">label</span><span class="p">&gt;</span>
                        <span class="p">&lt;</span><span class="nt">input</span> <span class="na">class</span><span class="o">=</span><span class="s">&quot;form-input&quot;</span> <span class="na">type</span><span class="o">=</span><span class="s">&quot;password&quot;</span> <span class="na">id</span><span class="o">=</span><span class="s">&quot;input-password&quot;</span> <span class="na">placeholder</span><span class="o">=</span><span class="s">&quot;Password&quot;</span><span class="p">&gt;</span>
                    <span class="p">&lt;/</span><span class="nt">div</span><span class="p">&gt;</span>
                    <span class="p">&lt;</span><span class="nt">div</span> <span class="na">class</span><span class="o">=</span><span class="s">&quot;form-group&quot;</span><span class="p">&gt;</span>
                        <span class="p">&lt;</span><span class="nt">label</span> <span class="na">class</span><span class="o">=</span><span class="s">&quot;form-checkbox&quot;</span> <span class="na">for</span><span class="o">=</span><span class="s">&quot;input-local-storage&quot;</span><span class="p">&gt;</span>
                            <span class="p">&lt;</span><span class="nt">input</span> <span class="na">type</span><span class="o">=</span><span class="s">&quot;checkbox&quot;</span> <span class="na">id</span><span class="o">=</span><span class="s">&quot;input-local-storage&quot;</span> <span class="p">/&gt;</span> <span class="p">&lt;</span><span class="nt">i</span> <span class="na">class</span><span class="o">=</span><span class="s">&quot;form-icon&quot;</span><span class="p">&gt;&lt;/</span><span class="nt">i</span><span class="p">&gt;</span>  Use local storage (remember me)
                        <span class="p">&lt;/</span><span class="nt">label</span><span class="p">&gt;</span>
                    <span class="p">&lt;/</span><span class="nt">div</span><span class="p">&gt;</span>
                <span class="p">&lt;/</span><span class="nt">form</span><span class="p">&gt;</span>
                <span class="p">&lt;</span><span class="nt">div</span> <span class="na">class</span><span class="o">=</span><span class="s">&#39;label label-error mt-1 d-invisible&#39;</span> <span class="na">id</span><span class="o">=</span><span class="s">&#39;modal-error&#39;</span><span class="p">&gt;</span>
                    Unable to login!
                <span class="p">&lt;/</span><span class="nt">div</span><span class="p">&gt;</span>
            <span class="p">&lt;/</span><span class="nt">div</span><span class="p">&gt;</span>
        <span class="p">&lt;/</span><span class="nt">div</span><span class="p">&gt;</span>
        <span class="p">&lt;</span><span class="nt">div</span> <span class="na">class</span><span class="o">=</span><span class="s">&quot;modal-footer&quot;</span><span class="p">&gt;</span>

            <span class="p">&lt;</span><span class="nt">button</span> <span class="na">class</span><span class="o">=</span><span class="s">&quot;btn btn-primary&quot;</span> <span class="na">id</span><span class="o">=</span><span class="s">&#39;loginOkButton&#39;</span> <span class="p">&gt;</span>Ok<span class="p">&lt;/</span><span class="nt">button</span><span class="p">&gt;</span>
            <span class="p">&lt;</span><span class="nt">a</span> <span class="na">href</span><span class="o">=</span><span class="s">&quot;#close&quot;</span> <span class="na">class</span><span class="o">=</span><span class="s">&quot;btn close-modal&quot;</span> <span class="p">&gt;</span>Close<span class="p">&lt;/</span><span class="nt">a</span><span class="p">&gt;</span>
        <span class="p">&lt;/</span><span class="nt">div</span><span class="p">&gt;</span>
    <span class="p">&lt;/</span><span class="nt">div</span><span class="p">&gt;</span>
<span class="p">&lt;/</span><span class="nt">div</span><span class="p">&gt;</span>
</pre></div>
<p>The html is very simple and I don&#8217;t think I need to explain much  - notice that the <cite>#logged-in</cite> and
<cite>#non-logged-in</cite> sections are mutually exclusive (I use <tt class="docutils literal">$.show()</tt> and <tt class="docutils literal">$.hide()</tt> to show and hide them) but the <cite>#test</cite> section is always displayed
so you&#8217;ll be able to call the test <span class="caps">REST</span> <span class="caps">API</span> when you are and are not authenticated. For the modal
to be displayed you need to add an <tt class="docutils literal">active</tt> class to its <tt class="docutils literal">#modal</tt> container.</p>
<p>For the javascript, let&#8217;s take a look at some initialization&nbsp;stuff:</p>
<div class="highlight"><pre><span></span><span class="kd">var</span><span class="w"> </span><span class="nx">g_urls</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="s1">&#39;login&#39;</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;{% url &quot;rest_login&quot; %}&#39;</span><span class="p">,</span>
<span class="w">    </span><span class="s1">&#39;logout&#39;</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;{% url &quot;rest_logout&quot; %}&#39;</span><span class="p">,</span>
<span class="w">    </span><span class="s1">&#39;test_auth&#39;</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;{% url &quot;test_auth&quot; %}&#39;</span><span class="p">,</span>
<span class="p">};</span>
<span class="kd">var</span><span class="w"> </span><span class="nx">g_auth</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">localStorage</span><span class="p">.</span><span class="nx">getItem</span><span class="p">(</span><span class="s2">&quot;auth&quot;</span><span class="p">);</span>
<span class="k">if</span><span class="p">(</span><span class="nx">g_auth</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="kc">null</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nx">g_auth</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">sessionStorage</span><span class="p">.</span><span class="nx">getItem</span><span class="p">(</span><span class="s2">&quot;auth&quot;</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">if</span><span class="p">(</span><span class="nx">g_auth</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">try</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="nx">g_auth</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">JSON</span><span class="p">.</span><span class="nx">parse</span><span class="p">(</span><span class="nx">g_auth</span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span><span class="w"> </span><span class="k">catch</span><span class="p">(</span><span class="nx">error</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="nx">g_auth</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">null</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>

<span class="kd">var</span><span class="w"> </span><span class="nx">getCookie</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kd">function</span><span class="p">(</span><span class="nx">name</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kd">var</span><span class="w"> </span><span class="nx">cookieValue</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">null</span><span class="p">;</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nb">document</span><span class="p">.</span><span class="nx">cookie</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="nb">document</span><span class="p">.</span><span class="nx">cookie</span><span class="w"> </span><span class="o">!==</span><span class="w"> </span><span class="s1">&#39;&#39;</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="kd">var</span><span class="w"> </span><span class="nx">cookies</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">document</span><span class="p">.</span><span class="nx">cookie</span><span class="p">.</span><span class="nx">split</span><span class="p">(</span><span class="s1">&#39;;&#39;</span><span class="p">);</span>
<span class="w">        </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kd">var</span><span class="w"> </span><span class="nx">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">0</span><span class="p">;</span><span class="w"> </span><span class="nx">i</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="nx">cookies</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span><span class="w"> </span><span class="nx">i</span><span class="o">++</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="kd">var</span><span class="w"> </span><span class="nx">cookie</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">jQuery</span><span class="p">.</span><span class="nx">trim</span><span class="p">(</span><span class="nx">cookies</span><span class="p">[</span><span class="nx">i</span><span class="p">]);</span>
<span class="w">            </span><span class="c1">// Does this cookie string begin with the name we want?</span>
<span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">cookie</span><span class="p">.</span><span class="nx">substring</span><span class="p">(</span><span class="mf">0</span><span class="p">,</span><span class="w"> </span><span class="nx">name</span><span class="p">.</span><span class="nx">length</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mf">1</span><span class="p">)</span><span class="w"> </span><span class="o">===</span><span class="w"> </span><span class="p">(</span><span class="nx">name</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="s1">&#39;=&#39;</span><span class="p">))</span><span class="w"> </span><span class="p">{</span>
<span class="w">                </span><span class="nx">cookieValue</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">decodeURIComponent</span><span class="p">(</span><span class="nx">cookie</span><span class="p">.</span><span class="nx">substring</span><span class="p">(</span><span class="nx">name</span><span class="p">.</span><span class="nx">length</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mf">1</span><span class="p">));</span>
<span class="w">                </span><span class="k">break</span><span class="p">;</span>
<span class="w">            </span><span class="p">}</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="nx">cookieValue</span><span class="p">;</span>
<span class="p">};</span>
<span class="kd">var</span><span class="w"> </span><span class="nx">g_csrftoken</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">getCookie</span><span class="p">(</span><span class="s1">&#39;csrftoken&#39;</span><span class="p">);</span>

<span class="kd">var</span><span class="w"> </span><span class="nx">initLogin</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kd">function</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">if</span><span class="p">(</span><span class="nx">g_auth</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="nx">$</span><span class="p">(</span><span class="s1">&#39;#non-logged-in&#39;</span><span class="p">).</span><span class="nx">hide</span><span class="p">();</span>
<span class="w">        </span><span class="nx">$</span><span class="p">(</span><span class="s1">&#39;#logged-in&#39;</span><span class="p">).</span><span class="nx">show</span><span class="p">();</span>
<span class="w">        </span><span class="nx">$</span><span class="p">(</span><span class="s1">&#39;#span-username&#39;</span><span class="p">).</span><span class="nx">html</span><span class="p">(</span><span class="nx">g_auth</span><span class="p">.</span><span class="nx">username</span><span class="p">);</span>
<span class="w">        </span><span class="k">if</span><span class="p">(</span><span class="nx">g_auth</span><span class="p">.</span><span class="nx">remember_me</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="nx">localStorage</span><span class="p">.</span><span class="nx">setItem</span><span class="p">(</span><span class="s2">&quot;auth&quot;</span><span class="p">,</span><span class="w"> </span><span class="nb">JSON</span><span class="p">.</span><span class="nx">stringify</span><span class="p">(</span><span class="nx">g_auth</span><span class="p">));</span>
<span class="w">        </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="nx">sessionStorage</span><span class="p">.</span><span class="nx">setItem</span><span class="p">(</span><span class="s2">&quot;auth&quot;</span><span class="p">,</span><span class="w"> </span><span class="nb">JSON</span><span class="p">.</span><span class="nx">stringify</span><span class="p">(</span><span class="nx">g_auth</span><span class="p">));</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">    </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="nx">$</span><span class="p">(</span><span class="s1">&#39;#non-logged-in&#39;</span><span class="p">).</span><span class="nx">show</span><span class="p">();</span>
<span class="w">        </span><span class="nx">$</span><span class="p">(</span><span class="s1">&#39;#logged-in&#39;</span><span class="p">).</span><span class="nx">hide</span><span class="p">();</span>
<span class="w">        </span><span class="nx">$</span><span class="p">(</span><span class="s1">&#39;#span-username&#39;</span><span class="p">).</span><span class="nx">html</span><span class="p">(</span><span class="s1">&#39;&#39;</span><span class="p">);</span>
<span class="w">        </span><span class="nx">localStorage</span><span class="p">.</span><span class="nx">removeItem</span><span class="p">(</span><span class="s2">&quot;auth&quot;</span><span class="p">);</span>
<span class="w">        </span><span class="nx">sessionStorage</span><span class="p">.</span><span class="nx">removeItem</span><span class="p">(</span><span class="s2">&quot;auth&quot;</span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">    </span><span class="nx">$</span><span class="p">(</span><span class="s1">&#39;#test-auth-response&#39;</span><span class="p">).</span><span class="nx">html</span><span class="p">(</span><span class="s2">&quot;&quot;</span><span class="p">);</span>
<span class="p">};</span>
</pre></div>
<p>First of all, I define a <tt class="docutils literal">g_urls</tt> window/global object that will keep the required <span class="caps">REST</span> <span class="caps">URLS</span> (login/logout and test auth). These
are retrieved from Django using the <tt class="docutils literal">{% url %}</tt> template tag and are not hard-coded.
After that, I check to see if the user has authenticated before. Notice that because
this is client-side code, I need to do that every time the page loads or else the <span class="caps">JS</span> won&#8217;t be initialized properly! The user login
information is stored to an object named <tt class="docutils literal">g_auth</tt> and contains two attributes: <tt class="docutils literal">username</tt>, <tt class="docutils literal">key</tt> (token) and <tt class="docutils literal">remember_me</tt>.</p>
<p>To keep the login information I use either a key named <tt class="docutils literal">auth</tt> to either the <tt class="docutils literal">localStorage</tt> or the <tt class="docutils literal">sessionStorage</tt>. The <tt class="docutils literal">sessionStorage</tt> is used to save
info for the current browser tab (<em>not</em> window) while the <tt class="docutils literal">localStorage</tt> saves info for ever (until somebody deletes it). Thus,
<tt class="docutils literal">localStorage</tt> can be used for implementing a &#8220;remember me&#8221; functionality. Notice that instead of using the session/local storage
I could instead integrate the user login information with the Django back-end. To do this I&#8217;d need to see if the current user has
a session login and if yes pass his username and token to  Javascript. These values would then be read by the login initialization
code. I&#8217;m leaving this as an exercise for attentive&nbsp;readers.</p>
<p>Getting the login information from the session probably is a better solution for web-apps however I think that using the local or session storage emulate better a more
general (and completely stateless) behaviour especially considering that the <span class="caps">API</span> may be used for mobible/desktop&nbsp;apps.</p>
<p>In any case, after you&#8217;ve initialized the <tt class="docutils literal">g_auth</tt> object you&#8217;ll need to read the <span class="caps">CSRF</span> cookie. By default Django requires
<a class="reference external" href="https://docs.djangoproject.com/en/2.0/ref/csrf/"><span class="caps">CSRF</span> protection</a> for all <tt class="docutils literal"><span class="caps">POST</span></tt> requests (we do a <span class="caps">POST</span> request for login and logout). What happens here is that for pages that may
need to do a <tt class="docutils literal"><span class="caps">POST</span></tt> request, Django will set a cookie (<span class="caps">CSRF</span> cookie) in its initial response. You&#8217;ll need to read that cookie and submit its
value along with the rest of your form fields when you do the <span class="caps">POST</span>. So the <tt class="docutils literal">getCookie</tt> function is just used to set the <tt class="docutils literal">g_csrftoken</tt> with the value
of the <span class="caps">CSRF</span>&nbsp;cookie.</p>
<p>The final function we define here (which is called a little later) checks to see if there is login information and hides/displays the correct
things in html. It will also set the local or session storage (depending on remember me&nbsp;value).</p>
<p>After that, we have some client side code that is inside the <tt class="docutils literal">$()</tt> function which will be called after the page has completely&nbsp;loaded:</p>
<div class="highlight"><pre><span></span><span class="nx">$</span><span class="p">(</span><span class="kd">function</span><span class="w"> </span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nx">initLogin</span><span class="p">();</span>

<span class="w">    </span><span class="nx">$</span><span class="p">(</span><span class="s1">&#39;#loginButton&#39;</span><span class="p">).</span><span class="nx">click</span><span class="p">(</span><span class="kd">function</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="nx">$</span><span class="p">(</span><span class="s1">&#39;#login-modal&#39;</span><span class="p">).</span><span class="nx">addClass</span><span class="p">(</span><span class="s1">&#39;active&#39;</span><span class="p">);</span>
<span class="w">    </span><span class="p">});</span>

<span class="w">    </span><span class="nx">$</span><span class="p">(</span><span class="s1">&#39;.close-modal&#39;</span><span class="p">).</span><span class="nx">click</span><span class="p">(</span><span class="kd">function</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="nx">$</span><span class="p">(</span><span class="s1">&#39;#login-modal&#39;</span><span class="p">).</span><span class="nx">removeClass</span><span class="p">(</span><span class="s1">&#39;active&#39;</span><span class="p">);</span>
<span class="w">    </span><span class="p">});</span>

<span class="w">    </span><span class="nx">$</span><span class="p">(</span><span class="s1">&#39;#testAuthButton&#39;</span><span class="p">).</span><span class="nx">click</span><span class="p">(</span><span class="kd">function</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="nx">$</span><span class="p">.</span><span class="nx">ajax</span><span class="p">({</span>
<span class="w">            </span><span class="nx">url</span><span class="o">:</span><span class="w"> </span><span class="nx">g_urls</span><span class="p">.</span><span class="nx">test_auth</span><span class="p">,</span>
<span class="w">            </span><span class="nx">method</span><span class="o">:</span><span class="w"> </span><span class="s2">&quot;GET&quot;</span><span class="p">,</span>
<span class="w">            </span><span class="nx">beforeSend</span><span class="o">:</span><span class="w"> </span><span class="kd">function</span><span class="p">(</span><span class="nx">request</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">                </span><span class="k">if</span><span class="p">(</span><span class="nx">g_auth</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">                    </span><span class="nx">request</span><span class="p">.</span><span class="nx">setRequestHeader</span><span class="p">(</span><span class="s2">&quot;Authorization&quot;</span><span class="p">,</span><span class="w"> </span><span class="s2">&quot;Token &quot;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nx">g_auth</span><span class="p">.</span><span class="nx">key</span><span class="p">);</span>
<span class="w">                </span><span class="p">}</span>
<span class="w">            </span><span class="p">}</span>
<span class="w">        </span><span class="p">}).</span><span class="nx">done</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">data</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="nx">$</span><span class="p">(</span><span class="s1">&#39;#test-auth-response&#39;</span><span class="p">).</span><span class="nx">html</span><span class="p">(</span><span class="s2">&quot;&lt;span class=&#39;label label-success&#39;&gt;Ok! Response: &quot;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nx">data</span><span class="p">);</span>
<span class="w">        </span><span class="p">}).</span><span class="nx">fail</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">data</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="nx">$</span><span class="p">(</span><span class="s1">&#39;#test-auth-response&#39;</span><span class="p">).</span><span class="nx">html</span><span class="p">(</span><span class="s2">&quot;&lt;span class=&#39;label label-error&#39;&gt;Fail! Response: &quot;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nx">data</span><span class="p">.</span><span class="nx">responseText</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="s2">&quot; (status: &quot;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nx">data</span><span class="p">.</span><span class="nx">status</span><span class="o">+</span><span class="s2">&quot;)&lt;/span&gt;&quot;</span><span class="p">);</span>
<span class="w">        </span><span class="p">});</span>
<span class="w">    </span><span class="p">});</span>


<span class="w">    </span><span class="c1">// continuing below ...</span>
</pre></div>
<p>The first thing happening here is to call the <tt class="docutils literal">initLogin</tt> function to properly intiialize the page and then we add a couple of
handlers to the click buttons of the <tt class="docutils literal">#loginButton</tt> (which just displays the modal by adding the <tt class="docutils literal">active</tt> class ),
<tt class="docutils literal"><span class="pre">.close-modal</span></tt> class (there are multiple
ways to close the modal thus I use a class which just removes that <tt class="docutils literal">active</tt> class) and finally to the <tt class="docutils literal">#testAuthButton</tt>. This
button will do a <tt class="docutils literal"><span class="caps">GET</span></tt> request to the <tt class="docutils literal">g_urls.test_auth</tt> we defined before. The important thing to notice here is that we add
a <tt class="docutils literal">beforeSend</tt> attribute to the <tt class="docutils literal">$.ajax</tt> request which, if <tt class="docutils literal">g_auth</tt> is defined adds an <tt class="docutils literal">Authorization</tt> header with the token
in the form that django-rest-framework <tt class="docutils literal">TokenAuthentication</tt> expects and as we&#8217;ve already discussed&nbsp;above:</p>
<div class="highlight"><pre><span></span><span class="nx">beforeSend</span><span class="o">:</span><span class="w"> </span><span class="kd">function</span><span class="p">(</span><span class="nx">request</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">if</span><span class="p">(</span><span class="nx">g_auth</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="nx">request</span><span class="p">.</span><span class="nx">setRequestHeader</span><span class="p">(</span><span class="s2">&quot;Authorization&quot;</span><span class="p">,</span><span class="w"> </span><span class="s2">&quot;Token &quot;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nx">g_auth</span><span class="p">.</span><span class="nx">key</span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>
</pre></div>
<p>If this ajax call returns ok (<tt class="docutils literal">done</tt> part) we just add the <tt class="docutils literal">Ok</tt> to a green label else if there&#8217;s an error (<tt class="docutils literal">fail</tt> part)
we add the response text and status to a red label. You can try clicking the button and you see that only if you&#8217;ve logged in
you will succeed in this&nbsp;call.</p>
<p>Let&#8217;s now take a look at the <tt class="docutils literal">#loginOkbutton</tt> click handler (inside the&nbsp;modal):</p>
<div class="highlight"><pre><span></span><span class="nx">$</span><span class="p">(</span><span class="s1">&#39;#loginOkButton&#39;</span><span class="p">).</span><span class="nx">click</span><span class="p">(</span><span class="kd">function</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kd">var</span><span class="w"> </span><span class="nx">username</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">$</span><span class="p">(</span><span class="s1">&#39;#input-username&#39;</span><span class="p">).</span><span class="nx">val</span><span class="p">();</span>
<span class="w">    </span><span class="kd">var</span><span class="w"> </span><span class="nx">password</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">$</span><span class="p">(</span><span class="s1">&#39;#input-password&#39;</span><span class="p">).</span><span class="nx">val</span><span class="p">();</span>
<span class="w">    </span><span class="kd">var</span><span class="w"> </span><span class="nx">remember_me</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">$</span><span class="p">(</span><span class="s1">&#39;#input-local-storage&#39;</span><span class="p">).</span><span class="nx">prop</span><span class="p">(</span><span class="s1">&#39;checked&#39;</span><span class="p">);</span>
<span class="w">    </span><span class="k">if</span><span class="p">(</span><span class="nx">username</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="nx">password</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">&quot;Will try to login with &quot;</span><span class="p">,</span><span class="w"> </span><span class="nx">username</span><span class="p">,</span><span class="w"> </span><span class="nx">password</span><span class="p">);</span>
<span class="w">        </span><span class="nx">$</span><span class="p">(</span><span class="s1">&#39;#modal-error&#39;</span><span class="p">).</span><span class="nx">addClass</span><span class="p">(</span><span class="s1">&#39;d-invisible&#39;</span><span class="p">);</span>
<span class="w">        </span><span class="nx">$</span><span class="p">.</span><span class="nx">ajax</span><span class="p">({</span>
<span class="w">            </span><span class="nx">url</span><span class="o">:</span><span class="w"> </span><span class="nx">g_urls</span><span class="p">.</span><span class="nx">login</span><span class="p">,</span>
<span class="w">            </span><span class="nx">method</span><span class="o">:</span><span class="w"> </span><span class="s2">&quot;POST&quot;</span><span class="p">,</span>
<span class="w">            </span><span class="nx">data</span><span class="o">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">                </span><span class="nx">username</span><span class="o">:</span><span class="w"> </span><span class="nx">username</span><span class="p">,</span>
<span class="w">                </span><span class="nx">password</span><span class="o">:</span><span class="w"> </span><span class="nx">password</span><span class="p">,</span>
<span class="w">                </span><span class="nx">csrfmiddlewaretoken</span><span class="o">:</span><span class="w"> </span><span class="nx">g_csrftoken</span>
<span class="w">            </span><span class="p">}</span>
<span class="w">        </span><span class="p">}).</span><span class="nx">done</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">data</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">&quot;DONE: &quot;</span><span class="p">,</span><span class="w"> </span><span class="nx">username</span><span class="p">,</span><span class="w"> </span><span class="nx">data</span><span class="p">.</span><span class="nx">key</span><span class="p">);</span>
<span class="w">            </span><span class="nx">g_auth</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span>
<span class="w">                </span><span class="nx">username</span><span class="o">:</span><span class="w"> </span><span class="nx">username</span><span class="p">,</span>
<span class="w">                </span><span class="nx">key</span><span class="o">:</span><span class="w"> </span><span class="nx">data</span><span class="p">.</span><span class="nx">key</span><span class="p">,</span>
<span class="w">                </span><span class="nx">remember_me</span><span class="o">:</span><span class="w"> </span><span class="nx">remember_me</span>
<span class="w">            </span><span class="p">};</span>
<span class="w">            </span><span class="nx">$</span><span class="p">(</span><span class="s1">&#39;#login-modal&#39;</span><span class="p">).</span><span class="nx">removeClass</span><span class="p">(</span><span class="s1">&#39;active&#39;</span><span class="p">);</span>
<span class="w">            </span><span class="nx">initLogin</span><span class="p">();</span>
<span class="w">            </span><span class="c1">// CAREFUL! csrf token is rotated after login: https://docs.djangoproject.com/en/1.7/releases/1.5.2/#bugfixes</span>
<span class="w">            </span><span class="nx">g_csrftoken</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">getCookie</span><span class="p">(</span><span class="s1">&#39;csrftoken&#39;</span><span class="p">);</span>
<span class="w">        </span><span class="p">}).</span><span class="nx">fail</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">data</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">&quot;FAIL&quot;</span><span class="p">,</span><span class="w"> </span><span class="nx">data</span><span class="p">);</span>
<span class="w">            </span><span class="nx">$</span><span class="p">(</span><span class="s1">&#39;#modal-error&#39;</span><span class="p">).</span><span class="nx">removeClass</span><span class="p">(</span><span class="s1">&#39;d-invisible&#39;</span><span class="p">);</span>
<span class="w">        </span><span class="p">});</span>
<span class="w">    </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="nx">$</span><span class="p">(</span><span class="s1">&#39;#modal-error&#39;</span><span class="p">).</span><span class="nx">removeClass</span><span class="p">(</span><span class="s1">&#39;d-invisible&#39;</span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">});</span>
</pre></div>
<p>All three user inputs (<tt class="docutils literal">username, password, remember_me</tt>) are read from the form and if both username and
password have been defined an Ajax request will be done to the <tt class="docutils literal">g_urls.login</tt> url. We pass
<tt class="docutils literal">username, password</tt> <em>and</em> <tt class="docutils literal">g_csrftoken</tt> (as discussed before) as the request data. Now, if there&#8217;s an
error (<tt class="docutils literal">fail</tt>) I just display a generic message (by removing it&#8217;s <cite>d-invisible</cite> class) while, if the
request was Ok I retrieve the <tt class="docutils literal">key</tt> (token) from the response, initialize the <tt class="docutils literal">g_auth</tt> object with the
<tt class="docutils literal">username</tt>, <tt class="docutils literal">key</tt> and <tt class="docutils literal">remember_me</tt> values and call <tt class="docutils literal">initLogin</tt> to show the correct divs and save
to the session/local&nbsp;storage.</p>
<p>It is important to keep in mind that with the line <tt class="docutils literal">g_csrftoken = <span class="pre">getCookie('csrftoken')</span></tt>
we re-read the <span class="caps">CSRF</span> cookie. This is needed because, as you can see in the mentioned link in the comment,
after Django logs in, the csrf cookie value is rotated for security reasons so it must be re-read here (or else
the <tt class="docutils literal">logout</tt> that is also a <span class="caps">POST</span> request will not&nbsp;work).</p>
<p>Finally, here&#8217;s the code for logout (still inside the <tt class="docutils literal">$(function () {</tt>):</p>
<div class="highlight"><pre><span></span><span class="w">    </span><span class="nx">$</span><span class="p">(</span><span class="s1">&#39;#logoutButton&#39;</span><span class="p">).</span><span class="nx">click</span><span class="p">(</span><span class="kd">function</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">&quot;Trying to logout&quot;</span><span class="p">);</span>
<span class="w">        </span><span class="nx">$</span><span class="p">.</span><span class="nx">ajax</span><span class="p">({</span>
<span class="w">            </span><span class="nx">url</span><span class="o">:</span><span class="w"> </span><span class="nx">g_urls</span><span class="p">.</span><span class="nx">logout</span><span class="p">,</span>
<span class="w">            </span><span class="nx">method</span><span class="o">:</span><span class="w"> </span><span class="s2">&quot;POST&quot;</span><span class="p">,</span>
<span class="w">            </span><span class="nx">beforeSend</span><span class="o">:</span><span class="w"> </span><span class="kd">function</span><span class="p">(</span><span class="nx">request</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">                </span><span class="nx">request</span><span class="p">.</span><span class="nx">setRequestHeader</span><span class="p">(</span><span class="s2">&quot;Authorization&quot;</span><span class="p">,</span><span class="w"> </span><span class="s2">&quot;Token &quot;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nx">g_auth</span><span class="p">.</span><span class="nx">key</span><span class="p">);</span>
<span class="w">            </span><span class="p">},</span>
<span class="w">            </span><span class="nx">data</span><span class="o">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">                </span><span class="nx">csrfmiddlewaretoken</span><span class="o">:</span><span class="w"> </span><span class="nx">g_csrftoken</span>
<span class="w">            </span><span class="p">}</span>
<span class="w">        </span><span class="p">}).</span><span class="nx">done</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">data</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">&quot;DONE: &quot;</span><span class="p">,</span><span class="w"> </span><span class="nx">data</span><span class="p">);</span>
<span class="w">            </span><span class="nx">g_auth</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">null</span><span class="p">;</span>
<span class="w">            </span><span class="nx">initLogin</span><span class="p">();</span>
<span class="w">        </span><span class="p">}).</span><span class="nx">fail</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">data</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">&quot;FAIL: &quot;</span><span class="p">,</span><span class="w"> </span><span class="nx">data</span><span class="p">);</span>
<span class="w">        </span><span class="p">});</span>
<span class="w">    </span><span class="p">});</span>

<span class="p">});</span><span class="w"> </span><span class="c1">// End of $(function () {</span>
</pre></div>
<p>The code here is very simple - just do a <tt class="docutils literal"><span class="caps">POST</span></tt> to the <tt class="docutils literal">g_urls.logout</tt>  and if everything is ok delete the <tt class="docutils literal">g_auth</tt> values
and call <tt class="docutils literal">initLogin()</tt> to show the correct divs and remove the <tt class="docutils literal">auth</tt> key from local/session storage. Notice that when
you <tt class="docutils literal"><span class="caps">POST</span></tt> to the <tt class="docutils literal">logout</tt> <span class="caps">REST</span> end-point, you need to also add the <tt class="docutils literal">Authorization</tt> header with the token or else
(since we&#8217;ve defined only <tt class="docutils literal">TokenAuthentication</tt> for the <tt class="docutils literal">authentication_classes</tt> for the <tt class="docutils literal">LogoutViewEx</tt> class)
there won&#8217;t be any way to correlate the request with the user and log him&nbsp;out!</p>
</div>
<div class="section" id="conclusion">
<h2>Conclusion</h2>
<p>Using the info presented on this article you should be able to properly login and logout to Django using <span class="caps">REST</span> and
also call <span class="caps">REST</span> end-points as an authenticated used. I recommend using the <tt class="docutils literal">curl</tt> utility to try to call the rest
end point with various parameters to see the response. Also, you change the <tt class="docutils literal">LogoutViewEx</tt> with the
default django-rest-auth <tt class="docutils literal">LogoutView</tt> and then try logging out through the web-app <em>and</em> through curl and see
what happens when you try to access the test-auth&nbsp;end-point.</p>
<p>Finally, the above project can be easily modified to use
<tt class="docutils literal">SessionAuthentication</tt> instead of <tt class="docutils literal">TokenAuthentication</tt> (so you won&#8217;t need <tt class="docutils literal"><span class="pre">django-rest-auth</span></tt> at all) - I&#8217;m
leaving it as an exercise to the&nbsp;reader.</p>
</div>
</div>
  		</article>
<div class="pagination">
    <a class="prev" href="https://www.spapas.net/index8.html">&larr; Older</a>

    <a class="next" href="https://www.spapas.net/index6.html">Newer &rarr;</a>
  <br />
</div></div>
<aside class="sidebar">
  
  <section>
    <br />
    <a href='/feeds/all.atom.xml'>Atom</a>
    |
    <a href='/feeds/all.rss.xml'>RSS</a>
  </section>

  <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <!-- Sidebar unit -->
  <ins class="adsbygoogle" style="display:block" data-ad-client="ca-pub-7673322832689008" data-ad-slot="2720624730"
    data-ad-format="auto" data-full-width-responsive="true"></ins>
  <script>
    (adsbygoogle = window.adsbygoogle || []).push({});
  </script>


  <script async src="https://cse.google.com/cse.js?cx=612920e5ca9da850c"></script>
  <div class="gcse-search"></div>

  
  <section>
    <h1>Support me</h1>

    You can show your appreciation for anything useful you've found here by 
    buying me a coffee 
    <script type="text/javascript" src="https://cdnjs.buymeacoffee.com/1.0.0/button.prod.min.js" data-name="bmc-button" data-slug="spapas" data-color="#FFDD00" data-emoji=""  data-font="Lato" data-text="Buy me a coffee" data-outline-color="#000000" data-font-color="#000000" data-coffee-color="#ffffff" ></script>

    or donating me some bitcoin to this address:
    <small><pre>bc1qx42vp8napheaewhnx0rk0mttdrdrtvw6czvxhl</pre></small>
    <svg shape-rendering="crispEdges" height="200" width="200" viewBox="0 0 29 29" class="qrcode">
      <path fill="#FFFFFF" d="M0,0 h29v29H0z"></path><path fill="#000000" d="M0 0h7v1H0zM9 0h2v1H9zM12 0h1v1H12zM14 0h2v1H14zM18 0h2v1H18zM22,0 h7v1H22zM0 1h1v1H0zM6 1h1v1H6zM8 1h1v1H8zM11 1h1v1H11zM14 1h5v1H14zM22 1h1v1H22zM28,1 h1v1H28zM0 2h1v1H0zM2 2h3v1H2zM6 2h1v1H6zM8 2h4v1H8zM17 2h1v1H17zM22 2h1v1H22zM24 2h3v1H24zM28,2 h1v1H28zM0 3h1v1H0zM2 3h3v1H2zM6 3h1v1H6zM9 3h2v1H9zM14 3h3v1H14zM18 3h1v1H18zM22 3h1v1H22zM24 3h3v1H24zM28,3 h1v1H28zM0 4h1v1H0zM2 4h3v1H2zM6 4h1v1H6zM8 4h1v1H8zM11 4h1v1H11zM13 4h1v1H13zM15 4h2v1H15zM18 4h1v1H18zM22 4h1v1H22zM24 4h3v1H24zM28,4 h1v1H28zM0 5h1v1H0zM6 5h1v1H6zM8 5h2v1H8zM14 5h2v1H14zM19 5h2v1H19zM22 5h1v1H22zM28,5 h1v1H28zM0 6h7v1H0zM8 6h1v1H8zM10 6h1v1H10zM12 6h1v1H12zM14 6h1v1H14zM16 6h1v1H16zM18 6h1v1H18zM20 6h1v1H20zM22,6 h7v1H22zM8 7h2v1H8zM11 7h1v1H11zM15 7h1v1H15zM17 7h2v1H17zM0 8h2v1H0zM3 8h1v1H3zM6 8h2v1H6zM10 8h1v1H10zM12 8h3v1H12zM20 8h1v1H20zM22 8h3v1H22zM26 8h2v1H26zM1 9h1v1H1zM3 9h3v1H3zM8 9h1v1H8zM10 9h1v1H10zM12 9h2v1H12zM16 9h2v1H16zM20 9h1v1H20zM22 9h1v1H22zM25 9h1v1H25zM27,9 h2v1H27zM0 10h1v1H0zM3 10h2v1H3zM6 10h1v1H6zM8 10h3v1H8zM12 10h2v1H12zM16 10h1v1H16zM19 10h1v1H19zM22 10h3v1H22zM27 10h1v1H27zM0 11h1v1H0zM2 11h1v1H2zM4 11h2v1H4zM7 11h1v1H7zM13 11h4v1H13zM18 11h4v1H18zM26 11h2v1H26zM0 12h1v1H0zM2 12h3v1H2zM6 12h1v1H6zM11 12h1v1H11zM13 12h1v1H13zM15 12h3v1H15zM20 12h1v1H20zM22 12h2v1H22zM27,12 h2v1H27zM4 13h1v1H4zM8 13h3v1H8zM12 13h1v1H12zM14 13h1v1H14zM17 13h4v1H17zM25 13h2v1H25zM0 14h1v1H0zM4 14h3v1H4zM8 14h2v1H8zM11 14h3v1H11zM16 14h1v1H16zM21 14h2v1H21zM24,14 h5v1H24zM3 15h3v1H3zM7 15h2v1H7zM10 15h1v1H10zM12 15h2v1H12zM15 15h1v1H15zM17 15h2v1H17zM20 15h2v1H20zM23 15h1v1H23zM1 16h1v1H1zM4 16h1v1H4zM6 16h4v1H6zM16 16h2v1H16zM20 16h1v1H20zM23 16h1v1H23zM25 16h1v1H25zM28,16 h1v1H28zM2 17h1v1H2zM5 17h1v1H5zM7 17h2v1H7zM11 17h3v1H11zM17 17h1v1H17zM22 17h1v1H22zM25 17h1v1H25zM27,17 h2v1H27zM0 18h1v1H0zM3 18h1v1H3zM5 18h4v1H5zM10 18h1v1H10zM12 18h1v1H12zM18 18h1v1H18zM20 18h1v1H20zM22 18h2v1H22zM25,18 h4v1H25zM2 19h3v1H2zM8 19h1v1H8zM16 19h2v1H16zM21 19h1v1H21zM23 19h1v1H23zM25 19h1v1H25zM27 19h1v1H27zM0 20h1v1H0zM2 20h5v1H2zM8 20h2v1H8zM13 20h4v1H13zM19 20h6v1H19zM26 20h1v1H26zM28,20 h1v1H28zM8 21h2v1H8zM12 21h3v1H12zM16 21h1v1H16zM20 21h1v1H20zM24 21h1v1H24zM26,21 h3v1H26zM0 22h7v1H0zM8 22h3v1H8zM17 22h1v1H17zM20 22h1v1H20zM22 22h1v1H22zM24 22h2v1H24zM27 22h1v1H27zM0 23h1v1H0zM6 23h1v1H6zM10 23h2v1H10zM13 23h2v1H13zM19 23h2v1H19zM24,23 h5v1H24zM0 24h1v1H0zM2 24h3v1H2zM6 24h1v1H6zM9 24h2v1H9zM12 24h2v1H12zM17 24h1v1H17zM20 24h6v1H20zM28,24 h1v1H28zM0 25h1v1H0zM2 25h3v1H2zM6 25h1v1H6zM8 25h3v1H8zM12 25h1v1H12zM14 25h1v1H14zM18 25h1v1H18zM22 25h3v1H22zM26 25h1v1H26zM0 26h1v1H0zM2 26h3v1H2zM6 26h1v1H6zM10 26h5v1H10zM16 26h3v1H16zM21 26h1v1H21zM24 26h1v1H24zM26 26h1v1H26zM28,26 h1v1H28zM0 27h1v1H0zM6 27h1v1H6zM8 27h3v1H8zM12 27h4v1H12zM17 27h1v1H17zM20 27h1v1H20zM23 27h2v1H23zM27 27h1v1H27zM0 28h7v1H0zM8 28h3v1H8zM14 28h1v1H14zM16 28h3v1H16zM20 28h1v1H20zM22 28h1v1H22zM24 28h2v1H24zM27 28h1v1H27z"></path>
    </svg>
  </section>
  

  <section>
    <h1>Subscribe</h1>
    Do you want to get notified via email when I post new content?
    <style>
      .subscribe-button {
        /* margin: 10px !important; */
        padding: 10px !important;
        background-color: black;
        display: inline-block;
        color: white !important;
        text-decoration: none;

        line-height: 36px !important;
        height: 37px !important;
        text-decoration: none !important;
        display: inline-block !important;
        color: #ffffff !important;
        background-color: #000000 !important;
        border-radius: 3px !important;
        border: 1px solid transparent !important;
        padding: 1px 9px !important;
        font-size: 23px !important;
        letter-spacing: 0.6px !important;
        box-shadow: 0px 1px 2px rgba(190, 190, 190, 0.5) !important;
        -webkit-box-shadow: 0px 1px 2px 2px rgba(190, 190, 190, 0.5) !important;
        margin: 0 auto !important;
        font-family: 'Cookie', cursive !important;
        -webkit-box-sizing: border-box !important;
        box-sizing: border-box !important;
        -o-transition: 0.3s all linear !important;
        -webkit-transition: 0.3s all linear !important;
        -moz-transition: 0.3s all linear !important;
        -ms-transition: 0.3s all linear !important;
        transition: 0.3s all linear !important;

      }
    </style>
    <a class='subscribe-button' target="_blank" href="http://eepurl.com/dxI3PP">Click here to subscribe!</a>
  </section>


  <section>
    <h1>Recent Posts</h1>
    <ul id="recent_posts">
      <li class="post">
        <a href="https://www.spapas.net/2024/08/22/multiple-erl-elixir-windows/">Multiple Erlang/Elixir versions in Windows</a>
      </li>
      <li class="post">
        <a href="https://www.spapas.net/2023/11/29/openid-connect-tutorial/">A simple OpenID connect tutorial</a>
      </li>
      <li class="post">
        <a href="https://www.spapas.net/2023/05/23/simple-django-datatables-integration/">Simple Django - DataTables integration</a>
      </li>
      <li class="post">
        <a href="https://www.spapas.net/2023/05/22/ai-auto-subtitling/">AI auto-subtitling</a>
      </li>
      <li class="post">
        <a href="https://www.spapas.net/2023/05/12/disable-your-forms/">HTML form disable after submit</a>
      </li>
    </ul>
  </section>
  <section>

    <h1>Categories</h1>
    <ul id="recent_posts">
      <li><a href="https://www.spapas.net/category/ai.html">ai</a></li>
      <li><a href="https://www.spapas.net/category/android.html">android</a></li>
      <li><a href="https://www.spapas.net/category/clojure.html">clojure</a></li>
      <li><a href="https://www.spapas.net/category/css.html">css</a></li>
      <li><a href="https://www.spapas.net/category/django.html">django</a></li>
      <li><a href="https://www.spapas.net/category/elixir.html">elixir</a></li>
      <li><a href="https://www.spapas.net/category/flask.html">flask</a></li>
      <li><a href="https://www.spapas.net/category/gaming.html">gaming</a></li>
      <li><a href="https://www.spapas.net/category/git.html">git</a></li>
      <li><a href="https://www.spapas.net/category/html.html">html</a></li>
      <li><a href="https://www.spapas.net/category/javascript.html">javascript</a></li>
      <li><a href="https://www.spapas.net/category/networking.html">networking</a></li>
      <li><a href="https://www.spapas.net/category/pelican.html">pelican</a></li>
      <li><a href="https://www.spapas.net/category/postgresql.html">postgresql</a></li>
      <li><a href="https://www.spapas.net/category/python.html">python</a></li>
      <li><a href="https://www.spapas.net/category/spring.html">spring</a></li>
      <li><a href="https://www.spapas.net/category/unix.html">unix</a></li>
      <li><a href="https://www.spapas.net/category/wagtail.html">wagtail</a></li>
    </ul>
  </section>

  <section>
    <h1>Tags</h1>
    <a href="https://www.spapas.net/tag/erlang.html">erlang</a>,    <a href="https://www.spapas.net/tag/elixir.html">elixir</a>,    <a href="https://www.spapas.net/tag/windows.html">windows</a>,    <a href="https://www.spapas.net/tag/openid.html">openid</a>,    <a href="https://www.spapas.net/tag/openid-connect.html">openid-connect</a>,    <a href="https://www.spapas.net/tag/oidc.html">oidc</a>,    <a href="https://www.spapas.net/tag/http.html">http</a>,    <a href="https://www.spapas.net/tag/keycloak.html">keycloak</a>,    <a href="https://www.spapas.net/tag/python.html">python</a>,    <a href="https://www.spapas.net/tag/django.html">django</a>,    <a href="https://www.spapas.net/tag/jquery.html">jquery</a>,    <a href="https://www.spapas.net/tag/datatables.html">datatables</a>,    <a href="https://www.spapas.net/tag/ai.html">ai</a>,    <a href="https://www.spapas.net/tag/whisper.html">whisper</a>,    <a href="https://www.spapas.net/tag/whispercpp.html">whisper.cpp</a>,    <a href="https://www.spapas.net/tag/subtitles.html">subtitles</a>,    <a href="https://www.spapas.net/tag/video.html">video</a>,    <a href="https://www.spapas.net/tag/auto-subtitling.html">auto-subtitling</a>,    <a href="https://www.spapas.net/tag/subtitiling.html">subtitiling</a>,    <a href="https://www.spapas.net/tag/transcribe.html">transcribe</a>,    <a href="https://www.spapas.net/tag/html.html">html</a>,    <a href="https://www.spapas.net/tag/javascript.html">javascript</a>,    <a href="https://www.spapas.net/tag/media.html">media</a>,    <a href="https://www.spapas.net/tag/storage.html">storage</a>,    <a href="https://www.spapas.net/tag/unpoly.html">unpoly</a>,    <a href="https://www.spapas.net/tag/access.html">access</a>,    <a href="https://www.spapas.net/tag/database.html">database</a>,    <a href="https://www.spapas.net/tag/accdb.html">accdb</a>,    <a href="https://www.spapas.net/tag/mdb.html">mdb</a>,    <a href="https://www.spapas.net/tag/postgresql.html">postgresql</a>,    <a href="https://www.spapas.net/tag/development.html">development</a>,    <a href="https://www.spapas.net/tag/inlines.html">inlines</a>,    <a href="https://www.spapas.net/tag/clojure.html">clojure</a>,    <a href="https://www.spapas.net/tag/cmd.html">cmd</a>,    <a href="https://www.spapas.net/tag/pdf.html">pdf</a>,    <a href="https://www.spapas.net/tag/wkhtmltopdf.html">wkhtmltopdf</a>,    <a href="https://www.spapas.net/tag/forward-proxy.html">forward-proxy</a>,    <a href="https://www.spapas.net/tag/reverse-proxy.html">reverse-proxy</a>,    <a href="https://www.spapas.net/tag/proxy.html">proxy</a>,    <a href="https://www.spapas.net/tag/networking.html">networking</a>,    <a href="https://www.spapas.net/tag/dj-rest-auth.html">dj-rest-auth</a>,    <a href="https://www.spapas.net/tag/rest.html">rest</a>,    <a href="https://www.spapas.net/tag/django-rest-framework.html">django-rest-framework</a>,    <a href="https://www.spapas.net/tag/authentication.html">authentication</a>,    <a href="https://www.spapas.net/tag/tokens.html">tokens</a>,    <a href="https://www.spapas.net/tag/migrations.html">migrations</a>,    <a href="https://www.spapas.net/tag/foreignkey.html">foreignkey</a>,    <a href="https://www.spapas.net/tag/dark-souls.html">dark-souls</a>,    <a href="https://www.spapas.net/tag/dark-souls-2.html">dark-souls-2</a>,    <a href="https://www.spapas.net/tag/dark-souls-3.html">dark-souls-3</a>,    <a href="https://www.spapas.net/tag/autohotkey.html">autohotkey</a>,    <a href="https://www.spapas.net/tag/matplotlib.html">matplotlib</a>,    <a href="https://www.spapas.net/tag/hashids.html">hashids</a>,    <a href="https://www.spapas.net/tag/wagtail.html">wagtail</a>,    <a href="https://www.spapas.net/tag/osmon.html">osmon</a>,    <a href="https://www.spapas.net/tag/phoenix.html">phoenix</a>,    <a href="https://www.spapas.net/tag/os-monitoring.html">os-monitoring</a>,    <a href="https://www.spapas.net/tag/forms.html">forms</a>,    <a href="https://www.spapas.net/tag/django-crispy-forms.html">django-crispy-forms</a>,    <a href="https://www.spapas.net/tag/django-widget-tweaks.html">django-widget-tweaks</a>,    <a href="https://www.spapas.net/tag/ecto.html">ecto</a>,    <a href="https://www.spapas.net/tag/queries.html">queries</a>,    <a href="https://www.spapas.net/tag/declarative.html">declarative</a>,    <a href="https://www.spapas.net/tag/form.html">form</a>,    <a href="https://www.spapas.net/tag/php.html">php</a>,    <a href="https://www.spapas.net/tag/select2.html">select2</a>,    <a href="https://www.spapas.net/tag/autocompelte.html">autocompelte</a>,    <a href="https://www.spapas.net/tag/ajax.html">ajax</a>,    <a href="https://www.spapas.net/tag/android.html">android</a>,    <a href="https://www.spapas.net/tag/kotlin.html">kotlin</a>,    <a href="https://www.spapas.net/tag/adapter.html">adapter</a>,    <a href="https://www.spapas.net/tag/filter.html">filter</a>,    <a href="https://www.spapas.net/tag/async.html">async</a>,    <a href="https://www.spapas.net/tag/tasks.html">tasks</a>,    <a href="https://www.spapas.net/tag/django-rq.html">django-rq</a>,    <a href="https://www.spapas.net/tag/rq.html">rq</a>,    <a href="https://www.spapas.net/tag/du.html">du</a>,    <a href="https://www.spapas.net/tag/unix.html">unix</a>,    <a href="https://www.spapas.net/tag/linux.html">linux</a>,    <a href="https://www.spapas.net/tag/disk-usage.html">disk-usage</a>,    <a href="https://www.spapas.net/tag/cbv.html">cbv</a>,    <a href="https://www.spapas.net/tag/middleware.html">middleware</a>,    <a href="https://www.spapas.net/tag/class-based-views.html">class-based-views</a>,    <a href="https://www.spapas.net/tag/react.html">react</a>,    <a href="https://www.spapas.net/tag/redux.html">redux</a>,    <a href="https://www.spapas.net/tag/hyperapp.html">hyperapp</a>,    <a href="https://www.spapas.net/tag/immutable.html">immutable</a>,    <a href="https://www.spapas.net/tag/es6.html">es6</a>,    <a href="https://www.spapas.net/tag/youtube.html">youtube</a>,    <a href="https://www.spapas.net/tag/youtube-dl.html">youtube-dl</a>,    <a href="https://www.spapas.net/tag/ffmpeg.html">ffmpeg</a>,    <a href="https://www.spapas.net/tag/django-rest-auth.html">django-rest-auth</a>,    <a href="https://www.spapas.net/tag/python-2.html">python-2</a>,    <a href="https://www.spapas.net/tag/python-3.html">python-3</a>,    <a href="https://www.spapas.net/tag/plpgsql.html">plpgsql</a>,    <a href="https://www.spapas.net/tag/component.html">component</a>,    <a href="https://www.spapas.net/tag/ag-grid.html">ag-grid</a>,    <a href="https://www.spapas.net/tag/grid.html">grid</a>,    <a href="https://www.spapas.net/tag/bash.html">bash</a>,    <a href="https://www.spapas.net/tag/cron.html">cron</a>,    <a href="https://www.spapas.net/tag/pandas.html">pandas</a>,    <a href="https://www.spapas.net/tag/scipy.html">scipy</a>,    <a href="https://www.spapas.net/tag/numpy.html">numpy</a>,    <a href="https://www.spapas.net/tag/pivot.html">pivot</a>,    <a href="https://www.spapas.net/tag/pivot_table.html">pivot_table</a>,    <a href="https://www.spapas.net/tag/ipython.html">ipython</a>,    <a href="https://www.spapas.net/tag/jupyter.html">jupyter</a>,    <a href="https://www.spapas.net/tag/notebook.html">notebook</a>,    <a href="https://www.spapas.net/tag/query.html">query</a>,    <a href="https://www.spapas.net/tag/q.html">q</a>,    <a href="https://www.spapas.net/tag/imgur.html">imgur</a>,    <a href="https://www.spapas.net/tag/console.html">console</a>,    <a href="https://www.spapas.net/tag/research.html">research</a>,    <a href="https://www.spapas.net/tag/debug.html">debug</a>,    <a href="https://www.spapas.net/tag/werkzeug.html">werkzeug</a>,    <a href="https://www.spapas.net/tag/django-extensions.html">django-extensions</a>,    <a href="https://www.spapas.net/tag/404.html">404</a>,    <a href="https://www.spapas.net/tag/error.html">error</a>,    <a href="https://www.spapas.net/tag/spring.html">spring</a>,    <a href="https://www.spapas.net/tag/spring-boot.html">spring-boot</a>,    <a href="https://www.spapas.net/tag/java.html">java</a>,    <a href="https://www.spapas.net/tag/ldap.html">ldap</a>,    <a href="https://www.spapas.net/tag/profiles.html">profiles</a>,    <a href="https://www.spapas.net/tag/settings.html">settings</a>,    <a href="https://www.spapas.net/tag/properties.html">properties</a>,    <a href="https://www.spapas.net/tag/yaml.html">yaml</a>,    <a href="https://www.spapas.net/tag/configuration.html">configuration</a>,    <a href="https://www.spapas.net/tag/deploy.html">deploy</a>,    <a href="https://www.spapas.net/tag/initd.html">init.d</a>,    <a href="https://www.spapas.net/tag/react-redux.html">react-redux</a>,    <a href="https://www.spapas.net/tag/redux-thunk.html">redux-thunk</a>,    <a href="https://www.spapas.net/tag/redux-form.html">redux-form</a>,    <a href="https://www.spapas.net/tag/react-router.html">react-router</a>,    <a href="https://www.spapas.net/tag/react-router-redux.html">react-router-redux</a>,    <a href="https://www.spapas.net/tag/react-notification.html">react-notification</a>,    <a href="https://www.spapas.net/tag/history.html">history</a>,    <a href="https://www.spapas.net/tag/babel.html">babel</a>,    <a href="https://www.spapas.net/tag/babelify.html">babelify</a>,    <a href="https://www.spapas.net/tag/browserify.html">browserify</a>,    <a href="https://www.spapas.net/tag/watchify.html">watchify</a>,    <a href="https://www.spapas.net/tag/uglify.html">uglify</a>,    <a href="https://www.spapas.net/tag/boilerplate.html">boilerplate</a>,    <a href="https://www.spapas.net/tag/tutorial.html">tutorial</a>,    <a href="https://www.spapas.net/tag/introduction.html">introduction</a>,    <a href="https://www.spapas.net/tag/fixed-data-tables.html">fixed-data-tables</a>,    <a href="https://www.spapas.net/tag/fixeddatatable.html">FixedDataTable</a>,    <a href="https://www.spapas.net/tag/reportlab.html">reportlab</a>,    <a href="https://www.spapas.net/tag/xhtml2pdf.html">xhtml2pdf</a>,    <a href="https://www.spapas.net/tag/node.html">node</a>,    <a href="https://www.spapas.net/tag/npm.html">npm</a>,    <a href="https://www.spapas.net/tag/generic.html">generic</a>,    <a href="https://www.spapas.net/tag/tables.html">tables</a>,    <a href="https://www.spapas.net/tag/flux.html">flux</a>,    <a href="https://www.spapas.net/tag/jobs.html">jobs</a>,    <a href="https://www.spapas.net/tag/asynchronous.html">asynchronous</a>,    <a href="https://www.spapas.net/tag/scheduling.html">scheduling</a>,    <a href="https://www.spapas.net/tag/redis.html">redis</a>,    <a href="https://www.spapas.net/tag/pusher.html">pusher</a>,    <a href="https://www.spapas.net/tag/auditing.html">auditing</a>,    <a href="https://www.spapas.net/tag/css.html">css</a>,    <a href="https://www.spapas.net/tag/design.html">design</a>,    <a href="https://www.spapas.net/tag/boostrap-material-design.html">boostrap-material-design</a>,    <a href="https://www.spapas.net/tag/less.html">less</a>,    <a href="https://www.spapas.net/tag/nodejs.html">node.js</a>,    <a href="https://www.spapas.net/tag/gmail.html">gmail</a>,    <a href="https://www.spapas.net/tag/security.html">security</a>,    <a href="https://www.spapas.net/tag/google.html">google</a>,    <a href="https://www.spapas.net/tag/flask.html">flask</a>,    <a href="https://www.spapas.net/tag/mongodb.html">mongodb</a>,    <a href="https://www.spapas.net/tag/heroku.html">heroku</a>,    <a href="https://www.spapas.net/tag/spring-security.html">spring-security</a>,    <a href="https://www.spapas.net/tag/git.html">git</a>,    <a href="https://www.spapas.net/tag/github.html">github</a>,    <a href="https://www.spapas.net/tag/branching.html">branching</a>,    <a href="https://www.spapas.net/tag/static-html.html">static-html</a>,    <a href="https://www.spapas.net/tag/githubio.html">github.io</a>,    <a href="https://www.spapas.net/tag/pelican.html">pelican</a>,    <a href="https://www.spapas.net/tag/github-pages.html">github-pages</a>,    <a href="https://www.spapas.net/tag/rst.html">rst</a>  </section>

  <section>
    <h1>Yearly archives</h1>
    <a href="https://www.spapas.net/posts/2013/">2013</a>,    <a href="https://www.spapas.net/posts/2014/">2014</a>,    <a href="https://www.spapas.net/posts/2015/">2015</a>,    <a href="https://www.spapas.net/posts/2016/">2016</a>,    <a href="https://www.spapas.net/posts/2017/">2017</a>,    <a href="https://www.spapas.net/posts/2018/">2018</a>,    <a href="https://www.spapas.net/posts/2019/">2019</a>,    <a href="https://www.spapas.net/posts/2020/">2020</a>,    <a href="https://www.spapas.net/posts/2021/">2021</a>,    <a href="https://www.spapas.net/posts/2022/">2022</a>,    <a href="https://www.spapas.net/posts/2023/">2023</a>,    <a href="https://www.spapas.net/posts/2024/">2024</a>  </section>



  <section>
    <h1>GitHub Repos</h1>
    <ul id="gh_repos">
      <li class="loading">Status updating...</li>
    </ul>
      <a href="https://github.com/spapas">@spapas</a> on GitHub
    <script  src="//code.jquery.com/jquery-3.3.1.min.js"
        integrity="sha256-FgpCb/KJQlLNfOu91ta32o/NMZxltwRo8QtmkMRdAu8="
        crossorigin="anonymous"></script>
    <script type="text/javascript">
      $(function(){
          if (!window.jXHR){
              var jxhr = document.createElement('script');
              jxhr.type = 'text/javascript';
              jxhr.src = 'https://www.spapas.net/theme/js/jXHR.js';
              var s = document.getElementsByTagName('script')[0];
              s.parentNode.insertBefore(jxhr, s);
          }

          github.showRepos({
              user: 'spapas',
              count: 5,
              skip_forks: true,
              target: '#gh_repos'
          });
      });
    </script>
    <script src="https://www.spapas.net/theme/js/github.js" type="text/javascript"> </script>
  </section>


  <section>
    <a href="https://twitter.com/_serafeim_?ref_src=twsrc%5Etfw" class="twitter-follow-button"
      data-show-count="false">Follow @_serafeim_</a>
    <script async src="https://platform.twitter.com/widgets.js" charset="utf-8"></script>
  </section>

</aside>    </div>
  </div>
  <footer role="contentinfo"><p>
    Copyright &copy;  2013&ndash;2024  Serafeim Papastefanos &mdash;
  <span class="credit">Powered by <a href="http://getpelican.com">Pelican</a></span>
</p></footer>
  <script src="https://www.spapas.net/theme/js/modernizr-2.0.js"></script>
  <script src="https://www.spapas.net/theme/js/ender.js"></script>
  <script src="https://www.spapas.net/theme/js/octopress.js" type="text/javascript"></script>
  <script src="https://www.spapas.net/theme/js/ads.js"></script>
    <script>
    (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
    (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
    m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
    })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

    ga('create', 'UA-44750952-1', 'auto');

    ga('send', 'pageview');
    </script>

<script defer data-domain="spapas.net" src="https://plausible.hcg.gr/js/script.js"></script>  <script type="text/javascript">
    var disqus_shortname = 'spapas-github-io';
    (function() {
      var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
      dsq.src = "//" + disqus_shortname + '.disqus.com/embed.js';
      (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
     })();
  </script>
  <script type="text/javascript">
    (function(){
      var twitterWidgets = document.createElement('script');
      twitterWidgets.type = 'text/javascript';
      twitterWidgets.async = true;
      twitterWidgets.src = '//platform.twitter.com/widgets.js';
      document.getElementsByTagName('head')[0].appendChild(twitterWidgets);
    })();
  </script>

</body>

</html>