<!DOCTYPE html>
<!--[if IEMobile 7 ]><html class="no-js iem7"><![endif]-->
<!--[if lt IE 9]><html class="no-js lte-ie8"><![endif]-->
<!--[if (gt IE 8)|(gt IEMobile 7)|!(IEMobile)|!(IE)]><!-->
<html class="no-js" lang="en">
<!--<![endif]-->

  <head>
    <meta charset="utf-8">
    <meta name="google-site-verification" content="5_8DTmIiEq4gFvNAfxAD6TsGOgrMAjp8lQFQvfA6zZc" />
    <title>/var/</title>
    <meta name="author" content="Serafeim Papastefanos">


    
<style type="text/css">
pre { line-height: 125%; }
td.linenos .normal { color: inherit; background-color: transparent; padding-left: 5px; padding-right: 5px; }
span.linenos { color: inherit; background-color: transparent; padding-left: 5px; padding-right: 5px; }
td.linenos .special { color: #000000; background-color: #ffffc0; padding-left: 5px; padding-right: 5px; }
span.linenos.special { color: #000000; background-color: #ffffc0; padding-left: 5px; padding-right: 5px; }
.highlight .hll { background-color: var(--jp-cell-editor-active-background) }
.highlight { background: var(--jp-cell-editor-background); color: var(--jp-mirror-editor-variable-color) }
.highlight .c { color: var(--jp-mirror-editor-comment-color); font-style: italic } /* Comment */
.highlight .err { color: var(--jp-mirror-editor-error-color) } /* Error */
.highlight .k { color: var(--jp-mirror-editor-keyword-color); font-weight: bold } /* Keyword */
.highlight .o { color: var(--jp-mirror-editor-operator-color); font-weight: bold } /* Operator */
.highlight .p { color: var(--jp-mirror-editor-punctuation-color) } /* Punctuation */
.highlight .ch { color: var(--jp-mirror-editor-comment-color); font-style: italic } /* Comment.Hashbang */
.highlight .cm { color: var(--jp-mirror-editor-comment-color); font-style: italic } /* Comment.Multiline */
.highlight .cp { color: var(--jp-mirror-editor-comment-color); font-style: italic } /* Comment.Preproc */
.highlight .cpf { color: var(--jp-mirror-editor-comment-color); font-style: italic } /* Comment.PreprocFile */
.highlight .c1 { color: var(--jp-mirror-editor-comment-color); font-style: italic } /* Comment.Single */
.highlight .cs { color: var(--jp-mirror-editor-comment-color); font-style: italic } /* Comment.Special */
.highlight .kc { color: var(--jp-mirror-editor-keyword-color); font-weight: bold } /* Keyword.Constant */
.highlight .kd { color: var(--jp-mirror-editor-keyword-color); font-weight: bold } /* Keyword.Declaration */
.highlight .kn { color: var(--jp-mirror-editor-keyword-color); font-weight: bold } /* Keyword.Namespace */
.highlight .kp { color: var(--jp-mirror-editor-keyword-color); font-weight: bold } /* Keyword.Pseudo */
.highlight .kr { color: var(--jp-mirror-editor-keyword-color); font-weight: bold } /* Keyword.Reserved */
.highlight .kt { color: var(--jp-mirror-editor-keyword-color); font-weight: bold } /* Keyword.Type */
.highlight .m { color: var(--jp-mirror-editor-number-color) } /* Literal.Number */
.highlight .s { color: var(--jp-mirror-editor-string-color) } /* Literal.String */
.highlight .ow { color: var(--jp-mirror-editor-operator-color); font-weight: bold } /* Operator.Word */
.highlight .pm { color: var(--jp-mirror-editor-punctuation-color) } /* Punctuation.Marker */
.highlight .w { color: var(--jp-mirror-editor-variable-color) } /* Text.Whitespace */
.highlight .mb { color: var(--jp-mirror-editor-number-color) } /* Literal.Number.Bin */
.highlight .mf { color: var(--jp-mirror-editor-number-color) } /* Literal.Number.Float */
.highlight .mh { color: var(--jp-mirror-editor-number-color) } /* Literal.Number.Hex */
.highlight .mi { color: var(--jp-mirror-editor-number-color) } /* Literal.Number.Integer */
.highlight .mo { color: var(--jp-mirror-editor-number-color) } /* Literal.Number.Oct */
.highlight .sa { color: var(--jp-mirror-editor-string-color) } /* Literal.String.Affix */
.highlight .sb { color: var(--jp-mirror-editor-string-color) } /* Literal.String.Backtick */
.highlight .sc { color: var(--jp-mirror-editor-string-color) } /* Literal.String.Char */
.highlight .dl { color: var(--jp-mirror-editor-string-color) } /* Literal.String.Delimiter */
.highlight .sd { color: var(--jp-mirror-editor-string-color) } /* Literal.String.Doc */
.highlight .s2 { color: var(--jp-mirror-editor-string-color) } /* Literal.String.Double */
.highlight .se { color: var(--jp-mirror-editor-string-color) } /* Literal.String.Escape */
.highlight .sh { color: var(--jp-mirror-editor-string-color) } /* Literal.String.Heredoc */
.highlight .si { color: var(--jp-mirror-editor-string-color) } /* Literal.String.Interpol */
.highlight .sx { color: var(--jp-mirror-editor-string-color) } /* Literal.String.Other */
.highlight .sr { color: var(--jp-mirror-editor-string-color) } /* Literal.String.Regex */
.highlight .s1 { color: var(--jp-mirror-editor-string-color) } /* Literal.String.Single */
.highlight .ss { color: var(--jp-mirror-editor-string-color) } /* Literal.String.Symbol */
.highlight .il { color: var(--jp-mirror-editor-number-color) } /* Literal.Number.Integer.Long */
</style>

<style type="text/css">
/* Overrides of notebook CSS for static HTML export */
div.entry-content {
  overflow: visible;
  padding: 8px;
}
.input_area {
  padding: 0.2em;
}

a.heading-anchor {
 white-space: normal;
}

.rendered_html
code {
 font-size: .8em;
}

pre.ipynb {
  color: black;
  background: #f7f7f7;
  border: none;
  box-shadow: none;
  margin-bottom: 0;
  padding: 0;
  margin: 0px;
  font-size: 13px;
}

/* remove the prompt div from text cells */
div.text_cell .prompt {
    display: none;
}

/* remove horizontal padding from text cells, */
/* so it aligns with outer body text */
div.text_cell_render {
    padding: 0.5em 0em;
}

img.anim_icon{padding:0; border:0; vertical-align:middle; -webkit-box-shadow:none; -box-shadow:none}

div.collapseheader {
    width=100%;
    background-color:#d3d3d3;
    padding: 2px;
    cursor: pointer;
    font-family:"Helvetica Neue",Helvetica,Arial,sans-serif;
}
</style>

<script type="text/x-mathjax-config">
MathJax.Hub.Config({
    tex2jax: {
        inlineMath: [['$','$'], ['\\(','\\)']],
        processEscapes: true,
        displayMath: [['$$','$$'], ["\\[","\\]"]]
    }
});
</script>
<script type="text/javascript" async src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.2/MathJax.js?config=TeX-MML-AM_CHTML">
</script>

<script src="https://ajax.googleapis.com/ajax/libs/jquery/1.10.2/jquery.min.js"></script>

<script type="text/javascript">
jQuery(document).ready(function($) {
    $("div.collapseheader").click(function () {
    $header = $(this).children("span").first();
    $codearea = $(this).children(".input_area");
    console.log($(this).children());
    $codearea.slideToggle(500, function () {
        $header.text(function () {
            return $codearea.is(":visible") ? "Collapse Code" : "Expand Code";
        });
    });
});
});
</script>




    <!-- http://t.co/dKP3o1e -->
    <meta name="HandheldFriendly" content="True">
    <meta name="MobileOptimized" content="320">
    <meta name="viewport" content="width=device-width, initial-scale=1">


    <link href="https://www.spapas.net/favicon.png" rel="icon">

    <link href="https://www.spapas.net/theme/css/main.css" media="screen, projection" rel="stylesheet"
      type="text/css">

    <link href="https://www.spapas.net/theme/css/extra_style.css" media="screen, projection" rel="stylesheet"
      type="text/css">

    <link href="https://fonts.googleapis.com/css?family=Fira+Mono|Fira+Sans:400,700&amp;subset=greek" rel="stylesheet">

<style>
#gHPzseYvFrhZ123 {
  padding: 5px !important;
  display: block;
  margin-bottom: 10px !important;
  background: #900;
  color: #fff;
  border-radius: 5px;
  font-size: 1.0rem !important;
}
</style>


  <script>
    
      
  </script>

    <script data-ad-client="ca-pub-7673322832689008" async
      src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"
      onerror="adBlockFunction();"></script>
  </head>

<body>
  <header role="banner"><hgroup>
  <h1><a href="https://www.spapas.net/">/var/</a></h1>
    <h2>Various programming stuff</h2>
</hgroup></header>
  <nav role="navigation"><ul class="subscription" data-subscription="rss">
</ul>


<ul class="main-navigation">
      <li >
        <a href="https://www.spapas.net/category/ai.html">Ai</a>
      </li>
      <li >
        <a href="https://www.spapas.net/category/android.html">Android</a>
      </li>
      <li >
        <a href="https://www.spapas.net/category/clojure.html">Clojure</a>
      </li>
      <li >
        <a href="https://www.spapas.net/category/css.html">Css</a>
      </li>
      <li >
        <a href="https://www.spapas.net/category/django.html">Django</a>
      </li>
      <li >
        <a href="https://www.spapas.net/category/elixir.html">Elixir</a>
      </li>
      <li >
        <a href="https://www.spapas.net/category/flask.html">Flask</a>
      </li>
      <li >
        <a href="https://www.spapas.net/category/gaming.html">Gaming</a>
      </li>
      <li >
        <a href="https://www.spapas.net/category/git.html">Git</a>
      </li>
      <li >
        <a href="https://www.spapas.net/category/html.html">Html</a>
      </li>
      <li >
        <a href="https://www.spapas.net/category/javascript.html">Javascript</a>
      </li>
      <li >
        <a href="https://www.spapas.net/category/networking.html">Networking</a>
      </li>
      <li >
        <a href="https://www.spapas.net/category/pelican.html">Pelican</a>
      </li>
      <li >
        <a href="https://www.spapas.net/category/postgresql.html">Postgresql</a>
      </li>
      <li >
        <a href="https://www.spapas.net/category/python.html">Python</a>
      </li>
      <li >
        <a href="https://www.spapas.net/category/spring.html">Spring</a>
      </li>
      <li >
        <a href="https://www.spapas.net/category/unix.html">Unix</a>
      </li>
      <li >
        <a href="https://www.spapas.net/category/wagtail.html">Wagtail</a>
      </li>
</ul></nav>
  <div id="main">
    <div id="content">
    <div id="gHPzseYvFrhZ123">
      Hello! If you are using an ad blocker but find something useful here 
      and want to support me please consider disabling your ad blocker for this site. 
      <br />
      <br />
      Thank you,<br />
      Serafeim
      
    </div>
<div class="blog-index">
  		<article>
<header>
      <h1 class="entry-title">
        <a href="https://www.spapas.net/2023/04/11/django-multiple-file-storages/">Multiple storages for the same FileField in Django</a>
      </h1>
    <p class="meta">
<time datetime="2023-04-11T14:20:00+03:00" pubdate>Tue 11 April 2023</time>    </p>
</header>

<div class="entry-content"><p>When you need to support user-uploaded files from Django (usually called <em>media</em>)
you will probably use a <a href="https://docs.djangoproject.com/en/4.2/topics/files/">FileField</a>
in your models. This is translated to a simple varchar (text) field in the database that
contains a unique identifier for the file. This usually would be the path to the file,
however this is not always the&nbsp;case!</p>
<p>What really happens is that Django has an underlying concept called a 
<a href="https://docs.djangoproject.com/en/4.2/topics/files/#file-storage">File Storage</a>
which is a class that has information on how to talk to the actual storage backend,
and particularly how to translate the unique identifier stored on the db to an actual file object. 
By default
Django stores files in the file system using the 
<a href="https://docs.djangoproject.com/en/4.2/ref/files/storage/#django.core.files.storage.FileSystemStorage">FileSystemStorage</a> 
however it is possible to use different backends through an add-on 
(for example <a href="https://django-storages.readthedocs.io/en/latest/backends/amazon-S3.html">Amazon S3</a>)
or even write your&nbsp;own.</p>
<p>Each FileField can be configured to use a different storage backend by passing the <code>storage</code> parameter;
if you don&#8217;t use this parameter then the default storage backend is used. So you can easily configure a <code>FileField</code>
that would upload files to your filesystem and another one that would upload files to&nbsp;S3.</p>
<p>However, one thing that is not
supported though is to use multiple storages for <em>the same</em> FileField depending on some parameter of the model instance.
Unfortunately, in a recent project I had to do exactly that: We had a <code>FileField</code> on a model that contained 
hundreds of GBs of files stored on the filesystem; we wanted to be able to upload the files of new
instances of that model on S3 but also wanted to keep the old files on the filesystem to avoid moving all these
to S3 (which would result to a lot of downtime). I also wanted a way to be &#8220;flexible&#8221; on this i.e to be able 
to change again the storage backend for some instances if needed and definitely not move/copy all these&nbsp;files!</p>
<p>If you take a peek
at the FileField options you&#8217;ll see that there&#8217;s a <code>storage</code> parameter that can be a 
<a href="https://docs.djangoproject.com/en/4.2/topics/files/#using-a-callable">callable</a>. However this
callable is initialized with the models and is not evaluated again until the app is restarted so it can&#8217;t be used
to decide on the storage for each model&nbsp;instance. </p>
<p>The only thing that is evaluated each time a file is uploaded through the FileField is when <code>upload_to</code> 
is a function. This function receives the model instance and returns the path that the file will be uploaded&nbsp;to.</p>
<p>The idea is to use this <code>upload_to</code> function to return a different path depending on the model instance
and then use a custom storage backend that will use the path to decide on the actual storage backend to&nbsp;use.</p>
<p>This is the code I ended up with for the <code>upload_to</code> function:</p>
<div class="highlight"><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">file_upload_path</span><span class="p">(</span><span class="n">instance</span><span class="p">,</span> <span class="n">filename</span><span class="p">):</span>
    <span class="n">dt_str</span> <span class="o">=</span> <span class="n">app</span><span class="o">.</span><span class="n">created_on</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s2">&quot;%Y/%m/</span><span class="si">%d</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="n">file_storage</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>

    <span class="k">if</span> <span class="n">instance</span><span class="o">.</span><span class="n">id</span> <span class="o">&gt;=</span> <span class="n">settings</span><span class="o">.</span><span class="n">STORAGE_CHANGE_ID</span><span class="p">:</span> 
        <span class="n">file_storage</span> <span class="o">=</span> <span class="n">settings</span><span class="o">.</span><span class="n">STORAGE_SELECTION_STR</span> <span class="o">+</span> <span class="s2">&quot;/&quot;</span>

    <span class="k">return</span> <span class="s2">&quot;protected/</span><span class="si">{0}{1}</span><span class="s2">/</span><span class="si">{2}</span><span class="s2">/</span><span class="si">{3}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">file_storage</span><span class="p">,</span> <span class="n">dt_str</span><span class="p">,</span> <span class="n">instance</span><span class="o">.</span><span class="n">id</span><span class="p">,</span> <span class="n">filename</span><span class="p">)</span>

<span class="k">class</span><span class="w"> </span><span class="nc">Model</span><span class="p">(</span><span class="n">models</span><span class="o">.</span><span class="n">Model</span><span class="p">):</span>
    <span class="n">file</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">FileField</span><span class="p">(</span><span class="n">upload_to</span><span class="o">=</span><span class="n">file_upload_path</span><span class="p">)</span>
</code></pre></div>

<p>What happens here is that I have a setting <code>STORAGE_CHANGE_ID</code> that is the <code>id</code> of the instance
after which all instances will use the different storage backend. You can use whatever method
you want here to decide on the storage that would be used; the only thing to keep in mind is to 
put the storage <em>somewhere on the returned path</em>.</p>
<p>I also have a setting
<code>STORAGE_SELECTION_STR</code> that is the string that will be used in the path to differentiate the storage backend.
The <code>STORAGE_SELECTION_STR</code> has the value of <code>minios3</code> for this&nbsp;project.</p>
<p>Using this function the paths of the instances that are &gt;= <code>STORAGE_CHANGE_ID</code> will be of the form <code>protected/minios3/2021/04/11/1234/filename.ext</code> while for the old files these will be of the form <code>protected/2021/04/11/1234/filename.ext</code>. Notice the <code>minios3</code> string in&nbsp;between. </p>
<p>Of course this is not enough. We also need to tell Django to use the different storage backend for the new files. In order 
to do this we have to implement a <a href="https://docs.djangoproject.com/en/4.2/howto/custom-file-storage/">custom storage class</a> like&nbsp;this:</p>
<div class="highlight"><pre><span></span><code><span class="kn">from</span><span class="w"> </span><span class="nn">django.core.files.storage</span><span class="w"> </span><span class="kn">import</span> <span class="n">FileSystemStorage</span><span class="p">,</span> <span class="n">Storage</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">storages.backends.s3boto3</span><span class="w"> </span><span class="kn">import</span> <span class="n">S3Boto3Storage</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">django.conf</span><span class="w"> </span><span class="kn">import</span> <span class="n">settings</span>


<span class="k">class</span><span class="w"> </span><span class="nc">FilenameBasedStorage</span><span class="p">(</span><span class="n">Storage</span><span class="p">):</span>
    <span class="n">minio_choice</span> <span class="o">=</span> <span class="n">settings</span><span class="o">.</span><span class="n">STORAGE_SELECTION_STR</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_open</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s2">&quot;rb&quot;</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">minio_choice</span> <span class="ow">in</span> <span class="n">name</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">S3Boto3Storage</span><span class="p">()</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">mode</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">FileSystemStorage</span><span class="p">()</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">mode</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_save</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">content</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">minio_choice</span> <span class="ow">in</span> <span class="n">name</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">S3Boto3Storage</span><span class="p">()</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">content</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">FileSystemStorage</span><span class="p">()</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">content</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">delete</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">minio_choice</span> <span class="ow">in</span> <span class="n">name</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">S3Boto3Storage</span><span class="p">()</span><span class="o">.</span><span class="n">delete</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">FileSystemStorage</span><span class="p">()</span><span class="o">.</span><span class="n">delete</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">exists</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">minio_choice</span> <span class="ow">in</span> <span class="n">name</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">S3Boto3Storage</span><span class="p">()</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">FileSystemStorage</span><span class="p">()</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">size</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">minio_choice</span> <span class="ow">in</span> <span class="n">name</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">S3Boto3Storage</span><span class="p">()</span><span class="o">.</span><span class="n">size</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">FileSystemStorage</span><span class="p">()</span><span class="o">.</span><span class="n">size</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">url</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">minio_choice</span> <span class="ow">in</span> <span class="n">name</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">S3Boto3Storage</span><span class="p">()</span><span class="o">.</span><span class="n">url</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">FileSystemStorage</span><span class="p">()</span><span class="o">.</span><span class="n">url</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">path</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">minio_choice</span> <span class="ow">in</span> <span class="n">name</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">S3Boto3Storage</span><span class="p">()</span><span class="o">.</span><span class="n">path</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">FileSystemStorage</span><span class="p">()</span><span class="o">.</span><span class="n">path</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>
</code></pre></div>

<p>This class should be self explainable: It uses the <code>settings.STORAGE_SELECTION_STR</code>
we mentioned above to decide which storage backend to use and then it forwards each
method to the corresponding backend (either the filesystem storage or the S3&nbsp;storage).</p>
<p>One thing to notice is that the <code>django.core.files.storage.Storage</code> class this class
inherits from has more methods that can be implemented (and would raise if called without implementing them)
however this implementation works fine for my&nbsp;needs.</p>
<p>One question some readers may have is what happens if the user uploads a file named <code>test-minios3.pdf</code> (i.e a file containing the 
<code>STORAGE_SELECTION_STR</code>). Well you may just as well ignore it; it will just be saved always on the minio-s3
storage backend. Or you can make sure to <em>remove</em> that string from the filename before saving it on the <code>file_upload_path</code>.
I chose to ignore it since it doesn&#8217;t matter for my use&nbsp;case.</p>
<p>Finally, we need to tell Django to use this storage class for the <code>file</code> field. We can do this by
adding it to the <code>FileField</code> like:</p>
<div class="highlight"><pre><span></span><code><span class="n">file</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">FileField</span><span class="p">(</span><span class="n">upload_to</span><span class="o">=</span><span class="n">file_upload_path</span><span class="p">,</span> <span class="n">storage</span><span class="o">=</span><span class="n">FilenameBasedStorage</span><span class="p">)</span>
</code></pre></div>

<p>or we can configure it on the <code>DEFAULT_FILE_STORAGE</code> setting 
(<a href="https://docs.djangoproject.com/en/4.2/ref/settings/#default-file-storage">for Django &lt; 4.2</a>) 
or on the 
<code>STORAGES</code> dict (<a href="https://docs.djangoproject.com/en/4.2/ref/settings/#std-setting-STORAGES">for Django &gt;= 4.2</a>).</p>
<p>I hope this helps someone else that needs to do something&nbsp;similar!</p></div>
  		</article>
  		<article>
<header>
      <h1 class="entry-title">
        <a href="https://www.spapas.net/2023/04/04/using-unpoly-with-django/">Using Unpoly with Django</a>
      </h1>
    <p class="meta">
<time datetime="2023-04-04T10:20:00+03:00" pubdate>Tue 04 April 2023</time>    </p>
</header>

<div class="entry-content"><div class="toc"><span class="toctitle">Table of contents:</span><ul>
<li><a href="#the-unpoly-demo">The unpoly&nbsp;demo</a></li>
<li><a href="#integrating-unpoly-with-django">Integrating unpoly with&nbsp;Django</a></li>
<li><a href="#unpoly-configuration">Unpoly&nbsp;configuration</a></li>
<li><a href="#navigation-improvements">Navigation improvements</a><ul>
<li><a href="#using-the-up-main">Using the&nbsp;up-main</a></li>
<li><a href="#make-all-links-followable">Make all links&nbsp;followable</a></li>
<li><a href="#navigation-feedback">Navigation&nbsp;feedback</a></li>
<li><a href="#aliases-for-navigation-feedback">Aliases for navigation&nbsp;feedback</a></li>
</ul>
</li>
<li><a href="#handling-forms">Handling forms</a><ul>
<li><a href="#integrating-with-messages">Integrating with&nbsp;messages</a></li>
<li><a href="#immediate-form-validation">Immediate form&nbsp;validation</a></li>
<li><a href="#other-form-helpers">Other form&nbsp;helpers</a></li>
</ul>
</li>
<li><a href="#understanding-layers">Understanding layers</a><ul>
<li><a href="#static-overlay-content">Static overlay&nbsp;content</a></li>
<li><a href="#advanced-layersoverlays">Advanced&nbsp;layers/overlays</a></li>
<li><a href="#opening-new-layers-over-existing-ones">Opening new layers over existing&nbsp;ones</a></li>
<li><a href="#closing-overlays">Closing overlays</a><ul>
<li><a href="#closing-the-overlay-when-visiting-a-link">Closing the overlay when visiting a&nbsp;link</a></li>
<li><a href="#handling-hardcoded-urls">Handling hardcoded&nbsp;urls</a></li>
<li><a href="#explicitly-closing-the-layer">Explicitly closing the&nbsp;layer</a></li>
<li><a href="#closing-the-layer-by-emitting-an-unpoly-event">Closing the layer by emitting an unpoly&nbsp;event</a></li>
</ul>
</li>
<li><a href="#doing-stuff-when-a-layer-is-closed">Doing stuff when a layer is&nbsp;closed</a></li>
<li><a href="#overlays-and-messages">Overlays and messages</a><ul>
<li><a href="#improving-delete">Improving&nbsp;delete</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#improving-interaction-with-django-packages">Improving interaction with Django&nbsp;packages</a></li>
<li><a href="#advanced-concepts">Advanced concepts</a><ul>
<li><a href="#more-about-upcompiler">More about&nbsp;up.compiler</a></li>
<li><a href="#passing-context-from-unpoly-to-server">Passing context from unpoly to&nbsp;server</a></li>
<li><a href="#listening-to-unpoly-events">Listening to unpoly&nbsp;events</a></li>
<li><a href="#updating-history">Updating&nbsp;history</a></li>
<li><a href="#troubleshooting">Troubleshooting</a></li>
</ul>
</li>
<li><a href="#conclusion">Conclusion</a></li>
</ul>
</div>
<p>Over the past few years, there has been a surge in the popularity of frontend frameworks, such as React and Vue. While there are certainly valid use cases for these frameworks, I believe that they are often unnecessary, as most web applications can be adequately served by traditional request/response web pages without any frontend framework. The high usage of these frameworks is largely driven by <span class="caps">FOMO</span> and lack of knowledge about alternatives. However, using such frameworks can add unnecessary complexity to your project, as you now have to develop two projects in parallel (the frontend and the backend) and maintain two separate&nbsp;codebases.</p>
<p>That being said, I understand that some projects may require extra <span class="caps">UX</span> enhancements such as modals, navigation and form submissions without full page reloads, immediate form validation feedback, page fragment updates etc. If you want some of this functionality but do not want to hop on the <span class="caps">JS</span> framework train, you can use the
<a href="https://unpoly.com/">Unpoly</a>&nbsp;library. </p>
<p>Unpoly is similar to other libraries like intercooler, htmx or turbo however I find it to be the easiest to be used in the kind of projects I work on. These libraries allow you to write dynamic web applications with minimal changes to your existing server-side&nbsp;code. </p>
<p>In this guide, we&#8217;ll go over how to use Unpoly with Django. Specifically, we&#8217;ll cover the following&nbsp;topics:</p>
<ul>
<li>An unpoly&nbsp;demo</li>
<li>Integrating unpoly with&nbsp;Django</li>
<li>Navigation&nbsp;improvements</li>
<li>Form&nbsp;improvements</li>
<li>Modal improvements&nbsp;(layers)</li>
<li>Integration with (some) django&nbsp;packages</li>
<li>More advanced&nbsp;concepts</li>
</ul>
<h2 id="the-unpoly-demo">The unpoly&nbsp;demo</h2>
<p>Unpoly provides a <a href="https://demo.unpoly.com/">demo application</a> written in Ruby. You can go on and play with it for a bit to understand what it offers compared to a traditional web&nbsp;app.</p>
<p>I&#8217;ve re-implemented this in Django
so you can compare the code with a non-unpoly Django app. It can be found on  https://github.com/spapas/django-unpoly-demo
and the actual demo in Django is at: https://unpoly-demo.spapas.net or https://unpoly-demo.fly.dev/ (deployed on fly.io)
or https://unpoly-demo.onrender.com/ (deployed on render.com; notice the free tier of render.com is very slow, this isn&#8217;t
related to the app). The demo app uses an ephemeral database so the data may be deleted at any&nbsp;time.</p>
<p>Try navigating the demo site and you&#8217;ll see things&nbsp;like:</p>
<ul>
<li>Navigation&nbsp;feedback</li>
<li>Navigation without page&nbsp;reloads</li>
<li>Forms opening in&nbsp;modals</li>
<li>Modals over&nbsp;modals</li>
<li>Form submissions without page&nbsp;reloads</li>
<li>Form validation feedback without page&nbsp;reloads</li>
</ul>
<p>All this is implemented mostly with traditional Django class based views and templates in addition to a few unpoly&nbsp;attributes.</p>
<p>To understand how much of a difference this makes, after you have taken a peek at the &#8220;companies&#8221; functionality in the demo, take 
a look at the actual code that implementation (I&#8217;m only pasting the views, the other components are exactly the same as in a normal Django&nbsp;app):</p>
<div class="highlight"><pre><span></span><code><span class="k">class</span><span class="w"> </span><span class="nc">FormMixin</span><span class="p">:</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">form_valid</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">form</span><span class="p">):</span>

        <span class="k">if</span> <span class="n">form</span><span class="o">.</span><span class="n">is_valid</span><span class="p">()</span> <span class="ow">and</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">up</span><span class="o">.</span><span class="n">validate</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s2">&quot;success_message&quot;</span><span class="p">):</span>
                <span class="n">messages</span><span class="o">.</span><span class="n">success</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">success_message</span><span class="p">)</span>
            <span class="k">return</span> <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">form_valid</span><span class="p">(</span><span class="n">form</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">render_to_response</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">get_context_data</span><span class="p">(</span><span class="n">form</span><span class="o">=</span><span class="n">form</span><span class="p">))</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">get_initial</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">initial</span> <span class="o">=</span> <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">get_initial</span><span class="p">()</span>

        <span class="n">initial</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">GET</span><span class="o">.</span><span class="n">dict</span><span class="p">())</span>
        <span class="k">return</span> <span class="n">initial</span>


<span class="k">class</span><span class="w"> </span><span class="nc">CompanyListView</span><span class="p">(</span><span class="n">ListView</span><span class="p">):</span>
    <span class="n">model</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">Company</span>


<span class="k">class</span><span class="w"> </span><span class="nc">CompanyDetailView</span><span class="p">(</span><span class="n">DetailView</span><span class="p">):</span>
    <span class="n">model</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">Company</span>


<span class="k">class</span><span class="w"> </span><span class="nc">CompanyCreateView</span><span class="p">(</span><span class="n">FormMixin</span><span class="p">,</span> <span class="n">CreateView</span><span class="p">):</span>
    <span class="n">success_message</span> <span class="o">=</span> <span class="s2">&quot;Company created successfully&quot;</span>
    <span class="n">model</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">Company</span>
    <span class="n">fields</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;name&quot;</span><span class="p">,</span> <span class="s2">&quot;address&quot;</span><span class="p">]</span>


<span class="k">class</span><span class="w"> </span><span class="nc">CompanyUpdateView</span><span class="p">(</span><span class="n">FormMixin</span><span class="p">,</span> <span class="n">UpdateView</span><span class="p">):</span>
    <span class="n">model</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">Company</span>
    <span class="n">success_message</span> <span class="o">=</span> <span class="s2">&quot;Company updated successfully&quot;</span>
    <span class="n">fields</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;name&quot;</span><span class="p">,</span> <span class="s2">&quot;address&quot;</span><span class="p">]</span>


<span class="k">class</span><span class="w"> </span><span class="nc">CompanyDeleteView</span><span class="p">(</span><span class="n">DeleteView</span><span class="p">):</span>
    <span class="n">model</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">Company</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">get_success_url</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">reverse</span><span class="p">(</span><span class="s2">&quot;company-list&quot;</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">form_valid</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">form</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">up</span><span class="o">.</span><span class="n">layer</span><span class="o">.</span><span class="n">emit</span><span class="p">(</span><span class="s2">&quot;company:destroyed&quot;</span><span class="p">,</span> <span class="p">{})</span>
        <span class="n">messages</span><span class="o">.</span><span class="n">success</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="p">,</span> <span class="s2">&quot;Company deleted successfully&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">form_valid</span><span class="p">(</span><span class="n">form</span><span class="p">)</span>
</code></pre></div>

<p>Experienced Django developers will immediately recognize that the above code has only two small diferences 
from what a traditional Django app would&nbsp;have:</p>
<ul>
<li>the check for <code>self.request.up.validate</code> on the <code>form_valid</code> of the <code>FormMixin</code></li>
<li>the <code>self.request.up.layer.emit</code> on the <code>DeleteView</code> <code>form_valid</code></li>
</ul>
<p>We&#8217;ll explain these later. However the thing to keep is that this is the same as a good-old Django app,
without the need to implement special functionality like checks for ajax views, fragments, special form handling&nbsp;etc.</p>
<h2 id="integrating-unpoly-with-django">Integrating unpoly with&nbsp;Django</h2>
<p>To integrate unpoly with Django you only need to include the unpoly JavaScript and <span class="caps">CSS</span> library to your project. This is a normal .js file
that you can retrieve from the <a href="https://unpoly.com/install">unpoly install page</a>. Also, if you are using Bootstrap 3,4 or 5 I recommend to also download the corresponding unpoly-bootstrapX.js&nbsp;file.</p>
<p>Unpoly communicates with your backend through custom X-<span class="caps">HTTP</span>-<span class="caps">UP</span> headers. You could use the headers directly however it is also possible to install the <a href="https://gitlab.com/rocketduck/python-unpoly">python-unpoly</a>
library to make things easier. After installing that library you&#8217;ll add the <code>unpoly.contrib.django.UnpolyMiddleware</code> in your <code>MIDDLEWARE</code> list resulting in an extra <code>up</code> attribute to your request. You can then use this <code>up</code> attribute through the <a href="https://unpoly.readthedocs.io/en/latest/usage.html"><span class="caps">API</span></a> for easier access to the unpoly&nbsp;headers.</p>
<p>To access <code>up</code> through your Django templates you can use <code>request.up</code> or add it to the default context using a context processor so you can access it&nbsp;directly.</p>
<p>To make sure that everything works, add the <code>up-follow</code> to one of your links, i.e change <code>&lt;a href='linkto'&gt;link&lt;/a&gt;</code>
to <code>&lt;a up-follow href='linkto'&gt;link&lt;/a&gt;</code>. When you click on this link you should observe that instead of a full-page reload
you&#8217;ll get the response immediately! What really happens is that unpoly will make an <span class="caps">AJAX</span> request to the server, retrieve the response and render it on the current page making the response seem much&nbsp;faster! </p>
<h2 id="unpoly-configuration">Unpoly&nbsp;configuration</h2>
<p>The main way to use unpoly is to add <code>up-x</code> attributes to your html elements to enable unpoly behavior. However it is possible to use the unpoly js <span class="caps">API</span> (<code>window.up</code> or <code>up</code>) to set some global configuration. For example, you can use <code>up.log.enable()</code> and <code>up.log.disable()</code> to enable/disable the unpoly logging to your console. I recommend enabling it for your development environment because it will help you debug when things don&#8217;t seem to be&nbsp;working. </p>
<p>To use <code>up</code> to configure unpoly you only need to add it on a <code>&lt;script&gt;</code> element after loading the unpoly library, for&nbsp;example:</p>
<div class="highlight"><pre><span></span><code><span class="p">&lt;</span><span class="nt">script</span> <span class="na">src</span><span class="o">=</span><span class="s">&quot;{% static &#39;unpoly/unpoly.min.js&#39; %}&quot;</span><span class="p">&gt;&lt;/</span><span class="nt">script</span><span class="p">&gt;</span>
<span class="p">&lt;</span><span class="nt">script</span> <span class="na">src</span><span class="o">=</span><span class="s">&quot;{% static &#39;unpoly/unpoly-bootstrap4.min.js&#39; %}&quot;</span><span class="p">&gt;&lt;/</span><span class="nt">script</span><span class="p">&gt;</span>
<span class="p">&lt;</span><span class="nt">script</span> <span class="na">src</span><span class="o">=</span><span class="s">&quot;{% static &#39;application.js&#39; %}&quot;</span><span class="p">&gt;&lt;/</span><span class="nt">script</span><span class="p">&gt;</span>
</code></pre></div>

<p>And in <code>application.js</code> you can use <code>up</code> directly, for example to enable&nbsp;logging:</p>
<div class="highlight"><pre><span></span><code><span class="w">  </span><span class="nx">up</span><span class="p">.</span><span class="nx">log</span><span class="p">.</span><span class="nx">enable</span><span class="p">()</span>
</code></pre></div>

<p>We&#8217;ll see more <code>up</code> configuration directives later, however keep in mind that for a lot of <code>up-x</code> attributes it is possible to use the config to automatically add that attribute to multiple elements using a&nbsp;selector.</p>
<h2 id="navigation-improvements">Navigation&nbsp;improvements</h2>
<p>Using the <code>up-follow</code> directive you can start adding <code>up-follow</code> to all your links and you&#8217;ll get a much more responsive application. This is very simple and&nbsp;easy.</p>
<p>One interesting thing is that we didn&#8217;t need to change <em>anything</em> on the backend. The whole response will be retrieved by unpoly and 
will <em>replace</em> the <code>body</code> of the current page. Actually, it is possible to instruct unpoly to replace only a specific part of the page
using a css selector (i.e replace only the <code>#content</code> div). To do this you can add the <code>up-target</code> attribute to the link, i.e <code>&lt;a up-target='#content' up-follow href='linkto'&gt;link&lt;/a&gt;</code>. When unpoly retrieves the response, it will make sure that it has an <code>#content</code> 
element and put its contents to the original page <code>#content</code> element.</p>
<p>This technique is called <code>linking to fragments</code> in the unpoly docs. To see this in action, try going to the tasks in the demo and add a couple of new task. Then try to edit a that task. You&#8217;ll notice that the edit form of the task will <em>replace</em> the task show card! To do that, unpoly loads the edit task form and matches the <code>.task</code> element there with the <em>current</em> <code>.task</code> element and does the replacement (see <a href="https://unpoly.com/fragment-placement#interaction-origin-is-considered">here</a> for rules on how this&nbsp;works). </p>
<p>Beyond the <code>up-follow</code>, you can also use two more directives to further improve the&nbsp;navigation: </p>
<ul>
<li><code>up-instant</code> to follow the link on mousedown (without waiting for the user releasing the mouse&nbsp;button)</li>
<li><code>up-preload</code> to follow the link when the mouse hovers over the&nbsp;link</li>
</ul>
<h3 id="using-the-up-main">Using the&nbsp;up-main</h3>
<p>To make things simpler, you can declare an element to be the default replacement target. This is done by adding the <code>up-main</code> attribute to an element. This way, all <code>up-follow</code> links will replace that particular element by default unless they have an <code>up-target</code> element&nbsp;themselves.</p>
<p>What I usually do is that I&#8217;ve got a <code>base.html</code> template looking something like&nbsp;this:</p>
<div class="highlight"><pre><span></span><code>    {% include &quot;partials/_nav.html&quot; %}
    <span class="p">&lt;</span><span class="nt">div</span> <span class="na">up-main</span> <span class="na">class</span><span class="o">=</span><span class="s">&quot;container&quot;</span><span class="p">&gt;</span>
      {% include &quot;partials/_messages.html&quot; %}
      {% block content %}
      {% endblock %}
    <span class="p">&lt;/</span><span class="nt">div</span><span class="p">&gt;</span>
    {% include &quot;partials/_footer.html&quot; %}
</code></pre></div>

<p>See the <code>up-main</code> on the <code>.container</code>? This way, all my <code>up-follow</code> links will replace the contents of the <code>.container</code> element by default. If I wanted to replace a specific part of the page, I could add the <code>up-target</code> attribute to the&nbsp;link.</p>
<p>If there&#8217;s no <code>up-main</code> element, unpoly will replace the whole <code>body</code> element.</p>
<h3 id="make-all-links-followable">Make all links&nbsp;followable</h3>
<p>It is possible to make all links (or links that follow a selector) <a href="https://unpoly.com/handling-everything#following-all-links">followable by default</a> by using the <code>up.link.config.followSelectors</code> option. 
I would recommend to only do this on greenfield projects where you&#8217;ll test the functionality anyway. For existing projects I think it&#8217;s better to add the <code>up-follow</code> attribute explicitly to the links you want to make&nbsp;followable.</p>
<p>This is recommend it because there are cases where using unpoly will break some pages, especially if you have some JavaScript code that relies on the page being loaded. We&#8217;ll talk about this in the up.compiler&nbsp;section.</p>
<p>If you have made all the links followable but you want to skip some links and do a full page reload instead, add the <code>up-follow=false</code> attribute to the link or use the <code>up.link.config.noFollowSelectors</code> config to make multiple links&nbsp;non-followable.</p>
<p>You can also make all links instant or preload for example by using <code>up.link.config.instantSelectors.push('a[href]')</code> to make all followable links load on mousedown. This should be safe because it will only work on links that are <a href="https://unpoly.com/handling-everything#following-all-links-on-mousedown">already followable</a>. </p>
<h3 id="navigation-feedback">Navigation&nbsp;feedback</h3>
<p>One very useful feature of unpoly is that it adds more or less <em>free</em> <a href="https://unpoly.com/up.feedback">navigation feedback</a>. This can be enabled by adding an <code>[up-nav]</code> element to the navigation section of your page. Unpoly then will add an <code>up-current</code> class to the links in that section that match the current <span class="caps">URL</span>. This works no matter if you are using <code>up-follow</code> or not. You can then style <code>.up-current</code> links as you&nbsp;want.</p>
<p>If you are using Bootstrap along with the unpoly-bootstrap integrations you&#8217;ll get all that without any extra work! The unpoly-bootstrap has the following&nbsp;configuration:</p>
<div class="highlight"><pre><span></span><code><span class="nx">up</span><span class="p">.</span><span class="nx">feedback</span><span class="p">.</span><span class="nx">config</span><span class="p">.</span><span class="nx">currentClasses</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="s1">&#39;active&#39;</span><span class="p">);</span>
<span class="nx">up</span><span class="p">.</span><span class="nx">feedback</span><span class="p">.</span><span class="nx">config</span><span class="p">.</span><span class="nx">navSelectors</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="s1">&#39;.nav&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;.navbar&#39;</span><span class="p">);</span>
</code></pre></div>

<p>So it will automatically add the <code>up-nav</code> element on <code>.nav</code> and <code>.navbar</code> elements and will add the <code>active</code> class to the current link (in addition to the <code>.up-current</code> class). This is what happens in the demo, if you take a peek you&#8217;ll see that there are no <code>up-nav</code> elements (since these are marked by the unpoly-bootstrap integration) in the navigation bar and we style the <code>.active</code> nav&nbsp;links.</p>
<h3 id="aliases-for-navigation-feedback">Aliases for navigation&nbsp;feedback</h3>
<p>Unpoly also allows you to add aliases for the navigation feedback. For example, you may have <code>/companies/</code> and <code>/companies/new</code> and you want the <code>companies</code> nav link to be active on both of them. To allow that you need to use the <code>up-alias</code> attribute on the link&nbsp;like </p>
<div class="highlight"><pre><span></span><code><span class="p">&lt;</span><span class="nt">a</span> <span class="na">class</span><span class="o">=</span><span class="s">&#39;nav-item nav-link&#39;</span> <span class="na">up-follow</span> <span class="na">href</span><span class="o">=</span><span class="s">&#39;{% url &quot;company-list&quot; %}&#39;</span> <span class="na">up-alias</span><span class="o">=</span><span class="s">&#39;{% url &quot;company-list&quot; %}new/&#39;</span><span class="p">&gt;</span>Companies<span class="p">&lt;/</span><span class="nt">a</span><span class="p">&gt;</span>
</code></pre></div>

<p>(notice that in my case the url of <code>company-list</code> is <code>/companies/</code> that&#8217;s why I added <code>{% url "company-list" %}new/</code> on the alias so the resulting alias path would be <code>/companies/new/</code>), or even add multiple links to the&nbsp;alias</p>
<div class="highlight"><pre><span></span><code><span class="p">&lt;</span><span class="nt">a</span> <span class="na">class</span><span class="o">=</span><span class="s">&#39;nav-item nav-link&#39;</span> <span class="na">up-follow</span> <span class="na">href</span><span class="o">=</span><span class="s">&#39;{% url &quot;company-list&quot; %}&#39;</span> <span class="na">up-alias</span><span class="o">=</span><span class="s">&#39;{% url &quot;company-list&quot; %}*&#39;</span><span class="p">&gt;</span>Companies<span class="p">&lt;/</span><span class="nt">a</span><span class="p">&gt;</span>
</code></pre></div>

<p>This will add the <code>up-current</code> class to the <code>a</code> element whenever the url starts with <code>/companies/</code> (i.e <code>/companies/</code>, <code>/companies/new</code>, <code>/companies/1/edit</code> etc).</p>
<p>Please notice that it is recommended to have a proper url hierarchy for this to work better. For example, if you have <code>/companies_list/</code> and <code>/add_new_company/</code> you&#8217;ll need to add the aliases like <code>up-alias='/companies_list/ /add_new_company/'</code> (notice the space between the urls to add two aliases). Also, if you want to also handle <span class="caps">URLS</span> with query parameters i.e <code>/companies/?name=foo</code> then you&#8217;ll need to add <code>?*</code> i.e <code>/companies/?*</code>. These urls aren&#8217;t aliased by default so <code>/companies/</code> doesn&#8217;t match <code>/companies/?name=foo</code> unless you add an&nbsp;alias.</p>
<p>One final remark is that it is possible to do some trickery to automatically add up-alias to all your nav links. This is useful in case you have many nav elements and you don&#8217;t want to add aliases to each one of them, for example, using this&nbsp;code:</p>
<div class="highlight"><pre><span></span><code><span class="w">  </span><span class="nx">up</span><span class="p">.</span><span class="nx">compiler</span><span class="p">(</span><span class="s1">&#39;nav a[href]&#39;</span><span class="p">,</span><span class="w"> </span><span class="p">(</span><span class="nx">link</span><span class="p">)</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="nx">link</span><span class="p">.</span><span class="nx">href</span><span class="p">.</span><span class="nx">endsWith</span><span class="p">(</span><span class="s1">&#39;#&#39;</span><span class="p">))</span><span class="w"> </span><span class="nx">link</span><span class="p">.</span><span class="nx">setAttribute</span><span class="p">(</span><span class="s1">&#39;up-alias&#39;</span><span class="p">,</span><span class="w"> </span><span class="nx">link</span><span class="p">.</span><span class="nx">href</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="s1">&#39;*&#39;</span><span class="p">)</span>
<span class="w">  </span><span class="p">})</span>
</code></pre></div>

<p>an <code>up-alias</code> attribute will be added to all links. The callback of the compiler will be called when the selector is matched and
in this case add the <code>up-alias</code> attribute to the link. We&#8217;ll talk later about compilers&nbsp;more.</p>
<h2 id="handling-forms">Handling&nbsp;forms</h2>
<p>Unpoly can also be used to handle forms without page reloads, similar to following links. This is simple to do by adding an <code>up-submit</code> attribute to your form. Also similar to links you can make <a href="https://unpoly.com/handling-everything#handling-all-forms">all your forms handled by unpoly</a> but I recommend to be cautious before doing this on existing projects to make sure that stuff doesn&#8217;t&nbsp;break.</p>
<p>When you add an <code>up-submit</code> to a form unpoly will do an <span class="caps">AJAX</span> post to submit the form and replace the contents of the <code>up-target</code> element with the response (if you don&#8217;t specify an <code>up-target</code> element, it will use the <code>up-main</code> element in a similar way as links). This works fine with the default Django behavior, i.e when the form is valid Django will do a redirect to the success url, unpoly will follow that link and render the response of the&nbsp;redirect.</p>
<h3 id="integrating-with-messages">Integrating with&nbsp;messages</h3>
<p>Django has the <a href="https://docs.djangoproject.com/en/stable/ref/contrib/messages/">messages framework</a> that can be used to add one-time flash messages
after a form is successfully submitted. You need to make sure that these messages are actually rendered! For example, in the <code>base.htm</code> template I mentioned before, we&#8217;ve got the&nbsp;following:</p>
<div class="highlight"><pre><span></span><code>    {% include &quot;partials/_nav.html&quot; %}
    <span class="p">&lt;</span><span class="nt">div</span> <span class="na">up-main</span> <span class="na">class</span><span class="o">=</span><span class="s">&quot;container&quot;</span><span class="p">&gt;</span>
      {% include &quot;partials/_messages.html&quot; %}
      {% block content %}
      {% endblock %}
    <span class="p">&lt;/</span><span class="nt">div</span><span class="p">&gt;</span>
    {% include &quot;partials/_footer.html&quot; %}
</code></pre></div>

<p>please notice that we&#8217;ve got the <code>partials/_messages.html</code> template included in the <code>up-main</code> element (<em>inside</em> the container). This means that when unpoly replaces the contents of the <code>up-main</code> element with the response of the form submission, the messages will be rendered as well. So it will work fine in this&nbsp;case. </p>
<p>However, if you are using <code>up-target</code> to render only particular parts of the page the flash messages will be actually lost! This happens because unpoly will load the page with the flash messages normally, so these messages will be consumed; then it will match the <code>.target</code> and display <em>only</em> that part of the&nbsp;response.</p>
<p>To resolve that you can use the <code>up-hungry</code> attribute on your messages. For example, in the <code>partials/_messages.html</code> template we&#8217;ve got the&nbsp;following:</p>
<div class="highlight"><pre><span></span><code><span class="p">&lt;</span><span class="nt">div</span> <span class="na">id</span><span class="o">=</span><span class="s">&#39;flash-messages&#39;</span> <span class="na">class</span><span class="o">=</span><span class="s">&quot;flash-messages&quot;</span> <span class="na">up-hungry</span><span class="p">&gt;</span>
    {% for message in messages %}
        <span class="p">&lt;</span><span class="nt">div</span> <span class="na">class</span><span class="o">=</span><span class="s">&quot;alert fade show {% if message.tags %} alert-{% if &#39;error&#39; in message.tags %}danger{% else %}{{ message.tags }}{% endif %}{% endif %}&quot;</span><span class="p">&gt;</span>
            {{ message }}
        <span class="p">&lt;/</span><span class="nt">div</span><span class="p">&gt;</span>
    {% endfor %}
<span class="p">&lt;/</span><span class="nt">div</span><span class="p">&gt;</span>
</code></pre></div>

<p>The <code>up-hungry</code> attribute will make unpoly refresh that particular part of the page on every page load <a href="https://unpoly.com/up-hungry">even if it&#8217;s not on the target</a>. For example notice how the message is displayed when you edit or mark as done an existing task in the&nbsp;demo. </p>
<p>However also notice that no messages are displayed if you create a new task! This happens because the actual response is &#8220;eaten&#8221; by the layer and the messages are discarded! We&#8217;ll see how to fix that&nbsp;later.</p>
<h3 id="immediate-form-validation">Immediate form&nbsp;validation</h3>
<p>Another area in which unpoly helps with our forms is that if we add the <code>up-validate</code> attribute to our form, unpoly will do an <span class="caps">AJAX</span> post to the server whenever the input focus changes and will display the errors in the form without reloading the page. For this we need a little modification to our views to check if the unpoly wants to validate the form. I&#8217;m using the following <code>form_valid</code> on a form&nbsp;mixin:</p>
<div class="highlight"><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">form_valid</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">form</span><span class="p">):</span>

    <span class="k">if</span> <span class="n">form</span><span class="o">.</span><span class="n">is_valid</span><span class="p">()</span> <span class="ow">and</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">up</span><span class="o">.</span><span class="n">validate</span><span class="p">:</span>
        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s2">&quot;success_message&quot;</span><span class="p">):</span>
            <span class="n">messages</span><span class="o">.</span><span class="n">success</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">success_message</span><span class="p">)</span>
        <span class="k">return</span> <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">form_valid</span><span class="p">(</span><span class="n">form</span><span class="p">)</span>
    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">render_to_response</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">get_context_data</span><span class="p">(</span><span class="n">form</span><span class="o">=</span><span class="n">form</span><span class="p">))</span>
</code></pre></div>

<p>So if the form is not valid or we get an unpoly validate request from unpoly we&#8217;ll render the response - this will render the form with or without errors. However if the form is actually valid and this is not an unpoly validate request we&#8217;ll do the usual form save and redirect to the success url. This is enough to handle all cases and is very simple and straightforward. It works fine without unpoly as well since the <code>up.validate</code> will be always <code>False</code> in this&nbsp;case.</p>
<p>One thing to keep in mind is that this works fine in most cases but may result to problematic behavior if you use components that rely on javascript onload events. The <code>up-validate</code> will behave more or less the same as with <code>up-follow</code> links. </p>
<h3 id="other-form-helpers">Other form&nbsp;helpers</h3>
<p>Beyond these, unpoly offers a <a href="https://unpoly.com/up.form">bunch of form helpers</a> to run callbacks or auto-submit a form when a field is changed. Most of this functionality can be replicated by other js libraries (i.e jquery) or even by vanilla.js and is geared towards the front-end so I won&#8217;t cover it more&nbsp;here.</p>
<h2 id="understanding-layers">Understanding&nbsp;layers</h2>
<p>One of the most powerful features of unpoly is <a href="https://unpoly.com/up.layer">layers</a>. To understand the terminology, a layer is any page that is stacked on top of another. The initial page is called the root layer, all other layers are called overlays. Layers can be arbitrary opened and stacked, there&#8217;s no limit on the number of layers that can be&nbsp;opened. </p>
<p>An overlay can be rendered like a modal / popup / drawer. The simplest way to use an overlay is to add an <code>up-layer='new'</code> attribute to a link. For example, in the demo app, the link to open a company is like&nbsp;this:</p>
<div class="highlight"><pre><span></span><code>  <span class="p">&lt;</span><span class="nt">a</span>
    <span class="na">up-layer</span><span class="o">=</span><span class="s">&#39;new&#39;</span>
    <span class="na">up-on-dismissed</span><span class="o">=</span><span class="s">&quot;up.reload(&#39;.table&#39;, { focus: &#39;:main&#39; })&quot;</span>
    <span class="na">up-dismiss-event</span><span class="o">=</span><span class="s">&#39;company:destroyed&#39;</span>
    <span class="na">href</span><span class="o">=</span><span class="s">&quot;{% url &#39;company-detail&#39; company.id %}&quot;</span><span class="p">&gt;</span>{{ company.name }}<span class="p">&lt;/</span><span class="nt">a</span><span class="p">&gt;</span>
</code></pre></div>

<p>(ignore the dismiss-related attributes for now). This opens a new modal dialog with the contents of the company detail. It will render the whole contents of the <code>up-main</code> element inside the modal since we don&#8217;t provide an <code>up-target</code>. If we added an <code>up-target='.projects'</code> attribute to this it would render <em>only</em> the <code>.projects</code> element inside the modal (but remember that it will retrieve the <em>whole</em> response since the /companies/detail/id is a normal django DetailView). So with <code>up-layer='new'</code> we open a page on a new overlay/modal. If we also add an <code>up-target</code> to it we&#8217;ll open only a particular part of that&nbsp;page.</p>
<p>You can use <code>up-mode</code> attribute to <a href="https://unpoly.com/layer-terminology#available-modes">change the kind of overlay</a>; the default is a <code>modal</code>. Also if you want to configure the ways this modal closes you can use the 
<code>up-dismissable</code> <a href="https://unpoly.com/closing-overlays#customizing-dismiss-controls">attribute</a>, for example add 
<code>up-dismissable='button'</code> to allow closing only with the X button on the top right. Another useful thing is that there&#8217;s an 
<code>up-size</code> attribute for changing the <a href="https://unpoly.com/customizing-overlays#overlay-sizes">size of the overlay</a>. I recommend playing a bit with these options to have a feel on how they are working and what you can do with&nbsp;them.</p>
<h3 id="static-overlay-content">Static overlay&nbsp;content</h3>
<p>An overlay can also contain &#8220;static&#8221; content (i.e not follow a link but display some html) by using the <code>up-content</code> <a href="https://unpoly.com/a-up-follow#up-content">attribute</a>. This is how the green dots are implemented, their html is similar to&nbsp;this:</p>
<div class="highlight"><pre><span></span><code><span class="p">&lt;</span><span class="nt">a</span> <span class="na">href</span><span class="o">=</span><span class="s">&quot;#&quot;</span> <span class="na">class</span><span class="o">=</span><span class="s">&quot;tour-dot viewed&quot;</span> <span class="na">up-layer</span><span class="o">=</span><span class="s">&quot;new popup&quot;</span> <span class="na">up-content</span><span class="o">=</span><span class="s">&quot;&lt;p&gt;Navigation links have the &lt;code&gt;[up-follow]&lt;/code&gt; attribute. </span>
<span class="s">    &lt;p&gt;</span>
<span class="s">        &lt;a href=&amp;quot;#&amp;quot; up-dismiss class=&amp;quot;btn btn-success btn-sm&amp;quot;&gt;OK&lt;/a&gt;</span>
<span class="s">    &lt;/p&gt;</span>
<span class="s">    &quot;</span> <span class="na">up-position</span><span class="o">=</span><span class="s">&quot;right&quot;</span> <span class="na">up-align</span><span class="o">=</span><span class="s">&quot;top&quot;</span> <span class="na">up-class</span><span class="o">=</span><span class="s">&quot;tour-hint&quot;</span> <span class="na">up-size</span><span class="o">=</span><span class="s">&quot;medium&quot;</span><span class="p">&gt;</span>
<span class="p">&lt;/</span><span class="nt">a</span><span class="p">&gt;</span>
</code></pre></div>

<p>Notice that the <code>up-content</code> contains a whole html snippet. This is implemented in Django using the following template&nbsp;tag:</p>
<div class="highlight"><pre><span></span><code><span class="nd">@register</span><span class="o">.</span><span class="n">tag</span><span class="p">(</span><span class="s2">&quot;tourdot&quot;</span><span class="p">)</span>
<span class="k">def</span><span class="w"> </span><span class="nf">do_tourdot</span><span class="p">(</span><span class="n">parser</span><span class="p">,</span> <span class="n">token</span><span class="p">):</span>
    <span class="n">nodelist</span> <span class="o">=</span> <span class="n">parser</span><span class="o">.</span><span class="n">parse</span><span class="p">((</span><span class="s2">&quot;endtourdot&quot;</span><span class="p">,))</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">delete_first_token</span><span class="p">()</span>
    <span class="k">return</span> <span class="n">TourDotNode</span><span class="p">(</span><span class="n">nodelist</span><span class="p">)</span>


<span class="k">class</span><span class="w"> </span><span class="nc">TourDotNode</span><span class="p">(</span><span class="n">template</span><span class="o">.</span><span class="n">Node</span><span class="p">):</span>
    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">nodelist</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">nodelist</span> <span class="o">=</span> <span class="n">nodelist</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">render</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">context</span><span class="p">):</span>
        <span class="n">rendered</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">nodelist</span><span class="o">.</span><span class="n">render</span><span class="p">(</span><span class="n">context</span><span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
        <span class="n">size</span> <span class="o">=</span> <span class="s2">&quot;medium&quot;</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">strip_tags</span><span class="p">(</span><span class="n">rendered</span><span class="p">))</span> <span class="o">&gt;</span> <span class="mi">400</span><span class="p">:</span>
            <span class="n">size</span> <span class="o">=</span> <span class="s2">&quot;large&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">rendered</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;&lt;p&quot;</span><span class="p">):</span>
            <span class="n">rendered</span> <span class="o">=</span> <span class="s2">&quot;&lt;p&gt;</span><span class="si">{}</span><span class="s2">&lt;/p&gt;&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">rendered</span><span class="p">)</span>

        <span class="n">rendered</span> <span class="o">+=</span> <span class="s2">&quot;&quot;&quot;</span>
<span class="s2">        &lt;p&gt;</span>
<span class="s2">            &lt;a href=&quot;#&quot; up-dismiss class=&quot;btn btn-success btn-sm&quot;&gt;OK&lt;/a&gt;</span>
<span class="s2">        &lt;/p&gt;</span>
<span class="s2">        &quot;&quot;&quot;</span>
        <span class="kn">from</span><span class="w"> </span><span class="nn">django.utils.html</span><span class="w"> </span><span class="kn">import</span> <span class="n">escape</span>

        <span class="n">output</span> <span class="o">=</span> <span class="n">escape</span><span class="p">(</span><span class="n">rendered</span><span class="p">)</span>
        <span class="k">return</span> <span class="s2">&quot;&quot;&quot;</span>
<span class="s2">        &lt;a </span>
<span class="s2">            href=&quot;#&quot; class=&quot;tour-dot&quot; up-layer=&quot;new popup&quot; </span>
<span class="s2">            up-position=&quot;right&quot; up-align=&quot;top&quot; up-class=&quot;tour-hint&quot;</span>
<span class="s2">            up-content=&quot;</span><span class="si">{}</span><span class="s2">&quot;</span>
<span class="s2">            up-size=&quot;</span><span class="si">{}</span><span class="s2">&quot;</span>
<span class="s2">            &gt;</span>
<span class="s2">        &lt;/a&gt;</span>
<span class="s2">        &quot;&quot;&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
            <span class="n">output</span><span class="p">,</span> <span class="n">size</span>
        <span class="p">)</span>
</code></pre></div>

<p>So we can do something like this in our Django&nbsp;templates:</p>
<div class="highlight"><pre><span></span><code>{% tourdot %}
  <span class="p">&lt;</span><span class="nt">p</span><span class="p">&gt;</span>Navigation links have the <span class="p">&lt;</span><span class="nt">code</span><span class="p">&gt;</span>[up-follow]<span class="p">&lt;/</span><span class="nt">code</span><span class="p">&gt;</span> attribute. Clicking such links only updates a <span class="p">&lt;</span><span class="nt">b</span><span class="p">&gt;</span>page fragment<span class="p">&lt;/</span><span class="nt">b</span><span class="p">&gt;</span>. The remaining DOM is not changed.<span class="p">&lt;/</span><span class="nt">p</span><span class="p">&gt;</span>
{% endtourdot %}
</code></pre></div>

<h3 id="advanced-layersoverlays">Advanced&nbsp;layers/overlays</h3>
<p>Opening overlays for popups or for modals to view links that don&#8217;t have interactivity is simple. However, when you open forms with overlays 
and need to handle these (i.e close the modals only when the form is submitted succesfully) the situation unfortunately starts to get more complex. I recommend to start by reading the 
<a href="https://unpoly.com/subinteractions">subinteractions</a> section of the unpoly documentation to understand how these things work. In the following subsections we&#8217;ll talk about specific cases and how to handle them with unpoly layers and&nbsp;Django.</p>
<h3 id="opening-new-layers-over-existing-ones">Opening new layers <em>over</em> existing&nbsp;ones</h3>
<p>How opening a new layer <em>over</em> an existing layer (i.e a modal inside a modal) would work? All links and forms that are handled in an existing layer will be handled in the same layer. So if we have opened a layer and there are <code>up-follow</code> links in the html of the layer, the user would be able to follow them normally inside that layer (of course if there are non <code>up-follow</code> links then a full page reload will be performed and the layer will disappear without a&nbsp;trace).</p>
<p>If we want to open a new layer we need to use the <code>up-layer='new'</code> attribute on that link; it doesn&#8217;t matter if this is inside an already opened layer, it will work as expected and open a <em>layer-in-a-layer</em>. If the parent layer is an overlay then it will open an <em>overlay-in-an-overlay</em>. </p>
<p>In the demo, if you click on an existing company to see its details you&#8217;ll get an overlay. If you try to edit that company the edit for will be opened <em>in the same layer</em> (notice that if you press the X button to close it you&#8217;ll go back to the company list without layers). Compare this with the behavior when adding a new project or viewing an existing one. You&#8217;ll get an overlay <em>inside</em> the parent overlay (both overlays should be visible). You need to close both overlays to go back to the company detail at the root&nbsp;layer. </p>
<p>Even more impressive: Go to the company detail layer, click an existing project to get to the project detail layer, click <em>edit</em>; this will be opened on the <em>project detail</em> layer. You can edit the project or even delete it, when you click that overlay the company overlay will be updated with the new data and work fine! All this also works fine from the project detail list <em>without</em> any modifications on the Django&nbsp;code.</p>
<p>The thing to remember here is that the layer behavior is very intuitive and is compatible with how a server side application works. Everything should work the same no matter if the link is opened in an overlay or in a new page or even an overlay over an&nbsp;overlay.</p>
<h3 id="closing-overlays">Closing&nbsp;overlays</h3>
<p>There are three main ways to <a href="https://unpoly.com/closing-overlays">close an overlay</a> (beyond of course using the (X) button or esc&nbsp;etc):</p>
<ul>
<li>Visiting a pre-defined&nbsp;link</li>
<li>Explicitly closing the overlay from the&nbsp;server</li>
<li>Emitting an unpoly&nbsp;event</li>
</ul>
<p>Also, when an overlay is closed we can decide if the overlay did something (i.e the user saved the form) or not (i.e the user clicked the X button). This is called <code>accepted</code> or <code>dismissed</code> respectively. We can use this to do different things. All the methods of closing an overlay have a version for accepting or dismissing the&nbsp;overlay.</p>
<h4 id="closing-the-overlay-when-visiting-a-link">Closing the overlay when visiting a&nbsp;link</h4>
<p>To close the overlay on visiting a link we&#8217;ll use the <code>up-accept-location</code> and <code>up-dismiss-location</code> respectively. For example, let&#8217;s take a peek on the new company&nbsp;link:</p>
<div class="highlight"><pre><span></span><code>  <span class="p">&lt;</span><span class="nt">a</span>
    <span class="na">class</span><span class="o">=</span><span class="s">&#39;btn btn-primary&#39;</span>
    <span class="na">up-layer</span><span class="o">=</span><span class="s">&#39;new&#39;</span>
    <span class="na">up-on-accepted</span><span class="o">=</span><span class="s">&quot;up.reload(&#39;.table&#39;, { focus: &#39;:main&#39; })&quot;</span>
    <span class="na">up-accept-location</span><span class="o">=</span><span class="s">&#39;/core/companies/detail/$id/&#39;</span>
    <span class="na">href</span><span class="o">=</span><span class="s">&#39;{% url &quot;company-create&quot; %}&#39;</span><span class="p">&gt;</span>New company<span class="p">&lt;/</span><span class="nt">a</span><span class="p">&gt;</span>
</code></pre></div>

<p>The important thing here is the <code>up-accept-location</code>. When Django creates a new object it redirects to the detail view of that object. In our case this detail view is <code>'/core/companies/detail/$id/'</code>; the <code>$id</code> is an unpoly thingie that will be replaced by the id of the new object and will be <a href="https://unpoly.com/closing-overlays#overlay-result-values">the result value of the overlay</a>. This value (the id) can then be used on the <code>up-on-accepted</code> callback if we&nbsp;want.</p>
<p>Now, let&#8217;s suppose that we want to close the overlay when the user clicks on a <em>cancel</em> button that returns to the list of companies. We can do that by adding the <code>up-dismiss-location</code> attribute to that <code>&lt;a&gt;</code></p>
<div class="highlight"><pre><span></span><code>up-dismiss-location=&#39;{% url &quot;company-list&quot; %}&#39;
</code></pre></div>

<p>The difference between these two is that the <code>up-on-accepted</code> event will only be called when the overlay is accepted and not on&nbsp;dismissed.</p>
<h4 id="handling-hardcoded-urls">Handling hardcoded&nbsp;urls</h4>
<p>One thing that Django developers may not like is that the url is hardcoded here. This is because using <code>{% url "company-detail" "$id" %}</code> will not work with our urls since we use have the following path for the company detail <code>"companies/detail/&lt;int:pk&gt;/"</code>. We can change it to <code>"companies/detail/&lt;str:pk&gt;/",</code> to make it work but then it will allow strings in the url and it will throw 500 error instead of 404 when the user uses a string there (to improve that we have to override the <code>get_object</code> of the <code>DetailView</code> to handle the string case). Another way to improve that is to create a <code>urlid</code> template tag like&nbsp;this:</p>
<div class="highlight"><pre><span></span><code><span class="kn">from</span><span class="w"> </span><span class="nn">django.urls</span><span class="w"> </span><span class="kn">import</span> <span class="n">reverse</span>

<span class="nd">@register</span><span class="o">.</span><span class="n">simple_tag</span>
<span class="k">def</span><span class="w"> </span><span class="nf">urlid</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">arg</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">arg</span> <span class="o">==</span> <span class="s2">&quot;$id&quot;</span><span class="p">:</span>
        <span class="n">arg</span> <span class="o">=</span> <span class="mi">999</span>

    <span class="n">url</span> <span class="o">=</span> <span class="n">reverse</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">args</span><span class="o">=</span><span class="p">[</span><span class="n">arg</span><span class="p">])</span>
    <span class="k">return</span> <span class="n">url</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;999&quot;</span><span class="p">,</span> <span class="s2">&quot;$id&quot;</span><span class="p">)</span>
</code></pre></div>

<p>And then using it like this on the&nbsp;up-accept-location:</p>
<div class="highlight"><pre><span></span><code>up-accept-location=&#39;{% urlid &quot;company-detail&quot; &quot;$id&quot; %}&#39;
</code></pre></div>

<h4 id="explicitly-closing-the-layer">Explicitly closing the&nbsp;layer</h4>
<p>To close the layer from the server you can you use the
<a href="https://unpoly.com/X-Up-Accept-Layer"><code>X-Up-Accept-Layer</code></a>
or <a href="https://unpoly.com/X-Up-Dismiss-Layer"><code>X-Up-Dismiss-Layer</code></a>
response header. When unpoly sees this header in a response it will close the overlay by accepting/dismissing&nbsp;it.</p>
<p>To do that from Django if you have integrated the unpoly middleware, call <code>request.up.layer.accept()</code> and <code>request.up.layer.dismiss()</code> respectively (passing an optional value if you&nbsp;want).</p>
<p>The same feature can be used to close the overlay from the client side. For example, if you want to close the overlay when the user clicks on a <em>cancel</em> button that returns to the list of companies you can do that by adding the <code>up-accept</code> or <code>up-dismiss</code> attribute,&nbsp;like:</p>
<div class="highlight"><pre><span></span><code><span class="p">&lt;</span><span class="nt">a</span> <span class="na">href</span><span class="o">=</span><span class="s">&#39;{% urlid &quot;company-detail&quot; &quot;$id&quot; %}&#39;</span> <span class="na">up-dismiss</span><span class="p">&gt;</span>Return<span class="p">&lt;/</span><span class="nt">a</span><span class="p">&gt;</span>
</code></pre></div>

<p>Please notice that the <code>href</code> here could be like <code>href='#'</code> since this is javascript only to close the overlay, however we added the correct href to make sure the return button will also work when we open the link in a new page (without any&nbsp;overlays). </p>
<p>Please notice that difference between this and <code>up-accept-location</code> or <code>up-dismiss-location</code> we mentioned before. In this case the <code>up-accept/dismiss</code> directive in placed in the a link that <em>closes</em> the overlay. In the former case the <code>up-accept/dismiss-location</code> directive is placed in the link that <em>opens</em> the&nbsp;overlay.</p>
<h4 id="closing-the-layer-by-emitting-an-unpoly-event">Closing the layer by emitting an unpoly&nbsp;event</h4>
<p>The final way to close an overlay is by emitting an event. Unpoly can emit events both from the server, using the <a href="https://unpoly.com/X-Up-Events"><code>X-Up-Event</code></a> response header or using <code>request.up.emit(event_type, data)</code> from the unpoly Django integration. Also events can be emitted from the client side using the <a href="https://unpoly.com/up.emit"><code>up-emit</code></a>&nbsp;attribute.</p>
<p>To close the overlay from an event we need to use <code>up-accept-event</code> and <code>up-dismiss-event</code> on the link that opens the&nbsp;overlay.</p>
<p>Let&#8217;s see what happens when we delete a company. We&#8217;ve got a form like&nbsp;this:</p>
<div class="highlight"><pre><span></span><code><span class="p">&lt;</span><span class="nt">form</span> <span class="na">up-submit</span> <span class="na">up-confirm</span><span class="o">=</span><span class="s">&#39;Really?&#39;</span> <span class="na">class</span><span class="o">=</span><span class="s">&quot;d-inline&quot;</span> <span class="na">method</span><span class="o">=</span><span class="s">&#39;POST&#39;</span> <span class="na">action</span><span class="o">=</span><span class="s">&#39;{% url &quot;company-delete&quot; company.id %}&#39;</span><span class="p">&gt;</span>
  {% csrf_token %}
  <span class="p">&lt;</span><span class="nt">input</span> <span class="na">type</span><span class="o">=</span><span class="s">&#39;submit&#39;</span> <span class="na">value</span><span class="o">=</span><span class="s">&#39;Delete&#39;</span> <span class="na">class</span><span class="o">=</span><span class="s">&#39;btn btn-danger mr-3&#39;</span> <span class="p">/&gt;</span>
<span class="p">&lt;/</span><span class="nt">form</span><span class="p">&gt;</span>
</code></pre></div>

<p>This form asks the user for confirmation (using the <code>up-confirm</code> directive) and then submits the form on the company delete view. The <code>CompanyDeleteView</code> is like&nbsp;this:</p>
<div class="highlight"><pre><span></span><code><span class="k">class</span><span class="w"> </span><span class="nc">CompanyDeleteView</span><span class="p">(</span><span class="n">DeleteView</span><span class="p">):</span>
    <span class="n">model</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">Company</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">get_success_url</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">reverse</span><span class="p">(</span><span class="s2">&quot;company-list&quot;</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">form_valid</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">form</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">up</span><span class="o">.</span><span class="n">layer</span><span class="o">.</span><span class="n">emit</span><span class="p">(</span><span class="s2">&quot;company:destroyed&quot;</span><span class="p">,</span> <span class="p">{})</span>
        <span class="k">return</span> <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">form_valid</span><span class="p">(</span><span class="n">form</span><span class="p">)</span>
</code></pre></div>

<p>So, it will emit the <code>company:destroyed</code> event and redirect to the list of companies (this is needed to make sure that delete works fine if we call it from a full page instead of an overlay). The company detail view overlay is opened from the following <code>a</code> link:</p>
<div class="highlight"><pre><span></span><code><span class="p">&lt;</span><span class="nt">a</span>
  <span class="na">up-layer</span><span class="o">=</span><span class="s">&#39;new&#39;</span>
  <span class="na">up-on-dismissed</span><span class="o">=</span><span class="s">&quot;up.reload(&#39;.table&#39;, { focus: &#39;:main&#39; })&quot;</span>
  <span class="na">up-dismiss-event</span><span class="o">=</span><span class="s">&#39;company:destroyed&#39;</span>
  <span class="na">href</span><span class="o">=</span><span class="s">&quot;{% url &#39;company-detail&#39; company.id %}&quot;</span><span class="p">&gt;</span>{{ company.name }}<span class="p">&lt;/</span><span class="nt">a</span><span class="p">&gt;</span>
</code></pre></div>

<p>Notice that we have the <code>up-dismiss-event</code> here. If we didn&#8217;t have that then the overlay wouldn&#8217;t be closed when we deleted the company but we&#8217;d see the list of companies on the overlay because of the redirect on the Django side! Also, instead of the <code>up-dismiss-event</code> we could use the <code>up-dismiss-location='{% url "company-list" %}'</code> similar to how we discussed before. If we did it this way we wouldn&#8217;t even need to do anything unpoly related in our DeleteView, however using events for this is useful for educational reasons and we&#8217;ll see later how events will help us to dispaly a message when companies are&nbsp;deleted.</p>
<h3 id="doing-stuff-when-a-layer-is-closed">Doing stuff when a layer is&nbsp;closed</h3>
<p>After a layer is closed (and depending if it was accepted or dismissed) unpoly allows us to use callbacks to do stuff. The most obvious things are to reload the list of results if a result is added/edited/deleted or to choose a result in a form if we used the overlay as an object&nbsp;picker.</p>
<p>The callbacks are <code>up-on-accepted</code> and <code>up-on-dismissed</code>.</p>
<p>Let&#8217;s see some examples from the&nbsp;demo.</p>
<p>On on the new company link we&#8217;ve got <code>up-on-accepted="up.reload('.table', { focus: ':main' })"</code>. However on the show details company link we&#8217;ve got <code>up-on-dismissed="up.reload('.table', { focus: ':main' })"</code>. This is a little strange (why <code>up-on-accepted</code> on the new vs <code>up-on-dismissed</code> on the detail) at first but we can explain&nbsp;it. </p>
<p>First of all, the <a href="https://unpoly.com/up.reload">up.reload</a> method will do an <span class="caps">HTTP</span> request and reload that specific element from the server (in our case the <code>.table</code> element that contains the list of companies). The focus option that is passed instructs unopoly to move the focus to (that&nbsp;element)[https://unpoly.com/focus-option].</p>
<p>For the &#8220;Add new&#8221; company we reload the companies when the form is accepted (when the user clicks on the &#8220;Save&#8221; button). However for the show details we&#8217;ll reload every time the overlay is dismissed because when the user edits a company the layer will not be closed but will display the edit company data. Also when we delete the company the layer will be&nbsp;dismissed. </p>
<p>Notice that if the user clicks the company details and then presses the (X) button <em>we&#8217;ll still do a reload</em> even though it may not be needed because we can&#8217;t know if the user actually edited the company or not before closing the overlay. This is a little bit of a tradeoff but it&#8217;s not a big&nbsp;deal. </p>
<p>Actually, it <em>is</em> possible to know if the overlay was dismissed because the user clicked the (X) button (or pressed escape) or if the overlay was dismissed because the object was deleted. This is useful if we wanted to display a message to the user when the company was deleted since we&#8217;d need to differentiate between these cases. We&#8217;ll see how the section about overlays and&nbsp;messages.</p>
<p>On the company detail we&#8217;ve got <code>up-on-accepted='up.reload(".projects")'</code> for adding a new project but same as before we&#8217;ve got <code>up-on-dismissed='up.reload(".projects")'</code> for viewing the project detail. The <code>.projects</code> element is the projects holder inside the company detail. This is exactly the same behavior we explained&nbsp;before.</p>
<p>On the project form we&#8217;ve got <code>up-on-accepted</code> both on the suggest name and on the new company button. In the first case, we are opening the name suggestion overlay like&nbsp;this:</p>
<div class="highlight"><pre><span></span><code><span class="p">&lt;</span><span class="nt">a</span>
    <span class="na">up-layer</span><span class="o">=</span><span class="s">&#39;new popup&#39;</span>
    <span class="na">up-align</span><span class="o">=</span><span class="s">&#39;left&#39;</span>
    <span class="na">up-size</span><span class="o">=</span><span class="s">&#39;large&#39;</span>
    <span class="na">up-accept-event</span><span class="o">=</span><span class="s">&#39;name:select&#39;</span>
    <span class="na">up-on-accepted</span><span class="o">=</span><span class="s">&quot;up.fragment.get(&#39;#id_name&#39;).value = value.name&quot;</span>
    <span class="na">href</span><span class="o">=</span><span class="s">&#39;{% url &quot;project-suggest-name&quot; %}&#39;</span><span class="p">&gt;</span>Suggest name<span class="p">&lt;/</span><span class="nt">a</span><span class="p">&gt;</span>
</code></pre></div>

<p>Notice that this overlay will be accepted when it receives the <code>name:select</code> event. This event passes it the selected name so it will  put it on the <code>#id_name</code> input. The <a href="https://unpoly.com/up.fragment.get"><code>up.fragment.get</code></a> is used to retrieve the input. To understand how this works we need to also see the name suggestion overlay. This is more or less similar&nbsp;to:</p>
<div class="highlight"><pre><span></span><code>  {% for n in names %}
    <span class="p">&lt;</span><span class="nt">a</span> <span class="na">up-emit</span><span class="o">=</span><span class="s">&quot;name:select&quot;</span>
       <span class="na">up-emit-props</span><span class="o">=</span><span class="s">&#39;{&quot;name&quot;: &quot;{{ n }}&quot;}&#39;</span>
       <span class="na">class</span><span class="o">=</span><span class="s">&quot;btn btn-info text-light mb-2 mr-1&quot;</span>
       <span class="na">tabindex</span><span class="o">=</span><span class="s">&quot;0&quot;</span><span class="p">&gt;</span>
      {{ n }}
    <span class="p">&lt;/</span><span class="nt">a</span><span class="p">&gt;</span>
  {% endfor %}
</code></pre></div>

<p>So we are using the <code>up-emit</code> directive here to emit the <code>name:select</code> event <em>and</em> we pass it some data which must be a json object. Then this data will be available as a javascript object named <code>value</code> on the <code>up-on-accepted</code> callback.</p>
<p>So the flow&nbsp;is:</p>
<ol>
<li>When we click the suggest name link we open a new overlay and wait for the <code>name:select</code> event to be emitted. We don&#8217;t care if we are a full page or already inside an&nbsp;overlay</li>
<li>The suggest name overlay displays a link of <code>&lt;a&gt;</code> elements that emit the <code>name:select</code> event when clicked and also pass the selected name as data on the&nbsp;event</li>
<li>The overlay opener receives the <code>name:select</code> event and closes the overlay. It then uses the data to fill the <code>#id_name</code> input</li>
</ol>
<p>The second case is similar but instead of filling an input it opens a new overlay to create and select a new company. This is the create company link from inside the project&nbsp;form:</p>
<div class="highlight"><pre><span></span><code>  <span class="p">&lt;</span><span class="nt">a</span> <span class="na">href</span><span class="o">=</span><span class="s">&#39;{% url &quot;company-create&quot; %}&#39;</span>
      <span class="na">up-layer</span><span class="o">=</span><span class="s">&#39;new&#39;</span>
      <span class="na">up-accept-location</span><span class="o">=</span><span class="s">&#39;{% urlid &quot;company-detail&quot; &quot;$id&quot; %}&#39;</span>
      <span class="na">up-on-accepted</span><span class="o">=</span><span class="s">&quot;up.validate(&#39;form&#39;, { params: { &#39;company&#39;: value.id } })&quot;</span>
  <span class="p">&gt;</span>
      New company
  <span class="p">&lt;/</span><span class="nt">a</span><span class="p">&gt;</span>
</code></pre></div>

<p>Nothing extra is needed from the company form side! We use the <code>up-accept-location</code> to accept the overlay when the company is created (so the user will be redirect to the company-detail view). Then we call <code>up.validate('form', { params: { 'company': value.id } })</code>  after the overlay is accepted. First of all, please remember that when we use the <code>up-accept-location</code> the overlay result 
<a href="https://unpoly.com/a-up-layer-new#up-accept-location">will be an object with the captured parts of the url</a>. In this case we capture the new company id. Then, we call <code>up.validate</code> passing it the form and the company id we just retrieved (i.e the id of the newly created&nbsp;company).</p>
<p>It is important to understand that we do <code>up.validate</code> here instead of simply setting the value of the select to the newly created id (similar to what we did before with the name) because the newly created value <em>is not</em> in the options that this select contains so it can&#8217;t be picked at this time;  when the validate returns though it <em>will</em> contain the newly created company to the options so it will be selected&nbsp;then.</p>
<p>If we wanted to select the newly created company without doing the validate  instead we&#8217;d need to first add a new option to the select with the correct id and then set it to that value (which is a little bit more complex since we don&#8217;t know the name of the new company at this point). To properly implement that and to further understand how unpoly works, we&#8217;d need to emit a <code>company:create</code> event from our <code>CreateCompanyView</code> which would contain as data both the id and the name of the newly created company. Then we&#8217;d change our accept condition to <code>up-accept-event='company:create'</code>. Finally, our <code>up-on-accepted</code> would add a new option with the <code>value.name</code> and <code>value.id</code> it received from the event and select <em>that</em>&nbsp;option.</p>
<h3 id="overlays-and-messages">Overlays and&nbsp;messages</h3>
<p>This probably is the most complex part of integrating unpoly with Django. The problem is that when we do an action the messages will 
be displayed on the page that our response redirects to. If we don&#8217;t display that page but we only use it as <code>on-accept-location</code> we&#8217;ll
miss these messages. There are various solutions on how this can be fixed, and there also is a <a href="https://github.com/unpoly/unpoly/discussions/400">long discussion</a> in the unpoly repo discussions about&nbsp;that. </p>
<p>We&#8217;ve already discussed about the <code>up-hungry</code> in your messages container element that will reread its contents from all responses. This will resolve all cases where the response is <em>not</em> discarded. For example, try to edit a project and you&#8217;ll see the edit message <em>on</em> the overlay (instead of the main page). This is because the overlay is contained in the <code>up-main</code> element so it will be rendered in the response in the&nbsp;overlay.</p>
<p>The problematic behavior is when creating a new project or deleting one. In both these cases we discard the response so the messages are lost. The simplest way to actually fix this is to ignore the server side message and render again the message <em>from unpoly</em>. This avoids changing anything on your server-side code. So, in order to implement this, we&#8217;ll use this function which we add on <code>application.js</code> (after a suggestion on the afforementioned&nbsp;discussion):</p>
<div class="highlight"><pre><span></span><code><span class="k">async</span><span class="w"> </span><span class="kd">function</span><span class="w"> </span><span class="nx">reloadWithFlash</span><span class="p">(</span><span class="nx">selector</span><span class="p">,</span><span class="w"> </span><span class="nx">flash</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="k">await</span><span class="w"> </span><span class="nx">up</span><span class="p">.</span><span class="nx">reload</span><span class="p">(</span><span class="nx">selector</span><span class="p">)</span>
<span class="w">  </span><span class="nx">up</span><span class="p">.</span><span class="nx">element</span><span class="p">.</span><span class="nx">affix</span><span class="p">(</span><span class="nb">document</span><span class="p">.</span><span class="nx">getElementById</span><span class="p">(</span><span class="s1">&#39;flash-messages&#39;</span><span class="p">),</span><span class="w"> </span><span class="s1">&#39;.alert.fade.show.alert-success&#39;</span><span class="p">,</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">text</span><span class="o">:</span><span class="w"> </span><span class="nx">flash</span><span class="w"> </span><span class="p">})</span>
<span class="p">}</span>
</code></pre></div>

<p>This function will call <code>up.reload</code> with a selection we pass to it (f.e <code>up.reload('.table')</code>) and wait until this function finished.
Then it will add a new element on the <code>flash-messages</code> container with the flash text we pass to it. In order to use it, we&#8217;ll change 
the new company link&nbsp;to:</p>
<div class="highlight"><pre><span></span><code>      <span class="p">&lt;</span><span class="nt">a</span>
        <span class="na">class</span><span class="o">=</span><span class="s">&#39;btn btn-primary&#39;</span>
        <span class="na">up-layer</span><span class="o">=</span><span class="s">&#39;new&#39;</span>
        <span class="na">up-on-accepted</span><span class="o">=</span><span class="s">&quot;reloadWithFlash(&#39;.table&#39;, &#39;Company created!&#39;)&quot;</span>
        <span class="na">up-accept-location</span><span class="o">=</span><span class="s">&#39;{% urlid &quot;company-detail&quot; &quot;$id&quot; %}&#39;</span>
        <span class="na">href</span><span class="o">=</span><span class="s">&#39;{% url &quot;company-create&quot; %}&#39;</span><span class="p">&gt;</span>New company<span class="p">&lt;/</span><span class="nt">a</span><span class="p">&gt;</span>
</code></pre></div>

<p>(remember that <code>up-on-accepted</code> before was <code>up-on-accepted="up.reload('.table', { focus: ':main' })")</code>, let&#8217;s skip <code>focus</code> for now it&#8217;s not important). If we try it this way we&#8217;ll notice that we&#8217;ll get the <code>Company created</code> message after the overlay is closed! As I said before, the problem with this is that we ignore the server side message and  duplicate the message both on server and on client side. The Django side message will be used when we open the /companies/new link on a new page (not an overlay) so the overlay functionality won&#8217;t be used and the message will be rendered properly on the response. When we use an overlay the client side message will be rendered&nbsp;instead.</p>
<p>Another solution would be to change our <code>CompanyCreateView</code> to redirect to the companies list page (instead of the newly created page). In this case, we can change the new company form&nbsp;like:</p>
<div class="highlight"><pre><span></span><code><span class="p">&lt;</span><span class="nt">form</span> <span class="na">up-submit</span> <span class="na">up-validate</span> <span class="na">method</span><span class="o">=</span><span class="s">&quot;POST&quot;</span> <span class="na">up-layer</span><span class="o">=</span><span class="s">&#39;root&#39;</span><span class="p">&gt;</span>
  ...
<span class="p">&lt;/</span><span class="nt">form</span><span class="p">&gt;</span>
</code></pre></div>

<p>Adding the <code>up-layer='root'</code> will render the response in the root layer which will close the overlay and render everything on the <code>up-main</code> element. Since we redirect to the companies list, we&#8217;ll get the list of companies along with the server-side message. This solution is actually simpler but modifies our server-side app (instead of the usual behavior of redirecting to the new company detail well&#8217;ll redirect to the companies&nbsp;list).</p>
<p>Let&#8217;s now talk about delete. As we&#8217;ve already discussed above, the company detail overlay will be closed either when the user closes it explicitly by clicking the (X) button or because the company was deleted. In both cases we want to reload the companies but when the company is deleted we also want to display a message. So we need to know when the overlay was closed because the company was deleted vs when the overlay was closed explicitly by the&nbsp;user. </p>
<p>Right now we&#8217;ve&nbsp;got </p>
<div class="highlight"><pre><span></span><code><span class="p">&lt;</span><span class="nt">a</span>
  <span class="na">up-layer</span><span class="o">=</span><span class="s">&#39;new&#39;</span>
  <span class="na">up-dismissable</span><span class="o">=</span><span class="s">&#39;button&#39;</span>
  <span class="na">up-on-dismissed</span><span class="o">=</span><span class="s">&quot;up.reload(&#39;.table&#39;, { focus: &#39;:main&#39; })&quot;</span>
  <span class="na">up-dismiss-event</span><span class="o">=</span><span class="s">&#39;company:destroyed&#39;</span>
  <span class="na">href</span><span class="o">=</span><span class="s">&quot;{% url &#39;company-detail&#39; company.id %}&quot;</span><span class="p">&gt;</span>{{ company.name }}<span class="p">&lt;/</span><span class="nt">a</span><span class="p">&gt;</span>
</code></pre></div>

<p>For starters, we&#8217;ll add the following&nbsp;function:</p>
<div class="highlight"><pre><span></span><code><span class="k">async</span><span class="w"> </span><span class="kd">function</span><span class="w"> </span><span class="nx">reloadWithFlashIfEvent</span><span class="p">(</span><span class="nx">selector</span><span class="p">,</span><span class="w"> </span><span class="nx">flash</span><span class="p">,</span><span class="w"> </span><span class="nx">value</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="k">await</span><span class="w"> </span><span class="nx">up</span><span class="p">.</span><span class="nx">reload</span><span class="p">(</span><span class="nx">selector</span><span class="p">,</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">focus</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;:main&#39;</span><span class="w"> </span><span class="p">})</span>
<span class="w">  </span><span class="k">if</span><span class="p">(</span><span class="nx">value</span><span class="w"> </span><span class="ow">instanceof</span><span class="w"> </span><span class="nx">Event</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nx">up</span><span class="p">.</span><span class="nx">element</span><span class="p">.</span><span class="nx">affix</span><span class="p">(</span><span class="nb">document</span><span class="p">.</span><span class="nx">getElementById</span><span class="p">(</span><span class="s1">&#39;flash-messages&#39;</span><span class="p">),</span><span class="w"> </span><span class="s1">&#39;.alert.fade.show.alert-danger&#39;</span><span class="p">,</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">text</span><span class="o">:</span><span class="w"> </span><span class="nx">flash</span><span class="w"> </span><span class="p">})</span>
<span class="w">  </span><span class="p">}</span>
<span class="p">}</span>
</code></pre></div>

<p>and change <code>up-on-dismissed</code> to <code>up-on-dismissed="reloadWithFlashIfEvent('.table', 'Company deleted!', value)"</code> on the open overlay&nbsp;link.</p>
<p>The <code>up-on-dismissed</code> and <code>up-on-accepted</code> callbacks are passed <a href="https://unpoly.com/a-up-layer-new#up-on-dismissed">these paremeters</a> by unpoly:
* <code>this</code> The link that originally opened the overlay
* <code>layer</code> An up.Layer object for the dismissed overlay
* <code>value</code> The overlay&#8217;s dismissal value
* <code>event</code> An up:layer:dismissed&nbsp;event</p>
<p>If the event was dismissed because the user clicked the (X) button, the <code>value</code> would have a similar to <code>:button</code> (there are same string values for pressing escape or clicking outside the modal). However if it was dismissed because of the <code>company:destroyed</code> event, the value would be an <code>Event</code> object. So we pass the <code>value</code> to our <code>reloadWithFlashIfEvent</code> callback and check if the value is an <code>Event</code> object. If it is, we know that the overlay was dismissed because the company was deleted and we can display the flash message. If it&#8217;s not, we know that the overlay was dismissed because the user clicked the (X) button and we won&#8217;t display the flash&nbsp;message.</p>
<p>Another way we could implement this would be if we closed the company detail overlay when the company was deleted and returned the response (which is the company list view) to the root layer. Something like&nbsp;this:</p>
<div class="highlight"><pre><span></span><code><span class="p">&lt;</span><span class="nt">form</span> <span class="na">up-submit</span> <span class="na">up-confirm</span><span class="o">=</span><span class="s">&#39;Really?&#39;</span> <span class="na">class</span><span class="o">=</span><span class="s">&quot;d-inline&quot;</span> <span class="na">method</span><span class="o">=</span><span class="s">&#39;POST&#39;</span> <span class="na">action</span><span class="o">=</span><span class="s">&#39;{% url &quot;company-delete&quot; company.id %}&#39;</span> <span class="na">up-layer</span><span class="o">=</span><span class="s">&#39;root&#39;</span><span class="p">&gt;</span>
</code></pre></div>

<p>(notice we added the <code>up-layer='root'</code> attribute). For this to work we need to <em>not</em>  <code>reload</code> in the <code>up-on-dismissed</code> function because if we reload the companies list the contents of the flash-messages will be re-read (because it has the <code>up-hungry</code> attr) and be immediately cleared out! However in this case we need to reload because a company may be&nbsp;edited!</p>
<h4 id="improving-delete">Improving&nbsp;delete</h4>
<p>Right now, the delete button is a form, similar to&nbsp;this:</p>
<div class="highlight"><pre><span></span><code><span class="p">&lt;</span><span class="nt">form</span> <span class="na">up-submit</span> <span class="na">up-confirm</span><span class="o">=</span><span class="s">&#39;Really?&#39;</span> <span class="na">class</span><span class="o">=</span><span class="s">&quot;d-inline&quot;</span> <span class="na">method</span><span class="o">=</span><span class="s">&#39;POST&#39;</span> <span class="na">action</span><span class="o">=</span><span class="s">&#39;{% url &quot;company-delete&quot; company.id %}&#39;</span><span class="p">&gt;</span>
  {% csrf_token %}
  <span class="p">&lt;</span><span class="nt">input</span> <span class="na">type</span><span class="o">=</span><span class="s">&#39;submit&#39;</span> <span class="na">value</span><span class="o">=</span><span class="s">&#39;Delete&#39;</span> <span class="na">class</span><span class="o">=</span><span class="s">&#39;btn btn-danger mr-3&#39;</span>  <span class="p">/&gt;</span>
<span class="p">&lt;/</span><span class="nt">form</span><span class="p">&gt;</span>
</code></pre></div>

<p>So this is an unpoly-handled form and will display a <code>Really?</code> javascript prompt to make sure the user really wants to delete the&nbsp;company. </p>
<p>I have to confess that I don&#8217;t like javascript prompts because they can&#8217;t be styled and seem out of context from the app. However we can improve that behavior with unpoly. Here&#8217;s an improved version of the delete&nbsp;functionality:</p>
<div class="highlight"><pre><span></span><code><span class="p">&lt;</span><span class="nt">a</span> <span class="na">class</span><span class="o">=</span><span class="s">&#39;btn btn-danger&#39;</span> <span class="na">up-layer</span><span class="o">=</span><span class="s">&quot;new&quot;</span> <span class="na">up-content</span><span class="o">=</span><span class="s">&#39;</span>
<span class="s">      &lt;h3&gt;Delete company {{ company.name }}&lt;/h3&gt;</span>
<span class="s">      Do you want to delete the company? </span>
<span class="s">      &lt;form up-submit up-target=&quot;.table&quot; up-layer=&quot;root&quot; class=&quot;d-inline&quot; method=&quot;POST&quot; action=&quot;{% url &quot;company-delete&quot; company.id %}&quot;&gt;</span>
<span class="s">        {% csrf_token %}</span>
<span class="s">        &lt;input type=&quot;submit&quot; value=&quot;Yes&quot; class=&quot;btn btn-danger mr-3&quot;/&gt;</span>
<span class="s">        &lt;a href=&quot;#&quot; class=&quot;btn btn-secondary&quot;  up-dismiss&gt;No&lt;/a&gt;</span>
<span class="s">      &lt;/form&gt;</span>
<span class="s">      &#39;</span><span class="p">&gt;</span>Delete<span class="p">&lt;/</span><span class="nt">a</span><span class="p">&gt;</span>
</code></pre></div>

<p>We changed the delete button to open a new layer. Instead of having a special view for the delete confirmation, we&#8217;re using the <code>up-content</code> attribute to directly pass the static <span class="caps">HTML</span> for the confirmation, which actually includes the delete form like before. Notice that we also include an <code>up-dismiss</code> button that clears the overlay when the user presses No. The up-layer of the form is <code>root</code> so when the form is submitted it will close both the confirmation overlay and the company detail overlay! Now, we&#8217;ll change the <code>reloadWithFlashIfEvent</code> like&nbsp;this:</p>
<div class="highlight"><pre><span></span><code><span class="k">async</span><span class="w"> </span><span class="kd">function</span><span class="w"> </span><span class="nx">reloadWithFlashIfEvent</span><span class="p">(</span><span class="nx">selector</span><span class="p">,</span><span class="w"> </span><span class="nx">flash</span><span class="p">,</span><span class="w"> </span><span class="nx">value</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="k">await</span><span class="w"> </span><span class="nx">up</span><span class="p">.</span><span class="nx">reload</span><span class="p">(</span><span class="nx">selector</span><span class="p">,</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">focus</span><span class="o">:</span><span class="w"> </span><span class="s1">&#39;:main&#39;</span><span class="w"> </span><span class="p">})</span>
<span class="w">  </span><span class="k">if</span><span class="p">(</span><span class="nx">value</span><span class="w"> </span><span class="ow">instanceof</span><span class="w"> </span><span class="nx">Event</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="nx">value</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="s1">&#39;:peel&#39;</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nx">up</span><span class="p">.</span><span class="nx">element</span><span class="p">.</span><span class="nx">affix</span><span class="p">(</span><span class="nb">document</span><span class="p">.</span><span class="nx">getElementById</span><span class="p">(</span><span class="s1">&#39;flash-messages&#39;</span><span class="p">),</span><span class="w"> </span><span class="s1">&#39;.alert.fade.show.alert-danger&#39;</span><span class="p">,</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">text</span><span class="o">:</span><span class="w"> </span><span class="nx">flash</span><span class="w"> </span><span class="p">})</span>
<span class="w">  </span><span class="p">}</span>
<span class="p">}</span>
</code></pre></div>

<p>This checks if the value is an event <em>or</em> <code>:peel</code>; this is the value that is passed when the overlay is dismissed because we use the <code>up-layer='root'</code> from the delete&nbsp;form.</p>
<h2 id="improving-interaction-with-django-packages">Improving interaction with Django&nbsp;packages</h2>
<p>There are two very important packages that I use on almost all my projects: <a href="https://django-tables2.readthedocs.io/en/latest/">django-tables2</a> and <a href="https://django-filter.readthedocs.io/en/stable/">django-filter</a>. You can see these in action at the <code>/core/tf/</code> path on the demo app. You&#8217;ll see&nbsp;that:</p>
<ul>
<li>Filtering is instant (when entering a character it will filter without the need to submit the form explicitly&nbsp;)</li>
<li>The row detail links open in an&nbsp;overlay</li>
<li>Sorting and pagination are handled by unpoly (so they don&#8217;t do full page&nbsp;reloads)</li>
</ul>
<p>To have the instant filtering we&#8217;ve changed our filter form like&nbsp;this:</p>
<div class="highlight"><pre><span></span><code><span class="p">&lt;</span><span class="nt">form</span> <span class="na">up-autosubmit</span> <span class="na">up-delay</span><span class="o">=</span><span class="s">&#39;250&#39;</span> <span class="na">class</span><span class="o">=</span><span class="s">&#39;form-inline&#39;</span> <span class="na">method</span><span class="o">=</span><span class="s">&#39;GET&#39;</span> <span class="na">action</span><span class="o">=</span><span class="s">&#39;&#39;</span> <span class="na">up-target</span><span class="o">=</span><span class="s">&#39;.form-data&#39;</span><span class="p">&gt;</span>
    {{ filter.form|crispy }}
    <span class="p">&lt;</span><span class="nt">input</span> <span class="na">class</span><span class="o">=</span><span class="s">&#39;btn btn-info&#39;</span> <span class="na">type</span><span class="o">=</span><span class="s">&#39;submit&#39;</span> <span class="na">value</span><span class="o">=</span><span class="s">&#39;Filter&#39;</span><span class="p">&gt;</span>
    <span class="p">&lt;</span><span class="nt">a</span> <span class="na">up-follow</span> <span class="na">href</span><span class="o">=</span><span class="s">&#39;{{ request.path }}&#39;</span> <span class="na">class</span><span class="o">=</span><span class="s">&#39;btn btn-secondary&#39;</span><span class="p">&gt;</span>Reset<span class="p">&lt;/</span><span class="nt">a</span><span class="p">&gt;</span>
<span class="p">&lt;/</span><span class="nt">form</span><span class="p">&gt;</span>
</code></pre></div>

<p>Notice the <code>up-autosubmit</code>; this will submit the form when a field changes. Also  the <code>up-delay</code> adds a small
delay before the form is submitted so when the user writes <code>foo</code> it will do 1 query instead of 3 (if he writes
fast enough of course). The <code>up-target</code> attribute is used to specify the element that will be updated with the
response. In this case we&#8217;re using a <code>form-data</code> element that includes the whole table (using django-tables2 of&nbsp;course):</p>
<div class="highlight"><pre><span></span><code><span class="p">&lt;</span><span class="nt">div</span> <span class="na">class</span><span class="o">=</span><span class="s">&#39;form-data&#39;</span><span class="p">&gt;</span>
  {% render_table table %}
<span class="p">&lt;/</span><span class="nt">div</span><span class="p">&gt;</span>
</code></pre></div>

<p>To open the links in a layer we only need to pass the correct parameters to the table field, for example in our case the table is like&nbsp;this:</p>
<div class="highlight"><pre><span></span><code><span class="k">class</span><span class="w"> </span><span class="nc">CompanyTable</span><span class="p">(</span><span class="n">tables</span><span class="o">.</span><span class="n">Table</span><span class="p">):</span>
    <span class="nb">id</span> <span class="o">=</span> <span class="n">tables</span><span class="o">.</span><span class="n">LinkColumn</span><span class="p">(</span>
        <span class="s2">&quot;company-detail&quot;</span><span class="p">,</span>
        <span class="n">args</span><span class="o">=</span><span class="p">[</span><span class="n">A</span><span class="p">(</span><span class="s2">&quot;id&quot;</span><span class="p">)],</span>
        <span class="n">attrs</span><span class="o">=</span><span class="p">{</span>
            <span class="s2">&quot;a&quot;</span><span class="p">:</span> <span class="p">{</span>
                <span class="s2">&quot;class&quot;</span><span class="p">:</span> <span class="s2">&quot;btn btn-primary btn-sm&quot;</span><span class="p">,</span>
                <span class="s2">&quot;up-on-dismissed&quot;</span><span class="p">:</span> <span class="s2">&quot;up.reload(&#39;.table&#39;, { focus: &#39;:main&#39; })&quot;</span><span class="p">,</span>
                <span class="s2">&quot;up-layer&quot;</span><span class="p">:</span> <span class="s2">&quot;new&quot;</span><span class="p">,</span>
            <span class="p">}</span>
        <span class="p">},</span>
    <span class="p">)</span>

    <span class="k">class</span><span class="w"> </span><span class="nc">Meta</span><span class="p">:</span>
        <span class="n">model</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">Company</span>
        <span class="n">template_name</span> <span class="o">=</span> <span class="s2">&quot;django_tables2/bootstrap4.html&quot;</span>
        <span class="n">fields</span> <span class="o">=</span> <span class="p">(</span><span class="s2">&quot;id&quot;</span><span class="p">,</span> <span class="s2">&quot;name&quot;</span><span class="p">,</span> <span class="s2">&quot;address&quot;</span><span class="p">)</span>
</code></pre></div>

<p>So we a pass the attributes directly to the link&#8217;s <code>a</code> element. Nothing really fancy is&nbsp;needed.</p>
<p>Furthermore, notice that we use the builtin bootstrap4 template. We don&#8217;t change the template at all. The original django-tables2 template does <em>not</em> have <code>unpoly</code> interation! So if we leave it like this the pagination
and header links will start a full request/response. To fix that, we could override the template with our own however this is not the ideal solution for&nbsp;me. </p>
<p>Instead, we can use <code>up.compiler</code>: </p>
<div class="highlight"><pre><span></span><code><span class="nx">up</span><span class="p">.</span><span class="nx">compiler</span><span class="p">(</span><span class="s1">&#39;.pagination .page-item a.page-link&#39;</span><span class="p">,</span><span class="w"> </span><span class="p">(</span><span class="nx">link</span><span class="p">)</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="nx">link</span><span class="p">.</span><span class="nx">setAttribute</span><span class="p">(</span><span class="s1">&#39;up-target&#39;</span><span class="p">,</span><span class="w"> </span><span class="s2">&quot;.table-container&quot;</span><span class="p">)</span>
<span class="p">})</span>

<span class="nx">up</span><span class="p">.</span><span class="nx">compiler</span><span class="p">(</span><span class="s1">&#39;th.orderable a[href]&#39;</span><span class="p">,</span><span class="w"> </span><span class="p">(</span><span class="nx">link</span><span class="p">)</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="nx">link</span><span class="p">.</span><span class="nx">setAttribute</span><span class="p">(</span><span class="s1">&#39;up-target&#39;</span><span class="p">,</span><span class="w"> </span><span class="s2">&quot;.table-container&quot;</span><span class="p">)</span>
<span class="p">})</span>
</code></pre></div>

<p>The <code>up.compiler</code> function takes a <span class="caps">CSS</span> selector and a callback function. The callback function is called
when a snippet matching the selector is added to the <span class="caps">DOM</span>. In this case we&#8217;re adding the <code>up-target='.table-container'</code> unpoly attributes
to both the pagination and the table header order links. The <code>.table-container</code> is the element that contains the table (it is added by&nbsp;django-tables2).</p>
<p>This way, when unpoly sees these links it will add the <code>up-target</code> attribute (and functionality) to these without  the need to override any&nbsp;templates.</p>
<h2 id="advanced-concepts">Advanced&nbsp;concepts</h2>
<p>We&#8217;ll discuss some more advanced concepts of unpoly&nbsp;now.</p>
<h3 id="more-about-upcompiler">More about&nbsp;up.compiler</h3>
<p>The <code>up.compiler</code> function is <a href="https://unpoly.com/up.compiler">very powerful</a>. We already used it to add functionality to
all our nav links (see the navigation aliases before) to avoid forgetting it and to add the <code>up-target</code> to our table links
to avoid overriding the django-table2&nbsp;templates.</p>
<p>Beyond these, the most important functionality of <code>up.compiler</code> is to replace the javascript on load (or jquery <code>$(function() {})</code>) event.
Most common javascript libraries will be initialized when the document is ready. Unfortunately, when a page is loaded through unpoly
this event will <em>not</em> be trigger, so the javascript elements will not be initialized! Let&#8217;s suppose that we&#8217;ve got a bunch traditional jquery ui datepicker elements and all these have the <code>.datepicker</code> css class. Normally we&#8217;d initialize it&nbsp;like</p>
<div class="highlight"><pre><span></span><code><span class="nx">$</span><span class="p">(</span><span class="kd">function</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="nx">$</span><span class="p">(</span><span class="s1">&#39;.datepicker&#39;</span><span class="p">).</span><span class="nx">datepicker</span><span class="p">()</span>
<span class="p">})</span>
</code></pre></div>

<p>If we are to load a form with these elements through unpoly we won&#8217;t get the datepicker functionality. To fix this we can use <code>up.compiler</code>:</p>
<div class="highlight"><pre><span></span><code><span class="nx">up</span><span class="p">.</span><span class="nx">compiler</span><span class="p">(</span><span class="s1">&#39;.datepicker&#39;</span><span class="p">,</span><span class="w"> </span><span class="p">(</span><span class="nx">element</span><span class="p">)</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="nx">$</span><span class="p">(</span><span class="nx">element</span><span class="p">).</span><span class="nx">datepicker</span><span class="p">()</span>
<span class="p">})</span>
</code></pre></div>

<p>So when unpoly sees a <code>.datepicker</code> element it will call that callback function and initialize it! This will work properly if you follow links through <code>up-follow</code> or open new overlays with <code>up-layer='new'</code>.</p>
<h3 id="passing-context-from-unpoly-to-server">Passing context from unpoly to&nbsp;server</h3>
<p>Unpoly has an <code>up-context</code> attribute that can be used to pass context to the server. This must be a json object and can then be used to change the response based on that context. If we are using the unpoly python package then the context will be available in the <code>request.up.context</code> dictionary.</p>
<p>Let&#8217;s see a particular example from the demo. When we create a new task we&#8217;ve got the following&nbsp;link:</p>
<div class="highlight"><pre><span></span><code><span class="p">&lt;</span><span class="nt">a</span>
    <span class="na">class</span><span class="o">=</span><span class="s">&#39;btn btn-primary&#39;</span>
    <span class="na">up-layer</span><span class="o">=</span><span class="s">&#39;new&#39;</span>
    <span class="na">up-context</span><span class="o">=</span><span class="s">&#39;{&quot;new_task&quot;: true}&#39;</span>
    <span class="na">up-accept-location</span><span class="o">=</span><span class="s">&#39;/core/tasks/detail/$id/&#39;</span>
    <span class="na">up-on-accepted</span><span class="o">=</span><span class="s">&quot;reloadWithFlash(&#39;.tasks&#39;, &#39;Task created!&#39;)&quot;</span>
    <span class="na">href</span><span class="o">=</span><span class="s">&#39;{% url &quot;task-create&quot; %}&#39;</span><span class="p">&gt;</span>New task<span class="p">&lt;/</span><span class="nt">a</span><span class="p">&gt;</span>
<span class="p">&lt;/</span><span class="nt">div</span><span class="p">&gt;</span>
</code></pre></div>

<p>Compare this with the edit&nbsp;link: </p>
<div class="highlight"><pre><span></span><code><span class="p">&lt;</span><span class="nt">a</span> <span class="na">up-target</span><span class="o">=</span><span class="s">&#39;.task&#39;</span> <span class="na">href</span><span class="o">=</span><span class="s">&#39;{% url &quot;task-update&quot; task.id %}&#39;</span> <span class="na">class</span><span class="o">=</span><span class="s">&#39;btn btn-sm btn-outline-secondary&#39;</span><span class="p">&gt;</span>Edit<span class="p">&lt;/</span><span class="nt">a</span><span class="p">&gt;</span>
</code></pre></div>

<p>Notice that the <code>up-context</code> is only included in the new link. Now, let&#8217;s see how the task form is&nbsp;implemented:</p>
<div class="highlight"><pre><span></span><code><span class="p">&lt;</span><span class="nt">form</span> <span class="na">up-submit</span> <span class="err">{%</span> <span class="na">if</span> <span class="na">not</span> <span class="na">up</span><span class="err">.</span><span class="na">context</span><span class="err">.</span><span class="na">new_task</span> <span class="err">%}</span><span class="na">up-target</span><span class="o">=</span><span class="s">&#39;.task&#39;</span><span class="err">{%</span> <span class="na">endif</span> <span class="err">%}</span> <span class="na">class</span><span class="o">=</span><span class="s">&#39;task card&#39;</span> <span class="na">method</span><span class="o">=</span><span class="s">&quot;POST&quot;</span><span class="p">&gt;</span>
    {% csrf_token %}
    <span class="p">&lt;</span><span class="nt">div</span> <span class="na">class</span><span class="o">=</span><span class="s">&quot;card-body d-flex flex-column&quot;</span><span class="p">&gt;</span>
        <span class="p">&lt;</span><span class="nt">div</span> <span class="na">class</span><span class="o">=</span><span class="s">&quot;form-group flex-grow-1 mb-0&quot;</span><span class="p">&gt;</span>
            {{ form|crispy }}
        <span class="p">&lt;/</span><span class="nt">div</span><span class="p">&gt;</span>
        <span class="p">&lt;</span><span class="nt">div</span> <span class="na">class</span><span class="o">=</span><span class="s">&quot;flex-grow-0&quot;</span><span class="p">&gt;</span>
            <span class="p">&lt;</span><span class="nt">input</span> <span class="na">type</span><span class="o">=</span><span class="s">&#39;submit&#39;</span> <span class="na">class</span><span class="o">=</span><span class="s">&#39;btn btn-primary mt-2&#39;</span> <span class="na">value</span><span class="o">=</span><span class="s">&#39;Save&#39;</span><span class="p">&gt;</span>
        <span class="p">&lt;/</span><span class="nt">div</span><span class="p">&gt;</span>
    <span class="p">&lt;/</span><span class="nt">div</span><span class="p">&gt;</span>
<span class="p">&lt;/</span><span class="nt">form</span><span class="p">&gt;</span>
</code></pre></div>

<p>So, using Django we check to see if there&#8217;s <code>new_task</code> in the context and add an <code>up-target='.task'</code> if <em>not</em>. This way, we&#8217;ll get an <code>up-target='.task'</code> in the form <em>only</em> if we click the edit task button. Beyond this the form  is the same for both the new and edit&nbsp;links. </p>
<p>This is needed because when we open the edit task it will be loaded in the same <code>.task</code> element we clicked the edit 
link from (remember that unpoly is smart enough <a href="https://unpoly.com/fragment-placement#interaction-origin-is-considered">to match closer elements</a>). When the form is submitted we want the detail view of 
the task to also be rendered on the same <code>.task</code> element so we use the <code>up-target='.task'</code>. This isn&#8217;t needed in
the create new since it will be rendered in a new layer and we want to reload the the tasks with the flash message
when the new task is&nbsp;created. </p>
<p>Please notice that if we were to use <code>up-target='.task'</code> for both the new and edit form we&#8217;d get an error when
the new task form was submitted because it wouldn&#8217;t be able to match the target <code>.task</code> element!</p>
<h3 id="listening-to-unpoly-events">Listening to unpoly&nbsp;events</h3>
<p>For most things happening in unpoly you&#8217;ll find out that there are events that you can listen to and add behavior. There are cases where handling these is&nbsp;useful. </p>
<p>For example, I&#8217;ve observed that if you&#8217;re using bootstrap dropdowns and click a link while the dropdowns are <em>opened</em>, the dropdowns <em>will remain open</em> when the fragment has been loaded! This is very annoying. One simple way to resolve that is include the navigation inside your <code>up-main</code> element so the dropdowns will be reloaded. However there&#8217;s a better way by using unpoly events like in the following&nbsp;snippet:</p>
<div class="highlight"><pre><span></span><code><span class="w">    </span><span class="nx">up</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s1">&#39;up:link:follow&#39;</span><span class="p">,</span><span class="w"> </span><span class="kd">function</span><span class="p">(</span><span class="nx">event</span><span class="p">,</span><span class="w"> </span><span class="nx">link</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="c1">// Hide visible dropdowns</span>
<span class="w">      </span><span class="kd">const</span><span class="w"> </span><span class="nx">dropdownElementList</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">document</span><span class="p">.</span><span class="nx">querySelectorAll</span><span class="p">(</span><span class="s1">&#39;.dropdown-toggle.show&#39;</span><span class="p">)</span>
<span class="w">      </span><span class="kd">const</span><span class="w"> </span><span class="nx">dropdownList</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">[...</span><span class="nx">dropdownElementList</span><span class="p">].</span><span class="nx">map</span><span class="p">(</span><span class="nx">dropdownToggleEl</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="ow">new</span><span class="w"> </span><span class="nx">bootstrap</span><span class="p">.</span><span class="nx">Dropdown</span><span class="p">(</span><span class="nx">dropdownToggleEl</span><span class="p">))</span>
<span class="w">      </span><span class="nx">dropdownList</span><span class="p">.</span><span class="nx">forEach</span><span class="p">(</span><span class="nx">dropdown</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="nx">dropdown</span><span class="p">.</span><span class="nx">hide</span><span class="p">())</span>
<span class="w">    </span><span class="p">})</span>
</code></pre></div>

<p>Please notice that this code is for bootstrap 5 (not 4 as the remaining code in the demo since it&#8217;s from a different project). So what happens is that whenever a link is followed from unpoly we&#8217;ll clear the open dropdowns (the code isn&#8217;t very important&nbsp;here).</p>
<h3 id="updating-history">Updating&nbsp;history</h3>
<p>One thing to consider when using unpoly is <em>when</em> we actually need to update the browser history and url.
<a href="https://unpoly.com/a-up-follow#up-history">By default</a>, unpoly will update the url only if the <code>up-target</code>
matches <code>up-main</code> (so if there&#8217;s no <code>up-target</code> the url will always be&nbsp;upgraded).</p>
<p>This can be configured through the <code>up-history</code> attribute. By default this has the value <code>'auto'</code> and we can
set to <code>'true'</code> or <code>'false'</code> if we want to configure it so that unpoly updates the history or not for a particlar
link or form&nbsp;submission. </p>
<p>Let&#8217;s see a particular example from the demo. Because the <code>up-target</code> of the filter form on the is set to <code>.form-data</code>:</p>
<div class="highlight"><pre><span></span><code><span class="p">&lt;</span><span class="nt">form</span> <span class="na">up-autosubmit</span> <span class="na">up-delay</span><span class="o">=</span><span class="s">&#39;250&#39;</span> <span class="na">class</span><span class="o">=</span><span class="s">&#39;form-inline&#39;</span> <span class="na">method</span><span class="o">=</span><span class="s">&#39;GET&#39;</span> <span class="na">action</span><span class="o">=</span><span class="s">&#39;&#39;</span> <span class="na">up-target</span><span class="o">=</span><span class="s">&#39;.form-data&#39;</span><span class="p">&gt;</span>
</code></pre></div>

<p>the url will not be updated when the filter is changed. This is contrary to the usual way these kind of  filters work 
(i.e update the url with the filter parameters). So we can add the  <code>up-history</code> attribute:</p>
<div class="highlight"><pre><span></span><code><span class="p">&lt;</span><span class="nt">form</span> <span class="na">up-autosubmit</span> <span class="na">up-history</span><span class="o">=</span><span class="s">&#39;true&#39;</span> <span class="na">up-delay</span><span class="o">=</span><span class="s">&#39;250&#39;</span> <span class="na">class</span><span class="o">=</span><span class="s">&#39;form-inline&#39;</span> <span class="na">method</span><span class="o">=</span><span class="s">&#39;GET&#39;</span> <span class="na">action</span><span class="o">=</span><span class="s">&#39;&#39;</span> <span class="na">up-target</span><span class="o">=</span><span class="s">&#39;.form-data&#39;</span><span class="p">&gt;</span>
</code></pre></div>

<p>The same applies for the pagination and header ordering links. They update the <code>.table-container</code> element so we&#8217;ll need
to add <code>up-history=true</code> also to them. Thus we&#8217;ll change the <code>up.compiler</code> for these elements like&nbsp;this:</p>
<div class="highlight"><pre><span></span><code><span class="nx">up</span><span class="p">.</span><span class="nx">compiler</span><span class="p">(</span><span class="s1">&#39;.pagination .page-item a.page-link&#39;</span><span class="p">,</span><span class="w"> </span><span class="p">(</span><span class="nx">link</span><span class="p">)</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="nx">link</span><span class="p">.</span><span class="nx">setAttribute</span><span class="p">(</span><span class="s1">&#39;up-follow&#39;</span><span class="p">,</span><span class="w"> </span><span class="nx">link</span><span class="p">.</span><span class="nx">href</span><span class="p">)</span>
<span class="w">  </span><span class="nx">link</span><span class="p">.</span><span class="nx">setAttribute</span><span class="p">(</span><span class="s1">&#39;up-target&#39;</span><span class="p">,</span><span class="w"> </span><span class="s2">&quot;.table-container&quot;</span><span class="p">)</span>
<span class="w">  </span><span class="nx">link</span><span class="p">.</span><span class="nx">setAttribute</span><span class="p">(</span><span class="s1">&#39;up-history&#39;</span><span class="p">,</span><span class="w"> </span><span class="s2">&quot;true&quot;</span><span class="p">)</span>
<span class="p">})</span>

<span class="nx">up</span><span class="p">.</span><span class="nx">compiler</span><span class="p">(</span><span class="s1">&#39;th.orderable a[href]&#39;</span><span class="p">,</span><span class="w"> </span><span class="p">(</span><span class="nx">link</span><span class="p">)</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="nx">link</span><span class="p">.</span><span class="nx">setAttribute</span><span class="p">(</span><span class="s1">&#39;up-follow&#39;</span><span class="p">,</span><span class="w"> </span><span class="nx">link</span><span class="p">.</span><span class="nx">href</span><span class="p">)</span>
<span class="w">  </span><span class="nx">link</span><span class="p">.</span><span class="nx">setAttribute</span><span class="p">(</span><span class="s1">&#39;up-target&#39;</span><span class="p">,</span><span class="w"> </span><span class="s2">&quot;.table-container&quot;</span><span class="p">)</span>
<span class="w">  </span><span class="nx">link</span><span class="p">.</span><span class="nx">setAttribute</span><span class="p">(</span><span class="s1">&#39;up-history&#39;</span><span class="p">,</span><span class="w"> </span><span class="s2">&quot;true&quot;</span><span class="p">)</span>
<span class="p">})</span>
</code></pre></div>

<p>This way, both the ordering links and the selected page will be reflected on the url&nbsp;history. </p>
<p>The final result is that this filter/table page will have the usual functionality of updating the url when the filter
is changed or the table sorting/pagination links are&nbsp;used.</p>
<h3 id="troubleshooting">Troubleshooting</h3>
<p>As I&#8217;ve already mentioned, the most common problem you are going to have with unpoly is when you use javascript on your page ready event. Unfortunately there&#8217;s a lot of functionality that relies on that event and pages will break when you use unpoly in these cases. That&#8217;s why I recommend to use <code>up-follow</code> and <code>up-submit</code> for your links and forms on a case-by-case basis on non greenfield projects so you&#8217;ve got more control on what works with unpoly and what is not working. Another thing that is very important to notice here is that I&#8217;ve stumbled upon libraries that not only rely on the load event but actually <em>there&#8217;s no other way to initialize them</em>! For example, there&#8217; are js libraries that have code&nbsp;like </p>
<div class="highlight"><pre><span></span><code><span class="nx">$</span><span class="p">(</span><span class="kd">function</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="kd">let</span><span class="w"> </span><span class="nx">initElement</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kd">function</span><span class="p">(</span><span class="nx">el</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="p">...</span>
<span class="w">  </span><span class="p">}</span>
<span class="w">  </span><span class="nx">$</span><span class="p">(</span><span class="s1">&#39;.selected-elements&#39;</span><span class="p">).</span><span class="nx">each</span><span class="p">(</span><span class="kd">function</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nx">initElement</span><span class="p">(</span><span class="k">this</span><span class="p">)</span>
<span class="w">  </span><span class="p">})</span>
<span class="p">})</span>
</code></pre></div>

<p>so the actual function that does the initialization (<code>initElement</code>) isn&#8217;t public and you can&#8217;t call it from the <code>up.compiler</code>. In these cases you&#8217;ll need to somehow make the <code>initElement</code> public so you can call it from the <code>up.compiler</code> or use a different&nbsp;library!</p>
<p>The other major case for headaches in unpoly overlays. Although they are very powerful I recommend to <em>not</em> abuse them and use them only when you feel that are really needed and would improve the <span class="caps">UX</span> of the user. For example, I&#8217;d recommend using them to add new options on a select list (similar to how the project form works for companies and of course similar to how django admin does it). Also you could use overlays to have a functionality similar to django-inlines (see how the projects are added to the company) however I&#8217;d probably prefer to do that using normal django inlines especially when the standalone child edit functionality isn&#8217;t&nbsp;needed.</p>
<p>Special care must be taken for the integration between layers and messages. I have tried to provide a solution in the previous sections by proposing flashing the message with javascript on the cases where the message will be &#8220;eaten&#8221; by a discarded response however I&#8217;m afraid that depending on how you&#8217;ve architectured your app you&#8217;ll may still get problems. The important thing is to understand how messages work (or not) and in which cases you may skip using messages at all since the feedback would be immediate and the users don&#8217;t really need&nbsp;messages.</p>
<h2 id="conclusion">Conclusion</h2>
<p>In conclusion, using unpoly with your Django apps can enhance the <span class="caps">UX</span> of your users by reducing page reloads and providing a more responsive and intuitive interface with little work from the developer. I recommend everybody to start integrating unpoly in their projects and see how it can improve the <span class="caps">UX</span> of your&nbsp;users!</p></div>
  		</article>
  		<article>
<header>
      <h1 class="entry-title">
        <a href="https://www.spapas.net/2023/03/22/access-microsoft-access-python-django/">Accessing MS Access databases from Python and Django</a>
      </h1>
    <p class="meta">
<time datetime="2023-03-22T15:20:00+02:00" pubdate>Wed 22 March 2023</time>    </p>
</header>

<div class="entry-content"><p>Have you ever needed to use data from a Microsoft Access database on a Django project? 
If so, you might have found that the data is contained in an .accdb file, which can make accessing it a challenge.
Actually, access files are either .mdb (older versions) and .accdb (more current versions); although the 
.mdb files is easier to access from python, most Access database would be .accdb&nbsp;nowadays.</p>
<p>The naive/simple way to access this data is to bite the bullet, install Access on your computer 
and use it to export the tables one by one in a 
more &#8220;open&#8221; format (i.e xlsx files). After some research I found out that there are ways to connect to 
this Access database through python and querying it directly. Thus I decided to implement a more automatic method 
of exporting your data. In this article, I&#8217;ll walk you through the steps to accomplish this, 
specifically we&#8217;ll cover how&nbsp;to:</p>
<ul>
<li>Connect to an accdb&nbsp;database </li>
<li>Export all the tables of that database to a json&nbsp;file</li>
<li>Create a models.py based on the exported&nbsp;data</li>
<li>Import the json data that was exported into the newly created&nbsp;models</li>
</ul>
<p>For the first two steps we&#8217;ll only use python. For the last two we&#8217;ll also need some Django.
By the end of this article, you&#8217;ll have a streamlined process for accessing your Microsoft 
Access data in your Django&nbsp;projects.</p>
<h2 id="connecting-to-a-microsoft-access-database-from-python">Connecting to a Microsoft Access database from&nbsp;python</h2>
<p>To be able to connect to an Access database from python you can use the
<a href="https://github.com/pypyodbc/pypyodbc">pypyodbc</a>. This is a pure-python library that can connect
to <span class="caps">ODBC</span>. To install it run <code>pip install pypyodbc</code>; since this is a pure-python the installation should
be always&nbsp;successfull.</p>
<p>However, there is an important caveat when working with .accdb databases:
<em>You must use Windows</em> and install 
<a href="https://www.microsoft.com/en-US/download/details.aspx?id=13255">Microsoft Access Database Engine 2010 Redistributable</a>.
This is necessary to ensure that the correct drivers are available, you can also take a look at 
the instructions from pyodbc <a href="https://github.com/mkleehammer/pyodbc/wiki/Connecting-to-Microsoft-Access">here</a>.</p>
<p>When installing the Access Redistributable, it&#8217;s crucial to remember that you need to install
either the 32-bit or 64-bit of the Access Redistributable 
depending on your python (you can&#8217;t install both). 
To check if your python is 32bit or 64bit run <code>python</code> and check if it says 32 or 64 bit. Also
please notice that you may be able to install <em>only</em> the 32bit or <em>only</em> the 64bit version if you have an <span class="caps">MS</span> Office installed
(the Access Redistributable will match the <span class="caps">MS</span> Office&nbsp;bitness).</p>
<p>If that&#8217;s the case then my recommendation would be to generate a new virtualenv (similiar to the bitness of the 
Access Redistributable you&#8217;ve installed on your system). Then install pypyodbc on that virtualenv and you should be&nbsp;fine.</p>
<p>If you want to use a .mdb database you should be able to do it without installing anything on Windows and it also should
be possible on Unix (I haven&#8217;t tested it&nbsp;though). </p>
<p>To ensure that you&#8217;ve got the correct drivers, run the following snippet
on a python&nbsp;shell:</p>
<div class="highlight"><pre><span></span><code><span class="kn">import</span><span class="w"> </span><span class="nn">pypyodbc</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">pypyodbc</span><span class="o">.</span><span class="n">drivers</span><span class="p">()))</span>
</code></pre></div>

<p>If you have installed the correct Microsoft Access Database Engine 2010 Redistributable you should see .accdb somewhere in the output, like&nbsp;this:</p>
<div class="highlight"><pre><span></span><code>Microsoft Access Driver (*.mdb)
Microsoft dBase Driver (*.dbf)
Microsoft Excel Driver (*.xls)
Microsoft ODBC for Oracle
Microsoft Paradox Driver (*.db )
Microsoft Text Driver (*.txt; <span class="gs">*.csv)</span>
<span class="gs">SQL Server</span>
<span class="gs">Oracle in OraClient10g_home1</span>
<span class="gs">SQL Server Native Client 11.0</span>
<span class="gs">ODBC Driver 17 for SQL Server</span>
<span class="gs">Microsoft Access Driver (*</span>.mdb, <span class="gs">*.accdb)</span>
<span class="gs">Microsoft Excel Driver (*</span>.xls, <span class="gs">*.xlsx, *</span>.xlsm, <span class="gs">*.xlsb)</span>
<span class="gs">Microsoft Access dBASE Driver (*</span>.dbf, <span class="gs">*.ndx, *</span>.mdx)
Microsoft Access Text Driver (*.txt, *.csv)
</code></pre></div>

<p>If on the other hand you can&#8217;t access .accdb files you&#8217;ll get much less&nbsp;options:</p>
<div class="highlight"><pre><span></span><code><span class="nv">SQL</span><span class="w"> </span><span class="nv">Server</span>
<span class="nv">PostgreSQL</span><span class="w"> </span><span class="nv">ANSI</span><span class="ss">(</span><span class="nv">x64</span><span class="ss">)</span>
<span class="nv">PostgreSQL</span><span class="w"> </span><span class="nv">Unicode</span><span class="ss">(</span><span class="nv">x64</span><span class="ss">)</span>
<span class="nv">PostgreSQL</span><span class="w"> </span><span class="nv">ANSI</span>
<span class="nv">PostgreSQL</span><span class="w"> </span><span class="nv">Unicode</span>
<span class="nv">SQL</span><span class="w"> </span><span class="nv">Server</span><span class="w"> </span><span class="nv">Native</span><span class="w"> </span><span class="nv">Client</span><span class="w"> </span><span class="mi">11</span>.<span class="mi">0</span>
<span class="nv">ODBC</span><span class="w"> </span><span class="nv">Driver</span><span class="w"> </span><span class="mi">17</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="nv">SQL</span><span class="w"> </span><span class="nv">Server</span>
</code></pre></div>

<p>In any case, after you&#8217;ve installed the correct drivers you can connect to the database 
(let&#8217;s suppose it&#8217;s named <code>access_data.accdb</code> on the parent directory) like&nbsp;this:</p>
<div class="highlight"><pre><span></span><code><span class="kn">import</span><span class="w"> </span><span class="nn">pypyodbc</span>

<span class="n">pypyodbc</span><span class="o">.</span><span class="n">lowercase</span> <span class="o">=</span> <span class="kc">False</span>
<span class="n">conn</span> <span class="o">=</span> <span class="n">pypyodbc</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span>
    <span class="sa">r</span><span class="s2">&quot;Driver={Microsoft Access Driver (*.mdb, *.accdb)};&quot;</span>
    <span class="o">+</span> <span class="sa">r</span><span class="s2">&quot;Dbq=..</span><span class="se">\\</span><span class="s2">access_data.accdb;&quot;</span>
<span class="p">)</span>
<span class="n">cur</span> <span class="o">=</span> <span class="n">conn</span><span class="o">.</span><span class="n">cursor</span><span class="p">()</span>

<span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">cur</span><span class="o">.</span><span class="n">tables</span><span class="p">(</span><span class="n">tableType</span><span class="o">=</span><span class="s2">&quot;TABLE&quot;</span><span class="p">):</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">row</span><span class="p">)</span>
</code></pre></div>

<p>If everything&#8217;s ok the above will print all the tables that are contained in the&nbsp;database.</p>
<h2 id="exporting-the-data-from-the-access-database-to-a-json-file">Exporting the data from the Access database to a json&nbsp;file</h2>
<p>After you&#8217;re able to connect to the database you can export all the data to a json file. Actually we&#8217;ll export both the data of the database and a &#8220;description&#8221; of the data (the names of the tables along with their columns and types). The description of the data will be useful&nbsp;later. </p>
<p>The general idea&nbsp;is:</p>
<ol>
<li>Connect the&nbsp;database</li>
<li>Get the names of the tables in a&nbsp;list</li>
<li>For each table<ul>
<li>Export a description of its&nbsp;columns</li>
<li>Export all its&nbsp;data</li>
</ul>
</li>
<li>Write the description and the data to two json&nbsp;files</li>
</ol>
<p>This is done by running the following&nbsp;snippet:</p>
<div class="highlight"><pre><span></span><code><span class="kn">import</span><span class="w"> </span><span class="nn">pypyodbc</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">struct</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">json</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">datetime</span><span class="w"> </span><span class="kn">import</span> <span class="n">datetime</span><span class="p">,</span> <span class="n">date</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">decimal</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;running as </span><span class="si">{0}</span><span class="s2">-bit&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">struct</span><span class="o">.</span><span class="n">calcsize</span><span class="p">(</span><span class="s2">&quot;P&quot;</span><span class="p">)</span> <span class="o">*</span> <span class="mi">8</span><span class="p">))</span>

<span class="k">def</span><span class="w"> </span><span class="nf">normalize</span><span class="p">(</span><span class="n">s</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;A simple function to normalize table names&quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">s</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot; &quot;</span><span class="p">,</span> <span class="s2">&quot;_&quot;</span><span class="p">)</span>


<span class="n">conn</span> <span class="o">=</span> <span class="n">pypyodbc</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span>
    <span class="sa">r</span><span class="s2">&quot;Driver={Microsoft Access Driver (*.mdb, *.accdb)};&quot;</span>
    <span class="o">+</span> <span class="sa">r</span><span class="s2">&quot;Dbq=..</span><span class="se">\\</span><span class="s2">access_data.accdb;&quot;</span>
<span class="p">)</span>
<span class="n">cur</span> <span class="o">=</span> <span class="n">conn</span><span class="o">.</span><span class="n">cursor</span><span class="p">()</span>
<span class="n">tables</span> <span class="o">=</span> <span class="p">[]</span>
<span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">cur</span><span class="o">.</span><span class="n">tables</span><span class="p">(</span><span class="n">tableType</span><span class="o">=</span><span class="s2">&quot;TABLE&quot;</span><span class="p">):</span>
    <span class="c1"># Only get the table names</span>
    <span class="n">tables</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">row</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span>

<span class="c1"># data will contain the data of all tables. It will have the following structure:</span>
<span class="c1"># {&quot;table_1&quot;: [{&quot;column_1&quot;: value, &quot;column_2&quot;: value}, ...], &quot;table_2&quot;: ...}</span>
<span class="n">data</span> <span class="o">=</span> <span class="p">{}</span>
<span class="c1"># descriptions will have  a description of all the tables. It will have the following structure:</span>
<span class="c1"># [</span>
<span class="c1">#   {</span>
<span class="c1">#       &quot;table_name&quot;: &quot;table 1&quot;,</span>
<span class="c1">#       &quot;fixed_table_name&quot;: &quot;table_1&quot;,</span>
<span class="c1">#       &quot;columns&quot;: [</span>
<span class="c1">#           {&quot;name&quot;: &quot;column_1&quot;, &quot;fixed_name&quot;: &quot;column_1&quot;,&quot;type&quot;: &quot;str&quot;},</span>
<span class="c1">#           {&quot;name&quot;: &quot;column_2&quot;, &quot;fixed_name&quot;: &quot;column_2&quot;,&quot;type&quot;: &quot;int&quot;},</span>
<span class="c1"># ]</span>
<span class="n">descriptions</span> <span class="o">=</span> <span class="p">[]</span>

<span class="k">for</span> <span class="n">table_name</span> <span class="ow">in</span> <span class="n">tables</span><span class="p">:</span>
    <span class="n">fixed_table_name</span> <span class="o">=</span> <span class="n">normalize</span><span class="p">(</span><span class="n">table_name</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;~~~~~~~~~~~~~</span><span class="si">{</span><span class="n">table_name</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">fixed_table_name</span><span class="si">}</span><span class="s2">~~~~~~~~~~~~~&quot;</span><span class="p">)</span>
    <span class="n">q</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;SELECT * FROM &quot;</span><span class="si">{</span><span class="n">table_name</span><span class="si">}</span><span class="s1">&quot;&#39;</span>
    <span class="n">description</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s2">&quot;table_name&quot;</span><span class="p">:</span> <span class="n">table_name</span><span class="p">,</span>
        <span class="s2">&quot;fixed_table_name&quot;</span><span class="p">:</span> <span class="n">fixed_table_name</span><span class="p">,</span>
        <span class="s2">&quot;columns&quot;</span><span class="p">:</span> <span class="p">[],</span>
    <span class="p">}</span>
    <span class="n">descriptions</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">description</span><span class="p">)</span>

    <span class="n">cur</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">q</span><span class="p">)</span>
    <span class="c1"># Here we get the description of the columns of the table from the cursor; we&#39;ll use that to fill the description.columns list</span>
    <span class="n">columns</span> <span class="o">=</span> <span class="n">cur</span><span class="o">.</span><span class="n">description</span>
    <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">columns</span><span class="p">:</span>
        <span class="n">description</span><span class="p">[</span><span class="s2">&quot;columns&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
            <span class="p">{</span><span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="n">c</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="s2">&quot;fixed_name&quot;</span><span class="p">:</span> <span class="n">normalize</span><span class="p">(</span><span class="n">c</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span> <span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="n">c</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="vm">__name__</span><span class="p">}</span>
        <span class="p">)</span>

    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;&quot;</span><span class="p">)</span>

    <span class="c1"># And here we retrieve the data of the whole table</span>
    <span class="c1"># Notice we use some double for loop comprehension to </span>
    <span class="c1"># create a json object with a column_name: value structure</span>
    <span class="c1"># for each row</span>
    <span class="n">data</span><span class="p">[</span><span class="n">fixed_table_name</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span>
        <span class="p">{</span><span class="n">normalize</span><span class="p">(</span><span class="n">columns</span><span class="p">[</span><span class="n">index</span><span class="p">][</span><span class="mi">0</span><span class="p">]):</span> <span class="n">column</span> <span class="k">for</span> <span class="n">index</span><span class="p">,</span> <span class="n">column</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">value</span><span class="p">)}</span>
        <span class="k">for</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">cur</span><span class="o">.</span><span class="n">fetchall</span><span class="p">()</span>
    <span class="p">]</span>

<span class="n">cur</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
<span class="n">conn</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

<span class="c1"># This is a function to serialize datetime and decimal objects </span>
<span class="c1"># to json; without it the json.dump function will fail if the </span>
<span class="c1"># results contain dates or decimals</span>
<span class="k">def</span><span class="w"> </span><span class="nf">json_serial</span><span class="p">(</span><span class="n">obj</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;JSON serializer for objects not serializable by default json code&quot;&quot;&quot;</span>

    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="p">(</span><span class="n">datetime</span><span class="p">,</span> <span class="n">date</span><span class="p">)):</span>
        <span class="k">return</span> <span class="n">obj</span><span class="o">.</span><span class="n">isoformat</span><span class="p">()</span>
    <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="n">decimal</span><span class="o">.</span><span class="n">Decimal</span><span class="p">):</span>
        <span class="k">return</span> <span class="nb">str</span><span class="p">(</span><span class="n">obj</span><span class="p">)</span>
    <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s2">&quot;Type </span><span class="si">%s</span><span class="s2"> not serializable&quot;</span> <span class="o">%</span> <span class="nb">type</span><span class="p">(</span><span class="n">obj</span><span class="p">))</span>


<span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="s2">&quot;..</span><span class="se">\\</span><span class="s2">access_description.json&quot;</span><span class="p">,</span> <span class="s2">&quot;w&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">outfile</span><span class="p">:</span>
    <span class="c1"># Notice the default=json_serial </span>
    <span class="n">json</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="n">descriptions</span><span class="p">,</span> <span class="n">outfile</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="n">json_serial</span><span class="p">)</span>

<span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="s2">&quot;..</span><span class="se">\\</span><span class="s2">access_data.json&quot;</span><span class="p">,</span> <span class="s2">&quot;w&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">outfile</span><span class="p">:</span>
    <span class="n">json</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">outfile</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="n">json_serial</span><span class="p">)</span>
</code></pre></div>

<p>If you run the above code and don&#8217;t see any errors you should have two json files in the parent directory: <code>access_description.json</code> and <code>access_data.json</code>. The dump of your access database is&nbsp;complete!</p>
<h2 id="creating-a-modelspy-based-on-the-exported-data">Creating a models.py based on the exported&nbsp;data</h2>
<p>Now that we have the description of the data in our database it is possible to create a small script that would help us
generate the models for importing that data into Django. This could by done by a snippet similar to&nbsp;this:</p>
<div class="highlight"><pre><span></span><code><span class="kn">import</span><span class="w"> </span><span class="nn">json</span>

<span class="k">def</span><span class="w"> </span><span class="nf">get_ctype</span><span class="p">(</span><span class="n">t</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Depending on the type of each column add a different field in the model&quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">t</span> <span class="o">==</span> <span class="s2">&quot;str&quot;</span><span class="p">:</span>
        <span class="k">return</span> <span class="s2">&quot;TextField(blank=True, )&quot;</span>
    <span class="k">elif</span> <span class="n">t</span> <span class="o">==</span> <span class="s2">&quot;int&quot;</span><span class="p">:</span>
        <span class="k">return</span> <span class="s2">&quot;IntegerField(blank=True, null=True)&quot;</span>
    <span class="k">elif</span> <span class="n">t</span> <span class="o">==</span> <span class="s2">&quot;float&quot;</span><span class="p">:</span>
        <span class="k">return</span> <span class="s2">&quot;FloatField(blank=True, null=True)&quot;</span>
    <span class="k">elif</span> <span class="n">t</span> <span class="o">==</span> <span class="s2">&quot;bool&quot;</span><span class="p">:</span>
        <span class="k">return</span> <span class="s2">&quot;BooleanField(blank=True, null=True)&quot;</span>
    <span class="k">elif</span> <span class="n">t</span> <span class="o">==</span> <span class="s2">&quot;datetime&quot;</span><span class="p">:</span>
        <span class="k">return</span> <span class="s2">&quot;DateTimeField(blank=True, null=True)&quot;</span>
    <span class="k">elif</span> <span class="n">t</span> <span class="o">==</span> <span class="s2">&quot;date&quot;</span><span class="p">:</span>
        <span class="k">return</span> <span class="s2">&quot;DateField(blank=True, null=True)&quot;</span>
    <span class="k">elif</span> <span class="n">t</span> <span class="o">==</span> <span class="s2">&quot;Decimal&quot;</span><span class="p">:</span>
        <span class="k">return</span> <span class="s2">&quot;DecimalField(blank=True, null=True, max_digits=15, decimal_places=5)&quot;</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">t</span><span class="p">)</span>
        <span class="k">raise</span> <span class="ne">NotImplementedError</span>

<span class="c1"># Load the descriptions we created in the previous step</span>
<span class="n">descriptions</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="nb">open</span><span class="p">(</span><span class="s2">&quot;..</span><span class="se">\\</span><span class="s2">access_description.json&quot;</span><span class="p">))</span>

<span class="c1"># mlines will be an array of the lines of the models.py file</span>
<span class="n">mlines</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;from django.db import models&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">]</span>

<span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="n">descriptions</span><span class="p">:</span>
    <span class="c1"># Create a model for each table</span>
    <span class="n">mname</span> <span class="o">=</span> <span class="n">d</span><span class="p">[</span><span class="s2">&quot;fixed_table_name&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">capitalize</span><span class="p">()</span>
    <span class="n">mlines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;class </span><span class="si">{</span><span class="n">mname</span><span class="si">}</span><span class="s2">(models.Model):&quot;</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">d</span><span class="p">[</span><span class="s2">&quot;columns&quot;</span><span class="p">]:</span>
        <span class="n">ctype</span> <span class="o">=</span> <span class="n">get_ctype</span><span class="p">(</span><span class="n">c</span><span class="p">[</span><span class="s2">&quot;type&quot;</span><span class="p">])</span>
        <span class="n">mlines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;    </span><span class="si">{</span><span class="n">c</span><span class="p">[</span><span class="s1">&#39;fixed_name&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2"> = models.</span><span class="si">{</span><span class="n">ctype</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="n">mlines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;&quot;</span><span class="p">)</span>
    <span class="n">mlines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;    class Meta:&quot;</span><span class="p">)</span>
    <span class="n">mlines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;        db_table = &#39;</span><span class="si">{</span><span class="n">d</span><span class="p">[</span><span class="s1">&#39;fixed_table_name&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&#39;&quot;</span><span class="p">)</span>
    <span class="n">mlines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;        verbose_name = &#39;</span><span class="si">{</span><span class="n">d</span><span class="p">[</span><span class="s1">&#39;table_name&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&#39;&quot;</span><span class="p">)</span>

    <span class="n">mlines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;&quot;</span><span class="p">)</span>
    <span class="n">mlines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;&quot;</span><span class="p">)</span>


<span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="s2">&quot;..</span><span class="se">\\</span><span class="s2">access_models.py&quot;</span><span class="p">,</span> <span class="s2">&quot;w&quot;</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="s2">&quot;utf-8&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">outfile</span><span class="p">:</span>
    <span class="n">outfile</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">mlines</span><span class="p">))</span>
</code></pre></div>

<p>This will generate a fine named access_models.py. You should edit this file a 
to add your primary and foreign keys. In an ideal world this would be done automatically,
however I couldn&#8217;t find a way to extract the primary and foreign keys of the tables from
the Access database. Also by default I&#8217;ve set all fields to allow blank and null values; please
you should fix that according to your&nbsp;needs.</p>
<p>After you edit the file, create a new app in your Django project and
copy the file to the models.py file of the new app. Add that app to your <code>INSTALLED_APPS</code> in
the settings.py file
and run <code>python manage.py migrate</code> to create the tables in your&nbsp;database.</p>
<h2 id="import-the-json-data-to-django">Import the json data to&nbsp;Django</h2>
<p>The final piece of the puzzle is to import the data we extracted before directly in Django.
Because we know the names of all the models and fields this is trivial to&nbsp;do:</p>
<div class="highlight"><pre><span></span><code><span class="kn">from</span><span class="w"> </span><span class="nn">django.core.management.base</span><span class="w"> </span><span class="kn">import</span> <span class="n">BaseCommand</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">json</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">django.db</span><span class="w"> </span><span class="kn">import</span> <span class="n">transaction</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">access_data</span><span class="w"> </span><span class="kn">import</span> <span class="n">models</span>

<span class="c1"># This is a list of all the fields that are foreign keys; these need special handling</span>
<span class="n">FK_FIELDS</span> <span class="o">=</span> <span class="p">[</span>
    <span class="c1"># ...</span>
<span class="p">]</span>

<span class="c1"># You need to add the table names from the access database here. This is required</span>
<span class="c1"># if you have relations in order to add first the tables without dependencies and last</span>
<span class="c1"># the tables that belong on these </span>
<span class="n">TABLE_NAMES</span> <span class="o">=</span> <span class="p">[</span>
    <span class="c1"># ...</span>
<span class="p">]</span>

<span class="k">def</span><span class="w"> </span><span class="nf">fix_fks</span><span class="p">(</span><span class="n">k</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Add _id to the end of the field name if it is a foreign key to pass the pk of the</span>
<span class="sd">    foreign key instead of the whole object&quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">FK_FIELDS</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">k</span> <span class="o">+</span> <span class="s1">&#39;_id&#39;</span>
    <span class="k">return</span> <span class="n">k</span>

<span class="k">def</span><span class="w"> </span><span class="nf">get_model_by_table</span><span class="p">(</span><span class="n">table</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Get the model by the table name&quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">models</span><span class="p">,</span> <span class="n">table</span><span class="o">.</span><span class="n">capitalize</span><span class="p">())</span>

<span class="k">class</span><span class="w"> </span><span class="nc">Command</span><span class="p">(</span><span class="n">BaseCommand</span><span class="p">):</span>

    <span class="nd">@transaction</span><span class="o">.</span><span class="n">atomic</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">handle</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">options</span><span class="p">):</span>

        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="s2">&quot;..</span><span class="se">\\</span><span class="s2">access_data.json&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="n">j</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>

        <span class="c1"># Delete the existing data before importing. This is optional but I find it useful</span>
        <span class="c1"># Notice that we delete the tables in reverse order to avoid foreign key errors</span>
        <span class="k">for</span> <span class="n">table</span> <span class="ow">in</span> <span class="nb">reversed</span><span class="p">(</span><span class="n">TABLE_NAMES</span><span class="p">):</span>
            <span class="n">get_model_by_table</span><span class="p">(</span><span class="n">table</span><span class="p">)</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">all</span><span class="p">()</span><span class="o">.</span><span class="n">delete</span><span class="p">()</span>

        <span class="k">for</span> <span class="n">table</span> <span class="ow">in</span> <span class="n">TABLE_NAMES</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">j</span><span class="p">[</span><span class="n">table</span><span class="p">]:</span>
                <span class="c1"># Create a dictionary with the column name: column value;</span>
                <span class="c1"># notice the fix_fks to add the _id to the column</span>
                <span class="n">row_ok</span> <span class="o">=</span> <span class="p">{</span><span class="n">fix_fks</span><span class="p">(</span><span class="n">k</span><span class="p">):</span> <span class="n">v</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span><span class="n">v</span> <span class="ow">in</span> <span class="n">row</span><span class="o">.</span><span class="n">items</span><span class="p">()}</span>
                <span class="nb">print</span><span class="p">(</span><span class="n">row_ok</span><span class="p">)</span>
                <span class="c1"># Create the object; we could add thse to an array and do a bulk_create instead</span>
                <span class="n">get_model_by_table</span><span class="p">(</span><span class="n">table</span><span class="p">)</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="o">**</span><span class="n">row_ok</span><span class="p">)</span>
</code></pre></div>

<p>The above code may error out if you have missing or bad data in your database. You should fix&nbsp;accordingly.</p>
<h2 id="conclusion">Conclusion</h2>
<p>In conclusion, accessing and using data from Microsoft Access databases in Django may seem daunting at first, 
but with the right tools and techniques, it can be a straightforward process. 
By using the pypyodbc library and following the instructions outlined in this post, you can connect to your 
.mdb or .accdb database and export its tables and schema to <span class="caps">JSON</span> files. 
From there, it is trivial to create a models.py file for Django and 
a management command to import the&nbsp;data.</p>
<p>Although I&#8217;ve presented these steps as separate snippets, you could also combine them into a 
single management command within Django. The possibilities are endless, and with a little bit of 
creativity, you can tailor this approach to your specific needs and&nbsp;data.</p></div>
  		</article>
  		<article>
<header>
      <h1 class="entry-title">
        <a href="https://www.spapas.net/2022/09/28/django-guidelines/">My essential guidelines for better Django development</a>
      </h1>
    <p class="meta">
<time datetime="2022-09-28T11:10:00+03:00" pubdate>Wed 28 September 2022</time>    </p>
</header>

<div class="entry-content"><div class="contents topic" id="contents">
<p class="topic-title"><a class="reference internal" href="#top">Contents</a></p>
<ul class="simple">
<li><a class="reference internal" href="#introduction" id="toc-entry-1">Introduction</a></li>
<li><a class="reference internal" href="#model-design-guidelines" id="toc-entry-2">Model design guidelines</a><ul>
<li><a class="reference internal" href="#avoid-using-choices" id="toc-entry-3">Avoid using&nbsp;choices</a></li>
<li><a class="reference internal" href="#always-use-surrogate-keys" id="toc-entry-4">Always use surrogate&nbsp;keys</a></li>
<li><a class="reference internal" href="#always-use-a-through-model-on-your-m2m-relations" id="toc-entry-5">Always use a through model on your m2m&nbsp;relations</a></li>
<li><a class="reference internal" href="#use-a-custom-user-model" id="toc-entry-6">Use a custom user&nbsp;model</a></li>
</ul>
</li>
<li><a class="reference internal" href="#views-guidelines" id="toc-entry-7">Views guidelines</a><ul>
<li><a class="reference internal" href="#use-class-based-views" id="toc-entry-8">Use class based&nbsp;views</a></li>
<li><a class="reference internal" href="#view-method-overriding-guidelines" id="toc-entry-9">View method overriding&nbsp;guidelines</a></li>
</ul>
</li>
<li><a class="reference internal" href="#querying-guidelines" id="toc-entry-10">Querying guidelines</a><ul>
<li><a class="reference internal" href="#guidelines-for-the-n-1-problem" id="toc-entry-11">Guidelines for the n+1&nbsp;problem</a></li>
<li><a class="reference internal" href="#re-use-your-queries" id="toc-entry-12">Re-use your&nbsp;queries</a></li>
</ul>
</li>
<li><a class="reference internal" href="#forms-guidelines" id="toc-entry-13">Forms guidelines</a><ul>
<li><a class="reference internal" href="#always-use-django-forms" id="toc-entry-14">Always use&nbsp;django-forms</a></li>
<li><a class="reference internal" href="#overriding-form-methods-guidelines" id="toc-entry-15">Overriding Form methods&nbsp;guidelines</a></li>
<li><a class="reference internal" href="#proper-cleaning" id="toc-entry-16">Proper&nbsp;cleaning</a></li>
<li><a class="reference internal" href="#overriding-the-init" id="toc-entry-17">Overriding the&nbsp;__init__</a></li>
<li><a class="reference internal" href="#laying-out-forms" id="toc-entry-18">Laying out&nbsp;forms</a></li>
<li><a class="reference internal" href="#improve-the-formset-functionality" id="toc-entry-19">Improve the formset&nbsp;functionality</a></li>
</ul>
</li>
<li><a class="reference internal" href="#template-guidelines" id="toc-entry-20">Template guidelines</a><ul>
<li><a class="reference internal" href="#stick-to-the-built-in-django-template-backend" id="toc-entry-21">Stick to the built-in Django template&nbsp;backend</a></li>
<li><a class="reference internal" href="#don-t-add-template-tags-when-you-can-use-a-method" id="toc-entry-22">Don&#8217;t add template tags when you can use a&nbsp;method</a></li>
<li><a class="reference internal" href="#re-use-templates-with-partials" id="toc-entry-23">Re-use templates with&nbsp;partials</a></li>
</ul>
</li>
<li><a class="reference internal" href="#settings-guidelines" id="toc-entry-24">Settings guidelines</a><ul>
<li><a class="reference internal" href="#use-a-package-instead-of-module" id="toc-entry-25">Use a package instead of&nbsp;module</a></li>
<li><a class="reference internal" href="#handle-secrets-properly" id="toc-entry-26">Handle secrets&nbsp;properly</a></li>
</ul>
</li>
<li><a class="reference internal" href="#static-and-media-guidelines" id="toc-entry-27">Static and media guidelines</a><ul>
<li><a class="reference internal" href="#use-manifeststaticfilesstorage" id="toc-entry-28">Use&nbsp;ManifestStaticFilesStorage</a></li>
<li><a class="reference internal" href="#organize-your-media-files" id="toc-entry-29">Organize your media&nbsp;files</a></li>
<li><a class="reference internal" href="#do-not-serve-media-through-your-application-server" id="toc-entry-30">Do not serve media through your application&nbsp;server</a></li>
<li><a class="reference internal" href="#secure-your-media-properly" id="toc-entry-31">Secure your media&nbsp;properly</a></li>
<li><a class="reference internal" href="#handle-stale-media" id="toc-entry-32">Handle stale&nbsp;media</a></li>
</ul>
</li>
<li><a class="reference internal" href="#debugging-guidelines" id="toc-entry-33">Debugging guidelines</a><ul>
<li><a class="reference internal" href="#be-careful-when-using-django-debug-toolbar" id="toc-entry-34">Be careful when using&nbsp;django-debug-toolbar</a></li>
<li><a class="reference internal" href="#use-the-werkzeug-debugger" id="toc-entry-35">Use the Werkzeug&nbsp;debugger</a></li>
</ul>
</li>
<li><a class="reference internal" href="#general-guidelines" id="toc-entry-36">General guidelines</a><ul>
<li><a class="reference internal" href="#consider-using-a-cookiecutter-project-template" id="toc-entry-37">Consider using a cookiecutter project&nbsp;template</a></li>
<li><a class="reference internal" href="#be-careful-on-your-selection-of-packages-addons" id="toc-entry-38">Be careful on your selection of&nbsp;packages/addons</a></li>
<li><a class="reference internal" href="#don-t-be-afraid-to-use-threadlocals" id="toc-entry-39">Don&#8217;t be afraid to use&nbsp;threadlocals</a></li>
<li><a class="reference internal" href="#the-async-tasks-situation" id="toc-entry-40">The async tasks&nbsp;situation</a></li>
</ul>
</li>
</ul>
</div>
<div class="section" id="introduction">
<h2><a class="toc-backref" href="#toc-entry-1">Introduction</a></h2>
<p>In this article I&#8217;d like to present a list of guidelines I follow when I develop
Django projects, especially projects that are destined to be used in a production
environment for many years. I am using django for more than 10 years as my day to
day work tool to develop applications for the public sector organization I work&nbsp;for.</p>
<p>My organization has got a number of different Django projects that cover its needs, with
some of them running successfully for a lot of years, since Django 1.4. I have
been involved in the development of all of them, and I have learned a lot in the process.
I understand that some of these may be controversial but they have served me well over these&nbsp;years.</p>
</div>
<div class="section" id="model-design-guidelines">
<h2><a class="toc-backref" href="#toc-entry-2">Model design&nbsp;guidelines</a></h2>
<div class="section" id="avoid-using-choices">
<h3><a class="toc-backref" href="#toc-entry-3">Avoid using&nbsp;choices</a></h3>
<p>Django has the convenient feature of allowing you to define <a class="reference external" href="https://docs.djangoproject.com/en/stable/ref/models/fields/#choices">choices for a field</a> by defining
a tuple of key-value pairs the field can take. So you&#8217;ll define a field like
<tt class="docutils literal">choice_field = models.CharField(choices=<span class="caps">CHOICES</span>)</tt> with <tt class="docutils literal"><span class="caps">CHOICES</span></tt> being a tuple&nbsp;like</p>
<div class="highlight"><pre><span></span><span class="n">CHOICES</span> <span class="o">=</span> <span class="p">(</span>
    <span class="p">(</span><span class="s1">&#39;CHOICE1&#39;</span><span class="p">,</span> <span class="s1">&#39;Choice 1 description&#39;</span><span class="p">),</span>
    <span class="p">(</span><span class="s1">&#39;CHOICE2&#39;</span><span class="p">,</span> <span class="s1">&#39;Choice 2 description&#39;</span><span class="p">),</span>
    <span class="p">(</span><span class="s1">&#39;CHOICE3&#39;</span><span class="p">,</span> <span class="s1">&#39;Choice 3 description&#39;</span><span class="p">),</span>
<span class="p">)</span>
</pre></div>
<p>and your database will contain <tt class="docutils literal"><span class="caps">CHOICE1</span></tt>, <tt class="docutils literal"><span class="caps">CHOICE2</span></tt> or <tt class="docutils literal"><span class="caps">CHOICE3</span></tt> as values for the field while your users will see
the corresponding&nbsp;description.</p>
<p>This is a great feature for prototyping however I
suggest to use it only on toy-prototyping-<span class="caps">MVP</span> projects and use normal relations in production projects instead. So the choice field
would be a Foreign Key and the choices would be tuples on the referenced table. The reasons for this&nbsp;are:</p>
<ul class="simple">
<li>The integrity of the choices is only on the application level. So people can go to the database and change a choice field with a random&nbsp;value.</li>
<li>More general, the database design is not normalized; saving <tt class="docutils literal"><span class="caps">CHOICE1</span></tt> for every row is not&nbsp;ideal.</li>
<li>Your users may want to edit the choices (add new ones) or change their descriptions. This is easy with a foreign key through the django-admin but needs a code change with&nbsp;choices.</li>
<li>It is almost sure that you will need to add &#8220;properties&#8221; to your choices. No matter what your current requirements are, they are going to change. For example, you may want to make a choice &#8220;obsolete&#8221; so it can&#8217;t be picked by users. This is trivial when you use a foreign key but not very easy when you use&nbsp;choices.</li>
<li>The values of the choices is saved only inside your app. The database has only the <tt class="docutils literal">'<span class="caps">CHOICE1</span>', '<span class="caps">CHOICE2</span>'</tt> etc values, so you&#8217;ll need to re-use the descriptions when your app is not used. For example, you may have reports that are generated directly from database queries so you&#8217;ll need to add the description of each key to your query using something like <tt class="docutils literal"><span class="caps">CASE</span></tt>.</li>
<li>It easier to use the <span class="caps">ORM</span> to annotate your queries when you use relations instead of the&nbsp;choices.</li>
</ul>
<p>The disadvantage of relations is of course that you&#8217;ll need to follow the relation to display the values. So you must be
careful to use <tt class="docutils literal">select_related</tt> to avoid the n+1 queries&nbsp;problem.</p>
<p>So, in short, I suggest to use choices only for quick prototyping and covert them to normal relations in production projects.
If you already are using choices in your project but want to convert them to normal relations, you can use take a look
at my <a class="reference external" href="https://www.spapas.net/2015/09/01/django-rq-redux/">Django choices to ForeignKey article</a>.</p>
</div>
<div class="section" id="always-use-surrogate-keys">
<h3><a class="toc-backref" href="#toc-entry-4">Always use surrogate&nbsp;keys</a></h3>
<p>A <a class="reference external" href="https://en.wikipedia.org/wiki/Surrogate_key">surrogate key</a> is a unique identifier for a database tuple which is used as the primary key. By default Django always adds a
surrogate key to your models. However, some people may be tempted to use a natural key as the primary key. Although this is possible
and supported in Django, I&#8217;d recommend to stick to integer surrogate keys. Why&nbsp;?</p>
<ul class="simple">
<li>Django is more or less build upon having integer primary keys. Although non-integer primary keys are supported in core Django, you can&#8217;t be assured that this will be supported by the various addons/packages that you&#8217;ll want to&nbsp;use.</li>
<li>I understand that your requirements say that &#8220;the field X will be unique and should be used to identify the row&#8221;. This is never true; this can easily be changed in the future and your primary key may stop being unique! It has happened to me and the solution was <em>not</em> something I&#8217;d like to discuss here. If there&#8217;s a field in the row that is guaranteed to be unique you can make it unique in the database level by adding <tt class="docutils literal"><span class="pre">unique==True</span></tt>; there&#8217;s no reason to also make it a primary&nbsp;key.</li>
<li>Relying on all your models having an <tt class="docutils literal">id</tt> integer primary key makes it easier to write your code and other people reading&nbsp;it.</li>
<li>Using an auto-increment primary key is the fastest way to insert a new row in the database (when compared to, for example using a random&nbsp;uuid)</li>
</ul>
<p>An even worse idea is to use composite keys (i.e define a primary key using two fields of your tuple). There&#8217;s actually
a <a class="reference external" href="https://code.djangoproject.com/ticket/373">17-year an open issue</a> about that in Django! This should be enough for you to understand that you shouldn&#8217;t touch that
with a 10-foot pole. Even if it is implemented somehow in core django, you&#8217;ll have something that can&#8217;t be used with all
other packages that rely on primary key being a single&nbsp;field.</p>
<p>Now, I understand that some public facing projects may not want to expose the auto-increment primary key since that discloses information
about the number of rows in the database, the number of rows that are added between a user&#8217;s tuples etc. In this case, you may want to
either add a unique uuid field, or a slug field, or even better use a library like hashid to convert your integer ids to hashes. I haven&#8217;t
used uuids myself, but for a slug field I had used the <a class="reference external" href="https://github.com/justinmayer/django-autoslug">django-autoslug</a> library and was very happy with&nbsp;it.</p>
<p>Concerning hashids, I&#8217;d recommend reading my <a class="reference external" href="https://www.spapas.net/2021/01/07/django-hashids/">Django hashids article</a>.</p>
</div>
<div class="section" id="always-use-a-through-model-on-your-m2m-relations">
<h3><a class="toc-backref" href="#toc-entry-5">Always use a through model on your m2m&nbsp;relations</a></h3>
<p>To add a many-to-many relation in Django, you&#8217;ll usually do something like <tt class="docutils literal">toppings = models.ManyToManyField(Topping)</tt>
(for a pizza). This is a very convenient but, similar to the choices I mentioned above, it is not a good practice for
production projects.
This is because your requirements <em>will</em> change and you&#8217;ll need to add properties to your m2m relation. Although this <em>is possible</em>,
it definitely is not pretty so it&#8217;s better to be safe than&nbsp;sorry.</p>
<p>When you use the <tt class="docutils literal">ManyToManyField</tt> field, django will generate an intermediate table with a name similar to app_model1_model2, i.e
for pizza and topping it will be <cite>pizzas_pizza_topping</cite>. This table will have 3 fields - the primary key, a foreign key to the pizza
table and a foreign key to the topping table. This is the default behavior of Django and it is not&nbsp;configurable.</p>
<p>What happens if you want to add a relation to the pizzas_pizza_topping table? For example, the amount of each topping on a pizza. Or
the fact that some pizzas used to have that topping but it has been replaced now by another one? This is not possible unless you use
a through table. As I said it is possible to fix that but it&#8217;s not something that you&#8217;ll want to&nbsp;do.</p>
<p>So, my recommendation is to <em>always</em> add a through table when you use a m2m relation. Create a model that will represent the relation
and has foreign keys to both tables along with any extra attributes the relation may&nbsp;have.</p>
<div class="highlight"><pre><span></span><span class="k">class</span><span class="w"> </span><span class="nc">PizzaTopping</span><span class="p">(</span><span class="n">models</span><span class="o">.</span><span class="n">Model</span><span class="p">):</span>
    <span class="n">pizza</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">ForeignKey</span><span class="p">(</span><span class="n">Pizza</span><span class="p">,</span> <span class="n">on_delete</span><span class="o">=</span><span class="n">models</span><span class="o">.</span><span class="n">CASCADE</span><span class="p">)</span>
    <span class="n">topping</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">ForeignKey</span><span class="p">(</span><span class="n">Topping</span><span class="p">,</span> <span class="n">on_delete</span><span class="o">=</span><span class="n">models</span><span class="o">.</span><span class="n">CASCADE</span><span class="p">)</span>
    <span class="n">amount</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">IntegerField</span><span class="p">()</span>
</pre></div>
<p>and define your pizza toppings relation like <tt class="docutils literal">toppings = models.ManyToManyField(Topping, through=PizzaTopping)</tt>.</p>
<p>If the relation doesn&#8217;t have no extra attributes don&#8217;t worry: You&#8217;ll be prepared when these are&nbsp;requested!</p>
<p>A bonus to that is that now you can query directly the PizzaTopping model and you can also add an admin interface for&nbsp;it.</p>
<p>There are <em>no</em> disadvantages to adding the through model (except the 1 minute needed to add the through model minor) since
Django will anyway create the intermediate table to represent the relation so you&#8217;ll still need to use <tt class="docutils literal">prefetch_related</tt>
to get the toppings of a pizza and avoid the n+1 query&nbsp;problem.</p>
</div>
<div class="section" id="use-a-custom-user-model">
<h3><a class="toc-backref" href="#toc-entry-6">Use a custom user&nbsp;model</a></h3>
<p>Using a custom user model when starting a new project is already <a class="reference external" href="https://docs.djangoproject.com/en/stable/topics/auth/customizing/#using-a-custom-user-model-when-starting-a-project">advised in the Django documentation</a>. This will make it
easier to add custom fields to your user model and have better control over it. Also, although you may be able to add
a <tt class="docutils literal">Profile</tt> model with an one to one relation with the default <tt class="docutils literal">django.auth.User</tt> model you&#8217;ll still need to use
a join to retrieve the profile for each user (something that won&#8217;t be necessary when the extra fields are on your custom user&nbsp;model).</p>
<p>Another very important reason to use a custom user model is that you&#8217;ll be able to easily add custom methods to your user model.
For example, there&#8217;s the <tt class="docutils literal">get_full_name</tt> method in builtin-Django that returns the first_name plus the last_name, with a space in between
so you&#8217;re able to call it like <tt class="docutils literal">{{ user.get_full_name }}</tt> in your templates. If you don&#8217;t have a custom user model, you&#8217;ll need to
add template tags for similar functionality; see the discussion about not adding template tags when you can use a&nbsp;method.</p>
<p>There&#8217;s no real disadvantage to using a custom user model except the 5 minute it is needed to set it up. I actually recommend
create a <tt class="docutils literal">users</tt> app that you&#8217;re going to use to keep user related information (see
the <a class="reference external" href="https://github.com/spapas/cookiecutter-django-starter/tree/master/%7B%7Bcookiecutter.project_name%7D%7D/%7B%7Bcookiecutter.project_name%7D%7D/users">users app on my cookiecutter project</a>).</p>
</div>
</div>
<div class="section" id="views-guidelines">
<h2><a class="toc-backref" href="#toc-entry-7">Views&nbsp;guidelines</a></h2>
<div class="section" id="use-class-based-views">
<h3><a class="toc-backref" href="#toc-entry-8">Use class based&nbsp;views</a></h3>
<p>I recommend to prefer using class-based views instead of function-based views. This is because class-based views are easier to
reuse and extend. I&#8217;ve written an extensive <a class="reference external" href="https://www.spapas.net/2018/03/19/comprehensive-django-cbv-guide/">comprehensive Django <span class="caps">CBV</span> guide</a> that you can read to
learn everything about class based&nbsp;views!</p>
<p>Also, by properly using CBVs people reading your code will use sensible defaults and you be able to understand what you
or others are doing much easier. Consider&nbsp;this</p>
<div class="highlight"><pre><span></span><span class="k">class</span><span class="w"> </span><span class="nc">FooDetailView</span><span class="p">(</span><span class="n">DetailView</span><span class="p">):</span>
    <span class="n">model</span> <span class="o">=</span> <span class="n">Foo</span>
</pre></div>
<p>vs</p>
<div class="highlight"><pre><span></span><span class="k">def</span><span class="w"> </span><span class="nf">object_detail_view</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="n">pk</span><span class="p">):</span>
    <span class="n">foo</span> <span class="o">=</span> <span class="n">get_object_or_404</span><span class="p">(</span><span class="n">Foo</span><span class="p">,</span> <span class="n">pk</span><span class="o">=</span><span class="n">pk</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">render</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="s1">&#39;foo/foo_detail.html&#39;</span><span class="p">,</span> <span class="p">{</span><span class="s1">&#39;foo&#39;</span><span class="p">:</span> <span class="n">foo</span><span class="p">})</span>
</pre></div>
<p>These are more or less the same. However in the function-based view you need to actually write some logic for retrieving
the Foo instance and then define the name of the template and the context object. Also notice that you use the <tt class="docutils literal">get_object_or_404</tt>
function that helps you being <span class="caps">DRY</span>. Whereas in the class based view this is
already done for you using well-known defaults. So, for example you&#8217;ll know which is the name of the template without the
need to check the&nbsp;code.</p>
</div>
<div class="section" id="view-method-overriding-guidelines">
<h3><a class="toc-backref" href="#toc-entry-9">View method overriding&nbsp;guidelines</a></h3>
<p>It is important to know which method you need to override to add functionality to your class based views. You can
use the excellent <a class="reference external" href="https://ccbv.co.uk/"><span class="caps">CBV</span> Inspector</a> app to understand how each <span class="caps">CBV</span> is working. Also, I&#8217;ve got
many examples in my <a class="reference external" href="https://www.spapas.net/2018/03/19/comprehensive-django-cbv-guide/">comprehensive Django <span class="caps">CBV</span> guide</a>.</p>
<p>Some quick guidelines&nbsp;follow:</p>
<ul class="simple">
<li>For <em>all</em> methods do not forget to call the parent&#8217;s method by <tt class="docutils literal">super()</tt>.</li>
<li>Override <tt class="docutils literal">dispatch(self, request, *args, **kwargs)</tt> if you want to add functionality that is executed before any other method. For example to add permission checks or add some attribute (<tt class="docutils literal">self.foo</tt>) to your view instance. This method will <em>always</em> run on both <span class="caps">HTTP</span> <span class="caps">GET</span>/<span class="caps">POST</span> or whatever. Must return a Response object (i.e <tt class="docutils literal">HttpResponse</tt>, <tt class="docutils literal">HttpResponseRedirect</tt>, <tt class="docutils literal">HttpResponseForbidden</tt> etc)</li>
<li>You should rarely need to override the <tt class="docutils literal">get</tt> or <tt class="docutils literal">post</tt> methods of your CBVs since they are called directly after <tt class="docutils literal">dispatch</tt> so any code should be&nbsp;there.</li>
<li>To add extra data in your context (template) override <tt class="docutils literal">get_context_data(self, **kwargs)</tt>. This should return a dictionary with the context&nbsp;data.</li>
<li>To pass extra data to your form (i.e the current request) override <tt class="docutils literal">get_form_kwargs(self)</tt>. This data will be passed on the <tt class="docutils literal">__init__</tt> of your form, you need to <em>remove it</em> by using something like <tt class="docutils literal">self.request = <span class="pre">kwargs.pop('request')</span></tt> before calling <tt class="docutils literal"><span class="pre">super().__init(*args,</span> **kwargs)</tt></li>
<li>To override the initial data of your form override <tt class="docutils literal">get_form_initial(self)</tt>. This should return a dictionary with the initial&nbsp;data.</li>
<li>You can override <tt class="docutils literal">get_form(self, form_class=None)</tt> to use a configurable form instance or <tt class="docutils literal">get_form_class(self)</tt> to use a configurable form class. The form instance will be generated by <tt class="docutils literal"><span class="pre">self.get_form_class()(**self.get_form_kwargs())</span></tt> (notice that the kwargs will contain an <tt class="docutils literal">initial=self.get_form_initial()</tt> value)</li>
<li>To do stuff after a valid form is submitted you&#8217;ll override <tt class="docutils literal">form_valid(self, form)</tt>. This should return an <tt class="docutils literal">HttpResponse</tt> object and more specifically an <tt class="docutils literal">HttpResponseRedirect</tt> to avoid double form submission. This is the place where you can also add flash messages to your&nbsp;responses.</li>
<li>You can also override <tt class="docutils literal">form_invalid(self, form)</tt> but this is rarely useful. This should return a normal response (not a&nbsp;redirect)</li>
<li>Override <tt class="docutils literal">get_success_url(self)</tt> if you only want to set where you&#8217;ll be redirected after a valid form submission (notice this is used by <tt class="docutils literal">form_valid</tt>)</li>
<li>You can use a different template based on some condition by overriding <tt class="docutils literal">get_template_names(self)</tt>. This is useful to return a partial response on an ajax request (for example the same detail view will return a full html view of an object when visited normally but will return a small partial html with the object&#8217;s info when called through an ajax&nbsp;call)</li>
<li>For views that return 1 or multiple objects (<tt class="docutils literal">DetailView, ListView, UpdateView</tt> etc) you almost always need to override the <tt class="docutils literal">get_queryset(self)</tt> method, <em>not</em> the <tt class="docutils literal">get_object</tt>. I&#8217;ll talk about that a little more&nbsp;later.</li>
<li>The <tt class="docutils literal">get_object(self, queryset=None)</tt> method will use the queryset returned by <tt class="docutils literal">get_queryset</tt> to get the object based on its pk, slug etc. I&#8217;ve observed that this rarely needs to be overridden since most of the time overriding <tt class="docutils literal">get_queryset</tt> will suffice. One possible use case for overriding <tt class="docutils literal">get_object</tt> is for views that don&#8217;t care at all about the queryset; for example you may implement a <tt class="docutils literal">/profile</tt> detail view that will pick the current user and display some stuff. This can be implemented by a <tt class="docutils literal">get_object</tt> similar to <tt class="docutils literal">return self.request.user</tt>.</li>
</ul>
</div>
</div>
<div class="section" id="querying-guidelines">
<h2><a class="toc-backref" href="#toc-entry-10">Querying&nbsp;guidelines</a></h2>
<div class="section" id="guidelines-for-the-n-1-problem">
<h3><a class="toc-backref" href="#toc-entry-11">Guidelines for the n+1&nbsp;problem</a></h3>
<p>The most common Django newbie mistake is not considering the n+1 problem when writing your&nbsp;queries.</p>
<p>Because Django automatically follows relations it is very easy to write code that will result in the n+1 queries
problem. A simple example is having something&nbsp;like</p>
<div class="highlight"><pre><span></span><span class="k">class</span><span class="w"> </span><span class="nc">Category</span><span class="p">(</span><span class="n">models</span><span class="o">.</span><span class="n">Model</span><span class="p">):</span>
    <span class="n">name</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">CharField</span><span class="p">(</span><span class="n">max_length</span><span class="o">=</span><span class="mi">255</span><span class="p">)</span>

<span class="k">class</span><span class="w"> </span><span class="nc">Product</span><span class="p">(</span><span class="n">models</span><span class="o">.</span><span class="n">Model</span><span class="p">):</span>
    <span class="n">name</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">CharField</span><span class="p">(</span><span class="n">max_length</span><span class="o">=</span><span class="mi">255</span><span class="p">)</span>
    <span class="n">category</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">ForeignKey</span><span class="p">(</span><span class="n">Category</span><span class="p">,</span> <span class="n">on_delete</span><span class="o">=</span><span class="n">models</span><span class="o">.</span><span class="n">CASCADE</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__str__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="s2">&quot;</span><span class="si">{0}</span><span class="s2"> (</span><span class="si">{1}</span><span class="s2">)&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">category</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
</pre></div>
<p>and doing something&nbsp;like:</p>
<div class="highlight"><pre><span></span><span class="k">for</span> <span class="n">product</span> <span class="ow">in</span> <span class="n">Product</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">all</span><span class="p">():</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">product</span><span class="p">)</span>
</pre></div>
<p>or even having <tt class="docutils literal">products = Product.objects.all()</tt> as a context variabile in your&nbsp;template:</p>
<div class="highlight"><pre><span></span>{% for product in products %}
    {{ product }}
{% endfor %}
</pre></div>
<p>If you&#8217;ve got 100 products, the above will run 101 queries to the database: The first one
will get all the products and the other 100 will return each product&#8217;s category one by one!
Consider what may happen if you had thousands of&nbsp;products&#8230;</p>
<p>To avoid this problem you should add the <tt class="docutils literal">select_related</tt>, so <tt class="docutils literal">products = <span class="pre">Product.objects.all().select_related('category')</span></tt>.
This will do an <span class="caps">SQL</span> <span class="caps">JOIN</span> between the products and categories table so each product will include its category instance. Now, when
you&#8217;ve got a many to many relation the situation is a little different. Let&#8217;s suppose you&#8217;ve got a <tt class="docutils literal">tags = models.ManyToManyField(Tag)</tt>
field in your <tt class="docutils literal">Product</tt> model. If you wanted to do something like <tt class="docutils literal">{{ <span class="pre">product.tags.all|join:&quot;,</span> &quot; }}</tt> to display the product tags you&#8217;d
also get a n+1 situation because Django will do a query for each product to get its tags. To avoid this you cannot use
<tt class="docutils literal">select_related</tt> but should use the <tt class="docutils literal">prefetch_related</tt>
method so <tt class="docutils literal">products = <span class="pre">Product.objects.all().prefetch_related('tags')</span></tt>. This will result in 2 queries, one for
products and one for their tags, the joining will be done in&nbsp;python.</p>
<p>One final comment about the <tt class="docutils literal">prefetch_related</tt> is that you must be very careful to use what you prefetch. Let&#8217;s suppose that we
had prefeched the tags but we wanted to display them ordered by name: Doing this <tt class="docutils literal">&quot;, <span class="pre">&quot;.join([tag</span> for tag in <span class="pre">product.tags.all().order_by('name')])</span></tt>
will <em>not</em> use the prefetched tags but will do a new query for each product to get its tags resulting in the n+1 problem! Django has
<tt class="docutils literal">tag.objects.all()</tt> for each product, <em>not</em> <tt class="docutils literal"><span class="pre">tag.objects.all().order_by('name')</span></tt>. To fix that you need to use <cite>Prefetch</cite> like&nbsp;this:</p>
<div class="highlight"><pre><span></span>Product.objects.prefetch_related(Prefetch(&#39;tags&#39;, queryset=Tag.objects.order_by(&#39;name&#39;)))
</pre></div>
<p>The same is true if you wanted to filter your tags&nbsp;etc.</p>
<p>Now, one thing to understand is that this behavior of Django is intentional. Instead of automatically following the relationships,
Django could throw an exception when you tried to follow a relationship that wasn&#8217;t in a <tt class="docutils literal">select_related</tt>
(this how it works in other frameworks). The disadvantage
of this is that it would make Django <em>more difficult</em> to use for new users. Also, there are cases that the n+1 problem isn&#8217;t
really a big deal, for example you may have a DetailView fetching a single object so in this case the n+1 problem will be 1+1
and wouldn&#8217;t really matter. So, at least for Django, it&#8217;s a case of premature optimization: Write your queries as good as you
can (but keep in mind the n+1 problem), if you miss some cases that actually make your views slow, you can easily optimize them&nbsp;later.</p>
</div>
<div class="section" id="re-use-your-queries">
<h3><a class="toc-backref" href="#toc-entry-12">Re-use your&nbsp;queries</a></h3>
<p>You should re-use your queries to avoid re-writing them. You can either put them inside your models
(as instance methods) or in a mixin for the queries of your views or even add a new manager for
your model. Let&#8217;s see some&nbsp;examples:</p>
<p>Let&#8217;s suppose I wanted to get the tags of my product: I&#8217;d add this method to my <tt class="docutils literal">Product</tt> model:</p>
<div class="highlight"><pre><span></span><span class="k">class</span><span class="w"> </span><span class="nc">Product</span><span class="p">(</span><span class="n">models</span><span class="o">.</span><span class="n">Model</span><span class="p">):</span>
    <span class="c1"># ...</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">get_tags</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">tags</span><span class="o">.</span><span class="n">all</span><span class="p">()</span><span class="o">.</span><span class="n">order_by</span><span class="p">(</span><span class="s1">&#39;name&#39;</span><span class="p">)</span>
</pre></div>
<p>Please notice that if you haven&#8217;t used a proper prefetch this will result in the n+1 queries problem. See the discussion above
for more info. To get the products with their tags I could add a new manager&nbsp;like:</p>
<div class="highlight"><pre><span></span><span class="k">class</span><span class="w"> </span><span class="nc">ProductWithTagManager</span><span class="p">(</span><span class="n">models</span><span class="o">.</span><span class="n">Manager</span><span class="p">):</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">get_queryset</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">get_queryset</span><span class="p">()</span><span class="o">.</span><span class="n">prefetch_related</span><span class="p">(</span><span class="n">Prefetch</span><span class="p">(</span><span class="s1">&#39;tags&#39;</span><span class="p">,</span> <span class="n">queryset</span><span class="o">=</span><span class="n">Tag</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">order_by</span><span class="p">(</span><span class="s1">&#39;name&#39;</span><span class="p">)))</span>

<span class="k">class</span><span class="w"> </span><span class="nc">Product</span><span class="p">(</span><span class="n">models</span><span class="o">.</span><span class="n">Model</span><span class="p">):</span>
    <span class="c1"># ...</span>

    <span class="n">products_with_tags</span> <span class="o">=</span> <span class="n">ProductWithTagManager</span><span class="p">()</span>
</pre></div>
<p>Now I could do <tt class="docutils literal">[p.get_tags() for p in <span class="pre">Product.products_with_tags.all()]</span></tt> and not have a n+1&nbsp;problem.</p>
<p>Actually, if I knew that I would <em>always</em> wanted to display the product&#8217;s tags I could override the default manager&nbsp;like</p>
<div class="highlight"><pre><span></span><span class="k">class</span><span class="w"> </span><span class="nc">Product</span><span class="p">(</span><span class="n">models</span><span class="o">.</span><span class="n">Model</span><span class="p">):</span>
    <span class="c1"># ...</span>

    <span class="n">objects</span> <span class="o">=</span> <span class="n">ProductWithTagManager</span><span class="p">()</span>
</pre></div>
<p>However I would not recommend that since having a consistent behavior when you run Model.objects is very important. If you
are to modify the default manager then you&#8217;ll need to always remember what your default manager does. This is very problematic
in old projects and when you want to quickly query your database from a shell. Also, even more problematic is if you
override your default manager to <em>filter</em> (hide) objects. Don&#8217;t do that or you&#8217;ll definitely regret&nbsp;it.</p>
<p>The other query re-use option is through a mixin that would override the <tt class="docutils literal">get_queryset</tt> of your models.
Let&#8217;s suppose that each user can only see his products: I could add a mixin&nbsp;like:</p>
<div class="highlight"><pre><span></span><span class="k">class</span><span class="w"> </span><span class="nc">ProductPermissionMixin</span><span class="p">:</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">get_queryset</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">get_queryset</span><span class="p">()</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">created_by</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">user</span><span class="p">)</span>
</pre></div>
<p>Then I could inherit my <tt class="docutils literal">ListView, DetailView, UpdateView</tt> and <tt class="docutils literal">DeleteView</tt>
i.e <tt class="docutils literal">ProductListView(ProductPermissionMixin, ListView)</tt> from that mixin and I&#8217;d have a consistent behavior on
which products each user can view. More on this can be found on my
<a class="reference external" href="https://www.spapas.net/2018/03/19/comprehensive-django-cbv-guide/">comprehensive Django <span class="caps">CBV</span> guide</a>.</p>
</div>
</div>
<div class="section" id="forms-guidelines">
<h2><a class="toc-backref" href="#toc-entry-13">Forms&nbsp;guidelines</a></h2>
<div class="section" id="always-use-django-forms">
<h3><a class="toc-backref" href="#toc-entry-14">Always use&nbsp;django-forms</a></h3>
<p>This is a no-brainer: The django-forms offers some great class-based functionality for your forms. I&#8217;ve
seen people creating html forms &#8220;by hand&#8221; and missing all this. Don&#8217;t be that guy; use&nbsp;django-forms!</p>
<p>I understand that sometimes the requirements of your forms may be difficult to be implemented with
a django form and you prefer to use a custom form. This may seem fine at first but in the long run
you&#8217;re gonna need (and probably re-implement) most of the django-forms&nbsp;capabilities.</p>
</div>
<div class="section" id="overriding-form-methods-guidelines">
<h3><a class="toc-backref" href="#toc-entry-15">Overriding Form methods&nbsp;guidelines</a></h3>
<p>Your <tt class="docutils literal">CustomForm</tt> inherits from a Django <tt class="docutils literal">Form</tt> so you can override some of its methods. Which ones
should you&nbsp;override?</p>
<ul class="simple">
<li>The most usual method for overriding is <tt class="docutils literal">clean(self)</tt>. This is used to add your own server-side checks to the form. I&#8217;ll talk a bit more about overriding clean&nbsp;later.</li>
<li>The second most usual to override is <tt class="docutils literal">__init__(self, *args, **kwargs)</tt>. You should override it to &#8220;pop&#8221;
any extra kwargs from the <tt class="docutils literal">kwargs</tt> dict <em>before</em> calling <tt class="docutils literal"><span class="pre">super().__init__(*args,</span> **kwargs)</tt>. See the view method overriding guidelines for more info. Also you&#8217;ll use it to&nbsp;change.</li>
<li>I usually <em>avoid</em> overriding the form&#8217;s <tt class="docutils literal">save()</tt> method. The <tt class="docutils literal">save()</tt> is almost always called from the view&#8217;s <tt class="docutils literal">form_valid</tt> method so I prefer to do any extra stuff from the view. This is mainly a personal preference in order to avoid having to hop between the form and view modules; by knowing that the form&#8217;s save is always the default the behavior will be consistent. This is personal preference&nbsp;though.</li>
</ul>
<p>There shouldn&#8217;t be a need to override any other method of a <tt class="docutils literal">Form</tt> or <tt class="docutils literal">ModelForm</tt>. However please notice that you can easily
use mixins to add extra functionality to your forms. For example, if you had a particular check that would be called from <em>many</em> forms,
you could add&nbsp;a</p>
<div class="highlight"><pre><span></span><span class="k">class</span><span class="w"> </span><span class="nc">CustomFormMixin</span><span class="p">:</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">clean</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">clean</span><span class="p">()</span> <span class="c1"># Not really needed here but I recommend to add it to keep the inheritance chain</span>
        <span class="c1"># The common checks that does the mixin</span>

<span class="k">class</span><span class="w"> </span><span class="nc">CustomForm</span><span class="p">(</span><span class="n">CustomFormMixin</span><span class="p">,</span> <span class="n">Form</span><span class="p">):</span>
    <span class="c1"># Other stuff</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">clean</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">clean</span><span class="p">()</span> <span class="c1"># This will run the mixin&#39;s clean</span>
        <span class="c1"># Any checks that only this form needs to do</span>
</pre></div>
</div>
<div class="section" id="proper-cleaning">
<h3><a class="toc-backref" href="#toc-entry-16">Proper&nbsp;cleaning</a></h3>
<p>When you override the <tt class="docutils literal">clean(self)</tt> method of a <tt class="docutils literal">Form</tt> you should always use the <tt class="docutils literal">self.cleaned_data</tt> to check the
data of the form. The common way to mark errors is to use the <tt class="docutils literal">self.add_error</tt> method, for example, if you have a
<tt class="docutils literal">date_from</tt> and <tt class="docutils literal">date_to</tt> and date_from is after the <tt class="docutils literal">date_to</tt> you can do your clean something like&nbsp;this:</p>
<div class="highlight"><pre><span></span><span class="k">def</span><span class="w"> </span><span class="nf">clean</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>

    <span class="n">date_from</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cleaned_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;date_from&quot;</span><span class="p">)</span>
    <span class="n">date_to</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cleaned_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;date_to&quot;</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">date_from</span> <span class="ow">and</span> <span class="n">date_to</span> <span class="ow">and</span> <span class="n">date_from</span> <span class="o">&gt;</span> <span class="n">date_to</span><span class="p">:</span>
        <span class="n">error_str</span> <span class="o">=</span> <span class="s2">&quot;Date from cannot be after date to&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">add_error</span><span class="p">(</span><span class="s2">&quot;date_from&quot;</span><span class="p">,</span> <span class="n">error_str</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">add_error</span><span class="p">(</span><span class="s2">&quot;date_from&quot;</span><span class="p">,</span> <span class="n">error_str</span><span class="p">)</span>
</pre></div>
<p>Please notice above that I am checking that both <tt class="docutils literal">date_from</tt> and <tt class="docutils literal">date_to</tt> are not null (or else it will try to compare
null dates and will throw). Then I am adding the same error message to both fields. Django will see that the form has errors
and run <tt class="docutils literal">form_invalid</tt> on the view and re-display the form with the&nbsp;errors.</p>
<p>Beyond the <tt class="docutils literal">self.add_error</tt> method that adds the error to the field there&#8217;s a possibility to add an error to the &#8220;whole&#8221;
form&nbsp;using:</p>
<div class="highlight"><pre><span></span><span class="kn">from</span><span class="w"> </span><span class="nn">django.core.exceptions</span><span class="w"> </span><span class="kn">import</span> <span class="n">ValidationError</span>

<span class="k">def</span><span class="w"> </span><span class="nf">clean</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">form_has_error</span><span class="p">:</span>
        <span class="k">raise</span> <span class="n">ValidationError</span><span class="p">(</span><span class="sa">u</span><span class="s2">&quot;The form has an error!&quot;</span><span class="p">)</span>
</pre></div>
<p>This kind of error won&#8217;t be correlated with a field. You can use this approach when an error is correlated to multiple fields
instead of adding the same error to multiple&nbsp;fields.</p>
<p>You must be very careful because if you are using a non-standard
form layout method (i.e you enumerate the fields) you also need to display the <tt class="docutils literal">{{ form.errors }}</tt> in your template or else
you&#8217;ll get a rejected form without any errors! This is a very common&nbsp;mistake.</p>
<p>Another thing to notice is that when your clean method raises it will display only the first such error. So if you&#8217;ve got multiple
checks&nbsp;like:</p>
<div class="highlight"><pre><span></span><span class="k">def</span><span class="w"> </span><span class="nf">clean</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">form_has_error</span><span class="p">:</span>
        <span class="k">raise</span> <span class="n">ValidationError</span><span class="p">(</span><span class="sa">u</span><span class="s2">&quot;The form has an error!&quot;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">form_has_another_error</span><span class="p">:</span>
        <span class="k">raise</span> <span class="n">ValidationError</span><span class="p">(</span><span class="sa">u</span><span class="s2">&quot;The form has another error!&quot;</span><span class="p">)</span>
</pre></div>
<p>and your form has <em>both</em> errors only the 1st one will be displayed to the user. Then after he fixes it he&#8217;ll also see the 2nd one. When
you use <tt class="docutils literal">self.add_error</tt> the user will get both at the same&nbsp;time.</p>
</div>
<div class="section" id="overriding-the-init">
<h3><a class="toc-backref" href="#toc-entry-17">Overriding the&nbsp;__init__</a></h3>
<p>You can override the <tt class="docutils literal">__init__</tt> method of your forms for three main&nbsp;reasons:</p>
<p>1. Override some field attributes on a ModelForm. A Django ModelForm will automatically create a field for each model field.
Some times you may want to override some of the attributes of the field. For example, you may want to change the label of the field
or make a field required. To do that, you can do something&nbsp;like:</p>
<div class="highlight"><pre><span></span><span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
    <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">fields</span><span class="p">[</span><span class="s2">&quot;my_field&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">label</span> <span class="o">=</span> <span class="s2">&quot;My custom label&quot;</span> <span class="c1"># Change the label</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">fields</span><span class="p">[</span><span class="s2">&quot;my_field&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">help_text</span> <span class="o">=</span> <span class="s2">&quot;My custom label&quot;</span> <span class="c1"># Change the help text</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">fields</span><span class="p">[</span><span class="s2">&quot;my_field&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">required</span> <span class="o">=</span> <span class="kc">True</span> <span class="c1"># change the required attribute</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">fields</span><span class="p">[</span><span class="s2">&quot;my_field&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">queryset</span> <span class="o">=</span> <span class="n">Model</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">is_active</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span> <span class="c1"># Only allow specific objects for the forein key</span>
</pre></div>
<p>Please notice that we need to use <tt class="docutils literal"><span class="pre">self.fields[&quot;my_field&quot;]</span></tt> <em>after</em> we call <tt class="docutils literal"><span class="pre">super().__init__(*args,</span> **kwargs)</tt>.</p>
<p>2. Retrieve parameters (usually the request or user) from the view. A view (either a function-based or a <span class="caps">CBV</span> through <tt class="docutils literal">get_form_kwargs</tt>)
can pass parameters to the form&#8217;s constructor. You need to override <tt class="docutils literal">__init__</tt> to handle these&nbsp;parameters:</p>
<div class="highlight"><pre><span></span><span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">request</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s2">&quot;request&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
    <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
</pre></div>
<p>Please notice that we must pop the <tt class="docutils literal">request</tt> from the <tt class="docutils literal">kwargs</tt> dict before calling <tt class="docutils literal"><span class="pre">super().__init__</span></tt> or else
we&#8217;ll get an exception since the <tt class="docutils literal">Form.__init__</tt> method accepts only specific&nbsp;kwargs.</p>
<p>3. Add functionality related to the current user/request. For example, you may want to add a field that is only editable if
the user is&nbsp;superuser:</p>
<div class="highlight"><pre><span></span><span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">request</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s2">&quot;request&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
    <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">user</span><span class="o">.</span><span class="n">is_superuser</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">fields</span><span class="p">[</span><span class="s2">&quot;my_field&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">widget</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;readonly&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
</pre></div>
<p>or you may want to allow some custom validation logic only for non -&nbsp;superusers:</p>
<div class="highlight"><pre><span></span><span class="k">def</span><span class="w"> </span><span class="nf">clean</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">user</span><span class="o">.</span><span class="n">is_superuser</span><span class="p">:</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">cleaned_data</span><span class="p">[</span><span class="s1">&#39;my_field&#39;</span><span class="p">]:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">add_error</span><span class="p">(</span><span class="s2">&quot;my_field&quot;</span><span class="p">,</span> <span class="s2">&quot;Please field this field&quot;</span><span class="p">)</span>
</pre></div>
</div>
<div class="section" id="laying-out-forms">
<h3><a class="toc-backref" href="#toc-entry-18">Laying out&nbsp;forms</a></h3>
<p>To lay out the forms I recommend using a library like <a class="reference external" href="https://github.com/django-crispy-forms/django-crispy-forms">django-crispy-forms</a>. This integrates your forms properly with your
front-end engine and helps you have proper styling. I&#8217;ve got some more info on
<a class="reference external" href="https://www.spapas.net/2020/03/18/django-crispy-form-quick-easy-layout/">form layout post</a>.</p>
<p>Please notice that the <a class="reference external" href="https://github.com/django-crispy-forms/django-crispy-forms">django-crispy-forms</a> supports specific front-end frameworks like bootstrap or tailwind (see its docs
for all available options). If you&#8217;re using a non-supported front-end framework you can
<a class="reference external" href="https://django-crispy-forms.readthedocs.io/en/latest/template_packs.html">create a custom template pack</a>. This seems like a lot of work but I recommend to do it. Also you don&#8217;t need to implement
everything, only the functionality you&#8217;re going to need, when you need&nbsp;it.</p>
</div>
<div class="section" id="improve-the-formset-functionality">
<h3><a class="toc-backref" href="#toc-entry-19">Improve the formset&nbsp;functionality</a></h3>
<p>Beyond simple forms, Django allows you to use a functionality it calls <a class="reference external" href="https://docs.djangoproject.com/en/4.1/topics/forms/formsets/">formsets</a>. A formset is a collection of forms that
can be used to edit multiple objects at the same time. This is usually used in combination with inlines which are a
way to edit models on the same page as a parent model.
For example you may have something like&nbsp;this:</p>
<div class="highlight"><pre><span></span><span class="k">class</span><span class="w"> </span><span class="nc">Pizza</span><span class="p">(</span><span class="n">models</span><span class="o">.</span><span class="n">Model</span><span class="p">):</span>
    <span class="n">name</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">CharField</span><span class="p">(</span><span class="n">max_length</span><span class="o">=</span><span class="mi">128</span><span class="p">)</span>
    <span class="n">toppings</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">ManyToManyField</span><span class="p">(</span><span class="s1">&#39;Topping&#39;</span><span class="p">,</span> <span class="n">through</span><span class="o">=</span><span class="s1">&#39;PizzaTopping&#39;</span><span class="p">)</span>

<span class="k">class</span><span class="w"> </span><span class="nc">Topping</span><span class="p">(</span><span class="n">models</span><span class="o">.</span><span class="n">Model</span><span class="p">):</span>
    <span class="n">name</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">CharField</span><span class="p">(</span><span class="n">max_length</span><span class="o">=</span><span class="mi">128</span><span class="p">)</span>

<span class="k">class</span><span class="w"> </span><span class="nc">PizzaTopping</span><span class="p">(</span><span class="n">models</span><span class="o">.</span><span class="n">Model</span><span class="p">):</span>
    <span class="n">amount</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">PositiveIntegerField</span><span class="p">()</span>
    <span class="n">pizza</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">ForeignKey</span><span class="p">(</span><span class="s1">&#39;Pizza&#39;</span><span class="p">)</span>
    <span class="n">topping</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">ForeignKey</span><span class="p">(</span><span class="s1">&#39;Topping&#39;</span><span class="p">)</span>
</pre></div>
<p>Now we&#8217;d like to have a form that allows us to edit a pizza by both changing the pizza name <em>and</em> the toppings of the pizza
along with their amounts. The pizza form will be the main form and the topping/amount will be the inline form. Notice that we
won&#8217;t also create/edit the topping name, we&#8217;ll just select it from the existing toppings (we&#8217;re gonna have a completely different
view for adding/editing individual&nbsp;toppings).</p>
<p>First of all, to create a class based view that includes a formset we can use the <a class="reference external" href="https://github.com/AndrewIngram/django-extra-views">django-extra-views</a>
package (this isn&#8217;t supported by built-in django CBVs unless we implement the functionality ourselves). Then we&#8217;d do something&nbsp;like:</p>
<div class="highlight"><pre><span></span><span class="kn">from</span><span class="w"> </span><span class="nn">extra_views</span><span class="w"> </span><span class="kn">import</span> <span class="n">CreateWithInlinesView</span><span class="p">,</span> <span class="n">InlineFormSetFactory</span>


<span class="k">class</span><span class="w"> </span><span class="nc">ToppingInline</span><span class="p">(</span><span class="n">InlineFormSetFactory</span><span class="p">):</span>
    <span class="n">model</span> <span class="o">=</span> <span class="n">Topping</span>
    <span class="n">fields</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;topping&#39;</span><span class="p">,</span> <span class="s1">&#39;amount&#39;</span><span class="p">]</span>


<span class="k">class</span><span class="w"> </span><span class="nc">CreatePizzaView</span><span class="p">(</span><span class="n">CreateWithInlinesView</span><span class="p">):</span>
    <span class="n">model</span> <span class="o">=</span> <span class="n">Pizza</span>
    <span class="n">inlines</span> <span class="o">=</span> <span class="p">[</span><span class="n">ToppingInline</span><span class="p">]</span>
    <span class="n">fields</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">]</span>
</pre></div>
<p>This will create a form that will allow us to create a pizza and add toppings to it. Now, to display the formset we&#8217;d
modify our template to be similar&nbsp;to:</p>
<div class="highlight"><pre><span></span><span class="p">&lt;</span><span class="nt">form</span> <span class="na">method</span><span class="o">=</span><span class="s">&quot;post&quot;</span><span class="p">&gt;</span>
...
{{ form }}

{% for formset in inlines %}
    {{ formset }}
{% endfor %}
...
<span class="p">&lt;</span><span class="nt">input</span> <span class="na">type</span><span class="o">=</span><span class="s">&quot;submit&quot;</span> <span class="na">value</span><span class="o">=</span><span class="s">&quot;Submit&quot;</span> <span class="p">/&gt;</span>
<span class="p">&lt;/</span><span class="nt">form</span><span class="p">&gt;</span>
</pre></div>
<p>This works however it will be very ugly. The default behavior is to display the <tt class="docutils literal">Pizza</tt> form and three empty <tt class="docutils literal">Topping</tt> forms.
If we want to add more toppings we&#8217;ll have to submit that form so it will be saved and then edit it. But once again we&#8217;ll get our
existing toppings and three more. I am not fond of this&nbsp;behavior.</p>
<p>That&#8217;s why my recommendation is to follow the instructions on my
<a class="reference external" href="https://www.spapas.net/2022/06/28/better-django-inlines/">better django inlines</a> article that allows you to sprinkle some javascript on your
template and get a much better, dynamic behavior. I.e you&#8217;ll get an &#8220;add more&#8221; button to add extra toppings without the need t
submit the form every&nbsp;time.</p>
</div>
</div>
<div class="section" id="template-guidelines">
<h2><a class="toc-backref" href="#toc-entry-20">Template&nbsp;guidelines</a></h2>
<div class="section" id="stick-to-the-built-in-django-template-backend">
<h3><a class="toc-backref" href="#toc-entry-21">Stick to the built-in Django template&nbsp;backend</a></h3>
<p>Django has its own built-in template engine but it also allows you to use the Jinja template engine or even
use a completely different one! The django template backend is considered &#8220;too restrictive&#8221; by some people mainly
because you can only call functions without parameters from&nbsp;it.</p>
<p>My opinion is to just stick to the builtin Django template. Its restriction is actually a strength, enabling you
to create re-usable custom template tags (or object methods) instead of calling business logic from the template.
Also, using a completely custom backend means that you&#8217;ll add dependencies to your project; please see my the guideline
about the selection of using external packages. Finally, don&#8217;t forget that any packages you&#8217;ll use that provide
templates would be for the Django template backend, so you&#8217;ll need to convert/re-write these templates to be used with
a different&nbsp;engine.</p>
<p>I would consider the Jinja engine only if I already had a bunch of Jinja templates from a different project and
wanted to quickly use them on my&nbsp;project.</p>
</div>
<div class="section" id="don-t-add-template-tags-when-you-can-use-a-method">
<h3><a class="toc-backref" href="#toc-entry-22">Don&#8217;t add template tags when you can use a&nbsp;method</a></h3>
<p>Continuing from the discussion on the previous guideline, I recommend you to add methods to your models instead of
adding template tags. For example, let&#8217;s suppose that we want to get our pizza toppings order by their name. We could
add a template tag that would do that&nbsp;like:</p>
<div class="highlight"><pre><span></span><span class="k">def</span><span class="w"> </span><span class="nf">get_pizza_toppings</span><span class="p">(</span><span class="n">context</span><span class="p">,</span> <span class="n">pizza</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">pizza</span><span class="o">.</span><span class="n">toppings</span><span class="o">.</span><span class="n">all</span><span class="p">()</span><span class="o">.</span><span class="n">order_by</span><span class="p">(</span><span class="s1">&#39;name&#39;</span><span class="p">)</span>
</pre></div>
<p>and use it like <tt class="docutils literal">{% get_pizza_toppings pizza as pizza_toppings %}</tt> in our template. Notice that if you don&#8217;t care about
the ordering you could instead do <tt class="docutils literal">{{ pizza.toppings.all }}</tt> but you need to use the order_by and pass a parameter so you
can&#8217;t call the&nbsp;method.</p>
<p>Instead of adding the template tag that I recommend  adding a method to your <tt class="docutils literal">pizza</tt> model&nbsp;like:</p>
<div class="highlight"><pre><span></span><span class="k">def</span><span class="w"> </span><span class="nf">get_toppings</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">toppings</span><span class="o">.</span><span class="n">all</span><span class="p">()</span><span class="o">.</span><span class="n">order_by</span><span class="p">(</span><span class="s1">&#39;name&#39;</span><span class="p">)</span>
</pre></div>
<p>and then call it like <tt class="docutils literal">{{ pizza.get_toppings }}</tt> in your template. This is much cleaner and easier to&nbsp;understand.</p>
<p>Please notice that this guideline is not a proposal towards the &#8220;fat models&#8221; approach. You can add 1 line methods to
your models that would only call the corresponding service methods if&nbsp;needed.</p>
</div>
<div class="section" id="re-use-templates-with-partials">
<h3><a class="toc-backref" href="#toc-entry-23">Re-use templates with&nbsp;partials</a></h3>
<p>When you have a part of a template that will be used in multiple places you can use partials to avoid repeating yourself.
For example, let&#8217;s suppose you like to display your pizza details. These details would be displayed in the list of
pizzas, in the cart page, in the receipt page etc. So can create an html page named <tt class="docutils literal">_pizza_details.html</tt> under a
<tt class="docutils literal">partial</tt> folder (or whatever name you want but I recommend having a way to quickly check your partials) with contents
similar&nbsp;to:</p>
<div class="highlight"><pre><span></span><span class="p">&lt;</span><span class="nt">div</span> <span class="na">class</span><span class="o">=</span><span class="s">&#39;pizza-details&#39;</span><span class="p">&gt;</span>
    <span class="p">&lt;</span><span class="nt">h3</span><span class="p">&gt;</span>{{ pizza.name }}<span class="p">&lt;/</span><span class="nt">h3</span><span class="p">&gt;</span>
    {% if show_photo %}
        <span class="p">&lt;</span><span class="nt">img</span> <span class="na">src</span><span class="o">=</span><span class="s">&#39;{{ pizza.photo.url }}&#39;</span><span class="p">&gt;</span>
    {% endif %}
    <span class="p">&lt;</span><span class="nt">p</span><span class="p">&gt;</span>Toppings: {{ pizza.get_toppings|join:&quot;, &quot; }}<span class="p">&lt;/</span><span class="nt">p</span><span class="p">&gt;</span>
<span class="p">&lt;/</span><span class="nt">div</span><span class="p">&gt;</span>
</pre></div>
<p>and then include it in your templates like <tt class="docutils literal">{% inlude &quot;pizzas/partials/_pizza_details.html&quot; %}</tt> to display the info without photo or
<tt class="docutils literal">{% inlude &quot;pizzas/partials/_pizza_details.html&quot; with show_photo=True %}</tt> to display the photo. Also notice that you can override the
{{ pizza }} context variable so, if you want to display two pizzas in a template you&#8217;ll write something&nbsp;like</p>
<div class="highlight"><pre><span></span>{% inlude &quot;partials/_pizza_details.html&quot; with show_photo=True pizza=pizza1 %}
{% inlude &quot;partials/_pizza_details.html&quot; with show_photo=True pizza=pizza2 %}
</pre></div>
</div>
</div>
<div class="section" id="settings-guidelines">
<h2><a class="toc-backref" href="#toc-entry-24">Settings&nbsp;guidelines</a></h2>
<div class="section" id="use-a-package-instead-of-module">
<h3><a class="toc-backref" href="#toc-entry-25">Use a package instead of&nbsp;module</a></h3>
<p>This is a well known guideline but I&#8217;d like to mention it here. When you create a new project, Django will
create a <tt class="docutils literal">settings.py</tt> file. This file is a python module. I recommend to create a settings folder next to the
<tt class="docutils literal">settings.py</tt> and put
in it the <tt class="docutils literal">settings.py</tt> renamed as <tt class="docutils literal">base.py</tt> and an <tt class="docutils literal">__init__.py</tt> file so the <tt class="docutils literal">settings</tt> folder will be a
python package. So instead of <tt class="docutils literal">project\settings.py</tt> you&#8217;ll have <tt class="docutils literal">project\settings\base.py</tt> and <tt class="docutils literal">project\settings\__init__.py</tt>.</p>
<p>Now, you&#8217;ll add an extra module inside settings for each kind of environment you are gonna use your app on. For example, you&#8217;ll
have something like
* <tt class="docutils literal">project\settings\dev.py</tt> for your development environment
* <tt class="docutils literal">project\settings\uat.py</tt> for the <span class="caps">UAT</span> environment
* <tt class="docutils literal">project\settings\prod.py</tt> for the production&nbsp;environment</p>
<p>Each of these files will import the <tt class="docutils literal">base.py</tt> file and override the settings that are different from the base settings, i.e
these files will start&nbsp;like:</p>
<div class="highlight"><pre><span></span><span class="kn">from</span><span class="w"> </span><span class="nn">.base</span><span class="w"> </span><span class="kn">import</span> <span class="o">*</span>

<span class="c1"># And now all options that are different from the base settings</span>
</pre></div>
<p>All these files will be put in your version control. You won&#8217;t put any secrets in these files. We&#8217;ll see how to handle
secrets&nbsp;later.</p>
<p>When Django starts, it will by default look for the <tt class="docutils literal">project/settings.py</tt> module. So, if you try to run <tt class="docutils literal">python manage.py</tt>
now it will complain. To fix that, you have to set the <tt class="docutils literal">DJANGO_SETTINGS_MODULE</tt> environment variable to point to
the correct settings module you wanna use. For example, in the dev env you&#8217;ll do <tt class="docutils literal">DJANGO_SETTINGS_MODULE=project.settings.dev</tt>.</p>
<p>To avoid doing that every time I recommend creating a script that will initiate the project&#8217;s virtual environment and set the
settings module. For example, in my projects I have a file named dovenv.bat (I use windows) with the following&nbsp;contents:</p>
<!-- code-block

call ..\venv\scripts\activate
set DJANGO_SETTINGS_MODULE=project.settings.dev -->
</div>
<div class="section" id="handle-secrets-properly">
<h3><a class="toc-backref" href="#toc-entry-26">Handle secrets&nbsp;properly</a></h3>
<p>You should never put secrets (i.e your database password or <span class="caps">API</span> <span class="caps">KEYS</span>) on your version control. There are two
ways that can be used to handle secrets in&nbsp;Django:</p>
<ul class="simple">
<li>Use a <tt class="docutils literal">settings/local.py</tt> file that contains all your secrets for the current environment and is not under version&nbsp;control.</li>
<li>Use environment&nbsp;variables.</li>
</ul>
<p>For the <tt class="docutils literal">settings/local.py</tt> solution, you&#8217;ll add the following code at the end of each one of your settings environment
modules (i.e you should put it at the end of <tt class="docutils literal">dev.py</tt>, <tt class="docutils literal">uat.py</tt>, <tt class="docutils literal">prod.py</tt> etc):</p>
<div class="highlight"><pre><span></span><span class="k">try</span><span class="p">:</span>
    <span class="kn">from</span><span class="w"> </span><span class="nn">.local</span><span class="w"> </span><span class="kn">import</span> <span class="o">*</span>
<span class="k">except</span> <span class="ne">ImportError</span><span class="p">:</span>
    <span class="k">pass</span>
</pre></div>
<p>The above will try to read a module named <tt class="docutils literal">local.py</tt> and if it exists it will import it. If it doesn&#8217;t exist it will
just ignore it. Because this file is at the end of the corresponding settings module, it will override any settings that are already
defined. The above file should be excluded from version control so you&#8217;ll add the line <tt class="docutils literal">local.py</tt> to your <tt class="docutils literal">.gitignore</tt>.</p>
<p>Notice that the same solution to store secrets can be used if you don&#8217;tt use the settings package approach but you have a <tt class="docutils literal">settings.py</tt>
module. Create a <tt class="docutils literal">settings_local.py</tt> module and import from that at the end of your settings module instead. However I strongly
recommend to use the settings package&nbsp;approach.</p>
<p>To catalogue my secrets, I will usually add a <tt class="docutils literal">local.py.template</tt> file that has all the settings that I need to override in my
local.py with empty values. I.e it will may be similar&nbsp;to:</p>
<div class="highlight"><pre><span></span><span class="n">API_TOKEN</span><span class="o">=</span><span class="s1">&#39;&#39;</span>
<span class="n">ANOTHER_API_TOKEN</span><span class="o">=</span><span class="s1">&#39;&#39;</span>
<span class="n">DATABASES_U</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s1">&#39;default&#39;</span><span class="p">:</span> <span class="p">{</span>
        <span class="s1">&#39;ENGINE&#39;</span><span class="p">:</span> <span class="s1">&#39;django.db.backends.postgresql_psycopg2&#39;</span><span class="p">,</span>
        <span class="s1">&#39;NAME&#39;</span><span class="p">:</span> <span class="s1">&#39;&#39;</span><span class="p">,</span>
        <span class="s1">&#39;USER&#39;</span><span class="p">:</span> <span class="s1">&#39;&#39;</span><span class="p">,</span>
        <span class="s1">&#39;PASSWORD&#39;</span><span class="p">:</span> <span class="s1">&#39;&#39;</span><span class="p">,</span>
        <span class="s1">&#39;HOST&#39;</span><span class="p">:</span> <span class="s1">&#39;&#39;</span><span class="p">,</span>
        <span class="s1">&#39;PORT&#39;</span><span class="p">:</span> <span class="s1">&#39;&#39;</span><span class="p">,</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></div>
<p>Then I&#8217;ll copy over <tt class="docutils literal">local.py.template</tt> to <tt class="docutils literal">local.py</tt> when I initialize my project and fill in the&nbsp;values.</p>
<p>Before continuing, it is important to understand the priority of the settings modules. So let&#8217;s suppose we are on
production. We should have a <tt class="docutils literal">DJANGO_SETTINGS_MODULE=project.settings.prod</tt>. The players will be <tt class="docutils literal">base.py</tt>,
<tt class="docutils literal">prod.py</tt> and <tt class="docutils literal">local.py</tt>. The priority will&nbsp;be</p>
<ol class="arabic simple">
<li><tt class="docutils literal">local.py</tt></li>
<li><tt class="docutils literal">prod.py</tt></li>
<li><tt class="docutils literal">base.py</tt></li>
</ol>
<p>So any settings defined in <tt class="docutils literal">prod.py</tt> will override the settings of <tt class="docutils literal">base.py</tt>. And any settings defined in <tt class="docutils literal">local.py</tt>
will override any settings defined either in <tt class="docutils literal">prod.py</tt> or <tt class="docutils literal">base.py</tt>. Please notice that I mention <em>any</em> setting, not
just&nbsp;secrets.</p>
<p>To use the environment variables approach, you&#8217;ll have to read the values of the secrets from your environment.
A simple way to do that is to use ths os.getenv function, for example in your <tt class="docutils literal">prod.py</tt> you may have something&nbsp;like:</p>
<div class="highlight"><pre><span></span><span class="kn">import</span><span class="w"> </span><span class="nn">os</span>

<span class="n">API_TOKEN</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">getenv</span><span class="p">(</span><span class="s1">&#39;API_TOKEN&#39;</span><span class="p">)</span>
</pre></div>
<p>This will set <tt class="docutils literal">API_TOKEN</tt> setting to <tt class="docutils literal">None</tt> if the <tt class="docutils literal">API_TOKEN</tt> env var is not found. You can do something like
<tt class="docutils literal"><span class="pre">os.environ[&quot;API_TOKEN&quot;]</span></tt> instead to throw an exception. Also, there are libraries that will help you with this
like <a class="reference external" href="https://github.com/theskumar/python-dotenv">python-dotenv</a>, However I can&#8217;t really recommend them because I haven&#8217;t used&nbsp;them.</p>
<p>Now, which one to use? My recommendation (and what I always do) is to use the first approach (<tt class="docutils literal">local.py</tt>) <em>unless</em> you need to use
environment variables to configure your project. For example, if you are using a PaaS like Heroku, you&#8217;ll have to use
environment variables because of the way you deploy so you can&#8217;t really choose. However using the <tt class="docutils literal">local.py</tt> is much
simpler, does not have any dependencies and you can quickly understand which settings are overriden. Also you can
use it to override <em>any</em> setting by putting it in your local.py, not just&nbsp;secrets.</p>
</div>
</div>
<div class="section" id="static-and-media-guidelines">
<h2><a class="toc-backref" href="#toc-entry-27">Static and media&nbsp;guidelines</a></h2>
<div class="section" id="use-manifeststaticfilesstorage">
<h3><a class="toc-backref" href="#toc-entry-28">Use&nbsp;ManifestStaticFilesStorage</a></h3>
<p>Django has a <tt class="docutils literal">STATICFILES_STORAGE</tt> setting that can be used to specify the storage engine that will be used to store
the static files. By default, Django uses the <tt class="docutils literal">StaticFilesStorage</tt> engine which stores the files in the file system
under the <tt class="docutils literal">STATIC_ROOT</tt> folder and with a <tt class="docutils literal">STATIC_URL</tt> url.</p>
<p>For example  if you&#8217;ve got a <tt class="docutils literal"><span class="pre">STATIC_ROOT=/static_root</span></tt> and a <tt class="docutils literal"><span class="pre">STATIC_URL=/static_url/</span></tt> and you&#8217;ve got a file named <tt class="docutils literal">styles.css</tt>
which you include with <tt class="docutils literal">{% static &quot;styles.css&quot; %}</tt>. When you run <tt class="docutils literal">python manage.py collectstatic</tt> the <tt class="docutils literal">styles.css</tt> will be copied
to <tt class="docutils literal">/static_root/styles.css</tt> and you&#8217;ll be able to access it with <tt class="docutils literal">/static_url/styles.css</tt>.</p>
<p>Please notice that the above should be configured in your web server (i.e nginx). Thus, you need to configure your
web server so as to publish the files under <tt class="docutils literal">/static_root</tt> on the <tt class="docutils literal">/static_url</tt> url. This should work without Django,
i.e if you have configured the web server properly you&#8217;ll be able to visit <tt class="docutils literal">example.com/static_url/styles.css</tt> even if
your Django app isn&#8217;t running. For more info see <a class="reference external" href="https://docs.djangoproject.com/en/4.1/howto/static-files/deployment/">how to deploy static files</a>.</p>
<p>Now, the problem with the <tt class="docutils literal">StaticFilesStorage</tt> is that if you change the <tt class="docutils literal">styles.css</tt> there won&#8217;t be any
way for the user&#8217;s browser to understand that the file has been changed so it will keep using the cached&nbsp;version.</p>
<p>This is why I recommend using the <a class="reference external" href="https://docs.djangoproject.com/en/stable/ref/contrib/staticfiles/#django.contrib.staticfiles.storage.ManifestStaticFilesStorage">ManifestStaticFilesStorage</a> instead. This storage will append the md5 has of each static
file when copying it so the <tt class="docutils literal">styles.css</tt> will be copied to <tt class="docutils literal">/static_root/styles.fb2be32168f5.css</tt> and the url will be
<tt class="docutils literal">/static_url/styles.fb2be32168f5.css</tt>. When the <tt class="docutils literal">styles.css</tt> is changed, its hash will also be changed so the users
are guaranteed to pick the correct file each&nbsp;time.</p>
</div>
<div class="section" id="organize-your-media-files">
<h3><a class="toc-backref" href="#toc-entry-29">Organize your media&nbsp;files</a></h3>
<p>When you upload a file to your app, Django will store it in the <tt class="docutils literal">MEDIA_ROOT</tt> folder and serve it through <tt class="docutils literal">MEDIA_URL</tt>
similar to the static files as I explained before. The problem with this approach is that you&#8217;ll end up with a lot of files
in the same folder. This is why I recommend creating a folder structure for your media files. To create this structure
you should set the <a class="reference external" href="https://docs.djangoproject.com/en/4.1/ref/models/fields/#django.db.models.FileField.upload_to">upload_to</a> attribute of <tt class="docutils literal">FileField</tt>.</p>
<p>So instead of having <tt class="docutils literal">file = models.FileField</tt> or <tt class="docutils literal">image = models.ImageField</tt> you&#8217;d do something like
<tt class="docutils literal">file = <span class="pre">models.FileField(upload_to='%Y/%m/files')</span></tt> or <tt class="docutils literal">image = <span class="pre">models.ImageField(upload_to='%Y/%m/images')</span></tt> to
upload these files to their corresponding folder organized by&nbsp;year/month.</p>
<p>Notice that instead of a string you can also pass a function to the <tt class="docutils literal">upload_to</tt> attribute. This function will need to
return a string that will contain the path of the uploaded file <em>including</em> the filename. For example, an upload_to
function can be similar to&nbsp;this:</p>
<div class="highlight"><pre><span></span>def custom_upload_path(instance, filename):
    dt_str = instance.created_on.strftime(&quot;%Y/%m/%d&quot;)
    fname, ext = os.path.splitext(filename)
    slug_fn = slugify(anyascii.anyascii(fname))
    if ext:
        slug_fn += &quot;&quot; + ext
    return &quot;protected/{0}/{1}/{2}&quot;.format(dt_str, instance.id, slug_fn)
</pre></div>
<p>The above code will convert the filename to an ascii slug (i.e a file named <tt class="docutils literal">δοκιμή.pdf</tt> will be
converted to <tt class="docutils literal">dokime.pdf</tt>) and will store it in a folder after the created date year/month/day and id of the
object instance the file belongs to. So if for example the file <tt class="docutils literal">δοκιμή.pdf</tt> belongs to the object with id 3242
and created date 2022-09-30 will be stored on the directory <tt class="docutils literal">protected/2022/09/30/3242/dokime.pdf</tt>.</p>
<p>The above code is just an example. You can use it as a starting point and modify it to fit your needs. Having the
media files in separate folders will enable you to easily navigate the folder structure and for example back up
only a portion of the&nbsp;files.</p>
</div>
<div class="section" id="do-not-serve-media-through-your-application-server">
<h3><a class="toc-backref" href="#toc-entry-30">Do not serve media through your application&nbsp;server</a></h3>
<p>This is important. The media files of your app have to be served through your web server (i.e nginx) and <em>not</em> your
application server (i.e gunicorn). This is because the application server has a limited number of workers and if you
serve the media files through them, it will be a bottleneck for your app. Thus you need to configure your web server
to serve the media files by publishing the <tt class="docutils literal">MEDIA_ROOT</tt> folder under the <tt class="docutils literal">MEDIA_URL</tt> url similar to the static files
as described&nbsp;above.</p>
<p>Notice that by default Django will only serve your media files for development by using the following at the end of your
<tt class="docutils literal">urls.py</tt> file:</p>
<div class="highlight"><pre><span></span><span class="k">if</span> <span class="n">settings</span><span class="o">.</span><span class="n">DEBUG</span><span class="p">:</span>
    <span class="n">urlpatterns</span> <span class="o">+=</span> <span class="n">static</span><span class="p">(</span><span class="n">settings</span><span class="o">.</span><span class="n">MEDIA_URL</span><span class="p">,</span> <span class="n">document_root</span><span class="o">=</span><span class="n">settings</span><span class="o">.</span><span class="n">MEDIA_ROOT</span><span class="p">)</span>
</pre></div>
<p>Under no circumstances you should use this when <tt class="docutils literal">settings.<span class="caps">DEBUG</span> = False</tt> (i.e on&nbsp;production).</p>
</div>
<div class="section" id="secure-your-media-properly">
<h3><a class="toc-backref" href="#toc-entry-31">Secure your media&nbsp;properly</a></h3>
<p>Continuing from the above, if you are not allowed to serve your media files through your application then how are
you supposed to secure them? For example you may want to allow a user to upload files to your app but you want only
that particular user to be able to download them and not anybody else. So you&#8217;ll need to check somehow that the
user that tries to download the file is the same user that uploaded it. How can you do&nbsp;that?</p>
<p>The answer is to use a functionality offered by most web servers called X SendFile. First of all I&#8217;d like to explain how this&nbsp;works:</p>
<ol class="arabic simple">
<li>A user wants to download a file with id <tt class="docutils literal">1234</tt> so he clicks the &#8220;download&#8221; button for that&nbsp;file</li>
<li>The browser of the user will then visit a normal django view for example <tt class="docutils literal">/download/1234</tt></li>
<li>This view will check if the user is allowed to download the file by doing any permissions checks it needs to do, all in Django&nbsp;code</li>
<li>If the user is not allowed to download, it will return a 403 (forbidden) or 404 (not-found)&nbsp;response</li>
<li>However if the user is <em>allowed</em> to download the Django view will return an http response that <em>will not</em> contain the file but will have a special header with the path of the file to download (which is the path that file 1234 is saved&nbsp;on)</li>
<li>When the web server (i.e nginx) receives the http response it will check if the response has the special header and if it does it will serve the response it got <em>along</em> with the file, directly from the file system without going through the application server (i.e&nbsp;gunicorn)</li>
</ol>
<p>The above gives us the best of both worlds: We are allowed to do any checks we want in Django and the file is served through&nbsp;nginx.</p>
<p>A library that implements this functionality is django-sendfile2 which is a fork of the non-maintained anymore django-sendfile.
To use it you&#8217;ll need to follow the instructions provided and depend on your web server. However, let&#8217;s see a quick example for
nginx from one production&nbsp;project:</p>
<div class="highlight"><pre><span></span><span class="c1"># nginx conf</span>

<span class="n">server</span> <span class="p">{</span>
    <span class="c1"># other stuff</span>

    <span class="n">location</span> <span class="o">/</span><span class="n">media_project</span><span class="o">/</span><span class="n">protected</span><span class="o">/</span> <span class="p">{</span>
        <span class="n">internal</span><span class="p">;</span>
        <span class="n">alias</span> <span class="o">/</span><span class="n">home</span><span class="o">/</span><span class="n">files</span><span class="o">/</span><span class="n">project</span><span class="o">/</span><span class="n">media</span><span class="o">/</span><span class="n">protected</span><span class="o">/</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="n">location</span> <span class="o">/</span><span class="n">media_project</span><span class="o">/</span> <span class="p">{</span>
        <span class="n">alias</span> <span class="o">/</span><span class="n">home</span><span class="o">/</span><span class="n">files</span><span class="o">/</span><span class="n">project</span><span class="o">/</span><span class="n">media</span><span class="o">/</span><span class="p">;</span>
    <span class="p">}</span>


<span class="p">}</span>
</pre></div>
<p>For nginx we add a new location block that will serve the files under the <tt class="docutils literal">/media_project/protected/</tt> url. The <tt class="docutils literal">internal;</tt>
directive will prevent the client from going directly to the <span class="caps">URI</span>, so visiting <tt class="docutils literal">example.com/media_project/protected/file.pdf</tt> directly
will not work. We also have a <tt class="docutils literal">/media_project/</tt> location that serves the files under /media that are not protected. Please notice that
nginx matches the most specific path first so all files under protected will be matched with the correct, internal&nbsp;location.</p>
<div class="highlight"><pre><span></span><span class="c1"># django settings</span>
<span class="n">MEDIA_ROOT</span> <span class="o">=</span> <span class="s2">&quot;/home/files/project/media&quot;</span>
<span class="n">SENDFILE_ROOT</span> <span class="o">=</span> <span class="s2">&quot;/home/files/project/media/protected&quot;</span>

<span class="n">MEDIA_URL</span> <span class="o">=</span> <span class="s2">&quot;/media_project/&quot;</span>
<span class="n">SENDFILE_URL</span> <span class="o">=</span> <span class="s2">&quot;/media_project/protected&quot;</span>
<span class="n">SENDFILE_BACKEND</span> <span class="o">=</span> <span class="s2">&quot;sendfile.backends.nginx&quot;</span>
</pre></div>
<p>Notice the difference between the <tt class="docutils literal">MEDIA_ROOT</tt> (that contains all our media files - some are not protected) and <tt class="docutils literal">SENDFILE_ROOT</tt>
and same for <tt class="docutils literal">MEDIA_URL</tt> and <tt class="docutils literal">SENDFILE_URL</tt></p>
<div class="highlight"><pre><span></span><span class="c1"># django view</span>

<span class="k">def</span><span class="w"> </span><span class="nf">get_document</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="n">doc_id</span><span class="p">):</span>
    <span class="kn">from</span><span class="w"> </span><span class="nn">django_sendfile</span><span class="w"> </span><span class="kn">import</span> <span class="n">sendfile</span>

    <span class="n">doc</span> <span class="o">=</span> <span class="n">get_object_or_404</span><span class="p">(</span><span class="n">Document</span><span class="p">,</span> <span class="n">pk</span><span class="o">=</span><span class="n">doc_id</span><span class="p">)</span>
    <span class="n">rules_light</span><span class="o">.</span><span class="n">require</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">user</span><span class="p">,</span> <span class="s2">&quot;apps.app.read_docs&quot;</span><span class="p">,</span> <span class="n">doc</span><span class="o">.</span><span class="n">app</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">sendfile</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="n">doc</span><span class="o">.</span><span class="n">file</span><span class="o">.</span><span class="n">path</span><span class="p">,</span> <span class="n">attachment</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</pre></div>
<p>So this view first gets the <tt class="docutils literal">Document</tt> instance from its id and checks to see if the current user
can read it. Finally, it returns the <tt class="docutils literal">sendfile</tt> response that will serve the file directly from the file system passing
the <tt class="docutils literal">path</tt> of that file. This function view will have a url like <tt class="docutils literal"><span class="pre">path(&quot;get_doc/&lt;int:doc_id&gt;/&quot;,</span> login_required(views.get_document), <span class="pre">name=&quot;get_document&quot;,</span> ),</tt></p>
<p>A final comment is that for your <tt class="docutils literal">dev</tt> environment you probably want to use the
<tt class="docutils literal">SENDFILE_BACKEND = &quot;django_sendfile.backends.development&quot;</tt> (please see the settings package guideline on how to
override settings per&nbsp;env).</p>
</div>
<div class="section" id="handle-stale-media">
<h3><a class="toc-backref" href="#toc-entry-32">Handle stale&nbsp;media</a></h3>
<p>Django does never delete your media files. For example if you have an object that has a file field and the object is deleted,
the file that this file field refers to will not be deleted. The same is true if you upload a new file on that file field,
the old file will also be kept&nbsp;there!</p>
<p>This is very problematic in some cases, resulting to <span class="caps">GB</span> of unused files in your disk. To handle that, there are two&nbsp;solutions:</p>
<ul class="simple">
<li>Add a signal in your models that checks if they are deleted or a file field is updated and delete the non-used file. This is implemented by the <a class="reference external" href="https://github.com/un1t/django-cleanup">django-cleanup</a>&nbsp;package.</li>
<li>Use a management command that will periodically check for stale files and delete them. This is implemented by the <a class="reference external" href="https://github.com/akolpakov/django-unused-media">django-unused-media</a>&nbsp;package.</li>
</ul>
<p>I&#8217;ve used both packages in various projects and they work great. I&#8217;d recommend the django-cleanup on greenfield projects so as to avoid stale files from the&nbsp;beginning.</p>
</div>
</div>
<div class="section" id="debugging-guidelines">
<h2><a class="toc-backref" href="#toc-entry-33">Debugging&nbsp;guidelines</a></h2>
<div class="section" id="be-careful-when-using-django-debug-toolbar">
<h3><a class="toc-backref" href="#toc-entry-34">Be careful when using&nbsp;django-debug-toolbar</a></h3>
<p>The <a class="reference external" href="https://github.com/jazzband/django-debug-toolbar">django-debug-toolbar</a> is a great and very popular library that can help you debug your Django applications
and identify slow views and n+1 query problems. However I have observed that it makes your development app <em>much slower</em>.
For some views I am seeing like 10x decrease in speed i.e instead of 500 ms we&#8217;ll need more than 5 seconds to display
that view! Since Django development (at least for me) is based on a very quick feedback loop, this is a huge&nbsp;problem.</p>
<p>Thus, I recommend to keep it disabled when you are doing normal development and only enable it when you need it,
for example to identify n+1 query&nbsp;problems.</p>
</div>
<div class="section" id="use-the-werkzeug-debugger">
<h3><a class="toc-backref" href="#toc-entry-35">Use the Werkzeug&nbsp;debugger</a></h3>
<p>Instead of using the traditional runserver to run your app in development
I recommend installing the <a class="reference external" href="https://github.com/django-extensions/django-extensions">django-extensions</a> package so as to be able to
use the Werkzeug debugger. This will enable you to get a python prompt
whenever your code throws an exception or even to add your own breakpoints by throwing&nbsp;exceptions.</p>
<p>In a nutshell, you&#8217;ll something like <tt class="docutils literal"><span class="pre">aa+=1</span></tt> (<tt class="docutils literal">aa</tt> should not be an integer) somewhere in your code (in a view, or a model method etc)
and python will throw an exception. You&#8217;ll be able to get a python shell and inspect the state of your app inside that particular point,
so you can see what variables are available and their values, run code etc. This is a superpower that after you start using it you&#8217;ll
never want to go back to the traditional&nbsp;runserver.</p>
<p>More info on my <a class="reference external" href="https://www.spapas.net/2016/06/07/django-werkzeug-debugger/">Django Werkzeug debugger article</a>.</p>
</div>
</div>
<div class="section" id="general-guidelines">
<h2><a class="toc-backref" href="#toc-entry-36">General&nbsp;guidelines</a></h2>
<div class="section" id="consider-using-a-cookiecutter-project-template">
<h3><a class="toc-backref" href="#toc-entry-37">Consider using a cookiecutter project&nbsp;template</a></h3>
<p>If you are working on a Django shop so you need to create frequenctly new Django apps I&#8217;d recommend to
consider creating (or use an existing) <a class="reference external" href="https://github.com/cookiecutter/cookiecutter">cookiecutter</a> project template. You can use <a class="reference external" href="https://github.com/spapas/cookiecutter-django-starter">my own cookiecutter</a>
to create your projects or as an inspiration to create your own. It follows all the conventions I mention in
this post and it is very simple to&nbsp;use.</p>
</div>
<div class="section" id="be-careful-on-your-selection-of-packages-addons">
<h3><a class="toc-backref" href="#toc-entry-38">Be careful on your selection of&nbsp;packages/addons</a></h3>
<p>Django, because of its popularity, has an <a class="reference external" href="https://djangopackages.org/">abundance of packages/addons</a> that can help you do almost anything.
However, my experience has taught me that you should be very careful and do your research before adding a new
package to your project. I&#8217;ve been left many times with projects that I was not able to upgrade because they
heavily relied on functionality from an external package that was abandoned by its creator. I also have lost
many hours trying to debug a problem that was caused by a package that was not compatible with the latest version
of&nbsp;Django.</p>
<p>So my guidelines before using an external Django addon&nbsp;are:</p>
<ul class="simple">
<li>Make sure that it has been upgraded recently. There are <em>no</em> finished Django addons. Django is constantly evolving by releasing new versions and that must be true for the addons. Even if the addons are compatible with the new Django version they need to denote that in their <span class="caps">README</span> so as to know that their maintainers&nbsp;care.</li>
<li>Avoid using very new packages. I&#8217;ve seen many packages that are not yet mature and they are not yet ready for production. If you really need to use such a package make sure that you understand what it does and you can fix problems with the package if&nbsp;needed.</li>
<li>Avoid using packages that rely heavily on Javascript; this is usually better to do on your&nbsp;own.</li>
<li>Try to understand, at least at a high level, what the package does. If you don&#8217;t understand it, you will not be able to debug if it&nbsp;breaks.</li>
<li>Make sure that the package is well documented and that it has a good test&nbsp;coverage.</li>
<li>Don&#8217;t use very simple packages that you can easily implement yourself. Don&#8217;t be a left-pad&nbsp;developer.</li>
</ul>
<p>I already propose some packages in this article but I also like to point you out to my
<a class="reference external" href="https://www.spapas.net/2017/10/11/essential-django-packages/">Django essential package list</a>. This list was compiled 5 years ago and
I&#8217;m happy to still recommend <em>all</em> of these packages with the following minor&nbsp;changes:</p>
<ul class="simple">
<li>Nowadays I recommend using wkhtmltopdf for creating PDFs from Django instead of xhtml2pdf. Please see my <a class="reference external" href="https://www.spapas.net/2022/02/14/django-pdfs-2022/">PDFs in Django like it&#8217;s 2022</a> article for more info. Notice that there&#8217;s nothing wrong with the xhtml2pdf package, it still works great and is supported but my personal preference is to use the&nbsp;wwhtmltopdf.</li>
<li>The django-sendfile is no longer supported so you need to use <a class="reference external" href="https://github.com/moggers87/django-sendfile2">django-sendfile2</a> instead. This is a drop-in replacement from django-sendfile2. See the point about media securing for more&nbsp;info.</li>
<li><a class="reference external" href="https://github.com/django-auth-ldap/django-auth-ldap">django-auth-ldap</a> uses github now (nothing changed, it just uses github instead of&nbsp;bitbucket).</li>
</ul>
<p>The fact that from a list of ~30 packages only one (django-sendfile) is no longer supported
(and the fact that even for that there&#8217;s a drop-in replacement) is
a testament to the quality of the Django ecosystem (and to my choosing&nbsp;capabilities).</p>
<p>In addition to the packages of my list, this article already contains a bunch of packages
that I&#8217;ve used in my projects and I am happy with them so I&#8217;d also recommend them to&nbsp;you.</p>
</div>
<div class="section" id="don-t-be-afraid-to-use-threadlocals">
<h3><a class="toc-backref" href="#toc-entry-39">Don&#8217;t be afraid to use&nbsp;threadlocals</a></h3>
<p>One controversial aspect if Django is that it avoids using the threadlocals functionality. The <a class="reference external" href="https://docs.python.org/3/library/threading.html#thread-local-data">thread-local data</a> is a
way to store data that is specific to the current running thread. This, combined with the fact that each one of the
requests to your Django app <em>will be served by the same thread</em> (worker) gives you a super powerful way to store and then
access data that is specific to the current request and would be very difficult (if at all possible) to do it&nbsp;otherwise.</p>
<p>The usual way to work with thread locals in Django is to add a middleware that sets the current request in the thread local
data. Then you can access this data from wherever you want in your code, like a global. You can either create that middleware
yourself but I&#8217;d recommend using the <a class="reference external" href="https://github.com/jedie/django-tools/">django-tools</a> library for adding this functionality. You&#8217;ll add the
<tt class="docutils literal">'django_tools.middlewares.ThreadLocal.ThreadLocalMiddleware'</tt> to your list of middleware (at the end of the listt
unless you want to use the current user from another middleware) and then you&#8217;ll use it like&nbsp;this:</p>
<div class="highlight"><pre><span></span><span class="kn">from</span><span class="w"> </span><span class="nn">django_tools.middlewares</span><span class="w"> </span><span class="kn">import</span> <span class="n">ThreadLocal</span>

<span class="c1"># Get the current request object:</span>
<span class="n">request</span> <span class="o">=</span> <span class="n">ThreadLocal</span><span class="o">.</span><span class="n">get_current_request</span><span class="p">()</span>
<span class="c1"># You can get the current user directly with:</span>
<span class="n">user</span> <span class="o">=</span> <span class="n">ThreadLocal</span><span class="o">.</span><span class="n">get_current_user</span><span class="p">()</span>
</pre></div>
<p>Please notice that Django recommends avoiding this technique because it hides the request/user dependency and makes
testing more difficult. However I&#8217;d like to respectfully disagree with their&nbsp;rationale.</p>
<ul class="simple">
<li>First of all, please notice that this is exactly how <a class="reference external" href="https://flask.palletsprojects.com/en/2.2.x/reqcontext/">Flask works</a> when you access the current request. It stores the request in the thread locals and then you can access it from anywhere in your&nbsp;code.</li>
<li>Second, there are things that are very difficult (or even not possible) without using the threadlocals. I&#8217;ll give you an example in a&nbsp;little.</li>
<li>Third, you can be careful to use the thread locals functionality properly. After all it is a very simple concept. The fact that you are using thread locals can be integrated to your&nbsp;tests.</li>
</ul>
<p>One example of why thread locals are so useful is this abstract class that I use in almost all my projects and&nbsp;models:</p>
<div class="highlight"><pre><span></span><span class="k">class</span><span class="w"> </span><span class="nc">UserDateAbstractModel</span><span class="p">(</span><span class="n">models</span><span class="o">.</span><span class="n">Model</span><span class="p">):</span>
    <span class="n">created_on</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">DateTimeField</span><span class="p">(</span><span class="n">auto_now_add</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="p">)</span>
    <span class="n">modified_on</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">DateTimeField</span><span class="p">(</span><span class="n">auto_now</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="n">created_by</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">ForeignKey</span><span class="p">(</span>
        <span class="n">settings</span><span class="o">.</span><span class="n">AUTH_USER_MODEL</span><span class="p">,</span>
        <span class="n">on_delete</span><span class="o">=</span><span class="n">models</span><span class="o">.</span><span class="n">PROTECT</span><span class="p">,</span>
        <span class="n">related_name</span><span class="o">=</span><span class="s2">&quot;</span><span class="si">%(class)s</span><span class="s2">_created&quot;</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="n">modified_by</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">ForeignKey</span><span class="p">(</span>
        <span class="n">settings</span><span class="o">.</span><span class="n">AUTH_USER_MODEL</span><span class="p">,</span>
        <span class="n">on_delete</span><span class="o">=</span><span class="n">models</span><span class="o">.</span><span class="n">PROTECT</span><span class="p">,</span>
        <span class="n">related_name</span><span class="o">=</span><span class="s2">&quot;</span><span class="si">%(class)s</span><span class="s2">_modified&quot;</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="k">class</span><span class="w"> </span><span class="nc">Meta</span><span class="p">:</span>
        <span class="n">abstract</span> <span class="o">=</span> <span class="kc">True</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">save</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="n">user</span> <span class="o">=</span> <span class="n">ThreadLocal</span><span class="o">.</span><span class="n">get_current_user</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">user</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">pk</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">created_by</span> <span class="o">=</span> <span class="n">user</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">modified_by</span> <span class="o">=</span> <span class="n">user</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">UserDateAbstractModel</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
</pre></div>
<p>Models that override this abstract model will automatically set the <tt class="docutils literal">created_by</tt> and <tt class="docutils literal">modified_by</tt> fields to the current user. This works
the same no matter if I edit the object from the admin, or from a view. To use that functionality all I need to do is to inherit from that model i.e
<tt class="docutils literal">class MyModel(UserDateAbstractModel)</tt> and that&#8217;s&nbsp;it.</p>
<p>What would I need to do if I didn&#8217;t use the thread locals? I&#8217;d need to create a mixin from which <em>all my views</em> (that modify an object)
would inherit! This mixin would pick the current user from the request and set it up. Please consider the difference between these two approaches;
using the model based approach with the thread locals I can be assured that no matter where I modify an object, the <tt class="docutils literal">created_by</tt> and <tt class="docutils literal">modified_by</tt>
will be set properly (unless of course I modify it through the database or django shell &#8212; actually, I could make <tt class="docutils literal">save</tt> throw if
the current use hasn&#8217;t been setup so it wouldn&#8217;t be possible to modify from the shell). If I use the mixin approach, I need to make sure that
all my views inherit from that mixin and that I don&#8217;t forget to do it. Also other people that add code to my project will also need to
remember that. This is a lot more error prone and difficult to&nbsp;maintain.</p>
<p>The above is a <em>simple</em> example. I have seen many more cases where without the use of thread locals I&#8217;d need to replicate 3-4 classes
from an external library (this library was django-allauth for anybody interested) in order to be able to pass through the current user
to where I needed to use this. This is a lot of code duplication and a maintenance&nbsp;hell.</p>
<p>One final comment: I&#8217;m not recommending to do it like Flask, i.e use thread locals anywhere. For example, in your views and forms it is
easy to get the current request, there&#8217;s no need to use thread locals there. However, in places where there&#8217;s no simple path for
accessing the current user then definitely use thread locals and don&#8217;t feel bad about&nbsp;it!</p>
</div>
<div class="section" id="the-async-tasks-situation">
<h3><a class="toc-backref" href="#toc-entry-40">The async tasks&nbsp;situation</a></h3>
<p>It is very common for new projects to add support for async tasks, either using celery, or django-rq or various other
solutions. I&#8217;ve already written a
<a class="reference external" href="https://www.spapas.net/2015/01/27/async-tasks-with-django-rq/">bunch</a>.
<a class="reference external" href="https://www.spapas.net/2015/09/01/django-rq-redux/">of</a>.
<a class="reference external" href="https://www.spapas.net/2019/02/25/django-fix-async-db/">posts</a>.
about this&nbsp;topic.</p>
<p>First of all let&#8217;s understand <em>why</em> we need async tasks: When you serve Djagno (or any Python web app) in production, you&#8217;ll
start a number of worker processes that will be used to serve the users. These usually are normal <span class="caps">OS</span> processes. The guidelines
are to start a finite amount of such processes, equal to 2-4 times the number of the <span class="caps">CPU</span> cores of your server. So with 2 cores
you&#8217;ll have like 8 workers. This means your Django app can handle up to 8 concurrent requests at the same time. If we have a
view that takes too long to response (e.g. because it runs a slow query), we&#8217;ll have many workers
&#8220;stuck&#8221; on that view, resulting in delays for the other users since the number of workers always stays the&nbsp;same.</p>
<p>To resolve that issue we can use async tasks to offload the work to the &#8220;background&#8221;. I.e instead of the view waiting
for the slow query to finish, it will now add a task in a queue and return immediately. The tasks in the queue will then be run
by the async worker one after another. The other way to resolve that is to increase the number of workers, but that is not
a good idea since each worker takes a certain amount of memory and resources and we still can&#8217;t be positive that we&#8217;ll be able
to handle all traffic peaks to our slow&nbsp;views.</p>
<p>So, although I believe that async tasks are essential for <em>some</em> situations,
my recommendation here is to be very careful and think twice before adding support for async tasks for your project.
Because of how python works, the <em>only</em> way to have support for async tasks is to have <em>one or more extra</em> moving parts
to your&nbsp;project.</p>
<p>These moving parts will be always a task worker process (that would pick the async tasks from the queue
and execute them asynchronously) and probably an external process that would store your queue. Actually the queue process may be redis
if you already use it for caching or even the database but also there are projects that use a separate application for the queue
like&nbsp;Rabbitmq.</p>
<p>This may look like a small thing but in a production environment this means that instead of running 1 thing for
your django app (a gunicorn or uwsgi app server) you need to add at least another thing (the worker). This results&nbsp;tp</p>
<ul class="simple">
<li>Make sure that the worker <em>sees</em> and handles your&nbsp;tasks</li>
<li>Monitoring the worker (getting alerts when the worker stops, make sure it runs&nbsp;etc)</li>
<li>Start the worker when your server starts (i.e when your server&nbsp;reboots)</li>
<li>Re-start the worker when you deploy changes (this is critical and easily missed; your worker won&#8217;t pick any changes to your app when you deploy it, if you don&#8217;t re-start it it will run stale&nbsp;code)</li>
<li>Handle exceptions to your async tasks&nbsp;properly</li>
<li>Make sure you have some kind of logging and exception tracking for the&nbsp;worker</li>
</ul>
<p>All this adds up especially if you need to do for every new&nbsp;app.</p>
<p>Taking this into account, I&#8217;d recommend to think twice before adding support for async tasks in you Django app. If you really need it, then
of course, you&#8217;ll need to bite the bullet and add it. But lately my understanding is that people tend to add support for async tasks
even though they don&#8217;t really need it. Let&#8217;s see some&nbsp;examples:</p>
<ul class="simple">
<li><em>I&#8217;ve got a view that sends mails and it is too slow</em>. If the view opens a connection to an <span class="caps">SMTP</span> server and sends the email then probably it will be slow. However, before using the async task situation, consider using a service like sendgrid or mailgun that will send your mails for you and will be much&nbsp;faster.</li>
<li><em>I need to run slow queries</em>. Well&#8230; no you don&#8217;t. Your queries should <em>not</em> be slow. You should try to optimize your queries to run faster. If you have done all optimizations and still your queries are slow then you should consider de-normalizing your data to increase performance. This (at least in my book) is preferable over adding async&nbsp;tasks.</li>
<li><em>I need to do bulk operations</em>. This probably is a reason to run async tasks. But before biting the bullet, consider: how many of your users are going to run such bulk operations at the same&nbsp;time?</li>
</ul>
</div>
</div>
</div>
  		</article>
  		<article>
<header>
      <h1 class="entry-title">
        <a href="https://www.spapas.net/2022/09/20/postgresql-windows-dev/">Setting up Postgres on Windows for development</a>
      </h1>
    <p class="meta">
<time datetime="2022-09-20T11:10:00+03:00" pubdate>Tue 20 September 2022</time>    </p>
</header>

<div class="entry-content"><div class="section" id="introduction">
<h2>Introduction</h2>
<p>To install Postgresql for a production server on Windows you&#8217;d usually go to the
<a class="reference external" href="https://www.postgresql.org/download/windows/">official website</a> and use the download link. This will give you an executable
installer that would install Postgresql on your server and help you configure&nbsp;it.</p>
<p>However, since I only use Windows for development (and never running any in
production on Windows) I&#8217;ve found out that there&#8217;s a much better and easier way to install
postgresql for development and windows which I&#8217;ll describe in this&nbsp;post.</p>
<p>If you want to avoid reading the whole post, you can just follow the steps described on the
<a class="reference internal" href="#tl-dr-below"><span class="caps">TL</span>;<span class="caps">DR</span> below</a> however I&#8217;d recommend reading to understand&nbsp;everything.</p>
</div>
<div class="section" id="downloading-the-server">
<h2>Downloading the&nbsp;server</h2>
<p>First, you&#8217;ll
click the <a class="reference external" href="https://www.enterprisedb.com/download-postgresql-binaries">zip archives</a> link on the . <a class="reference external" href="https://www.postgresql.org/download/windows/">official website</a> and then
download the zip archive of the Postgres version you&#8217;ll want to install. Right now there are
archives for every current version like 14.5, 13.8, 12.12 etc. Let&#8217;s get the latest one,&nbsp;14.5.</p>
<p>This will give me a zip file named <tt class="docutils literal"><span class="pre">postgresql-14.5-1-windows-x64-binaries.zip</span></tt> which contains a
single folder named <tt class="docutils literal">pgsql</tt>. I&#8217;ll extract that folder, rename it to <tt class="docutils literal">pgsql145</tt> and move it to <tt class="docutils literal"><span class="pre">c:\progr</span></tt>
(I keep stuff there to avoid putting everything on C:). Now you should have a folder named
<tt class="docutils literal"><span class="pre">c:\progr\pgsql145</span></tt> that contains a bunch of folder named <tt class="docutils literal">bin</tt>, <tt class="docutils literal">doc</tt>, <tt class="docutils literal">include</tt> etc.</p>
</div>
<div class="section" id="setting-up-the-server">
<h2>Setting up the&nbsp;server</h2>
<p>Now we are ready to setup Postgresql. Open a command line and move to the <tt class="docutils literal">pgsql145\bin</tt> folder:</p>
<pre class="code literal-block">
cd c:\progr\pgsql145\bin
</pre>
<p>The bin folder contains <em>all</em> executables of your server and client, like <tt class="docutils literal">psql.exe</tt> (the <span class="caps">CUI</span> client),
<tt class="docutils literal">pg_dump.exe</tt> (backup), <tt class="docutils literal">initdb.exe</tt> (create a new <span class="caps">DB</span> cluster), <tt class="docutils literal">createdb/dropdb/createuser/dropuser.exe ``
(create/drop database/user - these can also be run from <span class="caps">SQL</span>)
and ``postgres.exe</tt> which is the actual server&nbsp;executable.</p>
<p>Our first step is to create a database cluster using initdb. We need to pass it a folder that will
contain the data of our cluster. So we&#8217;ll run it&nbsp;like:</p>
<pre class="code literal-block">
initdb.exe -D c:\progr\pgsql145\data
</pre>
<p>(also you could run <tt class="docutils literal">initdb.exe <span class="pre">-D</span> <span class="pre">..\data</span></tt>, since we are on the bin folder). We&#8217;ll get output similar&nbsp;to:</p>
<pre class="code literal-block">
The files belonging to this database system will be owned by user &quot;serafeim&quot;.
This user must also own the server process.

The database cluster will be initialized with locale &quot;Greek_Greece.1252&quot;.
The default database encoding has accordingly been set to &quot;WIN1252&quot;.
The default text search configuration will be set to &quot;greek&quot;.

Data page checksums are disabled.

fixing permissions on existing directory c:/progr/pgsql145/data ... ok
creating subdirectories ... ok
selecting dynamic shared memory implementation ... windows
selecting default max_connections ... 100
selecting default shared_buffers ... 128MB
selecting default time zone ... Europe/Bucharest
creating configuration files ... ok
running bootstrap script ... ok
performing post-bootstrap initialization ... ok
syncing data to disk ... ok

initdb: warning: enabling &quot;trust&quot; authentication for local connections
You can change this by editing pg_hba.conf or using the option -A, or
--auth-local and --auth-host, the next time you run initdb.

Success. You can now start the database server using:

    pg_ctl -D ^&quot;c^:^\progr^\pgsql145^\data^&quot; -l logfile start
</pre>
<p>And now we&#8217;ll have a folder named <tt class="docutils literal"><span class="pre">c:\progr\pgsql145\data</span></tt> that contains files like
<tt class="docutils literal">pg_hba.conf</tt>, <tt class="docutils literal">pg_ident.conf</tt>, <tt class="docutils literal">postgresql.conf</tt> and various folders that will keep our
database server data. All these can be configured but we&#8217;re going to keep using the default config
since it fits our&nbsp;needs!</p>
<p>Notice&nbsp;that:</p>
<ul class="simple">
<li>The files of our database belong to the &#8220;serafeim&#8221; role. This role is automatically created by initdb. This is the same username that I&#8217;m using to log in to windows (i.e my home folder is <tt class="docutils literal"><span class="pre">c:\users\serafeim\</span></tt> folder) so this will be different for you. If you wanted to use a different user name or the classic <tt class="docutils literal">postgres</tt> you could pass it to <tt class="docutils literal">initdb</tt> with the -U parameter, for example: <tt class="docutils literal">initdb.exe <span class="pre">-D</span> <span class="pre">c:\progr\pgsql145\data_postgres</span> <span class="pre">-U</span> postgres</tt>.</li>
<li>By default &#8220;trust&#8221; authentication has been configured. This means, copying from <a class="reference external" href="https://www.postgresql.org/docs/current/auth-trust.html">postgres trust authentication page</a> that &#8220;[&#8230;] PostgreSQL assumes that anyone who can connect to the server is authorized to access the database with whatever database user name they specify (even superuser names)&#8221;. So local connections will always be accepted with the username we are passing. We&#8217;ll see how this works in a&nbsp;minute.</li>
<li>The default database encoding will be <span class="caps">WIN1252</span> (on my system). We&#8217;ll talk about that a little more later (hint: it&#8217;s better to pass -E utf-8 to set your cluster encodign to&nbsp;utf-8)</li>
</ul>
</div>
<div class="section" id="starting-the-server">
<h2>Starting the&nbsp;server</h2>
<p>We could use the <tt class="docutils literal">pg_ctl.exe</tt> executable as proposed by the initdb to start the server as a a background process.
However, for our purposes it&#8217;s better to start the server as a foreground process on a dedicated window. So we&#8217;ll run the <tt class="docutils literal">postgres.exe</tt> directly&nbsp;like:</p>
<pre class="code literal-block">
postgres.exe -D c:\progr\pgsql145\data
</pre>
<p>or, from the <tt class="docutils literal">bin</tt> directory we could run <tt class="docutils literal">postgres.exe <span class="pre">-D</span> <span class="pre">..\data</span></tt>. The output will&nbsp;be</p>
<pre class="code literal-block">
2022-09-20 09:34:10.184 EEST [10648] LOG:  starting PostgreSQL 14.5, compiled by Visual C++ build 1914, 64-bit
2022-09-20 09:34:10.189 EEST [10648] LOG:  listening on IPv6 address &quot;::1&quot;, port 5432
2022-09-20 09:34:10.189 EEST [10648] LOG:  listening on IPv4 address &quot;127.0.0.1&quot;, port 5432
2022-09-20 09:34:10.330 EEST [3084] LOG:  database system was shut down at 2022-09-20 09:34:08 EEST
2022-09-20 09:34:10.369 EEST [10648] LOG:  database system is ready to accept connections
</pre>
<p>Success! Our server is running and listening on 127.0.0.1 port 5432. This means that it accepts connection <em>only</em> from our local machine
(which is what we want for our purposes). We can now connect to it using the <tt class="docutils literal">psql.exe</tt> client. Open another cmd, go to <tt class="docutils literal"><span class="pre">C:\progr\pgsql145\bin</span></tt>
and run <tt class="docutils literal">psql.exe</tt>: You&#8217;ll probably get an error similar to <tt class="docutils literal">psql: error: connection to server at &quot;localhost&quot; <span class="pre">(::1),</span> port 5432 failed: <span class="caps">FATAL</span>:&nbsp; database &quot;serafeim&quot; does not exist</tt>
(unless your windows username is <tt class="docutils literal">postgres</tt>).</p>
<p>By default psql.exe tries to connect with a role with the username of your Windows user and to a database named after the user you are
connecting with. Our database server <em>has</em> a role named <tt class="docutils literal">serafeim</tt> (it is created by default by the initdb as described before) but it doesn&#8217;t have a database named <tt class="docutils literal">serafeim</tt>! Let&#8217;s connect
to the <tt class="docutils literal">postgres</tt> database instead by passing it as a parameter <tt class="docutils literal">psql postgres</tt>:</p>
<pre class="code literal-block">
C:\progr\pgsql145\bin&gt;psql postgres
psql (14.5)
WARNING: Console code page (437) differs from Windows code page (1252)
        8-bit characters might not work correctly. See psql reference
        page &quot;Notes for Windows users&quot; for details.
Type &quot;help&quot; for help.

postgres=# select version();
                          version
------------------------------------------------------------
PostgreSQL 14.5, compiled by Visual C++ build 1914, 64-bit
(1 row)
</pre>
<p>Success!</p>
<p>Let&#8217;s cerate a sample user and database to make user that everything&#8217;s working fine <tt class="docutils literal">createuser.exe koko</tt>,
<tt class="docutils literal">createdb kokodb</tt> and connect to the <tt class="docutils literal">kokodb</tt> as <tt class="docutils literal">koko</tt>: <tt class="docutils literal">psql <span class="pre">-U</span> koko kokodb</tt>.</p>
<pre class="code literal-block">
kokodb=&gt; create table kokotable(foo varchar);
CREATE TABLE
kokodb=&gt; insert into kokotable values('kokoko');
INSERT 0 1
kokodb=&gt; select * from kokotable;
  foo
--------
kokoko
(1 row)
</pre>
<p>Everything&#8217;s working fine! In the meantime, we should get useful output on our postgres dedicated windows, like
<tt class="docutils literal"><span class="pre">2022-09-20</span> 09:36:01.899 <span class="caps">EEST</span> [9704] <span class="caps">FATAL</span>:&nbsp; database &quot;serafeim&quot; does not exist</tt>. To stop it, just press <tt class="docutils literal">Ctrl+C</tt>
on that window and you should get output similar&nbsp;to:</p>
<pre class="code literal-block">
2022-09-20 09:46:45.178 EEST [10648] LOG:  background worker &quot;logical replication launcher&quot; (PID 7860) exited with exit code 1
2022-09-20 09:46:45.185 EEST [10048] LOG:  shutting down
2022-09-20 09:46:45.278 EEST [10648] LOG:  database system is shut down
</pre>
<p>I usually add a <tt class="docutils literal">pg.bat</tt> file on my <tt class="docutils literal"><span class="pre">c:\progr\pgsql145\</span></tt> that will start the database with its data folder. It&#8217;s contents are only
<tt class="docutils literal">bin\postgres.exe <span class="pre">-D</span> data</tt></p>
<p>So let&#8217;s create the pg.bat like&nbsp;this:</p>
<pre class="code literal-block">
c:\&gt;cd c:\progr\pgsql145

c:\progr\pgsql145&gt;copy con pg.bat
bin\postgres.exe -D data
^Z
        1 file(s) copied.

c:\progr\pgsql145&gt;pg.bat
2022-09-20 09:49:53.642 EEST [11660] LOG:  starting PostgreSQL 14.5, compiled by Visual C++ build 1914, 64-bit
...
</pre>
<p>One final thing to notice is that, since we use the trust authentication there&#8217;s no check for the password, so if we
tried to pass a password like <tt class="docutils literal">psql <span class="pre">-U</span> koko <span class="pre">-W</span> kokodb</tt> it will work no matter what password we&nbsp;type.</p>
</div>
<div class="section" id="encoding-stuff">
<h2>Encoding&nbsp;stuff</h2>
<div class="section" id="the-default-encoding-situation">
<h3>The default encoding&nbsp;situation</h3>
<p>You may have noticed before that the default encoding for databases will be <tt class="docutils literal"><span class="caps">WIN1252</span></tt> (or some other
similar 8-bit character set). You never want that (I guess this default is there for compatibility reasons),
you want to have utf-8 encoding. So you should either
pass the proper encoding to initdb,&nbsp;like:</p>
<pre class="code literal-block">
initdb -D ..\datautf8 -E utf-8
</pre>
<p>This will create a new cluster with utf-8 encoding. All databases created on that cluster will be utf-8 by&nbsp;default.</p>
<p>If you&#8217;ve already got a non-utf-8  cluster, you should force utf-8 for your new database&nbsp;instead:</p>
<pre class="code literal-block">
createdb -E utf-8 -T template0 dbutf8
</pre>
<p>Notice that I also passed the <tt class="docutils literal"><span class="pre">-T</span> template0</tt> parameter to use the <tt class="docutils literal">template0</tt> <a class="reference external" href="https://www.postgresql.org/docs/current/manage-ag-templatedbs.html">template database</a>. If I
tried to run <tt class="docutils literal">createdb <span class="pre">-E</span> <span class="pre">utf-8</span> dbutf8</tt> (so it would use the <tt class="docutils literal">template1</tt>) I&#8217;d get an error similar&nbsp;to:</p>
<pre class="code literal-block">
createdb: error: database creation failed: ERROR:  new encoding (UTF8) is incompatible with the encoding of the template database (WIN1252)
HINT:  Use the same encoding as in the template database, or use template0 as template.
</pre>
</div>
<div class="section" id="about-the-psql-codepage-warning">
<h3>About the psql codepage&nbsp;warning</h3>
<p>You may (or may not) have noticed a warning similar to this when starting the&nbsp;server:</p>
<pre class="code literal-block">
WARNING: Console code page (437) differs from Windows code page (1252)
      8-bit characters might not work correctly. See psql reference
      page &quot;Notes for Windows users&quot; for details.
</pre>
<p>Some more info about this can be found in the <a class="reference external" href="https://www.postgresql.org/docs/14/app-psql.html`">psql reference page</a> and
<a class="reference external" href="https://stackoverflow.com/questions/20794035/postgresql-warning-console-code-page-437-differs-from-windows-code-page-125">this <span class="caps">SO</span> issue</a>. To avoid this warning you&#8217;ll use <tt class="docutils literal">chcp 1252</tt> to set the console code page to 1252
before running&nbsp;psql.</p>
<p>I have to warn you though that using psql.exe from the windows console <strong>will be problematic</strong> anyway
because of not good unicode support. You can use it fine as long as you write only ascii characters but
I&#8217;d avoid anything&nbsp;else.</p>
<p>That&#8217;s why I&#8217;d recommend using a graphical database client like for example <a class="reference external" href="https://dbeaver.io/">dbeaver</a>.</p>
</div>
</div>
<div class="section" id="a-tl-dr-walkthrough">
<span id="tl-dr-below"></span><h2>A <span class="caps">TL</span>;<span class="caps">DR</span>&nbsp;walkthrough</h2>
<p>Here are the steps to follow to get a working postgresql server on&nbsp;windows:</p>
<ol class="arabic simple">
<li>Download the postgresql windows binaries of the version you want from the <a class="reference external" href="https://www.enterprisedb.com/download-postgresql-binaries">zip archives</a> page and extract it to a folder, let&#8217;s name it <tt class="docutils literal">pgsql</tt>.</li>
<li>Go to <tt class="docutils literal">pgsql\bin</tt> folder on a command&nbsp;line</li>
<li>Run <tt class="docutils literal">initdb.exe <span class="pre">-D</span> <span class="pre">..\data</span> <span class="pre">-E</span> <span class="pre">utf-8</span></tt> from inside the <tt class="docutils literal">pgsql\bin</tt> folder of the  to create a new database cluster with utf-8 encoding on the <tt class="docutils literal">data</tt> directory</li>
<li>Run <tt class="docutils literal">postgresql.exe <span class="pre">-D</span> <span class="pre">..\data</span></tt> to start the database&nbsp;server</li>
<li>Go to <tt class="docutils literal">pgsql\bin</tt> folder on another command&nbsp;line</li>
<li>Run <tt class="docutils literal">psql postgres</tt> to connect to the <tt class="docutils literal">postgres</tt> database with a role similar to your windows&nbsp;username</li>
<li>Profit!</li>
</ol>
</div>
<div class="section" id="conclusion">
<h2>Conclusion</h2>
<p>Using the above steps you can easily setup a postgres database server on windows for development. Some advantages of the method
proposed here&nbsp;are:</p>
<ul class="simple">
<li>Since you configure the data directory you can have as many clusters as you want (run initdb with different data directories and pass them to&nbsp;postgres)</li>
<li>Since nothing is installed globally, you can have as many postgresql versions as you want, each one having its own data directory. Then you&#8217;ll start the one you want each time! For example I&#8217;ve got Postgresql 12,13 and&nbsp;14.5.</li>
<li>Using the trust authentication makes it easy to connect with whatever&nbsp;user</li>
<li>Running the database from postgresql.exe so it has a dedicated window makes it easy to know what the database is doing, peeking at the logs and stopping it (using&nbsp;ctrl+c)</li>
</ul>
</div>
</div>
  		</article>
<div class="pagination">
    <a class="prev" href="https://www.spapas.net/index3.html">&larr; Older</a>

    <a class="next" href="https://www.spapas.net/index.html">Newer &rarr;</a>
  <br />
</div></div>
<aside class="sidebar">
  
  <section>
    <br />
    <a href='/feeds/all.atom.xml'>Atom</a>
    |
    <a href='/feeds/all.rss.xml'>RSS</a>
  </section>

  <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <!-- Sidebar unit -->
  <ins class="adsbygoogle" style="display:block" data-ad-client="ca-pub-7673322832689008" data-ad-slot="2720624730"
    data-ad-format="auto" data-full-width-responsive="true"></ins>
  <script>
    (adsbygoogle = window.adsbygoogle || []).push({});
  </script>


  <script async src="https://cse.google.com/cse.js?cx=612920e5ca9da850c"></script>
  <div class="gcse-search"></div>

  
  <section>
    <h1>Support me</h1>

    You can show your appreciation for anything useful you've found here by 
    buying me a coffee 
    <script type="text/javascript" src="https://cdnjs.buymeacoffee.com/1.0.0/button.prod.min.js" data-name="bmc-button" data-slug="spapas" data-color="#FFDD00" data-emoji=""  data-font="Lato" data-text="Buy me a coffee" data-outline-color="#000000" data-font-color="#000000" data-coffee-color="#ffffff" ></script>

    or donating me some bitcoin to this address:
    <small><pre>bc1qx42vp8napheaewhnx0rk0mttdrdrtvw6czvxhl</pre></small>
    <svg shape-rendering="crispEdges" height="200" width="200" viewBox="0 0 29 29" class="qrcode">
      <path fill="#FFFFFF" d="M0,0 h29v29H0z"></path><path fill="#000000" d="M0 0h7v1H0zM9 0h2v1H9zM12 0h1v1H12zM14 0h2v1H14zM18 0h2v1H18zM22,0 h7v1H22zM0 1h1v1H0zM6 1h1v1H6zM8 1h1v1H8zM11 1h1v1H11zM14 1h5v1H14zM22 1h1v1H22zM28,1 h1v1H28zM0 2h1v1H0zM2 2h3v1H2zM6 2h1v1H6zM8 2h4v1H8zM17 2h1v1H17zM22 2h1v1H22zM24 2h3v1H24zM28,2 h1v1H28zM0 3h1v1H0zM2 3h3v1H2zM6 3h1v1H6zM9 3h2v1H9zM14 3h3v1H14zM18 3h1v1H18zM22 3h1v1H22zM24 3h3v1H24zM28,3 h1v1H28zM0 4h1v1H0zM2 4h3v1H2zM6 4h1v1H6zM8 4h1v1H8zM11 4h1v1H11zM13 4h1v1H13zM15 4h2v1H15zM18 4h1v1H18zM22 4h1v1H22zM24 4h3v1H24zM28,4 h1v1H28zM0 5h1v1H0zM6 5h1v1H6zM8 5h2v1H8zM14 5h2v1H14zM19 5h2v1H19zM22 5h1v1H22zM28,5 h1v1H28zM0 6h7v1H0zM8 6h1v1H8zM10 6h1v1H10zM12 6h1v1H12zM14 6h1v1H14zM16 6h1v1H16zM18 6h1v1H18zM20 6h1v1H20zM22,6 h7v1H22zM8 7h2v1H8zM11 7h1v1H11zM15 7h1v1H15zM17 7h2v1H17zM0 8h2v1H0zM3 8h1v1H3zM6 8h2v1H6zM10 8h1v1H10zM12 8h3v1H12zM20 8h1v1H20zM22 8h3v1H22zM26 8h2v1H26zM1 9h1v1H1zM3 9h3v1H3zM8 9h1v1H8zM10 9h1v1H10zM12 9h2v1H12zM16 9h2v1H16zM20 9h1v1H20zM22 9h1v1H22zM25 9h1v1H25zM27,9 h2v1H27zM0 10h1v1H0zM3 10h2v1H3zM6 10h1v1H6zM8 10h3v1H8zM12 10h2v1H12zM16 10h1v1H16zM19 10h1v1H19zM22 10h3v1H22zM27 10h1v1H27zM0 11h1v1H0zM2 11h1v1H2zM4 11h2v1H4zM7 11h1v1H7zM13 11h4v1H13zM18 11h4v1H18zM26 11h2v1H26zM0 12h1v1H0zM2 12h3v1H2zM6 12h1v1H6zM11 12h1v1H11zM13 12h1v1H13zM15 12h3v1H15zM20 12h1v1H20zM22 12h2v1H22zM27,12 h2v1H27zM4 13h1v1H4zM8 13h3v1H8zM12 13h1v1H12zM14 13h1v1H14zM17 13h4v1H17zM25 13h2v1H25zM0 14h1v1H0zM4 14h3v1H4zM8 14h2v1H8zM11 14h3v1H11zM16 14h1v1H16zM21 14h2v1H21zM24,14 h5v1H24zM3 15h3v1H3zM7 15h2v1H7zM10 15h1v1H10zM12 15h2v1H12zM15 15h1v1H15zM17 15h2v1H17zM20 15h2v1H20zM23 15h1v1H23zM1 16h1v1H1zM4 16h1v1H4zM6 16h4v1H6zM16 16h2v1H16zM20 16h1v1H20zM23 16h1v1H23zM25 16h1v1H25zM28,16 h1v1H28zM2 17h1v1H2zM5 17h1v1H5zM7 17h2v1H7zM11 17h3v1H11zM17 17h1v1H17zM22 17h1v1H22zM25 17h1v1H25zM27,17 h2v1H27zM0 18h1v1H0zM3 18h1v1H3zM5 18h4v1H5zM10 18h1v1H10zM12 18h1v1H12zM18 18h1v1H18zM20 18h1v1H20zM22 18h2v1H22zM25,18 h4v1H25zM2 19h3v1H2zM8 19h1v1H8zM16 19h2v1H16zM21 19h1v1H21zM23 19h1v1H23zM25 19h1v1H25zM27 19h1v1H27zM0 20h1v1H0zM2 20h5v1H2zM8 20h2v1H8zM13 20h4v1H13zM19 20h6v1H19zM26 20h1v1H26zM28,20 h1v1H28zM8 21h2v1H8zM12 21h3v1H12zM16 21h1v1H16zM20 21h1v1H20zM24 21h1v1H24zM26,21 h3v1H26zM0 22h7v1H0zM8 22h3v1H8zM17 22h1v1H17zM20 22h1v1H20zM22 22h1v1H22zM24 22h2v1H24zM27 22h1v1H27zM0 23h1v1H0zM6 23h1v1H6zM10 23h2v1H10zM13 23h2v1H13zM19 23h2v1H19zM24,23 h5v1H24zM0 24h1v1H0zM2 24h3v1H2zM6 24h1v1H6zM9 24h2v1H9zM12 24h2v1H12zM17 24h1v1H17zM20 24h6v1H20zM28,24 h1v1H28zM0 25h1v1H0zM2 25h3v1H2zM6 25h1v1H6zM8 25h3v1H8zM12 25h1v1H12zM14 25h1v1H14zM18 25h1v1H18zM22 25h3v1H22zM26 25h1v1H26zM0 26h1v1H0zM2 26h3v1H2zM6 26h1v1H6zM10 26h5v1H10zM16 26h3v1H16zM21 26h1v1H21zM24 26h1v1H24zM26 26h1v1H26zM28,26 h1v1H28zM0 27h1v1H0zM6 27h1v1H6zM8 27h3v1H8zM12 27h4v1H12zM17 27h1v1H17zM20 27h1v1H20zM23 27h2v1H23zM27 27h1v1H27zM0 28h7v1H0zM8 28h3v1H8zM14 28h1v1H14zM16 28h3v1H16zM20 28h1v1H20zM22 28h1v1H22zM24 28h2v1H24zM27 28h1v1H27z"></path>
    </svg>
  </section>
  

  <section>
    <h1>Subscribe</h1>
    Do you want to get notified via email when I post new content?
    <style>
      .subscribe-button {
        /* margin: 10px !important; */
        padding: 10px !important;
        background-color: black;
        display: inline-block;
        color: white !important;
        text-decoration: none;

        line-height: 36px !important;
        height: 37px !important;
        text-decoration: none !important;
        display: inline-block !important;
        color: #ffffff !important;
        background-color: #000000 !important;
        border-radius: 3px !important;
        border: 1px solid transparent !important;
        padding: 1px 9px !important;
        font-size: 23px !important;
        letter-spacing: 0.6px !important;
        box-shadow: 0px 1px 2px rgba(190, 190, 190, 0.5) !important;
        -webkit-box-shadow: 0px 1px 2px 2px rgba(190, 190, 190, 0.5) !important;
        margin: 0 auto !important;
        font-family: 'Cookie', cursive !important;
        -webkit-box-sizing: border-box !important;
        box-sizing: border-box !important;
        -o-transition: 0.3s all linear !important;
        -webkit-transition: 0.3s all linear !important;
        -moz-transition: 0.3s all linear !important;
        -ms-transition: 0.3s all linear !important;
        transition: 0.3s all linear !important;

      }
    </style>
    <a class='subscribe-button' target="_blank" href="http://eepurl.com/dxI3PP">Click here to subscribe!</a>
  </section>


  <section>
    <h1>Recent Posts</h1>
    <ul id="recent_posts">
      <li class="post">
        <a href="https://www.spapas.net/2024/08/22/multiple-erl-elixir-windows/">Multiple Erlang/Elixir versions in Windows</a>
      </li>
      <li class="post">
        <a href="https://www.spapas.net/2023/11/29/openid-connect-tutorial/">A simple OpenID connect tutorial</a>
      </li>
      <li class="post">
        <a href="https://www.spapas.net/2023/05/23/simple-django-datatables-integration/">Simple Django - DataTables integration</a>
      </li>
      <li class="post">
        <a href="https://www.spapas.net/2023/05/22/ai-auto-subtitling/">AI auto-subtitling</a>
      </li>
      <li class="post">
        <a href="https://www.spapas.net/2023/05/12/disable-your-forms/">HTML form disable after submit</a>
      </li>
    </ul>
  </section>
  <section>

    <h1>Categories</h1>
    <ul id="recent_posts">
      <li><a href="https://www.spapas.net/category/ai.html">ai</a></li>
      <li><a href="https://www.spapas.net/category/android.html">android</a></li>
      <li><a href="https://www.spapas.net/category/clojure.html">clojure</a></li>
      <li><a href="https://www.spapas.net/category/css.html">css</a></li>
      <li><a href="https://www.spapas.net/category/django.html">django</a></li>
      <li><a href="https://www.spapas.net/category/elixir.html">elixir</a></li>
      <li><a href="https://www.spapas.net/category/flask.html">flask</a></li>
      <li><a href="https://www.spapas.net/category/gaming.html">gaming</a></li>
      <li><a href="https://www.spapas.net/category/git.html">git</a></li>
      <li><a href="https://www.spapas.net/category/html.html">html</a></li>
      <li><a href="https://www.spapas.net/category/javascript.html">javascript</a></li>
      <li><a href="https://www.spapas.net/category/networking.html">networking</a></li>
      <li><a href="https://www.spapas.net/category/pelican.html">pelican</a></li>
      <li><a href="https://www.spapas.net/category/postgresql.html">postgresql</a></li>
      <li><a href="https://www.spapas.net/category/python.html">python</a></li>
      <li><a href="https://www.spapas.net/category/spring.html">spring</a></li>
      <li><a href="https://www.spapas.net/category/unix.html">unix</a></li>
      <li><a href="https://www.spapas.net/category/wagtail.html">wagtail</a></li>
    </ul>
  </section>

  <section>
    <h1>Tags</h1>
    <a href="https://www.spapas.net/tag/erlang.html">erlang</a>,    <a href="https://www.spapas.net/tag/elixir.html">elixir</a>,    <a href="https://www.spapas.net/tag/windows.html">windows</a>,    <a href="https://www.spapas.net/tag/openid.html">openid</a>,    <a href="https://www.spapas.net/tag/openid-connect.html">openid-connect</a>,    <a href="https://www.spapas.net/tag/oidc.html">oidc</a>,    <a href="https://www.spapas.net/tag/http.html">http</a>,    <a href="https://www.spapas.net/tag/keycloak.html">keycloak</a>,    <a href="https://www.spapas.net/tag/python.html">python</a>,    <a href="https://www.spapas.net/tag/django.html">django</a>,    <a href="https://www.spapas.net/tag/jquery.html">jquery</a>,    <a href="https://www.spapas.net/tag/datatables.html">datatables</a>,    <a href="https://www.spapas.net/tag/ai.html">ai</a>,    <a href="https://www.spapas.net/tag/whisper.html">whisper</a>,    <a href="https://www.spapas.net/tag/whispercpp.html">whisper.cpp</a>,    <a href="https://www.spapas.net/tag/subtitles.html">subtitles</a>,    <a href="https://www.spapas.net/tag/video.html">video</a>,    <a href="https://www.spapas.net/tag/auto-subtitling.html">auto-subtitling</a>,    <a href="https://www.spapas.net/tag/subtitiling.html">subtitiling</a>,    <a href="https://www.spapas.net/tag/transcribe.html">transcribe</a>,    <a href="https://www.spapas.net/tag/html.html">html</a>,    <a href="https://www.spapas.net/tag/javascript.html">javascript</a>,    <a href="https://www.spapas.net/tag/media.html">media</a>,    <a href="https://www.spapas.net/tag/storage.html">storage</a>,    <a href="https://www.spapas.net/tag/unpoly.html">unpoly</a>,    <a href="https://www.spapas.net/tag/access.html">access</a>,    <a href="https://www.spapas.net/tag/database.html">database</a>,    <a href="https://www.spapas.net/tag/accdb.html">accdb</a>,    <a href="https://www.spapas.net/tag/mdb.html">mdb</a>,    <a href="https://www.spapas.net/tag/postgresql.html">postgresql</a>,    <a href="https://www.spapas.net/tag/development.html">development</a>,    <a href="https://www.spapas.net/tag/inlines.html">inlines</a>,    <a href="https://www.spapas.net/tag/clojure.html">clojure</a>,    <a href="https://www.spapas.net/tag/cmd.html">cmd</a>,    <a href="https://www.spapas.net/tag/pdf.html">pdf</a>,    <a href="https://www.spapas.net/tag/wkhtmltopdf.html">wkhtmltopdf</a>,    <a href="https://www.spapas.net/tag/forward-proxy.html">forward-proxy</a>,    <a href="https://www.spapas.net/tag/reverse-proxy.html">reverse-proxy</a>,    <a href="https://www.spapas.net/tag/proxy.html">proxy</a>,    <a href="https://www.spapas.net/tag/networking.html">networking</a>,    <a href="https://www.spapas.net/tag/dj-rest-auth.html">dj-rest-auth</a>,    <a href="https://www.spapas.net/tag/rest.html">rest</a>,    <a href="https://www.spapas.net/tag/django-rest-framework.html">django-rest-framework</a>,    <a href="https://www.spapas.net/tag/authentication.html">authentication</a>,    <a href="https://www.spapas.net/tag/tokens.html">tokens</a>,    <a href="https://www.spapas.net/tag/migrations.html">migrations</a>,    <a href="https://www.spapas.net/tag/foreignkey.html">foreignkey</a>,    <a href="https://www.spapas.net/tag/dark-souls.html">dark-souls</a>,    <a href="https://www.spapas.net/tag/dark-souls-2.html">dark-souls-2</a>,    <a href="https://www.spapas.net/tag/dark-souls-3.html">dark-souls-3</a>,    <a href="https://www.spapas.net/tag/autohotkey.html">autohotkey</a>,    <a href="https://www.spapas.net/tag/matplotlib.html">matplotlib</a>,    <a href="https://www.spapas.net/tag/hashids.html">hashids</a>,    <a href="https://www.spapas.net/tag/wagtail.html">wagtail</a>,    <a href="https://www.spapas.net/tag/osmon.html">osmon</a>,    <a href="https://www.spapas.net/tag/phoenix.html">phoenix</a>,    <a href="https://www.spapas.net/tag/os-monitoring.html">os-monitoring</a>,    <a href="https://www.spapas.net/tag/forms.html">forms</a>,    <a href="https://www.spapas.net/tag/django-crispy-forms.html">django-crispy-forms</a>,    <a href="https://www.spapas.net/tag/django-widget-tweaks.html">django-widget-tweaks</a>,    <a href="https://www.spapas.net/tag/ecto.html">ecto</a>,    <a href="https://www.spapas.net/tag/queries.html">queries</a>,    <a href="https://www.spapas.net/tag/declarative.html">declarative</a>,    <a href="https://www.spapas.net/tag/form.html">form</a>,    <a href="https://www.spapas.net/tag/php.html">php</a>,    <a href="https://www.spapas.net/tag/select2.html">select2</a>,    <a href="https://www.spapas.net/tag/autocompelte.html">autocompelte</a>,    <a href="https://www.spapas.net/tag/ajax.html">ajax</a>,    <a href="https://www.spapas.net/tag/android.html">android</a>,    <a href="https://www.spapas.net/tag/kotlin.html">kotlin</a>,    <a href="https://www.spapas.net/tag/adapter.html">adapter</a>,    <a href="https://www.spapas.net/tag/filter.html">filter</a>,    <a href="https://www.spapas.net/tag/async.html">async</a>,    <a href="https://www.spapas.net/tag/tasks.html">tasks</a>,    <a href="https://www.spapas.net/tag/django-rq.html">django-rq</a>,    <a href="https://www.spapas.net/tag/rq.html">rq</a>,    <a href="https://www.spapas.net/tag/du.html">du</a>,    <a href="https://www.spapas.net/tag/unix.html">unix</a>,    <a href="https://www.spapas.net/tag/linux.html">linux</a>,    <a href="https://www.spapas.net/tag/disk-usage.html">disk-usage</a>,    <a href="https://www.spapas.net/tag/cbv.html">cbv</a>,    <a href="https://www.spapas.net/tag/middleware.html">middleware</a>,    <a href="https://www.spapas.net/tag/class-based-views.html">class-based-views</a>,    <a href="https://www.spapas.net/tag/react.html">react</a>,    <a href="https://www.spapas.net/tag/redux.html">redux</a>,    <a href="https://www.spapas.net/tag/hyperapp.html">hyperapp</a>,    <a href="https://www.spapas.net/tag/immutable.html">immutable</a>,    <a href="https://www.spapas.net/tag/es6.html">es6</a>,    <a href="https://www.spapas.net/tag/youtube.html">youtube</a>,    <a href="https://www.spapas.net/tag/youtube-dl.html">youtube-dl</a>,    <a href="https://www.spapas.net/tag/ffmpeg.html">ffmpeg</a>,    <a href="https://www.spapas.net/tag/django-rest-auth.html">django-rest-auth</a>,    <a href="https://www.spapas.net/tag/python-2.html">python-2</a>,    <a href="https://www.spapas.net/tag/python-3.html">python-3</a>,    <a href="https://www.spapas.net/tag/plpgsql.html">plpgsql</a>,    <a href="https://www.spapas.net/tag/component.html">component</a>,    <a href="https://www.spapas.net/tag/ag-grid.html">ag-grid</a>,    <a href="https://www.spapas.net/tag/grid.html">grid</a>,    <a href="https://www.spapas.net/tag/bash.html">bash</a>,    <a href="https://www.spapas.net/tag/cron.html">cron</a>,    <a href="https://www.spapas.net/tag/pandas.html">pandas</a>,    <a href="https://www.spapas.net/tag/scipy.html">scipy</a>,    <a href="https://www.spapas.net/tag/numpy.html">numpy</a>,    <a href="https://www.spapas.net/tag/pivot.html">pivot</a>,    <a href="https://www.spapas.net/tag/pivot_table.html">pivot_table</a>,    <a href="https://www.spapas.net/tag/ipython.html">ipython</a>,    <a href="https://www.spapas.net/tag/jupyter.html">jupyter</a>,    <a href="https://www.spapas.net/tag/notebook.html">notebook</a>,    <a href="https://www.spapas.net/tag/query.html">query</a>,    <a href="https://www.spapas.net/tag/q.html">q</a>,    <a href="https://www.spapas.net/tag/imgur.html">imgur</a>,    <a href="https://www.spapas.net/tag/console.html">console</a>,    <a href="https://www.spapas.net/tag/research.html">research</a>,    <a href="https://www.spapas.net/tag/debug.html">debug</a>,    <a href="https://www.spapas.net/tag/werkzeug.html">werkzeug</a>,    <a href="https://www.spapas.net/tag/django-extensions.html">django-extensions</a>,    <a href="https://www.spapas.net/tag/404.html">404</a>,    <a href="https://www.spapas.net/tag/error.html">error</a>,    <a href="https://www.spapas.net/tag/spring.html">spring</a>,    <a href="https://www.spapas.net/tag/spring-boot.html">spring-boot</a>,    <a href="https://www.spapas.net/tag/java.html">java</a>,    <a href="https://www.spapas.net/tag/ldap.html">ldap</a>,    <a href="https://www.spapas.net/tag/profiles.html">profiles</a>,    <a href="https://www.spapas.net/tag/settings.html">settings</a>,    <a href="https://www.spapas.net/tag/properties.html">properties</a>,    <a href="https://www.spapas.net/tag/yaml.html">yaml</a>,    <a href="https://www.spapas.net/tag/configuration.html">configuration</a>,    <a href="https://www.spapas.net/tag/deploy.html">deploy</a>,    <a href="https://www.spapas.net/tag/initd.html">init.d</a>,    <a href="https://www.spapas.net/tag/react-redux.html">react-redux</a>,    <a href="https://www.spapas.net/tag/redux-thunk.html">redux-thunk</a>,    <a href="https://www.spapas.net/tag/redux-form.html">redux-form</a>,    <a href="https://www.spapas.net/tag/react-router.html">react-router</a>,    <a href="https://www.spapas.net/tag/react-router-redux.html">react-router-redux</a>,    <a href="https://www.spapas.net/tag/react-notification.html">react-notification</a>,    <a href="https://www.spapas.net/tag/history.html">history</a>,    <a href="https://www.spapas.net/tag/babel.html">babel</a>,    <a href="https://www.spapas.net/tag/babelify.html">babelify</a>,    <a href="https://www.spapas.net/tag/browserify.html">browserify</a>,    <a href="https://www.spapas.net/tag/watchify.html">watchify</a>,    <a href="https://www.spapas.net/tag/uglify.html">uglify</a>,    <a href="https://www.spapas.net/tag/boilerplate.html">boilerplate</a>,    <a href="https://www.spapas.net/tag/tutorial.html">tutorial</a>,    <a href="https://www.spapas.net/tag/introduction.html">introduction</a>,    <a href="https://www.spapas.net/tag/fixed-data-tables.html">fixed-data-tables</a>,    <a href="https://www.spapas.net/tag/fixeddatatable.html">FixedDataTable</a>,    <a href="https://www.spapas.net/tag/reportlab.html">reportlab</a>,    <a href="https://www.spapas.net/tag/xhtml2pdf.html">xhtml2pdf</a>,    <a href="https://www.spapas.net/tag/node.html">node</a>,    <a href="https://www.spapas.net/tag/npm.html">npm</a>,    <a href="https://www.spapas.net/tag/generic.html">generic</a>,    <a href="https://www.spapas.net/tag/tables.html">tables</a>,    <a href="https://www.spapas.net/tag/flux.html">flux</a>,    <a href="https://www.spapas.net/tag/jobs.html">jobs</a>,    <a href="https://www.spapas.net/tag/asynchronous.html">asynchronous</a>,    <a href="https://www.spapas.net/tag/scheduling.html">scheduling</a>,    <a href="https://www.spapas.net/tag/redis.html">redis</a>,    <a href="https://www.spapas.net/tag/pusher.html">pusher</a>,    <a href="https://www.spapas.net/tag/auditing.html">auditing</a>,    <a href="https://www.spapas.net/tag/css.html">css</a>,    <a href="https://www.spapas.net/tag/design.html">design</a>,    <a href="https://www.spapas.net/tag/boostrap-material-design.html">boostrap-material-design</a>,    <a href="https://www.spapas.net/tag/less.html">less</a>,    <a href="https://www.spapas.net/tag/nodejs.html">node.js</a>,    <a href="https://www.spapas.net/tag/gmail.html">gmail</a>,    <a href="https://www.spapas.net/tag/security.html">security</a>,    <a href="https://www.spapas.net/tag/google.html">google</a>,    <a href="https://www.spapas.net/tag/flask.html">flask</a>,    <a href="https://www.spapas.net/tag/mongodb.html">mongodb</a>,    <a href="https://www.spapas.net/tag/heroku.html">heroku</a>,    <a href="https://www.spapas.net/tag/spring-security.html">spring-security</a>,    <a href="https://www.spapas.net/tag/git.html">git</a>,    <a href="https://www.spapas.net/tag/github.html">github</a>,    <a href="https://www.spapas.net/tag/branching.html">branching</a>,    <a href="https://www.spapas.net/tag/static-html.html">static-html</a>,    <a href="https://www.spapas.net/tag/githubio.html">github.io</a>,    <a href="https://www.spapas.net/tag/pelican.html">pelican</a>,    <a href="https://www.spapas.net/tag/github-pages.html">github-pages</a>,    <a href="https://www.spapas.net/tag/rst.html">rst</a>  </section>

  <section>
    <h1>Yearly archives</h1>
    <a href="https://www.spapas.net/posts/2013/">2013</a>,    <a href="https://www.spapas.net/posts/2014/">2014</a>,    <a href="https://www.spapas.net/posts/2015/">2015</a>,    <a href="https://www.spapas.net/posts/2016/">2016</a>,    <a href="https://www.spapas.net/posts/2017/">2017</a>,    <a href="https://www.spapas.net/posts/2018/">2018</a>,    <a href="https://www.spapas.net/posts/2019/">2019</a>,    <a href="https://www.spapas.net/posts/2020/">2020</a>,    <a href="https://www.spapas.net/posts/2021/">2021</a>,    <a href="https://www.spapas.net/posts/2022/">2022</a>,    <a href="https://www.spapas.net/posts/2023/">2023</a>,    <a href="https://www.spapas.net/posts/2024/">2024</a>  </section>



  <section>
    <h1>GitHub Repos</h1>
    <ul id="gh_repos">
      <li class="loading">Status updating...</li>
    </ul>
      <a href="https://github.com/spapas">@spapas</a> on GitHub
    <script  src="//code.jquery.com/jquery-3.3.1.min.js"
        integrity="sha256-FgpCb/KJQlLNfOu91ta32o/NMZxltwRo8QtmkMRdAu8="
        crossorigin="anonymous"></script>
    <script type="text/javascript">
      $(function(){
          if (!window.jXHR){
              var jxhr = document.createElement('script');
              jxhr.type = 'text/javascript';
              jxhr.src = 'https://www.spapas.net/theme/js/jXHR.js';
              var s = document.getElementsByTagName('script')[0];
              s.parentNode.insertBefore(jxhr, s);
          }

          github.showRepos({
              user: 'spapas',
              count: 5,
              skip_forks: true,
              target: '#gh_repos'
          });
      });
    </script>
    <script src="https://www.spapas.net/theme/js/github.js" type="text/javascript"> </script>
  </section>


  <section>
    <a href="https://twitter.com/_serafeim_?ref_src=twsrc%5Etfw" class="twitter-follow-button"
      data-show-count="false">Follow @_serafeim_</a>
    <script async src="https://platform.twitter.com/widgets.js" charset="utf-8"></script>
  </section>

</aside>    </div>
  </div>
  <footer role="contentinfo"><p>
    Copyright &copy;  2013&ndash;2024  Serafeim Papastefanos &mdash;
  <span class="credit">Powered by <a href="http://getpelican.com">Pelican</a></span>
</p></footer>
  <script src="https://www.spapas.net/theme/js/modernizr-2.0.js"></script>
  <script src="https://www.spapas.net/theme/js/ender.js"></script>
  <script src="https://www.spapas.net/theme/js/octopress.js" type="text/javascript"></script>
  <script src="https://www.spapas.net/theme/js/ads.js"></script>
    <script>
    (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
    (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
    m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
    })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

    ga('create', 'UA-44750952-1', 'auto');

    ga('send', 'pageview');
    </script>

<script defer data-domain="spapas.net" src="https://plausible.hcg.gr/js/script.js"></script>  <script type="text/javascript">
    var disqus_shortname = 'spapas-github-io';
    (function() {
      var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
      dsq.src = "//" + disqus_shortname + '.disqus.com/embed.js';
      (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
     })();
  </script>
  <script type="text/javascript">
    (function(){
      var twitterWidgets = document.createElement('script');
      twitterWidgets.type = 'text/javascript';
      twitterWidgets.async = true;
      twitterWidgets.src = '//platform.twitter.com/widgets.js';
      document.getElementsByTagName('head')[0].appendChild(twitterWidgets);
    })();
  </script>

</body>

</html>