<!DOCTYPE html>
<!--[if IEMobile 7 ]><html class="no-js iem7"><![endif]-->
<!--[if lt IE 9]><html class="no-js lte-ie8"><![endif]-->
<!--[if (gt IE 8)|(gt IEMobile 7)|!(IEMobile)|!(IE)]><!-->
<html class="no-js" lang="en">
<!--<![endif]-->

  <head>
    <meta charset="utf-8">
    <meta name="google-site-verification" content="5_8DTmIiEq4gFvNAfxAD6TsGOgrMAjp8lQFQvfA6zZc" />
    <title>Fixing your Django async job - databaseÂ integration &mdash; /var/</title>
    <meta name="author" content="Serafeim Papastefanos">


    
<style type="text/css">
pre { line-height: 125%; }
td.linenos .normal { color: inherit; background-color: transparent; padding-left: 5px; padding-right: 5px; }
span.linenos { color: inherit; background-color: transparent; padding-left: 5px; padding-right: 5px; }
td.linenos .special { color: #000000; background-color: #ffffc0; padding-left: 5px; padding-right: 5px; }
span.linenos.special { color: #000000; background-color: #ffffc0; padding-left: 5px; padding-right: 5px; }
.highlight .hll { background-color: var(--jp-cell-editor-active-background) }
.highlight { background: var(--jp-cell-editor-background); color: var(--jp-mirror-editor-variable-color) }
.highlight .c { color: var(--jp-mirror-editor-comment-color); font-style: italic } /* Comment */
.highlight .err { color: var(--jp-mirror-editor-error-color) } /* Error */
.highlight .k { color: var(--jp-mirror-editor-keyword-color); font-weight: bold } /* Keyword */
.highlight .o { color: var(--jp-mirror-editor-operator-color); font-weight: bold } /* Operator */
.highlight .p { color: var(--jp-mirror-editor-punctuation-color) } /* Punctuation */
.highlight .ch { color: var(--jp-mirror-editor-comment-color); font-style: italic } /* Comment.Hashbang */
.highlight .cm { color: var(--jp-mirror-editor-comment-color); font-style: italic } /* Comment.Multiline */
.highlight .cp { color: var(--jp-mirror-editor-comment-color); font-style: italic } /* Comment.Preproc */
.highlight .cpf { color: var(--jp-mirror-editor-comment-color); font-style: italic } /* Comment.PreprocFile */
.highlight .c1 { color: var(--jp-mirror-editor-comment-color); font-style: italic } /* Comment.Single */
.highlight .cs { color: var(--jp-mirror-editor-comment-color); font-style: italic } /* Comment.Special */
.highlight .kc { color: var(--jp-mirror-editor-keyword-color); font-weight: bold } /* Keyword.Constant */
.highlight .kd { color: var(--jp-mirror-editor-keyword-color); font-weight: bold } /* Keyword.Declaration */
.highlight .kn { color: var(--jp-mirror-editor-keyword-color); font-weight: bold } /* Keyword.Namespace */
.highlight .kp { color: var(--jp-mirror-editor-keyword-color); font-weight: bold } /* Keyword.Pseudo */
.highlight .kr { color: var(--jp-mirror-editor-keyword-color); font-weight: bold } /* Keyword.Reserved */
.highlight .kt { color: var(--jp-mirror-editor-keyword-color); font-weight: bold } /* Keyword.Type */
.highlight .m { color: var(--jp-mirror-editor-number-color) } /* Literal.Number */
.highlight .s { color: var(--jp-mirror-editor-string-color) } /* Literal.String */
.highlight .ow { color: var(--jp-mirror-editor-operator-color); font-weight: bold } /* Operator.Word */
.highlight .pm { color: var(--jp-mirror-editor-punctuation-color) } /* Punctuation.Marker */
.highlight .w { color: var(--jp-mirror-editor-variable-color) } /* Text.Whitespace */
.highlight .mb { color: var(--jp-mirror-editor-number-color) } /* Literal.Number.Bin */
.highlight .mf { color: var(--jp-mirror-editor-number-color) } /* Literal.Number.Float */
.highlight .mh { color: var(--jp-mirror-editor-number-color) } /* Literal.Number.Hex */
.highlight .mi { color: var(--jp-mirror-editor-number-color) } /* Literal.Number.Integer */
.highlight .mo { color: var(--jp-mirror-editor-number-color) } /* Literal.Number.Oct */
.highlight .sa { color: var(--jp-mirror-editor-string-color) } /* Literal.String.Affix */
.highlight .sb { color: var(--jp-mirror-editor-string-color) } /* Literal.String.Backtick */
.highlight .sc { color: var(--jp-mirror-editor-string-color) } /* Literal.String.Char */
.highlight .dl { color: var(--jp-mirror-editor-string-color) } /* Literal.String.Delimiter */
.highlight .sd { color: var(--jp-mirror-editor-string-color) } /* Literal.String.Doc */
.highlight .s2 { color: var(--jp-mirror-editor-string-color) } /* Literal.String.Double */
.highlight .se { color: var(--jp-mirror-editor-string-color) } /* Literal.String.Escape */
.highlight .sh { color: var(--jp-mirror-editor-string-color) } /* Literal.String.Heredoc */
.highlight .si { color: var(--jp-mirror-editor-string-color) } /* Literal.String.Interpol */
.highlight .sx { color: var(--jp-mirror-editor-string-color) } /* Literal.String.Other */
.highlight .sr { color: var(--jp-mirror-editor-string-color) } /* Literal.String.Regex */
.highlight .s1 { color: var(--jp-mirror-editor-string-color) } /* Literal.String.Single */
.highlight .ss { color: var(--jp-mirror-editor-string-color) } /* Literal.String.Symbol */
.highlight .il { color: var(--jp-mirror-editor-number-color) } /* Literal.Number.Integer.Long */
</style>

<style type="text/css">
/* Overrides of notebook CSS for static HTML export */
div.entry-content {
  overflow: visible;
  padding: 8px;
}
.input_area {
  padding: 0.2em;
}

a.heading-anchor {
 white-space: normal;
}

.rendered_html
code {
 font-size: .8em;
}

pre.ipynb {
  color: black;
  background: #f7f7f7;
  border: none;
  box-shadow: none;
  margin-bottom: 0;
  padding: 0;
  margin: 0px;
  font-size: 13px;
}

/* remove the prompt div from text cells */
div.text_cell .prompt {
    display: none;
}

/* remove horizontal padding from text cells, */
/* so it aligns with outer body text */
div.text_cell_render {
    padding: 0.5em 0em;
}

img.anim_icon{padding:0; border:0; vertical-align:middle; -webkit-box-shadow:none; -box-shadow:none}

div.collapseheader {
    width=100%;
    background-color:#d3d3d3;
    padding: 2px;
    cursor: pointer;
    font-family:"Helvetica Neue",Helvetica,Arial,sans-serif;
}
</style>

<script type="text/x-mathjax-config">
MathJax.Hub.Config({
    tex2jax: {
        inlineMath: [['$','$'], ['\\(','\\)']],
        processEscapes: true,
        displayMath: [['$$','$$'], ["\\[","\\]"]]
    }
});
</script>
<script type="text/javascript" async src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.2/MathJax.js?config=TeX-MML-AM_CHTML">
</script>

<script src="https://ajax.googleapis.com/ajax/libs/jquery/1.10.2/jquery.min.js"></script>

<script type="text/javascript">
jQuery(document).ready(function($) {
    $("div.collapseheader").click(function () {
    $header = $(this).children("span").first();
    $codearea = $(this).children(".input_area");
    console.log($(this).children());
    $codearea.slideToggle(500, function () {
        $header.text(function () {
            return $codearea.is(":visible") ? "Collapse Code" : "Expand Code";
        });
    });
});
});
</script>






    <!-- http://t.co/dKP3o1e -->
    <meta name="HandheldFriendly" content="True">
    <meta name="MobileOptimized" content="320">
    <meta name="viewport" content="width=device-width, initial-scale=1">


    <link href="https://www.spapas.net/favicon.png" rel="icon">

    <link href="https://www.spapas.net/theme/css/main.css" media="screen, projection" rel="stylesheet"
      type="text/css">

    <link href="https://www.spapas.net/theme/css/extra_style.css" media="screen, projection" rel="stylesheet"
      type="text/css">

    <link href="https://fonts.googleapis.com/css?family=Fira+Mono|Fira+Sans:400,700&amp;subset=greek" rel="stylesheet">

<style>
#gHPzseYvFrhZ123 {
  padding: 5px !important;
  display: block;
  margin-bottom: 10px !important;
  background: #900;
  color: #fff;
  border-radius: 5px;
  font-size: 1.0rem !important;
}
</style>


  <script>
    
      
  </script>

    <script data-ad-client="ca-pub-7673322832689008" async
      src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"
      onerror="adBlockFunction();"></script>
  </head>

<body>
  <header role="banner"><hgroup>
  <h1><a href="https://www.spapas.net/">/var/</a></h1>
    <h2>Various programming stuff</h2>
</hgroup></header>
  <nav role="navigation"><ul class="subscription" data-subscription="rss">
</ul>


<ul class="main-navigation">
      <li >
        <a href="https://www.spapas.net/category/ai.html">Ai</a>
      </li>
      <li >
        <a href="https://www.spapas.net/category/android.html">Android</a>
      </li>
      <li >
        <a href="https://www.spapas.net/category/clojure.html">Clojure</a>
      </li>
      <li >
        <a href="https://www.spapas.net/category/css.html">Css</a>
      </li>
      <li class="active">
        <a href="https://www.spapas.net/category/django.html">Django</a>
      </li>
      <li >
        <a href="https://www.spapas.net/category/elixir.html">Elixir</a>
      </li>
      <li >
        <a href="https://www.spapas.net/category/flask.html">Flask</a>
      </li>
      <li >
        <a href="https://www.spapas.net/category/gaming.html">Gaming</a>
      </li>
      <li >
        <a href="https://www.spapas.net/category/git.html">Git</a>
      </li>
      <li >
        <a href="https://www.spapas.net/category/html.html">Html</a>
      </li>
      <li >
        <a href="https://www.spapas.net/category/javascript.html">Javascript</a>
      </li>
      <li >
        <a href="https://www.spapas.net/category/networking.html">Networking</a>
      </li>
      <li >
        <a href="https://www.spapas.net/category/pelican.html">Pelican</a>
      </li>
      <li >
        <a href="https://www.spapas.net/category/postgresql.html">Postgresql</a>
      </li>
      <li >
        <a href="https://www.spapas.net/category/python.html">Python</a>
      </li>
      <li >
        <a href="https://www.spapas.net/category/spring.html">Spring</a>
      </li>
      <li >
        <a href="https://www.spapas.net/category/unix.html">Unix</a>
      </li>
      <li >
        <a href="https://www.spapas.net/category/wagtail.html">Wagtail</a>
      </li>
</ul></nav>
  <div id="main">
    <div id="content">
    <div id="gHPzseYvFrhZ123">
      Hello! If you are using an ad blocker but find something useful here 
      and want to support me please consider disabling your ad blocker for this site. 
      <br />
      <br />
      Thank you,<br />
      Serafeim
      
    </div>
<div>
  <article class="hentry" role="article">
<header>
      <h1 class="entry-title">Fixing your Django async job - databaseÂ integration</h1>
    <p class="meta">
<time datetime="2019-02-25T15:20:00+02:00" pubdate>Mon 25 February 2019</time>    </p>
</header>

<div class="entry-content"><p>I&#8217;ve already written
<a class="reference external" href="https://www.spapas.net/2015/01/27/async-tasks-with-django-rq/">two</a>
<a class="reference external" href="https://www.spapas.net/2015/09/01/django-rq-redux/">articles</a>
about django-rq and implementing asynchronous tasks in Django. However I&#8217;ve found out
that there&#8217;s a very important thing missing from them: How to properly integrate
your asynchronous tasks with your Django database. This is very important because
if it is not done right you will start experiencing strange errors about missing
database objects or duplicate keys. The most troublesome thing about these errors is
that they are not consistent. Your app may work fine but for some reason you&#8217;ll see some
of your asynchronous tasks fail with these errors. When you re-queue the async jobs everything will
be&nbsp;ok.</p>
<p>Of course this behavior (code that runs <em>sometimes</em>) smells of a race condition but its not easy to debug
it if you don&#8217;t know the full&nbsp;story.</p>
<p>In the following I will describe the cause of this error and how you can fix it. As a companion
to this article I&#8217;ve implemented a small project that can be used to test the error and the
fix: <a class="reference external" href="https://github.com/spapas/async-job-db-fix">https://github.com/spapas/async-job-db-fix</a>.</p>
<p>Notice that although this article is written for django-rq it should also help people that have
the same problems with other async job systems (like celery or&nbsp;django-q).</p>
<div class="section" id="description-of-the-project">
<h2>Description of the&nbsp;project</h2>
<p>The project is very simple, you can just add a url and it will retrieve its content asynchronously and
report its length. For the models, it just has a <tt class="docutils literal">Task</tt> model which is used to provide information about
what we want to the asynchronous task to do and retrieve the&nbsp;result:</p>
<div class="highlight"><pre><span></span><span class="kn">from</span><span class="w"> </span><span class="nn">django.db</span><span class="w"> </span><span class="kn">import</span> <span class="n">models</span>

<span class="k">class</span><span class="w"> </span><span class="nc">Task</span><span class="p">(</span><span class="n">models</span><span class="o">.</span><span class="n">Model</span><span class="p">):</span>
    <span class="n">created_on</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">DateTimeField</span><span class="p">(</span><span class="n">auto_now_add</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">url</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">CharField</span><span class="p">(</span><span class="n">max_length</span><span class="o">=</span><span class="mi">128</span><span class="p">)</span>
    <span class="n">url_length</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">PositiveIntegerField</span><span class="p">(</span><span class="n">blank</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">null</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">job_id</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">CharField</span><span class="p">(</span><span class="n">max_length</span><span class="o">=</span><span class="mi">128</span><span class="p">,</span> <span class="n">blank</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">null</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">result</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">CharField</span><span class="p">(</span><span class="n">max_length</span><span class="o">=</span><span class="mi">128</span><span class="p">,</span> <span class="n">blank</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">null</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</pre></div>
<p>It also has a home view that can be used to start new asynchronous tasks by creating a <tt class="docutils literal">Task</tt> object
with the url we got and passing it to the asynchronous&nbsp;task:</p>
<div class="highlight"><pre><span></span><span class="kn">from</span><span class="w"> </span><span class="nn">django.views.generic.edit</span><span class="w"> </span><span class="kn">import</span> <span class="n">FormView</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">.forms</span><span class="w"> </span><span class="kn">import</span> <span class="n">TaskForm</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">.tasks</span><span class="w"> </span><span class="kn">import</span> <span class="n">get_url_length</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">.models</span><span class="w"> </span><span class="kn">import</span> <span class="n">Task</span>

<span class="kn">import</span><span class="w"> </span><span class="nn">time</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">django.db</span><span class="w"> </span><span class="kn">import</span> <span class="n">transaction</span>

<span class="k">class</span><span class="w"> </span><span class="nc">TasksHomeFormView</span><span class="p">(</span><span class="n">FormView</span><span class="p">):</span>
    <span class="n">form_class</span> <span class="o">=</span> <span class="n">TaskForm</span>
    <span class="n">template_name</span> <span class="o">=</span> <span class="s1">&#39;tasks_home.html&#39;</span>
    <span class="n">success_url</span> <span class="o">=</span> <span class="s1">&#39;/&#39;</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">form_valid</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">form</span><span class="p">):</span>
        <span class="n">task</span> <span class="o">=</span> <span class="n">Task</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="n">url</span><span class="o">=</span><span class="n">form</span><span class="o">.</span><span class="n">cleaned_data</span><span class="p">[</span><span class="s1">&#39;url&#39;</span><span class="p">])</span>
        <span class="n">get_url_length</span><span class="o">.</span><span class="n">delay</span><span class="p">(</span><span class="n">task</span><span class="o">.</span><span class="n">id</span><span class="p">)</span>
        <span class="k">return</span> <span class="nb">super</span><span class="p">(</span><span class="n">TasksHomeFormView</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">form_valid</span><span class="p">(</span><span class="n">form</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">get_context_data</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="n">ctx</span> <span class="o">=</span> <span class="nb">super</span><span class="p">(</span><span class="n">TasksHomeFormView</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">get_context_data</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="n">ctx</span><span class="p">[</span><span class="s1">&#39;tasks&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">Task</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">all</span><span class="p">()</span><span class="o">.</span><span class="n">order_by</span><span class="p">(</span><span class="s1">&#39;-created_on&#39;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">ctx</span>
</pre></div>
<p>And finally the asynchronous job itself that retrieves the task from the database,
requests its url and saves its&nbsp;length:</p>
<div class="highlight"><pre><span></span><span class="kn">import</span><span class="w"> </span><span class="nn">requests</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">.models</span><span class="w"> </span><span class="kn">import</span> <span class="n">Task</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">rq</span><span class="w"> </span><span class="kn">import</span> <span class="n">get_current_job</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">django_rq</span><span class="w"> </span><span class="kn">import</span> <span class="n">job</span>

<span class="nd">@job</span>
<span class="k">def</span><span class="w"> </span><span class="nf">get_url_length</span><span class="p">(</span><span class="n">task_id</span><span class="p">):</span>
    <span class="n">jb</span> <span class="o">=</span> <span class="n">get_current_job</span><span class="p">()</span>
    <span class="n">task</span> <span class="o">=</span> <span class="n">Task</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">get</span><span class="p">(</span>
        <span class="nb">id</span><span class="o">=</span><span class="n">task_id</span>
    <span class="p">)</span>
    <span class="n">response</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">task</span><span class="o">.</span><span class="n">url</span><span class="p">)</span>
    <span class="n">task</span><span class="o">.</span><span class="n">url_length</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">response</span><span class="o">.</span><span class="n">text</span><span class="p">)</span>
    <span class="n">task</span><span class="o">.</span><span class="n">job_id</span> <span class="o">=</span> <span class="n">jb</span><span class="o">.</span><span class="n">get_id</span><span class="p">()</span>
    <span class="n">task</span><span class="o">.</span><span class="n">result</span> <span class="o">=</span> <span class="s1">&#39;OK&#39;</span>
    <span class="n">task</span><span class="o">.</span><span class="n">save</span><span class="p">()</span>
</pre></div>
<p>The above should be fairly obvious: The user visits the homepage and enters a url at the input. When he presses submit
the view will create a new <tt class="docutils literal">Task</tt> object with the url that the user entered and fire-off the <tt class="docutils literal">get_url_length</tt> asynchronous job passing the
task id of the task that was just created. It will then return immediately without waiting for the asynchronous job to complete. The user will
need to refresh to see the result of his job; this is the usual behavior with async&nbsp;jobs.</p>
<p>The asynchronous job on the other hand will retrieve the task whose id got as a parameter from the database, do the work it needs to do
and update the result when it is&nbsp;finished.</p>
<p>Unfortunately, the above simple setup will <em>probably</em> behave erratically by randomly throwing database related&nbsp;errors!</p>
</div>
<div class="section" id="cause-of-the-problem">
<h2>Cause of the&nbsp;problem</h2>
<p>In the previous section I said <em>probably</em> because the erratic behavior is caused by a specific setting of your Django project; the <tt class="docutils literal">ATOMIC_REQUESTS</tt>.
This setting can be set on your database connection and if it is <tt class="docutils literal"><span class="caps">TRUE</span></tt> then each request will be <em>atomic</em>. This means that each request will be tied with
a database transaction i.e a transaction will be started when your request starts and commited only when your requests finishes; if for some reason your
request throws an error then the transaction will be rolled back. An example of this setting&nbsp;is:</p>
<div class="highlight"><pre><span></span><span class="n">DATABASES</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s1">&#39;default&#39;</span><span class="p">:</span> <span class="p">{</span>
        <span class="s1">&#39;ENGINE&#39;</span><span class="p">:</span> <span class="s1">&#39;django.db.backends.sqlite3&#39;</span><span class="p">,</span>
        <span class="s1">&#39;NAME&#39;</span><span class="p">:</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">BASE_DIR</span><span class="p">,</span> <span class="s1">&#39;db.sqlite3&#39;</span><span class="p">),</span>
        <span class="s1">&#39;ATOMIC_REQUESTS&#39;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></div>
<p>Now, in my opinion, <tt class="docutils literal">ATOMIC_REQUESTS</tt> is a great thing to have because it makes everything much easier. I always set it to <tt class="docutils literal">True</tt> to my projects because
I don&#8217;t need to actually think about transactions and requests; I know that if there&#8217;s a problem in a request the whole transaction will be rolle back and no
garbage will be left in the database. If on the other hand for some reason a request does not need to be tied to a transaction I just set it off
for this specific transaction (using <cite>transaction.non_atomic_requests_</cite>). Please notice that by default the <tt class="docutils literal">ATOMIC_REQUESTS</tt> has a <tt class="docutils literal">False</tt> value which means that
the database will be in autocommit mode meaning that every command will be executed&nbsp;immediately.</p>
<p>So although the <tt class="docutils literal">ATOMIC_REQUESTS</tt> is great, it is actually the reason that there are problems with asynchronous tasks. Why? Let&#8217;s take a closer look at what the <tt class="docutils literal">form_valid</tt> of the view&nbsp;does:</p>
<div class="highlight"><pre><span></span><span class="k">def</span><span class="w"> </span><span class="nf">form_valid</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">form</span><span class="p">):</span>
    <span class="n">task</span> <span class="o">=</span> <span class="n">Task</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="n">url</span><span class="o">=</span><span class="n">form</span><span class="o">.</span><span class="n">cleaned_data</span><span class="p">[</span><span class="s1">&#39;url&#39;</span><span class="p">])</span> <span class="c1">#1</span>
    <span class="n">get_url_length</span><span class="o">.</span><span class="n">delay</span><span class="p">(</span><span class="n">task</span><span class="o">.</span><span class="n">id</span><span class="p">)</span> <span class="c1">#2</span>
    <span class="k">return</span> <span class="nb">super</span><span class="p">(</span><span class="n">TasksHomeFormView</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">form_valid</span><span class="p">(</span><span class="n">form</span><span class="p">)</span> <span class="c1">#3</span>
</pre></div>
<p>It creates the task in #1, fires off the asynchronous task in #2 and continues the execution of the view processing in #3. The important thing to understand
here is that the transaction will be commited <em>only after #3</em> is finished. This means that there&#8217;s a possibility that the asynchronous task will be started
before #3 is finished thus it won&#8217;t find the task because the task will <em>not</em> be created yet(!) This is a little counter-intuitive but you must remember
that the async task is run by a worker which is a different process than your application server; the worker may be able to start before the transaction is&nbsp;commited.</p>
<p>If you want to actually see the problem <em>every time</em> you can add a small delay between the start of the async task and the <tt class="docutils literal">form_valid</tt> something like&nbsp;this:</p>
<div class="highlight"><pre><span></span><span class="k">def</span><span class="w"> </span><span class="nf">form_valid</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">form</span><span class="p">):</span>
    <span class="n">task</span> <span class="o">=</span> <span class="n">Task</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="n">url</span><span class="o">=</span><span class="n">form</span><span class="o">.</span><span class="n">cleaned_data</span><span class="p">[</span><span class="s1">&#39;url&#39;</span><span class="p">])</span>
    <span class="n">get_url_length</span><span class="o">.</span><span class="n">delay</span><span class="p">(</span><span class="n">task</span><span class="o">.</span><span class="n">id</span><span class="p">)</span>
    <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
    <span class="k">return</span> <span class="nb">super</span><span class="p">(</span><span class="n">TasksHomeFormView</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">form_valid</span><span class="p">(</span><span class="n">form</span><span class="p">)</span>
</pre></div>
<p>This will make the view more slow so the asynchronous worker will always have time to start executing the task (and get the not found error). Also notice
that if you had <tt class="docutils literal">ATOMIC_REQUESTS: False</tt> the above code would work fine because the task would be created immediately (auto-commited) and the async job would be able to find&nbsp;it.</p>
</div>
<div class="section" id="the-solution">
<h2>The&nbsp;solution</h2>
<p>So how is this problem solved? Well it&#8217;s not that difficult now that you know what&#8217;s causing&nbsp;it!</p>
<p>One solution would be to set <tt class="docutils literal">ATOMIC_REQUESTS</tt> to <tt class="docutils literal">False</tt> but that would make all database commands auto-commit so you&#8217;ll lose
request-transaction-tieing. Another solution would be to set <tt class="docutils literal">ATOMIC_REQUESTS</tt> to <tt class="docutils literal">True</tt> and disable atomic requests for the specific view that starts the
asynchronous job using <cite>transaction.non_atomic_requests_</cite>. This is a viable solution however I don&#8217;t like it because I&#8217;d lose the comfort of transaction per request
for this specific request and I would need to add my own transaction&nbsp;handling.</p>
<p>A third solution is to avoid messing with the database in your view and create the task object in the async job. Any parameters you want to pass to the async job would be
passed directly to the async function. This may work fine in some cases but I find it more safe to create the task in the database before starting the async job so that
I have better control and error handling. This way even if there&#8217;s an error in my worker and for some reason the async job never starts or it breaks before being able to
handle the database, I will have the task object in the database because it will have been created in the&nbsp;view.</p>
<p>Is there anything better? Isn&#8217;t there a way to start the executing the async job <em>after</em> the transaction of the
view is commited? Actually yes, there is! For this, <a class="reference external" href="https://docs.djangoproject.com/en/2.1/topics/db/transactions/#django.db.transaction.on_commit">transaction.on_commit</a> comes to the rescue! This function
receives a callback that will be called after the transaction is commited! Thus, to properly fix you project, you should
change the <tt class="docutils literal">form_valid</tt> method like&nbsp;this:</p>
<div class="highlight"><pre><span></span><span class="k">def</span><span class="w"> </span><span class="nf">form_valid</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">form</span><span class="p">):</span>
    <span class="n">task</span> <span class="o">=</span> <span class="n">Task</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="n">url</span><span class="o">=</span><span class="n">form</span><span class="o">.</span><span class="n">cleaned_data</span><span class="p">[</span><span class="s1">&#39;url&#39;</span><span class="p">])</span>
    <span class="n">transaction</span><span class="o">.</span><span class="n">on_commit</span><span class="p">(</span><span class="k">lambda</span><span class="p">:</span> <span class="n">get_url_length</span><span class="o">.</span><span class="n">delay</span><span class="p">(</span><span class="n">task</span><span class="o">.</span><span class="n">id</span><span class="p">))</span>
    <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
    <span class="k">return</span> <span class="nb">super</span><span class="p">(</span><span class="n">TasksHomeFormView</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">form_valid</span><span class="p">(</span><span class="n">form</span><span class="p">)</span>
</pre></div>
<p>Notice that I need to use <tt class="docutils literal">lambda</tt> to create a callback function that will call <tt class="docutils literal">get_url_length.delay(task.id)</tt> when the transaction is commited. Now
even though I have the delay there the async job will start after the transaction is commited, ie after the view handler is finished (after the 1 second&nbsp;delay).</p>
</div>
<div class="section" id="conclusion">
<h2>Conclusion</h2>
<p>From the above you should be able to understand why sometimes you have problems when your async jobs use the database. To fix it you have various
options but at least for me, the best solution is to start your async jobs <em>after</em> the transaction is commited using <tt class="docutils literal">transaction.on_commit</tt>. Just
change each <tt class="docutils literal">async.job.delay(parameters)</tt> call to <tt class="docutils literal">transaction.on_commit(lambda: async.job.delay(parameters))</tt> and you will be&nbsp;fine!</p>
</div>
</div>
    <footer>
<p class="meta">
  <span class="byline author vcard">
    Posted by <span class="fn">
        Serafeim Papastefanos
    </span>
  </span>
<time datetime="2019-02-25T15:20:00+02:00" pubdate>Mon 25 February 2019</time>  <span class="categories">
    <a class='category' href='https://www.spapas.net/category/django.html'>django</a>
  </span>
  <span class="categories">
    <a class="category" href="https://www.spapas.net/tag/django.html">django</a>,    <a class="category" href="https://www.spapas.net/tag/async.html">async</a>,    <a class="category" href="https://www.spapas.net/tag/tasks.html">tasks</a>,    <a class="category" href="https://www.spapas.net/tag/django-rq.html">django-rq</a>,    <a class="category" href="https://www.spapas.net/tag/rq.html">rq</a>  </span>
</p><div class="sharing">
  <a href="http://twitter.com/share" class="twitter-share-button" data-url="https://www.spapas.net/2019/02/25/django-fix-async-db/" data-via="" data-counturl="https://www.spapas.net/2019/02/25/django-fix-async-db/" >Tweet</a>
</div>    </footer>
  </article>

  <section>
    <h1>Comments</h1>
    <div id="disqus_thread" aria-live="polite"><noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript></div>
  </section>
</div>
<aside class="sidebar">
  
  <section>
    <br />
    <a href='/feeds/all.atom.xml'>Atom</a>
    |
    <a href='/feeds/all.rss.xml'>RSS</a>
  </section>

  <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <!-- Sidebar unit -->
  <ins class="adsbygoogle" style="display:block" data-ad-client="ca-pub-7673322832689008" data-ad-slot="2720624730"
    data-ad-format="auto" data-full-width-responsive="true"></ins>
  <script>
    (adsbygoogle = window.adsbygoogle || []).push({});
  </script>


  <script async src="https://cse.google.com/cse.js?cx=612920e5ca9da850c"></script>
  <div class="gcse-search"></div>

  
  <section>
    <h1>Support me</h1>

    You can show your appreciation for anything useful you've found here by 
    buying me a coffee 
    <script type="text/javascript" src="https://cdnjs.buymeacoffee.com/1.0.0/button.prod.min.js" data-name="bmc-button" data-slug="spapas" data-color="#FFDD00" data-emoji=""  data-font="Lato" data-text="Buy me a coffee" data-outline-color="#000000" data-font-color="#000000" data-coffee-color="#ffffff" ></script>

    or donating me some bitcoin to this address:
    <small><pre>bc1qx42vp8napheaewhnx0rk0mttdrdrtvw6czvxhl</pre></small>
    <svg shape-rendering="crispEdges" height="200" width="200" viewBox="0 0 29 29" class="qrcode">
      <path fill="#FFFFFF" d="M0,0 h29v29H0z"></path><path fill="#000000" d="M0 0h7v1H0zM9 0h2v1H9zM12 0h1v1H12zM14 0h2v1H14zM18 0h2v1H18zM22,0 h7v1H22zM0 1h1v1H0zM6 1h1v1H6zM8 1h1v1H8zM11 1h1v1H11zM14 1h5v1H14zM22 1h1v1H22zM28,1 h1v1H28zM0 2h1v1H0zM2 2h3v1H2zM6 2h1v1H6zM8 2h4v1H8zM17 2h1v1H17zM22 2h1v1H22zM24 2h3v1H24zM28,2 h1v1H28zM0 3h1v1H0zM2 3h3v1H2zM6 3h1v1H6zM9 3h2v1H9zM14 3h3v1H14zM18 3h1v1H18zM22 3h1v1H22zM24 3h3v1H24zM28,3 h1v1H28zM0 4h1v1H0zM2 4h3v1H2zM6 4h1v1H6zM8 4h1v1H8zM11 4h1v1H11zM13 4h1v1H13zM15 4h2v1H15zM18 4h1v1H18zM22 4h1v1H22zM24 4h3v1H24zM28,4 h1v1H28zM0 5h1v1H0zM6 5h1v1H6zM8 5h2v1H8zM14 5h2v1H14zM19 5h2v1H19zM22 5h1v1H22zM28,5 h1v1H28zM0 6h7v1H0zM8 6h1v1H8zM10 6h1v1H10zM12 6h1v1H12zM14 6h1v1H14zM16 6h1v1H16zM18 6h1v1H18zM20 6h1v1H20zM22,6 h7v1H22zM8 7h2v1H8zM11 7h1v1H11zM15 7h1v1H15zM17 7h2v1H17zM0 8h2v1H0zM3 8h1v1H3zM6 8h2v1H6zM10 8h1v1H10zM12 8h3v1H12zM20 8h1v1H20zM22 8h3v1H22zM26 8h2v1H26zM1 9h1v1H1zM3 9h3v1H3zM8 9h1v1H8zM10 9h1v1H10zM12 9h2v1H12zM16 9h2v1H16zM20 9h1v1H20zM22 9h1v1H22zM25 9h1v1H25zM27,9 h2v1H27zM0 10h1v1H0zM3 10h2v1H3zM6 10h1v1H6zM8 10h3v1H8zM12 10h2v1H12zM16 10h1v1H16zM19 10h1v1H19zM22 10h3v1H22zM27 10h1v1H27zM0 11h1v1H0zM2 11h1v1H2zM4 11h2v1H4zM7 11h1v1H7zM13 11h4v1H13zM18 11h4v1H18zM26 11h2v1H26zM0 12h1v1H0zM2 12h3v1H2zM6 12h1v1H6zM11 12h1v1H11zM13 12h1v1H13zM15 12h3v1H15zM20 12h1v1H20zM22 12h2v1H22zM27,12 h2v1H27zM4 13h1v1H4zM8 13h3v1H8zM12 13h1v1H12zM14 13h1v1H14zM17 13h4v1H17zM25 13h2v1H25zM0 14h1v1H0zM4 14h3v1H4zM8 14h2v1H8zM11 14h3v1H11zM16 14h1v1H16zM21 14h2v1H21zM24,14 h5v1H24zM3 15h3v1H3zM7 15h2v1H7zM10 15h1v1H10zM12 15h2v1H12zM15 15h1v1H15zM17 15h2v1H17zM20 15h2v1H20zM23 15h1v1H23zM1 16h1v1H1zM4 16h1v1H4zM6 16h4v1H6zM16 16h2v1H16zM20 16h1v1H20zM23 16h1v1H23zM25 16h1v1H25zM28,16 h1v1H28zM2 17h1v1H2zM5 17h1v1H5zM7 17h2v1H7zM11 17h3v1H11zM17 17h1v1H17zM22 17h1v1H22zM25 17h1v1H25zM27,17 h2v1H27zM0 18h1v1H0zM3 18h1v1H3zM5 18h4v1H5zM10 18h1v1H10zM12 18h1v1H12zM18 18h1v1H18zM20 18h1v1H20zM22 18h2v1H22zM25,18 h4v1H25zM2 19h3v1H2zM8 19h1v1H8zM16 19h2v1H16zM21 19h1v1H21zM23 19h1v1H23zM25 19h1v1H25zM27 19h1v1H27zM0 20h1v1H0zM2 20h5v1H2zM8 20h2v1H8zM13 20h4v1H13zM19 20h6v1H19zM26 20h1v1H26zM28,20 h1v1H28zM8 21h2v1H8zM12 21h3v1H12zM16 21h1v1H16zM20 21h1v1H20zM24 21h1v1H24zM26,21 h3v1H26zM0 22h7v1H0zM8 22h3v1H8zM17 22h1v1H17zM20 22h1v1H20zM22 22h1v1H22zM24 22h2v1H24zM27 22h1v1H27zM0 23h1v1H0zM6 23h1v1H6zM10 23h2v1H10zM13 23h2v1H13zM19 23h2v1H19zM24,23 h5v1H24zM0 24h1v1H0zM2 24h3v1H2zM6 24h1v1H6zM9 24h2v1H9zM12 24h2v1H12zM17 24h1v1H17zM20 24h6v1H20zM28,24 h1v1H28zM0 25h1v1H0zM2 25h3v1H2zM6 25h1v1H6zM8 25h3v1H8zM12 25h1v1H12zM14 25h1v1H14zM18 25h1v1H18zM22 25h3v1H22zM26 25h1v1H26zM0 26h1v1H0zM2 26h3v1H2zM6 26h1v1H6zM10 26h5v1H10zM16 26h3v1H16zM21 26h1v1H21zM24 26h1v1H24zM26 26h1v1H26zM28,26 h1v1H28zM0 27h1v1H0zM6 27h1v1H6zM8 27h3v1H8zM12 27h4v1H12zM17 27h1v1H17zM20 27h1v1H20zM23 27h2v1H23zM27 27h1v1H27zM0 28h7v1H0zM8 28h3v1H8zM14 28h1v1H14zM16 28h3v1H16zM20 28h1v1H20zM22 28h1v1H22zM24 28h2v1H24zM27 28h1v1H27z"></path>
    </svg>
  </section>
  

  <section>
    <h1>Subscribe</h1>
    Do you want to get notified via email when I post new content?
    <style>
      .subscribe-button {
        /* margin: 10px !important; */
        padding: 10px !important;
        background-color: black;
        display: inline-block;
        color: white !important;
        text-decoration: none;

        line-height: 36px !important;
        height: 37px !important;
        text-decoration: none !important;
        display: inline-block !important;
        color: #ffffff !important;
        background-color: #000000 !important;
        border-radius: 3px !important;
        border: 1px solid transparent !important;
        padding: 1px 9px !important;
        font-size: 23px !important;
        letter-spacing: 0.6px !important;
        box-shadow: 0px 1px 2px rgba(190, 190, 190, 0.5) !important;
        -webkit-box-shadow: 0px 1px 2px 2px rgba(190, 190, 190, 0.5) !important;
        margin: 0 auto !important;
        font-family: 'Cookie', cursive !important;
        -webkit-box-sizing: border-box !important;
        box-sizing: border-box !important;
        -o-transition: 0.3s all linear !important;
        -webkit-transition: 0.3s all linear !important;
        -moz-transition: 0.3s all linear !important;
        -ms-transition: 0.3s all linear !important;
        transition: 0.3s all linear !important;

      }
    </style>
    <a class='subscribe-button' target="_blank" href="http://eepurl.com/dxI3PP">Click here to subscribe!</a>
  </section>


  <section>
    <h1>Recent Posts</h1>
    <ul id="recent_posts">
      <li class="post">
        <a href="https://www.spapas.net/2024/08/22/multiple-erl-elixir-windows/">Multiple Erlang/Elixir versions inÂ Windows</a>
      </li>
      <li class="post">
        <a href="https://www.spapas.net/2023/11/29/openid-connect-tutorial/">A simple OpenID connectÂ tutorial</a>
      </li>
      <li class="post">
        <a href="https://www.spapas.net/2023/05/23/simple-django-datatables-integration/">Simple Django - DataTablesÂ integration</a>
      </li>
      <li class="post">
        <a href="https://www.spapas.net/2023/05/22/ai-auto-subtitling/">AIÂ auto-subtitling</a>
      </li>
      <li class="post">
        <a href="https://www.spapas.net/2023/05/12/disable-your-forms/">HTML form disable afterÂ submit</a>
      </li>
    </ul>
  </section>
  <section>

    <h1>Categories</h1>
    <ul id="recent_posts">
      <li><a href="https://www.spapas.net/category/ai.html">ai</a></li>
      <li><a href="https://www.spapas.net/category/android.html">android</a></li>
      <li><a href="https://www.spapas.net/category/clojure.html">clojure</a></li>
      <li><a href="https://www.spapas.net/category/css.html">css</a></li>
      <li><a href="https://www.spapas.net/category/django.html">django</a></li>
      <li><a href="https://www.spapas.net/category/elixir.html">elixir</a></li>
      <li><a href="https://www.spapas.net/category/flask.html">flask</a></li>
      <li><a href="https://www.spapas.net/category/gaming.html">gaming</a></li>
      <li><a href="https://www.spapas.net/category/git.html">git</a></li>
      <li><a href="https://www.spapas.net/category/html.html">html</a></li>
      <li><a href="https://www.spapas.net/category/javascript.html">javascript</a></li>
      <li><a href="https://www.spapas.net/category/networking.html">networking</a></li>
      <li><a href="https://www.spapas.net/category/pelican.html">pelican</a></li>
      <li><a href="https://www.spapas.net/category/postgresql.html">postgresql</a></li>
      <li><a href="https://www.spapas.net/category/python.html">python</a></li>
      <li><a href="https://www.spapas.net/category/spring.html">spring</a></li>
      <li><a href="https://www.spapas.net/category/unix.html">unix</a></li>
      <li><a href="https://www.spapas.net/category/wagtail.html">wagtail</a></li>
    </ul>
  </section>

  <section>
    <h1>Tags</h1>
    <a href="https://www.spapas.net/tag/erlang.html">erlang</a>,    <a href="https://www.spapas.net/tag/elixir.html">elixir</a>,    <a href="https://www.spapas.net/tag/windows.html">windows</a>,    <a href="https://www.spapas.net/tag/openid.html">openid</a>,    <a href="https://www.spapas.net/tag/openid-connect.html">openid-connect</a>,    <a href="https://www.spapas.net/tag/oidc.html">oidc</a>,    <a href="https://www.spapas.net/tag/http.html">http</a>,    <a href="https://www.spapas.net/tag/keycloak.html">keycloak</a>,    <a href="https://www.spapas.net/tag/python.html">python</a>,    <a href="https://www.spapas.net/tag/django.html">django</a>,    <a href="https://www.spapas.net/tag/jquery.html">jquery</a>,    <a href="https://www.spapas.net/tag/datatables.html">datatables</a>,    <a href="https://www.spapas.net/tag/ai.html">ai</a>,    <a href="https://www.spapas.net/tag/whisper.html">whisper</a>,    <a href="https://www.spapas.net/tag/whispercpp.html">whisper.cpp</a>,    <a href="https://www.spapas.net/tag/subtitles.html">subtitles</a>,    <a href="https://www.spapas.net/tag/video.html">video</a>,    <a href="https://www.spapas.net/tag/auto-subtitling.html">auto-subtitling</a>,    <a href="https://www.spapas.net/tag/subtitiling.html">subtitiling</a>,    <a href="https://www.spapas.net/tag/transcribe.html">transcribe</a>,    <a href="https://www.spapas.net/tag/html.html">html</a>,    <a href="https://www.spapas.net/tag/javascript.html">javascript</a>,    <a href="https://www.spapas.net/tag/media.html">media</a>,    <a href="https://www.spapas.net/tag/storage.html">storage</a>,    <a href="https://www.spapas.net/tag/unpoly.html">unpoly</a>,    <a href="https://www.spapas.net/tag/access.html">access</a>,    <a href="https://www.spapas.net/tag/database.html">database</a>,    <a href="https://www.spapas.net/tag/accdb.html">accdb</a>,    <a href="https://www.spapas.net/tag/mdb.html">mdb</a>,    <a href="https://www.spapas.net/tag/postgresql.html">postgresql</a>,    <a href="https://www.spapas.net/tag/development.html">development</a>,    <a href="https://www.spapas.net/tag/inlines.html">inlines</a>,    <a href="https://www.spapas.net/tag/clojure.html">clojure</a>,    <a href="https://www.spapas.net/tag/cmd.html">cmd</a>,    <a href="https://www.spapas.net/tag/pdf.html">pdf</a>,    <a href="https://www.spapas.net/tag/wkhtmltopdf.html">wkhtmltopdf</a>,    <a href="https://www.spapas.net/tag/forward-proxy.html">forward-proxy</a>,    <a href="https://www.spapas.net/tag/reverse-proxy.html">reverse-proxy</a>,    <a href="https://www.spapas.net/tag/proxy.html">proxy</a>,    <a href="https://www.spapas.net/tag/networking.html">networking</a>,    <a href="https://www.spapas.net/tag/dj-rest-auth.html">dj-rest-auth</a>,    <a href="https://www.spapas.net/tag/rest.html">rest</a>,    <a href="https://www.spapas.net/tag/django-rest-framework.html">django-rest-framework</a>,    <a href="https://www.spapas.net/tag/authentication.html">authentication</a>,    <a href="https://www.spapas.net/tag/tokens.html">tokens</a>,    <a href="https://www.spapas.net/tag/migrations.html">migrations</a>,    <a href="https://www.spapas.net/tag/foreignkey.html">foreignkey</a>,    <a href="https://www.spapas.net/tag/dark-souls.html">dark-souls</a>,    <a href="https://www.spapas.net/tag/dark-souls-2.html">dark-souls-2</a>,    <a href="https://www.spapas.net/tag/dark-souls-3.html">dark-souls-3</a>,    <a href="https://www.spapas.net/tag/autohotkey.html">autohotkey</a>,    <a href="https://www.spapas.net/tag/matplotlib.html">matplotlib</a>,    <a href="https://www.spapas.net/tag/hashids.html">hashids</a>,    <a href="https://www.spapas.net/tag/wagtail.html">wagtail</a>,    <a href="https://www.spapas.net/tag/osmon.html">osmon</a>,    <a href="https://www.spapas.net/tag/phoenix.html">phoenix</a>,    <a href="https://www.spapas.net/tag/os-monitoring.html">os-monitoring</a>,    <a href="https://www.spapas.net/tag/forms.html">forms</a>,    <a href="https://www.spapas.net/tag/django-crispy-forms.html">django-crispy-forms</a>,    <a href="https://www.spapas.net/tag/django-widget-tweaks.html">django-widget-tweaks</a>,    <a href="https://www.spapas.net/tag/ecto.html">ecto</a>,    <a href="https://www.spapas.net/tag/queries.html">queries</a>,    <a href="https://www.spapas.net/tag/declarative.html">declarative</a>,    <a href="https://www.spapas.net/tag/form.html">form</a>,    <a href="https://www.spapas.net/tag/php.html">php</a>,    <a href="https://www.spapas.net/tag/select2.html">select2</a>,    <a href="https://www.spapas.net/tag/autocompelte.html">autocompelte</a>,    <a href="https://www.spapas.net/tag/ajax.html">ajax</a>,    <a href="https://www.spapas.net/tag/android.html">android</a>,    <a href="https://www.spapas.net/tag/kotlin.html">kotlin</a>,    <a href="https://www.spapas.net/tag/adapter.html">adapter</a>,    <a href="https://www.spapas.net/tag/filter.html">filter</a>,    <a href="https://www.spapas.net/tag/async.html">async</a>,    <a href="https://www.spapas.net/tag/tasks.html">tasks</a>,    <a href="https://www.spapas.net/tag/django-rq.html">django-rq</a>,    <a href="https://www.spapas.net/tag/rq.html">rq</a>,    <a href="https://www.spapas.net/tag/du.html">du</a>,    <a href="https://www.spapas.net/tag/unix.html">unix</a>,    <a href="https://www.spapas.net/tag/linux.html">linux</a>,    <a href="https://www.spapas.net/tag/disk-usage.html">disk-usage</a>,    <a href="https://www.spapas.net/tag/cbv.html">cbv</a>,    <a href="https://www.spapas.net/tag/middleware.html">middleware</a>,    <a href="https://www.spapas.net/tag/class-based-views.html">class-based-views</a>,    <a href="https://www.spapas.net/tag/react.html">react</a>,    <a href="https://www.spapas.net/tag/redux.html">redux</a>,    <a href="https://www.spapas.net/tag/hyperapp.html">hyperapp</a>,    <a href="https://www.spapas.net/tag/immutable.html">immutable</a>,    <a href="https://www.spapas.net/tag/es6.html">es6</a>,    <a href="https://www.spapas.net/tag/youtube.html">youtube</a>,    <a href="https://www.spapas.net/tag/youtube-dl.html">youtube-dl</a>,    <a href="https://www.spapas.net/tag/ffmpeg.html">ffmpeg</a>,    <a href="https://www.spapas.net/tag/django-rest-auth.html">django-rest-auth</a>,    <a href="https://www.spapas.net/tag/python-2.html">python-2</a>,    <a href="https://www.spapas.net/tag/python-3.html">python-3</a>,    <a href="https://www.spapas.net/tag/plpgsql.html">plpgsql</a>,    <a href="https://www.spapas.net/tag/component.html">component</a>,    <a href="https://www.spapas.net/tag/ag-grid.html">ag-grid</a>,    <a href="https://www.spapas.net/tag/grid.html">grid</a>,    <a href="https://www.spapas.net/tag/bash.html">bash</a>,    <a href="https://www.spapas.net/tag/cron.html">cron</a>,    <a href="https://www.spapas.net/tag/pandas.html">pandas</a>,    <a href="https://www.spapas.net/tag/scipy.html">scipy</a>,    <a href="https://www.spapas.net/tag/numpy.html">numpy</a>,    <a href="https://www.spapas.net/tag/pivot.html">pivot</a>,    <a href="https://www.spapas.net/tag/pivot_table.html">pivot_table</a>,    <a href="https://www.spapas.net/tag/ipython.html">ipython</a>,    <a href="https://www.spapas.net/tag/jupyter.html">jupyter</a>,    <a href="https://www.spapas.net/tag/notebook.html">notebook</a>,    <a href="https://www.spapas.net/tag/query.html">query</a>,    <a href="https://www.spapas.net/tag/q.html">q</a>,    <a href="https://www.spapas.net/tag/imgur.html">imgur</a>,    <a href="https://www.spapas.net/tag/console.html">console</a>,    <a href="https://www.spapas.net/tag/research.html">research</a>,    <a href="https://www.spapas.net/tag/debug.html">debug</a>,    <a href="https://www.spapas.net/tag/werkzeug.html">werkzeug</a>,    <a href="https://www.spapas.net/tag/django-extensions.html">django-extensions</a>,    <a href="https://www.spapas.net/tag/404.html">404</a>,    <a href="https://www.spapas.net/tag/error.html">error</a>,    <a href="https://www.spapas.net/tag/spring.html">spring</a>,    <a href="https://www.spapas.net/tag/spring-boot.html">spring-boot</a>,    <a href="https://www.spapas.net/tag/java.html">java</a>,    <a href="https://www.spapas.net/tag/ldap.html">ldap</a>,    <a href="https://www.spapas.net/tag/profiles.html">profiles</a>,    <a href="https://www.spapas.net/tag/settings.html">settings</a>,    <a href="https://www.spapas.net/tag/properties.html">properties</a>,    <a href="https://www.spapas.net/tag/yaml.html">yaml</a>,    <a href="https://www.spapas.net/tag/configuration.html">configuration</a>,    <a href="https://www.spapas.net/tag/deploy.html">deploy</a>,    <a href="https://www.spapas.net/tag/initd.html">init.d</a>,    <a href="https://www.spapas.net/tag/react-redux.html">react-redux</a>,    <a href="https://www.spapas.net/tag/redux-thunk.html">redux-thunk</a>,    <a href="https://www.spapas.net/tag/redux-form.html">redux-form</a>,    <a href="https://www.spapas.net/tag/react-router.html">react-router</a>,    <a href="https://www.spapas.net/tag/react-router-redux.html">react-router-redux</a>,    <a href="https://www.spapas.net/tag/react-notification.html">react-notification</a>,    <a href="https://www.spapas.net/tag/history.html">history</a>,    <a href="https://www.spapas.net/tag/babel.html">babel</a>,    <a href="https://www.spapas.net/tag/babelify.html">babelify</a>,    <a href="https://www.spapas.net/tag/browserify.html">browserify</a>,    <a href="https://www.spapas.net/tag/watchify.html">watchify</a>,    <a href="https://www.spapas.net/tag/uglify.html">uglify</a>,    <a href="https://www.spapas.net/tag/boilerplate.html">boilerplate</a>,    <a href="https://www.spapas.net/tag/tutorial.html">tutorial</a>,    <a href="https://www.spapas.net/tag/introduction.html">introduction</a>,    <a href="https://www.spapas.net/tag/fixed-data-tables.html">fixed-data-tables</a>,    <a href="https://www.spapas.net/tag/fixeddatatable.html">FixedDataTable</a>,    <a href="https://www.spapas.net/tag/reportlab.html">reportlab</a>,    <a href="https://www.spapas.net/tag/xhtml2pdf.html">xhtml2pdf</a>,    <a href="https://www.spapas.net/tag/node.html">node</a>,    <a href="https://www.spapas.net/tag/npm.html">npm</a>,    <a href="https://www.spapas.net/tag/generic.html">generic</a>,    <a href="https://www.spapas.net/tag/tables.html">tables</a>,    <a href="https://www.spapas.net/tag/flux.html">flux</a>,    <a href="https://www.spapas.net/tag/jobs.html">jobs</a>,    <a href="https://www.spapas.net/tag/asynchronous.html">asynchronous</a>,    <a href="https://www.spapas.net/tag/scheduling.html">scheduling</a>,    <a href="https://www.spapas.net/tag/redis.html">redis</a>,    <a href="https://www.spapas.net/tag/pusher.html">pusher</a>,    <a href="https://www.spapas.net/tag/auditing.html">auditing</a>,    <a href="https://www.spapas.net/tag/css.html">css</a>,    <a href="https://www.spapas.net/tag/design.html">design</a>,    <a href="https://www.spapas.net/tag/boostrap-material-design.html">boostrap-material-design</a>,    <a href="https://www.spapas.net/tag/less.html">less</a>,    <a href="https://www.spapas.net/tag/nodejs.html">node.js</a>,    <a href="https://www.spapas.net/tag/gmail.html">gmail</a>,    <a href="https://www.spapas.net/tag/security.html">security</a>,    <a href="https://www.spapas.net/tag/google.html">google</a>,    <a href="https://www.spapas.net/tag/flask.html">flask</a>,    <a href="https://www.spapas.net/tag/mongodb.html">mongodb</a>,    <a href="https://www.spapas.net/tag/heroku.html">heroku</a>,    <a href="https://www.spapas.net/tag/spring-security.html">spring-security</a>,    <a href="https://www.spapas.net/tag/git.html">git</a>,    <a href="https://www.spapas.net/tag/github.html">github</a>,    <a href="https://www.spapas.net/tag/branching.html">branching</a>,    <a href="https://www.spapas.net/tag/static-html.html">static-html</a>,    <a href="https://www.spapas.net/tag/githubio.html">github.io</a>,    <a href="https://www.spapas.net/tag/pelican.html">pelican</a>,    <a href="https://www.spapas.net/tag/github-pages.html">github-pages</a>,    <a href="https://www.spapas.net/tag/rst.html">rst</a>  </section>

  <section>
    <h1>Yearly archives</h1>
    <a href="https://www.spapas.net/posts/2013/">2013</a>,    <a href="https://www.spapas.net/posts/2014/">2014</a>,    <a href="https://www.spapas.net/posts/2015/">2015</a>,    <a href="https://www.spapas.net/posts/2016/">2016</a>,    <a href="https://www.spapas.net/posts/2017/">2017</a>,    <a href="https://www.spapas.net/posts/2018/">2018</a>,    <a href="https://www.spapas.net/posts/2019/">2019</a>,    <a href="https://www.spapas.net/posts/2020/">2020</a>,    <a href="https://www.spapas.net/posts/2021/">2021</a>,    <a href="https://www.spapas.net/posts/2022/">2022</a>,    <a href="https://www.spapas.net/posts/2023/">2023</a>,    <a href="https://www.spapas.net/posts/2024/">2024</a>  </section>



  <section>
    <h1>GitHub Repos</h1>
    <ul id="gh_repos">
      <li class="loading">Status updating...</li>
    </ul>
      <a href="https://github.com/spapas">@spapas</a> on GitHub
    <script  src="//code.jquery.com/jquery-3.3.1.min.js"
        integrity="sha256-FgpCb/KJQlLNfOu91ta32o/NMZxltwRo8QtmkMRdAu8="
        crossorigin="anonymous"></script>
    <script type="text/javascript">
      $(function(){
          if (!window.jXHR){
              var jxhr = document.createElement('script');
              jxhr.type = 'text/javascript';
              jxhr.src = 'https://www.spapas.net/theme/js/jXHR.js';
              var s = document.getElementsByTagName('script')[0];
              s.parentNode.insertBefore(jxhr, s);
          }

          github.showRepos({
              user: 'spapas',
              count: 5,
              skip_forks: true,
              target: '#gh_repos'
          });
      });
    </script>
    <script src="https://www.spapas.net/theme/js/github.js" type="text/javascript"> </script>
  </section>


  <section>
    <a href="https://twitter.com/_serafeim_?ref_src=twsrc%5Etfw" class="twitter-follow-button"
      data-show-count="false">Follow @_serafeim_</a>
    <script async src="https://platform.twitter.com/widgets.js" charset="utf-8"></script>
  </section>

</aside>    </div>
  </div>
  <footer role="contentinfo"><p>
    Copyright &copy;  2013&ndash;2024  Serafeim Papastefanos &mdash;
  <span class="credit">Powered by <a href="http://getpelican.com">Pelican</a></span>
</p></footer>
  <script src="https://www.spapas.net/theme/js/modernizr-2.0.js"></script>
  <script src="https://www.spapas.net/theme/js/ender.js"></script>
  <script src="https://www.spapas.net/theme/js/octopress.js" type="text/javascript"></script>
  <script src="https://www.spapas.net/theme/js/ads.js"></script>
    <script>
    (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
    (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
    m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
    })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

    ga('create', 'UA-44750952-1', 'auto');

    ga('send', 'pageview');
    </script>

<script defer data-domain="spapas.net" src="https://plausible.hcg.gr/js/script.js"></script>  <script type="text/javascript">
    var disqus_shortname = 'spapas-github-io';
    var disqus_identifier = '/2019/02/25/django-fix-async-db/';
    var disqus_url = 'https://www.spapas.net/2019/02/25/django-fix-async-db/';
    var disqus_title = 'Fixing your Django async job - database&nbsp;integration';
    (function() {
      var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
      dsq.src = "//" + disqus_shortname + '.disqus.com/embed.js';
      (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
     })();
  </script>
  <script type="text/javascript">
    (function(){
      var twitterWidgets = document.createElement('script');
      twitterWidgets.type = 'text/javascript';
      twitterWidgets.async = true;
      twitterWidgets.src = '//platform.twitter.com/widgets.js';
      document.getElementsByTagName('head')[0].appendChild(twitterWidgets);
    })();
  </script>

</body>

</html>